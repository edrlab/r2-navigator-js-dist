{"version":3,"file":"highlight.js","sourceRoot":"","sources":["../../../../../src/electron/renderer/highlight.ts"],"names":[],"mappings":"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","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport {\n    IEventPayload_R2_EVENT_HIGHLIGHT_CLICK, IEventPayload_R2_EVENT_HIGHLIGHT_CREATE,\n    IEventPayload_R2_EVENT_HIGHLIGHT_REMOVE, IEventPayload_R2_EVENT_HIGHLIGHT_REMOVE_ALL, R2_EVENT_HIGHLIGHT_CLICK, R2_EVENT_HIGHLIGHT_CREATE,\n    R2_EVENT_HIGHLIGHT_REMOVE, R2_EVENT_HIGHLIGHT_REMOVE_ALL,\n    IEventPayload_R2_EVENT_HIGHLIGHT_DRAW_MARGIN, R2_EVENT_HIGHLIGHT_DRAW_MARGIN,\n} from \"../common/events\";\nimport { IHighlight, IHighlightDefinition } from \"../common/highlight\";\nimport { ReadiumElectronBrowserWindow, IReadiumElectronWebview } from \"./webview/state\";\n\n// import * as debug_ from \"debug\";\n// const debug = debug_(\"r2:navigator#electron/renderer/index\");\n// const IS_DEV = (process.env.NODE_ENV === \"development\" || process.env.NODE_ENV === \"dev\");\n\nconst win = global.window as ReadiumElectronBrowserWindow;\n\nexport function highlightsHandleIpcMessage(\n    eventChannel: string,\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    eventArgs: any[],\n    eventCurrentTarget: IReadiumElectronWebview): boolean {\n\n    if (eventChannel === R2_EVENT_HIGHLIGHT_CLICK) {\n        const activeWebView = eventCurrentTarget;\n        const payload = eventArgs[0] as IEventPayload_R2_EVENT_HIGHLIGHT_CLICK;\n        if (_highlightsClickListener && activeWebView.READIUM2.link) {\n            _highlightsClickListener(activeWebView.READIUM2.link.Href, payload.highlight, payload.event);\n        }\n        return true;\n    } else if (eventChannel === R2_EVENT_HIGHLIGHT_CREATE) {\n        return true;\n    } else {\n        return false;\n    }\n}\n\nlet _highlightsClickListener: ((href: string, highlight: IHighlight, event?: IEventPayload_R2_EVENT_HIGHLIGHT_CLICK[\"event\"]) => void) | undefined;\nexport function highlightsClickListen(highlightsClickListener: (href: string, highlight: IHighlight, event?: IEventPayload_R2_EVENT_HIGHLIGHT_CLICK[\"event\"]) => void) {\n    _highlightsClickListener = highlightsClickListener;\n}\nexport function highlightsRemoveAll(href: string, groups: string[] | undefined) {\n    console.log(\"--HIGH-- highlightsRemoveAll: \" + href + \" ... \" + JSON.stringify(groups));\n    const activeWebViews = win.READIUM2.getActiveWebViews();\n    for (const activeWebView of activeWebViews) {\n        if (activeWebView.READIUM2.link?.Href !== href) {\n            continue;\n        }\n\n        setTimeout(async () => {\n            if (activeWebView.READIUM2?.DOMisReady) {\n\n                const payload: IEventPayload_R2_EVENT_HIGHLIGHT_REMOVE_ALL = {\n                    groups,\n                };\n                if (groups) {\n                    if (activeWebView.READIUM2.highlights) {\n                        activeWebView.READIUM2.highlights =  activeWebView.READIUM2.highlights.filter((h) => {\n                            return !h.group || !groups.includes(h.group);\n                        });\n                    }\n                } else {\n                    activeWebView.READIUM2.highlights = undefined;\n                }\n                await activeWebView.send(R2_EVENT_HIGHLIGHT_REMOVE_ALL, payload);\n            }\n        }, 0);\n    }\n}\nexport function highlightsRemove(href: string, highlightIDs: string[]) {\n    console.log(\"--HIGH-- highlightsRemove: \" + href + \" ==> \" + highlightIDs.length);\n    const activeWebViews = win.READIUM2.getActiveWebViews();\n    for (const activeWebView of activeWebViews) {\n        if (activeWebView.READIUM2.link?.Href !== href) {\n            continue;\n        }\n\n        const payload: IEventPayload_R2_EVENT_HIGHLIGHT_REMOVE = {\n            highlightIDs,\n        };\n        setTimeout(async () => {\n            if (activeWebView.READIUM2?.DOMisReady) {\n                if (activeWebView.READIUM2.highlights) {\n                    activeWebView.READIUM2.highlights = activeWebView.READIUM2.highlights.filter((h) => {\n                        return !highlightIDs.includes(h.id);\n                    });\n                }\n                await activeWebView.send(R2_EVENT_HIGHLIGHT_REMOVE, payload);\n            }\n        }, 0);\n    }\n}\nexport async function highlightsCreate(\n    href: string,\n    highlightDefinitions: IHighlightDefinition[] | undefined):\n    Promise<Array<IHighlight | null>> {\n    return new Promise<Array<IHighlight | null>>((resolve, reject) => {\n        console.log(\"--HIGH-- highlightsCreate: \" + href + \" ==> \" + highlightDefinitions?.length);\n        const activeWebViews = win.READIUM2.getActiveWebViews();\n        for (const activeWebView of activeWebViews) {\n            if (activeWebView.READIUM2.link?.Href !== href) {\n                continue;\n            }\n\n            const cb = (event: Electron.IpcMessageEvent) => {\n                if (event.channel === R2_EVENT_HIGHLIGHT_CREATE) {\n                    const webview = event.currentTarget as IReadiumElectronWebview;\n                    if (webview !== activeWebView) {\n                        console.log(\"Wrong navigator webview?!\");\n                        return;\n                    }\n                    const payloadPong = event.args[0] as IEventPayload_R2_EVENT_HIGHLIGHT_CREATE;\n                    webview.removeEventListener(\"ipc-message\", cb);\n                    if (!payloadPong.highlights) { // includes undefined and empty array\n                        // UNCHANGED webview.READIUM2.highlights = undefined;\n                        reject(\"highlightCreate fail?!\");\n                    } else {\n                        if (!webview.READIUM2.highlights) {\n                            webview.READIUM2.highlights = [];\n                        }\n                        webview.READIUM2.highlights.push(...(payloadPong.highlights.filter((h) => !!h) as IHighlight[]));\n                        resolve(payloadPong.highlights);\n                    }\n                }\n            };\n            activeWebView.addEventListener(\"ipc-message\", cb);\n            const payloadPing: IEventPayload_R2_EVENT_HIGHLIGHT_CREATE = {\n                highlightDefinitions,\n                highlights: undefined,\n            };\n\n            setTimeout(async () => {\n                if (activeWebView.READIUM2?.DOMisReady) {\n                    await activeWebView.send(R2_EVENT_HIGHLIGHT_CREATE, payloadPing);\n                }\n            }, 0);\n\n            return;\n        }\n\n        reject(\"highlightsCreate - no webview match?!\");\n    });\n}\n\nexport function highlightsDrawMargin(drawMargin: boolean | string[]) {\n    console.log(\"--HIGH-- highlightsDrawMargin: \" + JSON.stringify(drawMargin, null, 4));\n    win.READIUM2.highlightsDrawMargin = drawMargin;\n    const activeWebViews = win.READIUM2.getActiveWebViews();\n    for (const activeWebView of activeWebViews) {\n        const payload: IEventPayload_R2_EVENT_HIGHLIGHT_DRAW_MARGIN = {\n            drawMargin,\n        };\n        setTimeout(async () => {\n            if (activeWebView.READIUM2?.DOMisReady) {\n                await activeWebView.send(R2_EVENT_HIGHLIGHT_DRAW_MARGIN, payload);\n            }\n        }, 0);\n    }\n}\n"]}