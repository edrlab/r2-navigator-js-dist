{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../../src/electron/renderer/index.ts"],"names":[],"mappings":"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","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nconst IS_DEV = (process.env.NODE_ENV === \"development\" || process.env.NODE_ENV === \"dev\");\n\n// import { consoleRedirect } from \"../common/console-redirect\";\nif (IS_DEV) {\n    // tslint:disable-next-line:no-var-requires\n    const cr = require(\"./common/console-redirect\");\n    // const releaseConsoleRedirect =\n    cr.consoleRedirect(\"r2:navigator#electron/renderer/index\", process.stdout, process.stderr, true);\n}\n\nimport { URL } from \"url\";\n\nimport { Locator, LocatorLocations } from \"@r2-shared-js/models/locator\";\nimport { Publication } from \"@r2-shared-js/models/publication\";\nimport { Link } from \"@r2-shared-js/models/publication-link\";\nimport { encodeURIComponent_RFC3986 } from \"@r2-utils-js/_utils/http/UrlUtils\";\nimport { debounce } from \"debounce\";\nimport * as debug_ from \"debug\";\nimport { ipcRenderer, shell } from \"electron\";\n\nimport {\n    IEventPayload_R2_EVENT_LINK,\n    IEventPayload_R2_EVENT_LOCATOR_VISIBLE,\n    IEventPayload_R2_EVENT_PAGE_TURN,\n    IEventPayload_R2_EVENT_READING_LOCATION,\n    IEventPayload_R2_EVENT_READING_LOCATION_PAGINATION_INFO,\n    IEventPayload_R2_EVENT_READIUMCSS,\n    IEventPayload_R2_EVENT_SCROLLTO,\n    IEventPayload_R2_EVENT_TTS_CLICK_ENABLE,\n    IEventPayload_R2_EVENT_TTS_DO_PLAY,\n    IEventPayload_R2_EVENT_WEBVIEW_READY,\n    R2_EVENT_DEBUG_VISUALS,\n    R2_EVENT_LINK,\n    R2_EVENT_LOCATOR_VISIBLE,\n    R2_EVENT_PAGE_TURN,\n    R2_EVENT_PAGE_TURN_RES,\n    R2_EVENT_READING_LOCATION,\n    R2_EVENT_READIUMCSS,\n    R2_EVENT_SCROLLTO,\n    R2_EVENT_TTS_CLICK_ENABLE,\n    R2_EVENT_TTS_DO_NEXT,\n    R2_EVENT_TTS_DO_PAUSE,\n    R2_EVENT_TTS_DO_PLAY,\n    R2_EVENT_TTS_DO_PREVIOUS,\n    R2_EVENT_TTS_DO_RESUME,\n    R2_EVENT_TTS_DO_STOP,\n    R2_EVENT_TTS_IS_PAUSED,\n    R2_EVENT_TTS_IS_PLAYING,\n    R2_EVENT_TTS_IS_STOPPED,\n    R2_EVENT_WEBVIEW_READY,\n} from \"../common/events\";\nimport {\n    R2_SESSION_WEBVIEW,\n    READIUM2_ELECTRON_HTTP_PROTOCOL,\n    convertCustomSchemeToHttpUrl,\n    convertHttpUrlToCustomScheme,\n} from \"../common/sessions\";\nimport {\n    URL_PARAM_CSS,\n    URL_PARAM_DEBUG_VISUALS,\n    URL_PARAM_EPUBREADINGSYSTEM,\n    URL_PARAM_GOTO,\n    URL_PARAM_PREVIOUS,\n} from \"./common/url-params\";\nimport { INameVersion } from \"./webview/epubReadingSystem\";\nimport { IElectronBrowserWindow, IElectronWebviewTag } from \"./webview/state\";\n\nimport URI = require(\"urijs\");\n\n// import { registerProtocol } from \"@r2-navigator-js/electron/renderer/common/protocol\";\n// registerProtocol();\n\nconst ENABLE_WEBVIEW_RESIZE = true;\n\n// const CLASS_POS_RIGHT = \"r2_posRight\";\n// const CLASS_SHIFT_LEFT = \"r2_shiftedLeft\";\n// const CLASS_ANIMATED = \"r2_animated\";\n\n// export const DOM_EVENT_HIDE_VIEWPORT = \"r2:hide-content-viewport\";\n// export const DOM_EVENT_SHOW_VIEWPORT = \"r2:show-content-viewport\";\n\nconst ELEMENT_ID_SLIDING_VIEWPORT = \"r2_navigator_sliding_viewport\";\n\nconst debug = debug_(\"r2:navigator#electron/renderer/index\");\n\n// const queryParams = getURLQueryParams();\n\n// // tslint:disable-next-line:no-string-literal\n// const publicationJsonUrl = queryParams[\"pub\"];\n// debug(publicationJsonUrl);\n// const publicationJsonUrl_ = publicationJsonUrl.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL) ?\n//     convertCustomSchemeToHttpUrl(publicationJsonUrl) : publicationJsonUrl;\n// debug(publicationJsonUrl_);\n// const pathBase64 = publicationJsonUrl_.replace(/.*\\/pub\\/(.*)\\/manifest.json/, \"$1\");\n// debug(pathBase64);\n// const pathDecoded = new Buffer(decodeURIComponent(pathBase64), \"base64\").toString(\"utf8\");\n// debug(pathDecoded);\n// const pathFileName = pathDecoded.substr(\n//     pathDecoded.replace(/\\\\/g, \"/\").lastIndexOf(\"/\") + 1,\n//     pathDecoded.length - 1);\n// debug(pathFileName);\n\n// // tslint:disable-next-line:no-string-literal\n// const lcpHint = queryParams[\"lcpHint\"];\n\nfunction isRTL(/* link: Link | undefined */): boolean {\n    // if (link && link.Properties) {\n    //     if (link.Properties.Direction === \"rtl\") {\n    //         return true;\n    //     }\n    //     if (typeof link.Properties.Direction !== \"undefined\") {\n    //         return false;\n    //     }\n    // }\n    if (_publication &&\n        _publication.Metadata &&\n        _publication.Metadata.Direction) {\n        return _publication.Metadata.Direction.toLowerCase() === \"rtl\"; //  any other value is LTR\n    }\n    return false;\n}\n\nfunction isFixedLayout(link: Link | undefined): boolean {\n    if (link && link.Properties) {\n        if (link.Properties.Layout === \"fixed\") {\n            return true;\n        }\n        if (typeof link.Properties.Layout !== \"undefined\") {\n            return false;\n        }\n    }\n    if (_publication &&\n        _publication.Metadata &&\n        _publication.Metadata.Rendition) {\n        return _publication.Metadata.Rendition.Layout === \"fixed\";\n    }\n    return false;\n}\n\nlet _epubReadingSystemNameVersion: INameVersion = { name: \"Readium2\", version: \"0.0.0\" };\nexport function setEpubReadingSystemInfo(nv: INameVersion) {\n    _epubReadingSystemNameVersion = nv;\n}\n\nexport function __computeReadiumCssJsonMessage(link: Link | undefined): IEventPayload_R2_EVENT_READIUMCSS {\n\n    if (isFixedLayout(link)) {\n        return { setCSS: undefined, isFixedLayout: true };\n    }\n\n    if (!_computeReadiumCssJsonMessage) {\n        return { setCSS: undefined, isFixedLayout: false };\n    }\n\n    const readiumCssJsonMessage = _computeReadiumCssJsonMessage();\n    return readiumCssJsonMessage;\n}\nlet _computeReadiumCssJsonMessage: () => IEventPayload_R2_EVENT_READIUMCSS = () => {\n    return { setCSS: undefined, isFixedLayout: false };\n};\nexport function setReadiumCssJsonGetter(func: () => IEventPayload_R2_EVENT_READIUMCSS) {\n    _computeReadiumCssJsonMessage = func;\n}\n\nexport interface LocatorExtended {\n    locator: Locator;\n    paginationInfo: IEventPayload_R2_EVENT_READING_LOCATION_PAGINATION_INFO | undefined;\n}\n\nlet _lastSavedReadingLocation: LocatorExtended | undefined;\nexport function getCurrentReadingLocation(): LocatorExtended | undefined {\n    return _lastSavedReadingLocation;\n}\nlet _readingLocationSaver: ((locator: LocatorExtended) => void) | undefined;\nconst _saveReadingLocation = (docHref: string, locator: IEventPayload_R2_EVENT_READING_LOCATION) => {\n    _lastSavedReadingLocation = {\n        locator: {\n            href: docHref,\n            locations: {\n                cfi: locator.cfi ? locator.cfi : undefined,\n                cssSelector: locator.cssSelector ? locator.cssSelector : undefined,\n                position: (typeof locator.position !== \"undefined\") ? locator.position : undefined,\n                progression: (typeof locator.progression !== \"undefined\") ? locator.progression : undefined,\n            },\n        },\n        paginationInfo: locator.paginationInfo,\n    };\n    if (_readingLocationSaver) {\n        _readingLocationSaver(_lastSavedReadingLocation);\n    }\n\n    // // tslint:disable-next-line:no-floating-promises\n    // (async () => {\n    //     try {\n    //         const visible = await isLocatorVisible(_lastSavedReadingLocation.locator);\n    //         debug(`isLocatorVisible async: ${visible}`);\n    //     } catch (err) {\n    //         debug(err);\n    //     }\n    // })();\n};\nexport function setReadingLocationSaver(func: (locator: LocatorExtended) => void) {\n    _readingLocationSaver = func;\n}\n\nexport function readiumCssOnOff() {\n\n    if (_webview1) {\n        const payload1 = __computeReadiumCssJsonMessage(_webview1.READIUM2.link);\n        _webview1.send(R2_EVENT_READIUMCSS, payload1); // .getWebContents()\n    }\n\n    // if (_webview2) {\n    //     const payload2 = __computeReadiumCssJsonMessage(_webview2.READIUM2.link);\n    //     _webview2.send(R2_EVENT_READIUMCSS, payload2); // .getWebContents()\n    // }\n}\n\nexport async function isLocatorVisible(locator: Locator): Promise<boolean> {\n    return new Promise<boolean>((resolve, reject) => {\n        if (!_webview1) {\n            reject(\"No navigator webview?!\");\n            return;\n        }\n        if (!_webview1.READIUM2.link) {\n            reject(\"No navigator webview link?!\");\n            return;\n        }\n        if (_webview1.READIUM2.link.Href !== locator.href) {\n            debug(`isLocatorVisible FALSE: ${_webview1.READIUM2.link.Href} !== ${locator.href}`);\n            resolve(false);\n            return;\n        }\n\n        // const cb = (_event: any, payload: IEventPayload_R2_EVENT_LOCATOR_VISIBLE) => {\n        //     debug(\"R2_EVENT_LOCATOR_VISIBLE\");\n        //     debug(payload.visible);\n        // };\n        // ipcRenderer.once(R2_EVENT_LOCATOR_VISIBLE, cb);\n\n        const cb = (event: Electron.IpcMessageEvent) => {\n            if (event.channel === R2_EVENT_LOCATOR_VISIBLE) {\n                const webview = event.currentTarget as IElectronWebviewTag;\n                // const activeWebView = getActiveWebView();\n                if (webview !== _webview1) {\n                    reject(\"Wrong navigator webview?!\");\n                    return;\n                }\n                const payload_ = event.args[0] as IEventPayload_R2_EVENT_LOCATOR_VISIBLE;\n                debug(`isLocatorVisible: ${payload_.visible}`);\n                _webview1.removeEventListener(\"ipc-message\", cb);\n                resolve(payload_.visible);\n            }\n        };\n        _webview1.addEventListener(\"ipc-message\", cb);\n        const payload: IEventPayload_R2_EVENT_LOCATOR_VISIBLE = { location: locator.locations, visible: false };\n        _webview1.send(R2_EVENT_LOCATOR_VISIBLE, payload);\n    });\n}\n\nlet _webview1: IElectronWebviewTag;\n// let _webview2: IElectronWebviewTag;\n\nlet _publication: Publication | undefined;\nlet _publicationJsonUrl: string | undefined;\n\nlet _rootHtmlElement: Element | undefined;\n\nexport function handleLink(href: string, previous: boolean | undefined, useGoto: boolean) {\n\n    const special = href.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\");\n    if (special) {\n        loadLink(href, previous, useGoto);\n    } else {\n        const okay = loadLink(href, previous, useGoto);\n        if (!okay) {\n            debug(\"EXTERNAL LINK:\");\n            debug(href);\n            shell.openExternal(href);\n        }\n    }\n}\n\nexport function handleLinkUrl(href: string) {\n    handleLink(href, undefined, false);\n}\n\nexport function handleLinkLocator(location: Locator | undefined) {\n\n    // installNavigatorDOM() should have initiated the state\n    if (!_publication || !_publicationJsonUrl) {\n        return;\n    }\n\n    let linkToLoad: Link | undefined;\n    let linkToLoadGoto: LocatorLocations | undefined;\n    if (location && location.href) {\n        if (_publication.Spine && _publication.Spine.length) {\n            linkToLoad = _publication.Spine.find((spineLink) => {\n                return spineLink.Href === location.href;\n            });\n            if (linkToLoad && location.locations) {\n                linkToLoadGoto = location.locations;\n            }\n        }\n        if (!linkToLoad &&\n            _publication.Resources && _publication.Resources.length) {\n            linkToLoad = _publication.Resources.find((resLink) => {\n                return resLink.Href === location.href;\n            });\n            if (linkToLoad && location.locations) {\n                linkToLoadGoto = location.locations;\n            }\n        }\n    }\n    if (!linkToLoad) {\n        if (_publication.Spine && _publication.Spine.length) {\n            const firstLinear = _publication.Spine[0];\n            if (firstLinear) {\n                linkToLoad = firstLinear;\n            }\n        }\n    }\n\n    if (linkToLoad) {\n        const useGoto = typeof linkToLoadGoto !== \"undefined\"\n            // && typeof linkToLoadGoto.cssSelector !== \"undefined\"\n            ;\n        const uri = new URL(linkToLoad.Href, _publicationJsonUrl);\n        uri.hash = \"\";\n        uri.search = \"\";\n        const urlNoQueryParams = uri.toString(); // _publicationJsonUrl + \"/../\" + linkToLoad.Href;\n        const hrefToLoad = urlNoQueryParams +\n            ((useGoto) ? (\"?\" + URL_PARAM_GOTO + \"=\" +\n                encodeURIComponent_RFC3986(new Buffer(JSON.stringify(linkToLoadGoto, null, \"\")).toString(\"base64\"))) :\n                \"\");\n        handleLink(hrefToLoad, undefined, useGoto);\n    }\n}\n\nexport function installNavigatorDOM(\n    publication: Publication,\n    publicationJsonUrl: string,\n    rootHtmlElementID: string,\n    preloadScriptPath: string,\n    location: Locator | undefined) {\n\n    _publication = publication;\n    _publicationJsonUrl = publicationJsonUrl;\n\n    if (IS_DEV) {\n        debug(\"|||||||||||||| installNavigatorDOM: \", JSON.stringify(location));\n\n        const debugVisuals = (window.localStorage &&\n            window.localStorage.getItem(URL_PARAM_DEBUG_VISUALS) === \"true\") ? true : false;\n        debug(\"debugVisuals GET: \", debugVisuals);\n\n        (window as IElectronBrowserWindow).READIUM2 = {\n            DEBUG_VISUALS: debugVisuals,\n            publication: _publication,\n            publicationURL: _publicationJsonUrl,\n            ttsClickEnabled: false,\n        };\n\n        (window as any).READIUM2.debug = (debugVisualz: boolean) => {\n            debug(\"debugVisuals SET: \", debugVisualz);\n\n            (window as IElectronBrowserWindow).READIUM2.DEBUG_VISUALS = debugVisualz;\n            if (_webview1) {\n                _webview1.send(R2_EVENT_DEBUG_VISUALS, debugVisualz ? \"true\" : \"false\"); // .getWebContents()\n            }\n            if (window.localStorage) {\n                window.localStorage.setItem(URL_PARAM_DEBUG_VISUALS, debugVisualz ? \"true\" : \"false\");\n            }\n            setTimeout(() => {\n                const loc = getCurrentReadingLocation();\n                debug(\"|||||||||||||| getCurrentReadingLocation: \", JSON.stringify(loc));\n                if (loc) {\n                    handleLinkLocator(loc.locator);\n                }\n            }, 100);\n        };\n    }\n\n    _rootHtmlElement = document.getElementById(rootHtmlElementID) as HTMLElement;\n    if (!_rootHtmlElement) {\n        debug(\"!rootHtmlElement ???\");\n        return;\n    }\n\n    const slidingViewport = document.createElement(\"div\");\n    slidingViewport.setAttribute(\"id\", ELEMENT_ID_SLIDING_VIEWPORT);\n    slidingViewport.setAttribute(\"style\", \"display: block; position: absolute; left: 0; width: 200%; \" +\n        \"top: 0; bottom: 0; margin: 0; padding: 0; box-sizing: border-box; background: white; overflow: hidden;\");\n\n    _webview1 = createWebView(preloadScriptPath);\n    _webview1.READIUM2 = {\n        id: 1,\n        link: undefined,\n    };\n    _webview1.setAttribute(\"id\", \"webview1\");\n\n    // _webview2 = createWebView(preloadScriptPath);\n    // _webview2.READIUM2 = {\n    //     id: 2,\n    //     link: undefined,\n    // };\n    // _webview2.setAttribute(\"id\", \"webview2\");\n\n    slidingViewport.appendChild(_webview1 as Node);\n    // slidingViewport.appendChild(_webview2 as Node);\n\n    _rootHtmlElement.appendChild(slidingViewport);\n\n    // if (isRTL()) {\n    //     _webview1.classList.add(CLASS_POS_RIGHT);\n    //     _webview1.style.left = \"50%\";\n    // }\n    // else {\n    //     _webview2.classList.add(CLASS_POS_RIGHT);\n    //     _webview2.style.left = \"50%\";\n    // }\n\n    setTimeout(() => {\n        handleLinkLocator(location);\n    }, 100);\n}\n\nexport function navLeftOrRight(left: boolean) {\n    if (!_publication) {\n        return;\n    }\n    const activeWebView = getActiveWebView();\n    const rtl = isRTL();\n    const goPREVIOUS = left ? !rtl : rtl;\n    const payload: IEventPayload_R2_EVENT_PAGE_TURN = {\n        direction: rtl ? \"RTL\" : \"LTR\",\n        go: goPREVIOUS ? \"PREVIOUS\" : \"NEXT\",\n    };\n    activeWebView.send(R2_EVENT_PAGE_TURN, payload); // .getWebContents()\n}\n\nconst getActiveWebView = (): IElectronWebviewTag => {\n\n    return _webview1;\n\n    // let activeWebView: IElectronWebviewTag;\n\n    // const slidingViewport = document.getElementById(ELEMENT_ID_SLIDING_VIEWPORT) as HTMLElement;\n    // if (slidingViewport.classList.contains(CLASS_SHIFT_LEFT)) {\n    //     if (_webview1.classList.contains(CLASS_POS_RIGHT)) {\n    //         activeWebView = _webview1;\n    //     } else {\n    //         activeWebView = _webview2;\n    //     }\n    // } else {\n    //     if (_webview2.classList.contains(CLASS_POS_RIGHT)) {\n    //         activeWebView = _webview1;\n    //     } else {\n    //         activeWebView = _webview2;\n    //     }\n    // }\n\n    // return activeWebView;\n};\n\nfunction loadLink(hrefFull: string, previous: boolean | undefined, useGoto: boolean): boolean {\n\n    if (!_publication || !_publicationJsonUrl) {\n        return false;\n    }\n\n    if (hrefFull.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\")) {\n        hrefFull = convertCustomSchemeToHttpUrl(hrefFull);\n    }\n\n    const pubJsonUri = _publicationJsonUrl.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\") ?\n        convertCustomSchemeToHttpUrl(_publicationJsonUrl) : _publicationJsonUrl;\n\n    let linkPath: string | undefined;\n\n    const urlToLink = new URL(hrefFull);\n    urlToLink.hash = \"\";\n    urlToLink.search = \"\";\n    const urlPublication = new URL(pubJsonUri);\n    urlPublication.hash = \"\";\n    urlPublication.search = \"\";\n    let iBreak = -1;\n    for (let i = 0; i < urlPublication.pathname.length; i++) {\n        const c1 = urlPublication.pathname[i];\n        if (i < urlToLink.pathname.length) {\n            const c2 = urlToLink.pathname[i];\n            if (c1 !== c2) {\n                iBreak = i;\n                break;\n            }\n        } else {\n            break;\n        }\n    }\n    if (iBreak > 0) {\n        linkPath = urlToLink.pathname.substr(iBreak);\n    }\n\n    if (!linkPath) {\n        return false;\n    }\n\n    // const pubUri = new URI(pubJsonUri);\n    // // \"/pub/BASE64_PATH/manifest.json\" ==> \"/pub/BASE64_PATH/\"\n    // const pathPrefix = decodeURIComponent(pubUri.path().replace(\"manifest.json\", \"\"));\n    // // \"/pub/BASE64_PATH/epub/chapter.html\" ==> \"epub/chapter.html\"\n    // const normPath = decodeURIComponent(linkUri.normalizePath().path());\n    // const linkPath = normPath.replace(pathPrefix, \"\");\n\n    let pubLink = _publication.Spine ? _publication.Spine.find((spineLink) => {\n        return spineLink.Href === linkPath;\n    }) : undefined;\n    if (!pubLink) {\n        pubLink = _publication.Resources.find((spineLink) => {\n            return spineLink.Href === linkPath;\n        });\n    }\n\n    if (!pubLink) {\n        debug(\"FATAL WEBVIEW READIUM2_LINK ??!! \" + hrefFull + \" ==> \" + linkPath);\n        return false;\n    }\n\n    const linkUri = new URI(hrefFull);\n    linkUri.search((data: any) => {\n        // overrides existing (leaves others intact)\n\n        if (typeof previous === \"undefined\") {\n            // erase unwanted forward of query param during linking\n            data[URL_PARAM_PREVIOUS] = undefined;\n            // delete data[URL_PARAM_PREVIOUS];\n        } else {\n            data[URL_PARAM_PREVIOUS] = previous ? \"true\" : \"false\";\n        }\n\n        if (!useGoto) {\n            // erase unwanted forward of query param during linking\n            data[URL_PARAM_GOTO] = undefined;\n            // delete data[URL_PARAM_GOTO];\n        }\n    });\n    if (useGoto) {\n        linkUri.hash(\"\").normalizeHash();\n    }\n\n    // no need for encodeURIComponent_RFC3986, auto-encoded by URI class\n\n    const rcssJson = __computeReadiumCssJsonMessage(pubLink);\n    const rcssJsonstr = JSON.stringify(rcssJson, null, \"\");\n    const rcssJsonstrBase64 = new Buffer(rcssJsonstr).toString(\"base64\");\n\n    const rersJson = _epubReadingSystemNameVersion;\n    const rersJsonstr = JSON.stringify(rersJson, null, \"\");\n    const rersJsonstrBase64 = new Buffer(rersJsonstr).toString(\"base64\");\n\n    linkUri.search((data: any) => {\n        // overrides existing (leaves others intact)\n\n        // tslint:disable-next-line:no-string-literal\n        data[URL_PARAM_CSS] = rcssJsonstrBase64;\n\n        // tslint:disable-next-line:no-string-literal\n        data[URL_PARAM_EPUBREADINGSYSTEM] = rersJsonstrBase64;\n\n        // tslint:disable-next-line:no-string-literal\n        data[URL_PARAM_DEBUG_VISUALS] = (IS_DEV && (window as IElectronBrowserWindow).READIUM2.DEBUG_VISUALS) ?\n            \"true\" : \"false\";\n    });\n\n    const activeWebView = getActiveWebView();\n    const wv1AlreadyLoaded = _webview1.READIUM2.link === pubLink;\n    // const wv2AlreadyLoaded = _webview2.READIUM2.link === pubLink;\n    if (wv1AlreadyLoaded\n        // || wv2AlreadyLoaded\n        ) {\n        const goto = useGoto ? linkUri.search(true)[URL_PARAM_GOTO] as string : undefined;\n        const hash = useGoto ? undefined : linkUri.fragment(); // without #\n\n        debug(\"ALREADY LOADED: \" + pubLink.Href);\n\n        const webviewToReuse = _webview1;\n        // const webviewToReuse = wv1AlreadyLoaded ? _webview1 : _webview2;\n        // // const otherWebview = webviewToReuse === _webview2 ? _webview1 : _webview2;\n        // if (webviewToReuse !== activeWebView) {\n\n        //     debug(\"INTO VIEW ...\");\n\n        //     const slidingView = document.getElementById(ELEMENT_ID_SLIDING_VIEWPORT) as HTMLElement;\n        //     if (slidingView) {\n        //         let animate = true;\n        //         if (goto || hash) {\n        //             debug(\"DISABLE ANIM\");\n        //             animate = false;\n        //         } else if (previous) {\n        //             if (!slidingView.classList.contains(CLASS_SHIFT_LEFT)) {\n        //                 debug(\"DISABLE ANIM\");\n        //                 animate = false;\n        //             }\n        //         }\n        //         if (animate) {\n        //             if (!slidingView.classList.contains(CLASS_ANIMATED)) {\n        //                 slidingView.classList.add(CLASS_ANIMATED);\n        //                 slidingView.style.transition = \"left 500ms ease-in-out\";\n        //             }\n        //         } else {\n        //             if (slidingView.classList.contains(CLASS_ANIMATED)) {\n        //                 slidingView.classList.remove(CLASS_ANIMATED);\n        //                 slidingView.style.transition = \"none\";\n        //             }\n        //         }\n        //         if (slidingView.classList.contains(CLASS_SHIFT_LEFT)) {\n        //             slidingView.classList.remove(CLASS_SHIFT_LEFT);\n        //             slidingView.style.left = \"0\";\n\n        //             // if (_webview1.classList.contains(CLASS_POS_RIGHT)) {\n        //             //     // activeWebView === _webview1;\n        //             // } else {\n        //             //     // activeWebView === _webview2;\n        //             // }\n        //         } else {\n        //             slidingView.classList.add(CLASS_SHIFT_LEFT);\n        //             slidingView.style.left = \"-100%\";\n\n        //             // if (_webview2.classList.contains(CLASS_POS_RIGHT)) {\n        //             //     // activeWebView === _webview1;\n        //             // } else {\n        //             //     // activeWebView === _webview2;\n        //             // }\n        //         }\n        //     }\n        // }\n\n        // const msgJson = {\n        //     goto: ,\n        //     hash: ,\n        //     previous,\n        // };\n\n        const payload: IEventPayload_R2_EVENT_SCROLLTO = {\n            goto,\n            hash,\n            previous: previous ? true : false,\n        };\n\n        if (IS_DEV) {\n            const msgStr = JSON.stringify(payload);\n            debug(msgStr);\n        }\n\n        webviewToReuse.send(R2_EVENT_SCROLLTO, payload); // .getWebContents()\n\n        return true;\n    }\n\n    // if (!isFixedLayout(pubLink)) {\n    //     if (_rootHtmlElement) {\n    //         _rootHtmlElement.dispatchEvent(new Event(DOM_EVENT_HIDE_VIEWPORT));\n    //     }\n    // }\n\n    const uriStr = linkUri.toString();\n\n    if (IS_DEV) {\n        debug(\"####### >>> ---\");\n        debug(activeWebView.READIUM2.id);\n        debug(pubLink.Href);\n        debug(uriStr);\n        debug(linkUri.hash()); // with #\n        debug(linkUri.fragment()); // without #\n        // tslint:disable-next-line:no-string-literal\n        const gto = linkUri.search(true)[URL_PARAM_GOTO];\n        debug(gto ? (new Buffer(gto, \"base64\").toString(\"utf8\")) : \"\"); // decodeURIComponent\n        // tslint:disable-next-line:no-string-literal\n        debug(linkUri.search(true)[URL_PARAM_PREVIOUS]);\n        // tslint:disable-next-line:no-string-literal\n        debug(linkUri.search(true)[URL_PARAM_CSS]);\n        debug(\"####### >>> ---\");\n    }\n\n    activeWebView.READIUM2.link = pubLink;\n\n    const needConvert = _publicationJsonUrl.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\");\n    const uriStr_ = uriStr.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\") ?\n        uriStr : (needConvert ? convertHttpUrlToCustomScheme(uriStr) : uriStr);\n    if (IS_DEV) {\n        debug(\"setAttribute SRC:\");\n        debug(uriStr_);\n    }\n    activeWebView.setAttribute(\"src\", uriStr_);\n    // activeWebView.getWebContents().loadURL(uriStr_, { extraHeaders: \"pragma: no-cache\\n\" });\n    // activeWebView.loadURL(uriStr_, { extraHeaders: \"pragma: no-cache\\n\" });\n\n    // ALWAYS FALSE => let's comment for now...\n    // const enableOffScreenRenderPreload = false;\n    // if (enableOffScreenRenderPreload) {\n    //     setTimeout(() => {\n    //         if (!_publication || !pubLink) {\n    //             return;\n    //         }\n\n    //         const otherWebview = activeWebView === _webview2 ? _webview1 : _webview2;\n\n    //         // let inSpine = true;\n    //         const index = _publication.Spine.indexOf(pubLink);\n    //         // if (!index) {\n    //         //     inSpine = false;\n    //         //     index = _publication.Resources.indexOf(pubLink);\n    //         // }\n    //         if (index >= 0 &&\n    //             previous && (index - 1) >= 0 ||\n    //             !previous && (index + 1) < _publication.Spine.length\n    //             // (index + 1) < (inSpine ? _publication.Spine.length : _publication.Resources.length)\n    //         ) {\n    //             const nextPubLink = _publication.Spine[previous ? (index - 1) : (index + 1)];\n    //             // (inSpine ? _publication.Spine[index + 1] : _publication.Resources[index + 1]);\n\n    //             if (otherWebview.READIUM2.link !== nextPubLink) {\n    //                 const linkUriNext = new URI(_publicationJsonUrl + \"/../\" + nextPubLink.Href);\n    //                 linkUriNext.normalizePath();\n    //                 linkUriNext.search((data: any) => {\n    //                     // overrides existing (leaves others intact)\n\n    //                     // tslint:disable-next-line:no-string-literal\n    //                     data[URL_PARAM_CSS] = rcssJsonstrBase64;\n    //                 });\n    //                 const uriStrNext = linkUriNext.toString();\n\n    //                 debug(\"####### ======\");\n    //                 debug(otherWebview.READIUM2.id);\n    //                 debug(nextPubLink.Href);\n    //                 debug(linkUriNext.hash()); // with #\n    //                 debug(linkUriNext.fragment()); // without #\n    //                 // tslint:disable-next-line:no-string-literal\n    //                 debug(linkUriNext.search(true)[URL_PARAM_GOTO]);\n    //                 // tslint:disable-next-line:no-string-literal\n    //                 debug(linkUriNext.search(true)[URL_PARAM_PREVIOUS]);\n    //                 debug(\"####### ======\");\n    //                 otherWebview.READIUM2.link = nextPubLink;\n    //                 otherWebview.setAttribute(\"src\", uriStrNext);\n    //             }\n    //         }\n    //     }, 300);\n    // }\n\n    return true;\n}\n\nfunction createWebView(preloadScriptPath: string): IElectronWebviewTag {\n\n    // Unfortunately the Chromium web inspector crashes when closing preload :(\n    // Also, the debugger fails to open the sourcemaps (maybe related issue?)\n    // process.stderr.write(\"\\n####\\n\" + preloadScriptPath + \"\\n####\\n\");\n    // TODO: what are the critical features needed from Node context\n    // that justify using webview.preload? Can we instead use regular DOM code?\n    // The ReadiumCSS injection is now streamer-based (best performance / timing)\n    // and we can use postMessage instead of Electron IPC.\n    // Also, preload really does most of its processing once DOM-ready.\n    // Perhaps the main problem would be exposing the internal logic of navigator\n    // into EPUB content documents? (preload is good for isolating app code)\n\n    const wv = document.createElement(\"webview\");\n    // tslint:disable-next-line:max-line-length\n    // https://github.com/electron/electron/blob/master/docs/tutorial/security.md#3-enable-context-isolation-for-remote-content\n    wv.setAttribute(\"webpreferences\",\n        \"nodeIntegration=0, nodeIntegrationInWorker=0, sandbox=0, javascript=1, \" +\n        \"contextIsolation=0, webSecurity=1, allowRunningInsecureContent=0\");\n    wv.setAttribute(\"partition\", R2_SESSION_WEBVIEW);\n    if (_publicationJsonUrl) {\n        // const ref = _publicationJsonUrl.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\") ?\n        //     _publicationJsonUrl : convertHttpUrlToCustomScheme(_publicationJsonUrl);\n        wv.setAttribute(\"httpreferrer\", _publicationJsonUrl);\n    }\n    wv.setAttribute(\"style\", \"display: flex; margin: 0; padding: 0; box-sizing: border-box; \" +\n        \"position: absolute; left: 0; width: 50%; bottom: 0; top: 0;\");\n    wv.setAttribute(\"preload\", preloadScriptPath); // \"file://\"\n\n    // https://github.com/electron/electron/blob/v3.0.0/docs/api/breaking-changes.md#webview\n    if (ENABLE_WEBVIEW_RESIZE) {\n        wv.setAttribute(\"disableguestresize\", \"\");\n    }\n\n    setTimeout(() => {\n        wv.removeAttribute(\"tabindex\");\n    }, 500);\n\n    wv.addEventListener(\"dom-ready\", () => {\n        // https://github.com/electron/electron/blob/v3.0.0/docs/api/breaking-changes.md#webcontents\n        // wc.openDevTools({ mode: \"detach\" });\n        wv.clearHistory();\n\n        if ((window as IElectronBrowserWindow).READIUM2) {\n            ttsClickEnable((window as IElectronBrowserWindow).READIUM2.ttsClickEnabled);\n        }\n    });\n\n    wv.addEventListener(\"ipc-message\", (event: Electron.IpcMessageEvent) => {\n        const webview = event.currentTarget as IElectronWebviewTag;\n        const activeWebView = getActiveWebView();\n        if (webview !== activeWebView) {\n            return;\n        }\n\n        if (event.channel === R2_EVENT_LINK) {\n            debug(\"R2_EVENT_LINK (webview.addEventListener('ipc-message')\");\n            const payload = event.args[0] as IEventPayload_R2_EVENT_LINK;\n            handleLinkUrl(payload.url);\n        } else if (event.channel === R2_EVENT_WEBVIEW_READY) {\n            const payload = event.args[0] as IEventPayload_R2_EVENT_WEBVIEW_READY;\n            debug(\"WEBVIEW READY: \" + payload.href);\n\n            // if (_rootHtmlElement) {\n            //     _rootHtmlElement.dispatchEvent(new Event(DOM_EVENT_SHOW_VIEWPORT));\n            // }\n        } else if (event.channel === R2_EVENT_READING_LOCATION) {\n            const payload = event.args[0] as IEventPayload_R2_EVENT_READING_LOCATION;\n            if (webview.READIUM2.link && _saveReadingLocation) {\n                // TODO: position metrics, based on arbitrary number of characters (1034)\n                // https://github.com/readium/architecture/tree/master/positions\n                // https://github.com/readium/architecture/tree/master/locators#about-the-notion-of-position\n                // https://github.com/readium/architecture/blob/master/locators/locator-api.md\n                // if (typeof payload.progression !== \"undefined\" && _publication && webview.READIUM2.link) {\n                //     const totalPositions = _publication.getTotalPositions(webview.READIUM2.link);\n                //     if (totalPositions) {\n                //         payload.position = totalPositions * payload.progression;\n                //         const totalSpinePositions = _publication.getTotalSpinePositions();\n                //         if (totalSpinePositions) {\n                //             payload.globalProgression = payload.position / totalSpinePositions;\n                //         }\n                //     }\n                // }\n                _saveReadingLocation(webview.READIUM2.link.Href, payload);\n            }\n        } else if (event.channel === R2_EVENT_PAGE_TURN_RES) {\n            if (!_publication) {\n                return;\n            }\n\n            const payload = event.args[0] as IEventPayload_R2_EVENT_PAGE_TURN;\n\n            const goPREVIOUS = payload.go === \"PREVIOUS\"; // any other value is NEXT\n\n            if (!webview.READIUM2.link) {\n                debug(\"WEBVIEW READIUM2_LINK ??!!\");\n                return;\n            }\n\n            let nextOrPreviousSpineItem: Link | undefined;\n            if (_publication.Spine) {\n                for (let i = 0; i < _publication.Spine.length; i++) {\n                    if (_publication.Spine[i] === webview.READIUM2.link) {\n                        if (goPREVIOUS && (i - 1) >= 0) {\n                            nextOrPreviousSpineItem = _publication.Spine[i - 1];\n                        } else if (!goPREVIOUS && (i + 1) < _publication.Spine.length) {\n                            nextOrPreviousSpineItem = _publication.Spine[i + 1];\n                        }\n                        break;\n                    }\n                }\n            }\n            if (!nextOrPreviousSpineItem) {\n                return;\n            }\n            if (_publicationJsonUrl) {\n                const uri = new URL(nextOrPreviousSpineItem.Href, _publicationJsonUrl);\n                uri.hash = \"\";\n                uri.search = \"\";\n                const urlNoQueryParams = uri.toString(); // _publicationJsonUrl + \"/../\" + nextOrPreviousSpineItem.Href;\n                handleLink(urlNoQueryParams, goPREVIOUS, false);\n            }\n        } else if (event.channel === R2_EVENT_TTS_IS_PAUSED) {\n            if (_ttsListener) {\n                _ttsListener(TTSStateEnum.PAUSED);\n            }\n        } else if (event.channel === R2_EVENT_TTS_IS_STOPPED) {\n            if (_ttsListener) {\n                _ttsListener(TTSStateEnum.STOPPED);\n            }\n        } else if (event.channel === R2_EVENT_TTS_IS_PLAYING) {\n            if (_ttsListener) {\n                _ttsListener(TTSStateEnum.PLAYING);\n            }\n        } else {\n            debug(\"webview1 ipc-message\");\n            debug(event.channel);\n        }\n    });\n\n    return wv as IElectronWebviewTag;\n}\nif (ENABLE_WEBVIEW_RESIZE) {\n    // https://github.com/electron/electron/blob/v3.0.0/docs/api/breaking-changes.md#webcontents\n    // https://github.com/electron/electron/blob/v3.0.0/docs/api/breaking-changes.md#webview\n    // wv.setAttribute(\"disableguestresize\", \"\");\n    const adjustResize = (webview: IElectronWebviewTag) => {\n        // https://javascript.info/size-and-scroll\n        // offsetW/H: excludes margin, includes border, scrollbar, padding.\n        // clientW/H: excludes margin, border, scrollbar, includes padding.\n        // scrollW/H: like client, but includes hidden (overflow) areas\n        const width = webview.clientWidth;\n        const height = webview.clientHeight;\n        const wc = webview.getWebContents();\n        if (wc && (wc as any).setSize && width && height) {\n            (wc as any).setSize({ // wc is WebContents, works in Electron < 3.0\n                normal: {\n                    height,\n                    width,\n                },\n            });\n        }\n    };\n    const onResizeDebounced = debounce(() => {\n        adjustResize(_webview1);\n        // adjustResize(_webview2);\n\n        // setTimeout(() => {\n        //     if (_rootHtmlElement) {\n        //         _rootHtmlElement.dispatchEvent(new Event(DOM_EVENT_SHOW_VIEWPORT));\n        //     }\n        // }, 1000);\n    }, 200);\n    window.addEventListener(\"resize\", () => {\n        // if (!isFixedLayout(_webview1.READIUM2.link)) {\n        //     if (_rootHtmlElement) {\n        //         _rootHtmlElement.dispatchEvent(new Event(DOM_EVENT_HIDE_VIEWPORT));\n        //     }\n        // }\n        onResizeDebounced();\n    });\n}\n\n// see webview.addEventListener(\"ipc-message\", ...)\n// needed for main process browserWindow.webContents.send()\nipcRenderer.on(R2_EVENT_LINK, (_event: any, payload: IEventPayload_R2_EVENT_LINK) => {\n    debug(\"R2_EVENT_LINK (ipcRenderer.on)\");\n    debug(payload.url);\n    handleLinkUrl(payload.url);\n});\n\nexport function ttsPlay() {\n    const activeWebView = getActiveWebView();\n    if (!activeWebView) {\n        return;\n    }\n\n    let startElementCSSSelector: string | undefined;\n    if (_lastSavedReadingLocation && activeWebView.READIUM2 && activeWebView.READIUM2.link) {\n        if (_lastSavedReadingLocation.locator.href === activeWebView.READIUM2.link.Href) {\n            startElementCSSSelector = _lastSavedReadingLocation.locator.locations.cssSelector;\n        }\n    }\n\n    const payload: IEventPayload_R2_EVENT_TTS_DO_PLAY = {\n        rootElement: \"html > body\", // window.document.body\n        startElement: startElementCSSSelector,\n    };\n    activeWebView.send(R2_EVENT_TTS_DO_PLAY, payload);\n}\n\nexport function ttsPause() {\n    const activeWebView = getActiveWebView();\n    if (!activeWebView) {\n        return;\n    }\n    activeWebView.send(R2_EVENT_TTS_DO_PAUSE);\n}\nexport function ttsStop() {\n    const activeWebView = getActiveWebView();\n    if (!activeWebView) {\n        return;\n    }\n    activeWebView.send(R2_EVENT_TTS_DO_STOP);\n}\nexport function ttsResume() {\n    const activeWebView = getActiveWebView();\n    if (!activeWebView) {\n        return;\n    }\n    activeWebView.send(R2_EVENT_TTS_DO_RESUME);\n}\nexport function ttsPrevious() {\n    const activeWebView = getActiveWebView();\n    if (!activeWebView) {\n        return;\n    }\n    activeWebView.send(R2_EVENT_TTS_DO_PREVIOUS);\n}\nexport function ttsNext() {\n    const activeWebView = getActiveWebView();\n    if (!activeWebView) {\n        return;\n    }\n    activeWebView.send(R2_EVENT_TTS_DO_NEXT);\n}\n\nexport enum TTSStateEnum {\n    PAUSED = \"PAUSED\",\n    PLAYING = \"PLAYING\",\n    STOPPED = \"STOPPED\",\n}\nlet _ttsListener: (ttsState: TTSStateEnum) => void | undefined;\nexport function ttsListen(ttsListener: (ttsState: TTSStateEnum) => void) {\n    _ttsListener = ttsListener;\n}\n\nexport function ttsClickEnable(doEnable: boolean) {\n\n    if ((window as IElectronBrowserWindow).READIUM2) {\n        (window as IElectronBrowserWindow).READIUM2.ttsClickEnabled = doEnable;\n    }\n\n    const activeWebView = getActiveWebView();\n    if (!activeWebView) {\n        return;\n    }\n\n    const payload: IEventPayload_R2_EVENT_TTS_CLICK_ENABLE = {\n        doEnable,\n    };\n    activeWebView.send(R2_EVENT_TTS_CLICK_ENABLE, payload);\n}\n"]}