{"version":3,"file":"media-overlays.js","sourceRoot":"","sources":["../../../../../src/electron/renderer/media-overlays.ts"],"names":[],"mappings":"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","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport * as debug_ from \"debug\";\nimport * as util from \"util\";\n\nimport { TaJsonDeserialize } from \"@r2-lcp-js/serializable\";\nimport { MediaOverlayNode } from \"@r2-shared-js/models/media-overlay\";\nimport { Publication } from \"@r2-shared-js/models/publication\";\nimport { Link } from \"@r2-shared-js/models/publication-link\";\n\nimport { DEBUG_AUDIO } from \"../common/audiobook\";\nimport {\n    IEventPayload_R2_EVENT_MEDIA_OVERLAY_CLICK, IEventPayload_R2_EVENT_MEDIA_OVERLAY_HIGHLIGHT,\n    IEventPayload_R2_EVENT_MEDIA_OVERLAY_STARTSTOP, R2_EVENT_MEDIA_OVERLAY_CLICK,\n    R2_EVENT_MEDIA_OVERLAY_HIGHLIGHT, R2_EVENT_MEDIA_OVERLAY_STARTSTOP,\n} from \"../common/events\";\nimport { READIUM2_ELECTRON_HTTP_PROTOCOL, convertCustomSchemeToHttpUrl } from \"../common/sessions\";\nimport { handleLinkUrl, navLeftOrRight } from \"./location\";\nimport { isRTL } from \"./readium-css\";\nimport { IReadiumElectronBrowserWindow, IReadiumElectronWebview } from \"./webview/state\";\n\nconst debug = debug_(\"r2:navigator#electron/renderer/media-overlays\");\n\nconst IS_DEV = process.env.NODE_ENV === \"development\" || process.env.NODE_ENV === \"dev\";\n\nconst win = window as IReadiumElectronBrowserWindow;\n\nconst AUDIO_MO_ID = \"R2_AUDIO_MO_ID\";\n\nexport function publicationHasMediaOverlays(publication: Publication) {\n    if (publication.Spine) {\n        const firstMoLink = publication.Spine.find((link) => {\n            if (link.Properties?.MediaOverlay) {\n                return true;\n            }\n            if (link.Alternate) {\n                for (const altLink of link.Alternate) {\n                    if (altLink.TypeLink === \"application/vnd.syncnarr+json\") {\n                        return true;\n                    }\n                }\n            }\n            return false;\n        });\n        if (firstMoLink) {\n            return true;\n        }\n    }\n    return false;\n}\n\nlet _captionsMode = false;\n\nlet _mediaOverlaysClickEnabled = false;\nlet _mediaOverlaysPlaybackRate = 1;\n\n// URL without t=begin,end media fragment! (pure audio reference)\nlet _currentAudioUrl: string | undefined;\nlet _previousAudioUrl: string | undefined;\n\nlet _currentAudioBegin: number | undefined;\n// let _previousAudioBegin: number | undefined;\n\nlet _currentAudioEnd: number | undefined;\nlet _previousAudioEnd: number | undefined;\n\nlet _currentAudioElement: HTMLAudioElement | undefined;\n\nlet _mediaOverlayRoot: MediaOverlayNode | undefined;\nlet _mediaOverlayTextAudioPair: MediaOverlayNode | undefined;\nlet _mediaOverlayTextId: string | undefined;\nlet _mediaOverlayTextHref: string | undefined;\n\nlet _mediaOverlayActive = false;\n\nasync function playMediaOverlays(\n    textHref: string,\n    rootMo: MediaOverlayNode,\n    textFragmentIDChain: Array<string | null> | undefined) {\n\n    if (IS_DEV) {\n        debug(\"playMediaOverlays()\");\n    }\n\n    let textFragmentIDChain_ = textFragmentIDChain ? textFragmentIDChain.filter((id) => id) : undefined;\n    if (textFragmentIDChain_ && textFragmentIDChain_.length === 0) {\n        textFragmentIDChain_ = undefined;\n    }\n\n    let moTextAudioPair = findDepthFirstTextAudioPair(textHref, rootMo, textFragmentIDChain_);\n    if (!moTextAudioPair && textFragmentIDChain_) {\n        if (IS_DEV) {\n            debug(\"playMediaOverlays() - findDepthFirstTextAudioPair() SECOND CHANCE \");\n            debug(JSON.stringify(textFragmentIDChain_, null, 4));\n            debug(JSON.stringify(rootMo, null, 4));\n        }\n        moTextAudioPair = findDepthFirstTextAudioPair(textHref, rootMo, undefined);\n    }\n    if (moTextAudioPair) {\n        if (moTextAudioPair.Audio) {\n            if (IS_DEV) {\n                debug(\"playMediaOverlays() - playMediaOverlaysAudio()\");\n            }\n            _mediaOverlayRoot = rootMo;\n            await playMediaOverlaysAudio(moTextAudioPair, undefined, undefined);\n            if (_mediaOverlaysListener) {\n                _mediaOverlaysListener(MediaOverlaysStateEnum.PLAYING);\n            }\n        }\n    } else {\n        if (IS_DEV) {\n            debug(\"playMediaOverlays() - !moTextAudioPair \" + textHref);\n        }\n    }\n}\n\nconst ontimeupdate = async (ev: Event) => {\n    const currentAudioElement = ev.currentTarget as HTMLAudioElement;\n    if (_currentAudioEnd && currentAudioElement.currentTime >= (_currentAudioEnd - 0.05)) {\n\n        if (IS_DEV) {\n            debug(\"ontimeupdate - mediaOverlaysNext()\");\n        }\n        mediaOverlaysNext();\n    }\n};\nconst ensureOnTimeUpdate = (remove: boolean) => {\n    if (_currentAudioElement) {\n        if (remove) {\n            if ((_currentAudioElement as any).__ontimeupdate) {\n                (_currentAudioElement as any).__ontimeupdate = false;\n                _currentAudioElement.removeEventListener(\"timeupdate\", ontimeupdate);\n            }\n        } else {\n            if (!(_currentAudioElement as any).__ontimeupdate) {\n                (_currentAudioElement as any).__ontimeupdate = true;\n                _currentAudioElement.addEventListener(\"timeupdate\", ontimeupdate);\n            }\n        }\n    }\n};\n\nasync function playMediaOverlaysAudio(\n    moTextAudioPair: MediaOverlayNode,\n    begin: number | undefined,\n    end: number | undefined) {\n\n    if (IS_DEV) {\n        debug(\"playMediaOverlaysAudio()\");\n    }\n\n    ensureKillAutoNextTimeout();\n    _mediaOverlayActive = true;\n\n    _mediaOverlayTextAudioPair = moTextAudioPair;\n    _mediaOverlayTextId = undefined;\n\n    moHighlight_(moTextAudioPair);\n\n    if (!moTextAudioPair.Audio) {\n        return; // TODO TTS\n    }\n\n    let publicationURL = win.READIUM2.publicationURL;\n    if (publicationURL.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\")) {\n        publicationURL = convertCustomSchemeToHttpUrl(publicationURL);\n    }\n\n    // const url = publicationURL + \"/../\" + moTextAudioPair.Audio;\n    const urlObjFull = new URL(moTextAudioPair.Audio, publicationURL);\n    const urlFull = urlObjFull.toString();\n\n    const urlObjNoQuery = new URL(urlFull);\n    urlObjNoQuery.hash = \"\";\n    urlObjNoQuery.search = \"\";\n    const urlNoQuery = urlObjNoQuery.toString();\n\n    const hasBegin = typeof begin !== \"undefined\";\n    const hasEnd = typeof end !== \"undefined\";\n\n    // _previousAudioBegin = _currentAudioBegin;\n    _previousAudioEnd = _currentAudioEnd;\n\n    _currentAudioBegin = undefined;\n    _currentAudioEnd = undefined;\n\n    if (!hasBegin && !hasEnd) {\n        if (urlObjFull.hash) {\n            const matches = urlObjFull.hash.match(/t=([0-9\\.]+)(,([0-9\\.]+))?/);\n            if (matches && matches.length >= 1) {\n                const b = matches[1];\n                try {\n                    _currentAudioBegin = parseFloat(b);\n                } catch (err) {\n                    debug(err);\n                }\n                if (matches.length >= 3) {\n                    const e = matches[3];\n                    try {\n                        _currentAudioEnd = parseFloat(e);\n                    } catch (err) {\n                        debug(err);\n                    }\n                }\n            }\n        }\n    } else {\n        // const mediaFragmentUrl = `${urlNoQuery}${`t=${hasBegin ? begin : \"\"}${hasEnd ? `,${end}` : \"\"}`}`;\n        _currentAudioBegin = begin;\n        _currentAudioEnd = end;\n    }\n    if (IS_DEV) {\n        debug(`${urlFull} => [${_currentAudioBegin}-${_currentAudioEnd}]`);\n    }\n\n    const playClip = async (initial: boolean) => {\n        if (!_currentAudioElement) {\n            return;\n        }\n\n        const timeToSeekTo = _currentAudioBegin ? _currentAudioBegin : 0;\n\n        if (initial || _currentAudioElement.paused) {\n            if ((initial && !timeToSeekTo) ||\n                _currentAudioElement.currentTime === timeToSeekTo) {\n\n                if (IS_DEV) {\n                    debug(\"playMediaOverlaysAudio() - playClip() - _currentAudioElement.play()\");\n                }\n                ensureOnTimeUpdate(false);\n                _currentAudioElement.playbackRate = _mediaOverlaysPlaybackRate;\n                await _currentAudioElement.play();\n\n                // if (_mediaOverlaysListener) {\n                //     _mediaOverlaysListener(MediaOverlaysStateEnum.PLAYING);\n                // }\n            } else {\n                if (IS_DEV) {\n                    debug(\"playMediaOverlaysAudio() - playClip() - ontimeupdateSeeked\");\n                }\n                const ontimeupdateSeeked = async (ev: Event) => {\n                    const currentAudioElement = ev.currentTarget as HTMLAudioElement;\n                    currentAudioElement.removeEventListener(\"timeupdate\", ontimeupdateSeeked);\n\n                    if (IS_DEV) {\n                        debug(\"playMediaOverlaysAudio() - playClip() - ontimeupdateSeeked - .play()\");\n                    }\n                    ensureOnTimeUpdate(false);\n                    if (_currentAudioElement) {\n                        _currentAudioElement.playbackRate = _mediaOverlaysPlaybackRate;\n                        await _currentAudioElement.play();\n                    }\n                    // if (_mediaOverlaysListener) {\n                    //     _mediaOverlaysListener(MediaOverlaysStateEnum.PLAYING);\n                    // }\n                };\n                _currentAudioElement.addEventListener(\"timeupdate\", ontimeupdateSeeked);\n                _currentAudioElement.currentTime = timeToSeekTo;\n            }\n        } else {\n            const contiguous =\n                _previousAudioUrl === _currentAudioUrl &&\n                typeof _previousAudioEnd !== \"undefined\" &&\n                _previousAudioEnd > (timeToSeekTo - 0.02) &&\n                _previousAudioEnd <= timeToSeekTo &&\n                _currentAudioElement.currentTime >= (timeToSeekTo - 0.1);\n                // _currentAudioElement.currentTime <= (timeToSeekTo + 0.5)\n            ensureOnTimeUpdate(false);\n            if (contiguous) {\n                if (IS_DEV) {\n                    debug(\"playMediaOverlaysAudio() - playClip() - ensureOnTimeUpdate\");\n                }\n            } else {\n                if (IS_DEV) {\n                    debug(\"playMediaOverlaysAudio() - playClip() - currentTime = timeToSeekTo\");\n                }\n                _currentAudioElement.currentTime = timeToSeekTo;\n            }\n        }\n    };\n\n    _previousAudioUrl = _currentAudioUrl;\n    if (!_currentAudioUrl || urlNoQuery !== _currentAudioUrl) {\n        _currentAudioUrl = urlNoQuery;\n        if (IS_DEV) {\n            debug(\"playMediaOverlaysAudio() - RESET: \" + _previousAudioUrl + \" => \" + _currentAudioUrl);\n        }\n\n        // _currentAudioElement = document.getElementById(AUDIO_MO_ID) as HTMLAudioElement;\n        ensureOnTimeUpdate(true);\n        if (_currentAudioElement) {\n            _currentAudioElement.pause();\n            _currentAudioElement.setAttribute(\"src\", \"\");\n            if (_currentAudioElement.parentNode) {\n                _currentAudioElement.parentNode.removeChild(_currentAudioElement);\n            }\n        }\n        _currentAudioElement = document.createElement(\"audio\"); // no controls => should be invisible\n        _currentAudioElement.setAttribute(\"style\", \"display: none\");\n        _currentAudioElement.setAttribute(\"id\", AUDIO_MO_ID);\n        // _currentAudioElement.setAttribute(\"loop\", \"loop\");\n        // _currentAudioElement.setAttribute(\"autoplay\", \"autoplay\");\n        _currentAudioElement.setAttribute(\"role\", \"media-overlays\");\n        document.body.appendChild(_currentAudioElement);\n\n        _currentAudioElement.addEventListener(\"error\", (ev) => {\n            debug(\"-1) error: \" +\n            (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n            + (ev.currentTarget as HTMLAudioElement).src.substr((ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n\n            if (_currentAudioElement && _currentAudioElement.error) {\n                // 1 === MEDIA_ERR_ABORTED\n                // 2 === MEDIA_ERR_NETWORK\n                // 3 === MEDIA_ERR_DECODE\n                // 4 === MEDIA_ERR_SRC_NOT_SUPPORTED\n                debug(_currentAudioElement.error.code);\n                debug(_currentAudioElement.error.message);\n            }\n        });\n\n        if (IS_DEV) {\n            _currentAudioElement.addEventListener(\"load\", (ev) => {\n                debug(\"0) load: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n\n            _currentAudioElement.addEventListener(\"loadstart\", (ev) => {\n                debug(\"1) loadstart: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n\n            _currentAudioElement.addEventListener(\"durationchange\", (ev) => {\n                debug(\"2) durationchange: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n\n            _currentAudioElement.addEventListener(\"loadedmetadata\", (ev) => {\n                debug(\"3) loadedmetadata: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n\n            _currentAudioElement.addEventListener(\"loadeddata\", (ev) => {\n                debug(\"4) loadeddata: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n\n            _currentAudioElement.addEventListener(\"progress\", (ev) => {\n                debug(\"5) progress: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n\n            _currentAudioElement.addEventListener(\"canplay\", (ev) => {\n                debug(\"6) canplay: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n\n            _currentAudioElement.addEventListener(\"canplaythrough\", (ev) => {\n                debug(\"7) canplaythrough: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n\n            _currentAudioElement.addEventListener(\"play\", (ev) => {\n                debug(\"8) play: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n\n            _currentAudioElement.addEventListener(\"pause\", (ev) => {\n                debug(\"9) pause: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n\n            _currentAudioElement.addEventListener(\"ended\", (ev) => {\n                debug(\"10) ended: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n\n            _currentAudioElement.addEventListener(\"seeked\", (ev) => {\n                debug(\"11) seeked: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n\n            if (DEBUG_AUDIO) {\n                _currentAudioElement.addEventListener(\"timeupdate\", (ev) => {\n                    debug(\"12) timeupdate: \" +\n                    (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                    + (ev.currentTarget as HTMLAudioElement).src.substr(\n                        (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n                });\n            }\n\n            _currentAudioElement.addEventListener(\"seeking\", (ev) => {\n                debug(\"13) seeking: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n\n            _currentAudioElement.addEventListener(\"waiting\", (ev) => {\n                debug(\"14) waiting: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n\n            _currentAudioElement.addEventListener(\"volumechange\", (ev) => {\n                debug(\"15) volumechange: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n\n            _currentAudioElement.addEventListener(\"suspend\", (ev) => {\n                debug(\"16) suspend: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n\n            _currentAudioElement.addEventListener(\"stalled\", (ev) => {\n                debug(\"17) stalled: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n\n            _currentAudioElement.addEventListener(\"ratechange\", (ev) => {\n                debug(\"18) ratechange: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n\n            _currentAudioElement.addEventListener(\"playing\", (ev) => {\n                debug(\"19) playing: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n\n            _currentAudioElement.addEventListener(\"interruptend\", (ev) => {\n                debug(\"20) interruptend: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n\n            _currentAudioElement.addEventListener(\"interruptbegin\", (ev) => {\n                debug(\"21) interruptbegin: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n\n            _currentAudioElement.addEventListener(\"emptied\", (ev) => {\n                debug(\"22) emptied: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n\n            _currentAudioElement.addEventListener(\"abort\", (ev) => {\n                debug(\"23) abort: \" +\n                (_currentAudioUrl !== (ev.currentTarget as HTMLAudioElement).src ? (_currentAudioUrl + \" -- \") : \"\")\n                + (ev.currentTarget as HTMLAudioElement).src.substr(\n                    (ev.currentTarget as HTMLAudioElement).src.lastIndexOf(\"/\")));\n            });\n        }\n\n        const oncanplaythrough = async (ev: Event) => {\n            const currentAudioElement = ev.currentTarget as HTMLAudioElement;\n            currentAudioElement.removeEventListener(\"canplaythrough\", oncanplaythrough);\n            debug(\"oncanplaythrough\");\n            await playClip(true);\n        };\n        _currentAudioElement.addEventListener(\"canplaythrough\", oncanplaythrough);\n\n        const onpause = async (_ev: Event) => {\n            debug(\"onpause\");\n            // if (_mediaOverlaysListener) {\n            //     _mediaOverlaysListener(MediaOverlaysStateEnum.PAUSED);\n            // }\n        };\n        _currentAudioElement.addEventListener(\"pause\", onpause);\n\n        const onplay = async (_ev: Event) => {\n            debug(\"onplay\");\n            // if (_mediaOverlaysListener) {\n            //     _mediaOverlaysListener(MediaOverlaysStateEnum.PLAYING);\n            // }\n        };\n        _currentAudioElement.addEventListener(\"play\", onplay);\n\n        _currentAudioElement.playbackRate = _mediaOverlaysPlaybackRate;\n        _currentAudioElement.setAttribute(\"src\", _currentAudioUrl);\n    } else {\n        if (IS_DEV) {\n            debug(\"playMediaOverlaysAudio() - playClip()\");\n        }\n        await playClip(false);\n    }\n}\n\n// https://www.w3.org/publishing/epub3/epub-mediaoverlays.html#sec-skippability\n// https://idpf.github.io/epub-vocabs/structure/\nconst _skippables = [\n    \"footnote\",\n    \"endnote\",\n    \"pagebreak\",\n    //\n    \"note\",\n    \"rearnote\",\n    \"sidebar\",\n    \"marginalia\",\n    \"annotation\",\n    // \"practice\",\n    // \"help\",\n];\nfunction isSkippable(mo: MediaOverlayNode): boolean {\n    return mo.Role && mo.Role.findIndex((r) => {\n        return _skippables.includes(r);\n    }) >= 0;\n}\n\n// https://www.w3.org/publishing/epub3/epub-mediaoverlays.html#sec-escabaility\n// const _escapables = [\n//     \"table\",\n//     \"table-row\",\n//     \"table-cell\",\n//     \"list\",\n//     \"list-item\",\n//     \"figure\",\n//     //\n//     \"footnote\",\n//     \"endnote\",\n//     \"note\",\n//     \"rearnote\",\n//     \"footnotes\",\n//     \"rearnotes\",\n//     \"sidebar\",\n//     \"bibliography\",\n//     \"toc\",\n//     \"loi\",\n//     \"appendix\",\n//     \"landmarks\",\n//     \"lot\",\n//     \"index\",\n//     \"colophon\",\n//     \"epigraph\",\n//     \"conclusion\",\n//     \"afterword\",\n//     \"warning\",\n//     \"epilogue\",\n//     \"foreword\",\n//     \"introduction\",\n//     \"prologue\",\n//     \"preface\",\n//     \"preamble\",\n//     \"notice\",\n//     \"errata\",\n//     \"copyright-page\",\n//     \"acknowledgments\",\n//     \"other-credits\",\n//     \"titlepage\",\n//     \"imprimatur\",\n//     \"contributors\",\n//     \"halftitlepage\",\n//     \"dedication\",\n//     \"help\",\n//     \"annotation\",\n//     \"marginalia\",\n//     \"practice\",\n//     \"bridgehead\",\n//     \"page-list\",\n//     \"glossary\",\n// ];\n// function isEscapable(mo: MediaOverlayNode): boolean {\n//     return mo.Role && mo.Role.findIndex((r) => {\n//         return _escapables.includes(r);\n//     }) >= 0;\n// }\n\nfunction findNextTextAudioPair(\n    mo: MediaOverlayNode,\n    moToMatch: MediaOverlayNode,\n    previousMo: {prev: MediaOverlayNode | undefined},\n    escape: boolean):\n    MediaOverlayNode | undefined | null { // returns null when skipped\n\n    if (DEBUG_AUDIO) {\n        debug(\"findNextTextAudioPair()\");\n        debug(JSON.stringify(moToMatch));\n        debug(JSON.stringify(previousMo.prev));\n    }\n    const isSkip = _mediaOverlaySkippabilityIsEnabled && isSkippable(mo);\n    if (isSkip) {\n        if (DEBUG_AUDIO) {\n            debug(\"findNextTextAudioPair() - isSkippable\");\n            debug(JSON.stringify(mo));\n        }\n        return null;\n    }\n\n    if (!mo.Children || !mo.Children.length) { // leaf === text/audio pair (SMIL par)\n        if (DEBUG_AUDIO) {\n            debug(\"findNextTextAudioPair() - leaf text/audio pair\");\n            debug(JSON.stringify(mo));\n        }\n        if (previousMo.prev === moToMatch\n            // && (!escape || !isEscapable(mo))\n            ) {\n\n            if (DEBUG_AUDIO) {\n                debug(\"findNextTextAudioPair() - prevMo === moToMatch\");\n            }\n            return mo;\n        }\n        if (!_mediaOverlaySkippabilityIsEnabled || !isSkippable(mo)) {\n            if (DEBUG_AUDIO) {\n                debug(\"findNextTextAudioPair() - set previous\");\n                debug(JSON.stringify(mo));\n            }\n            previousMo.prev = mo;\n        }\n        return undefined;\n    }\n    for (const child of mo.Children) {\n        if (DEBUG_AUDIO) {\n            debug(\"findNextTextAudioPair() - child\");\n            debug(JSON.stringify(child));\n        }\n        const match = findNextTextAudioPair(child, moToMatch, previousMo, escape);\n        if (match) {\n            if (DEBUG_AUDIO) {\n                debug(\"findNextTextAudioPair() - match\");\n                debug(JSON.stringify(match));\n            }\n            return match;\n        }\n    }\n    return undefined;\n}\n\nfunction findPreviousTextAudioPair(\n    mo: MediaOverlayNode,\n    moToMatch: MediaOverlayNode,\n    previousMo: {prev: MediaOverlayNode | undefined}):\n    MediaOverlayNode | undefined | null { // returns null when skipped\n\n    if (DEBUG_AUDIO) {\n        debug(\"findPreviousTextAudioPair()\");\n        debug(JSON.stringify(moToMatch));\n        debug(JSON.stringify(previousMo.prev));\n    }\n    const isSkip = _mediaOverlaySkippabilityIsEnabled && isSkippable(mo);\n    if (isSkip) {\n        if (DEBUG_AUDIO) {\n            debug(\"findPreviousTextAudioPair() - isSkippable\");\n            debug(JSON.stringify(mo));\n        }\n        return null;\n    }\n\n    if (!mo.Children || !mo.Children.length) { // leaf === text/audio pair (SMIL par)\n        if (DEBUG_AUDIO) {\n            debug(\"findPreviousTextAudioPair() - leaf text/audio pair\");\n            debug(JSON.stringify(mo));\n        }\n        if (previousMo.prev &&\n            mo === moToMatch\n            ) {\n\n            if (DEBUG_AUDIO) {\n                debug(\"findPreviousTextAudioPair() - mo === moToMatch\");\n                debug(JSON.stringify(previousMo.prev));\n            }\n            return previousMo.prev;\n        }\n        if (!_mediaOverlaySkippabilityIsEnabled || !isSkippable(mo)) {\n            if (DEBUG_AUDIO) {\n                debug(\"findPreviousTextAudioPair() - set previous\");\n                debug(JSON.stringify(mo));\n            }\n            previousMo.prev = mo;\n        }\n        return undefined;\n    }\n    for (const child of mo.Children) {\n        if (DEBUG_AUDIO) {\n            debug(\"findPreviousTextAudioPair() - child\");\n            debug(JSON.stringify(child));\n        }\n        const match = findPreviousTextAudioPair(child, moToMatch, previousMo);\n        if (match) {\n            if (DEBUG_AUDIO) {\n                debug(\"findPreviousTextAudioPair() - match\");\n                debug(JSON.stringify(match));\n            }\n            return match;\n        }\n    }\n    return undefined;\n}\n\nfunction findDepthFirstTextAudioPair(\n    textHref: string,\n    mo: MediaOverlayNode,\n    textFragmentIDChain: Array<string | null> | undefined):\n    MediaOverlayNode | undefined | null { // returns null when skipped\n\n    if (DEBUG_AUDIO) {\n        debug(\"findDepthFirstTextAudioPair()\");\n    }\n    const isSkip = _mediaOverlaySkippabilityIsEnabled && isSkippable(mo);\n\n    let isTextUrlMatch: boolean | undefined;\n    let isFragmentIDMatch: boolean | undefined;\n    if (mo.Text) {\n        const hrefUrlObj = new URL(\"https://dummy.com/\" + mo.Text);\n        if (hrefUrlObj.pathname.substr(1) === textHref) { // includes leading slash\n            isTextUrlMatch = true;\n\n            if (hrefUrlObj.hash && textFragmentIDChain) {\n                isFragmentIDMatch = false;\n                const id = hrefUrlObj.hash.substr(1); // includes #\n                for (const frag of textFragmentIDChain) {\n                    if (frag === id) {\n                        isFragmentIDMatch = true;\n                        break;\n                    }\n                }\n            }\n        } else {\n            isTextUrlMatch = false;\n        }\n    }\n\n    if (DEBUG_AUDIO) {\n        debug(\"isSkip: \" + isSkip);\n        debug(\"isFragmentIDMatch: \" + isFragmentIDMatch);\n        debug(\"isTextUrlMatch: \" + isTextUrlMatch);\n    }\n    if (!mo.Children || !mo.Children.length) { // leaf === text/audio pair (SMIL par)\n        if (DEBUG_AUDIO) {\n            debug(\"findDepthFirstTextAudioPair() - leaf text/audio pair\");\n        }\n        if (!isTextUrlMatch) {\n            if (DEBUG_AUDIO) {\n                debug(\"findDepthFirstTextAudioPair() - leaf - !isTextUrlMatch\");\n            }\n            return undefined;\n        }\n        if (isFragmentIDMatch || (isTextUrlMatch && !textFragmentIDChain)) {\n            if (isSkip) {\n                if (DEBUG_AUDIO) {\n                    debug(\"findDepthFirstTextAudioPair() - leaf - isFragmentIDMatch || (isTextUrlMatch && !textFragmentIDChain (isSkip)\");\n                }\n                return null;\n            } else {\n                if (DEBUG_AUDIO) {\n                    debug(\"findDepthFirstTextAudioPair() - leaf - isFragmentIDMatch || (isTextUrlMatch && !textFragmentIDChain\");\n                }\n                return mo;\n            }\n        }\n        return undefined;\n    }\n    let frags = textFragmentIDChain;\n    for (const child of mo.Children) {\n        if (DEBUG_AUDIO) {\n            debug(\"findDepthFirstTextAudioPair() - child\");\n            debug(JSON.stringify(child));\n        }\n        const match = findDepthFirstTextAudioPair(textHref, child, frags);\n        if (match === null) { // match, but skipped ... let's ignore the fragment IDs and just pick the next\n            if (DEBUG_AUDIO) {\n                debug(\"findDepthFirstTextAudioPair() - child - match null (skip)\");\n            }\n            frags = undefined;\n        }\n        if (match) {\n            if (DEBUG_AUDIO) {\n                debug(\"findDepthFirstTextAudioPair() - child - match\");\n                debug(JSON.stringify(match));\n            }\n            return match;\n        }\n    }\n    if (isFragmentIDMatch) {\n        if (isSkip) {\n            if (DEBUG_AUDIO) {\n                debug(\"findDepthFirstTextAudioPair() - post isFragmentIDMatch (skip)\");\n            }\n            return null;\n        } else {\n            if (DEBUG_AUDIO) {\n                debug(\"findDepthFirstTextAudioPair() - post isFragmentIDMatch\");\n            }\n            const match = findDepthFirstTextAudioPair(textHref, mo, undefined);\n            if (match) {\n                if (DEBUG_AUDIO) {\n                    debug(\"findDepthFirstTextAudioPair() - post isFragmentIDMatch - match\");\n                    debug(JSON.stringify(match));\n                }\n                return match;\n            }\n        }\n    }\n    return undefined;\n}\n\nlet _timeoutAutoNext: number | undefined;\nfunction ensureKillAutoNextTimeout() {\n    if (_timeoutAutoNext) {\n        clearTimeout(_timeoutAutoNext);\n        _timeoutAutoNext = undefined;\n    }\n}\nasync function playMediaOverlaysForLink(link: Link, textFragmentIDChain: Array<string | null> | undefined) {\n\n    if (IS_DEV) {\n        debug(\"playMediaOverlaysForLink()\");\n        debug(link.Href);\n        debug(link.HrefDecoded);\n        debug(JSON.stringify(textFragmentIDChain, null, 4));\n    }\n    let moUrl: string | undefined;\n    if (link.Properties?.MediaOverlay) {\n        moUrl = link.Properties.MediaOverlay;\n        if (IS_DEV) {\n            debug(link.Properties.MediaOverlay);\n            debug(link.Duration);\n        }\n    }\n    if (link.Alternate) {\n        for (const altLink of link.Alternate) {\n            if (altLink.TypeLink === \"application/vnd.syncnarr+json\") {\n                if (!moUrl) {\n                    moUrl = altLink.Href; // HrefDecoded corrupts the query param! media-overlay.json?href=PATH\n                }\n                if (IS_DEV) {\n                    debug(altLink.Href);\n                    debug(altLink.HrefDecoded);\n                    debug(altLink.TypeLink);\n                    debug(altLink.Duration);\n                }\n            }\n        }\n    }\n\n    ensureKillAutoNextTimeout();\n\n    if (!moUrl) {\n        if (IS_DEV) {\n            debug(\"playMediaOverlaysForLink() - navLeftOrRight()\");\n        }\n        _timeoutAutoNext = window.setTimeout(() => {\n            _timeoutAutoNext = undefined;\n\n            mediaOverlaysStop(true);\n            // metadata-level RTL\n            const rtl = isRTL();\n            navLeftOrRight(rtl, true, true);\n        }, 600); // was 2 seconds, but transition too slow (user thinks playback is stalled)\n        if (_mediaOverlaysListener) {\n            _mediaOverlaysListener(MediaOverlaysStateEnum.PLAYING);\n        }\n        return;\n    }\n    // typically undefined at first, because serialized JSON not init'ed, lazy-loaded\n    if (!link.MediaOverlays || !link.MediaOverlays.initialized) {\n\n        let publicationURL = win.READIUM2.publicationURL;\n        if (publicationURL.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\")) {\n            publicationURL = convertCustomSchemeToHttpUrl(publicationURL);\n        }\n\n        // const moUrlFull = publicationURL + \"/../\" + moUrl;\n        const moUrlObjFull = new URL(moUrl, publicationURL);\n        const moUrlFull = moUrlObjFull.toString();\n\n        let response: Response;\n        try {\n            response = await fetch(moUrlFull);\n        } catch (e) {\n            debug(e);\n            debug(moUrlFull);\n            return;\n        }\n        if (!response.ok) {\n            debug(\"BAD RESPONSE?!\");\n        }\n        // response.headers.forEach((arg0: any, arg1: any) => {\n        //     debug(arg0 + \" => \" + arg1);\n        // });\n\n        let moJson: any | undefined;\n        try {\n            moJson = await response.json();\n        } catch (e) {\n            debug(e);\n        }\n        if (!moJson) {\n            return;\n        }\n\n        link.MediaOverlays = TaJsonDeserialize<MediaOverlayNode>(moJson, MediaOverlayNode);\n        // link.MediaOverlays.SmilPathInZip = smilFilePath;\n        link.MediaOverlays.initialized = true;\n\n        if (IS_DEV) {\n            // debug(JSON.stringify(link.MediaOverlays, null, 4));\n            debug(util.inspect(link.MediaOverlays,\n                { showHidden: false, depth: 1000, colors: true, customInspect: true }));\n        }\n    }\n    if (!link.MediaOverlays || !link.MediaOverlays.initialized) {\n        debug(\"Has MO but no Media Overlays?! \" + link.Href);\n        if (IS_DEV) {\n            debug(JSON.stringify(win.READIUM2.publication, null, 4));\n            debug(util.inspect(win.READIUM2.publication,\n                { showHidden: false, depth: 1000, colors: true, customInspect: true }));\n        }\n        return;\n    }\n\n    if (IS_DEV) {\n        debug(\"playMediaOverlaysForLink() - playMediaOverlays()\");\n    }\n    const href = link.HrefDecoded || link.Href;\n    const hrefUrlObj = new URL(\"https://dummy.com/\" + href);\n    // hrefUrlObj.hash = \"\";\n    // hrefUrlObj.search = \"\";\n    await playMediaOverlays(hrefUrlObj.pathname.substr(1), link.MediaOverlays, textFragmentIDChain);\n}\n\nlet _lastClickedNotification: {\n    textFragmentIDChain: Array<string | null> | undefined;\n    link: Link | undefined;\n} | undefined;\nexport function mediaOverlaysHandleIpcMessage(\n    eventChannel: string,\n    eventArgs: any[],\n    eventCurrentTarget: IReadiumElectronWebview): boolean {\n\n    const activeWebView = eventCurrentTarget;\n\n    if (eventChannel === R2_EVENT_MEDIA_OVERLAY_CLICK) {\n        // debug(\"R2_EVENT_MEDIA_OVERLAY_CLICK (webview.addEventListener('ipc-message')\");\n        if (publicationHasMediaOverlays(win.READIUM2.publication)\n            // &&\n            // (\n            // // win.READIUM2.mediaOverlaysClickEnabled &&\n            // _mediaOverlayRoot\n            // )\n        ) {\n            if (IS_DEV) {\n                debug(\"R2_EVENT_MEDIA_OVERLAY_CLICK\");\n            }\n\n            const payload = eventArgs[0] as IEventPayload_R2_EVENT_MEDIA_OVERLAY_CLICK;\n\n            // if (!payload.userInteract) {\n            //     let linkFirst: Link | undefined;\n            //     let linkSecond: Link | undefined;\n            //     const firstWebView = win.READIUM2.getFirstWebView();\n            //     if (firstWebView) {\n            //         linkFirst = firstWebView.READIUM2.link;\n            //     }\n            //     const secondWebView = win.READIUM2.getSecondWebView(false);\n            //     if (secondWebView) {\n            //         linkSecond = secondWebView.READIUM2.link;\n            //     }\n            //     if (linkFirst && linkSecond && win.READIUM2.publication.Spine) {\n            //         const indexFirst = win.READIUM2.publication.Spine.indexOf(linkFirst);\n            //         const indexSecond = win.READIUM2.publication.Spine.indexOf(linkSecond);\n            //         if (indexSecond >= 0 && indexFirst >= 0) {\n            //             const firstLink = indexSecond < indexFirst ? linkSecond : linkFirst;\n            //             if (activeWebView.READIUM2.link?.Href &&\n            //                 activeWebView.READIUM2.link?.Href !== firstLink.Href) {\n            //                 debug(`R2_EVENT_MEDIA_OVERLAY_CLICK skipped spread\n            //                 ${activeWebView.READIUM2.link?.Href}`);\n            //                 return true;\n            //             }\n            //         }\n            //     }\n            // }\n\n            mediaOverlaysInterrupt();\n\n            _lastClickedNotification = {\n                link: activeWebView.READIUM2.link,\n                textFragmentIDChain: payload.textFragmentIDChain,\n            };\n\n            if ((payload.userInteract && _mediaOverlaysClickEnabled) ||\n                _mediaOverlayActive) {\n\n                if (IS_DEV) {\n                    debug(\"playMediaOverlaysForLink\");\n                }\n                setTimeout(async () => {\n                    if (activeWebView.READIUM2.link) {\n                        await playMediaOverlaysForLink(activeWebView.READIUM2.link, payload.textFragmentIDChain);\n                    }\n                }, 0);\n            }\n        }\n    } else if (eventChannel === R2_EVENT_MEDIA_OVERLAY_STARTSTOP) {\n        const payload = eventArgs[0] as IEventPayload_R2_EVENT_MEDIA_OVERLAY_STARTSTOP;\n\n        if (IS_DEV) {\n            debug(\"R2_EVENT_MEDIA_OVERLAY_STARTSTOP\");\n        }\n        mediaOverlaysStop();\n\n        if (payload.start) {\n            const rate = _mediaOverlaysPlaybackRate;\n            mediaOverlaysPlay(1); // iBooks\n            _mediaOverlaysPlaybackRate = rate;\n        } else if (payload.stop) {\n            //\n        } else {\n            if (_currentAudioElement && !_currentAudioElement.paused) {\n                //\n            } else {\n                const rate = _mediaOverlaysPlaybackRate;\n                mediaOverlaysPlay(1); // iBooks\n                _mediaOverlaysPlaybackRate = rate;\n            }\n        }\n    } else {\n        return false;\n    }\n    return true;\n}\nfunction moHighlight_(moTextAudioPair: MediaOverlayNode) {\n    if (IS_DEV) {\n        debug(\"moHighlight ...\");\n    }\n    if (moTextAudioPair.Text) {\n        const i = moTextAudioPair.Text.lastIndexOf(\"#\");\n        if (i >= 0) {\n            const id = moTextAudioPair.Text.substr(i + 1);\n            if (id) {\n                _mediaOverlayTextId = id;\n                _mediaOverlayTextHref = moTextAudioPair.Text.substr(0, i);\n                moHighlight(_mediaOverlayTextHref, _mediaOverlayTextId);\n            }\n        }\n    }\n}\nfunction moHighlight(href: string | undefined, id: string | undefined) {\n    if (IS_DEV) {\n        debug(\"moHighlight: \" + href + \" ## \" + id);\n    }\n\n    const classActive = win.READIUM2.publication.Metadata?.MediaOverlay?.ActiveClass;\n    const classActivePlayback =\n        win.READIUM2.publication.Metadata?.MediaOverlay?.PlaybackActiveClass;\n    const payload: IEventPayload_R2_EVENT_MEDIA_OVERLAY_HIGHLIGHT = {\n        captionsMode: _captionsMode,\n        classActive: classActive ? classActive : undefined,\n        classActivePlayback: classActivePlayback ? classActivePlayback : undefined,\n        id,\n    };\n    const activeWebViews = win.READIUM2.getActiveWebViews();\n    for (const activeWebView of activeWebViews) {\n        if (href && activeWebView.READIUM2.link?.Href !== href) {\n            continue;\n        }\n\n        setTimeout(async () => {\n            await activeWebView.send(R2_EVENT_MEDIA_OVERLAY_HIGHLIGHT, payload);\n        }, 0);\n    }\n}\n\nexport enum MediaOverlaysStateEnum {\n    PAUSED = \"PAUSED\",\n    PLAYING = \"PLAYING\",\n    STOPPED = \"STOPPED\",\n}\nlet _mediaOverlaysListener: ((mediaOverlaysState: MediaOverlaysStateEnum) => void) | undefined;\nexport function mediaOverlaysListen(mediaOverlaysListener: (mediaOverlaysState: MediaOverlaysStateEnum) => void) {\n    _mediaOverlaysListener = mediaOverlaysListener;\n}\n\nexport function mediaOverlaysPlay(speed: number) {\n    if (IS_DEV) {\n        debug(\"mediaOverlaysPlay()\");\n    }\n    if (!win.READIUM2 || !win.READIUM2.publication) {\n        return;\n    }\n\n    _mediaOverlaysPlaybackRate = speed;\n\n    if (!_mediaOverlayRoot || !_mediaOverlayTextAudioPair) {\n        if (IS_DEV) {\n            debug(\"mediaOverlaysPlay() - playMediaOverlaysForLink()\");\n        }\n        let textFragmentIDChain: Array<string | null> | undefined;\n        const href = _lastClickedNotification?.link?.Href;\n        let activeWebView = win.READIUM2.getActiveWebViews().find((webview) => {\n            return href && webview.READIUM2.link?.Href === href;\n        });\n        if (activeWebView) {\n            textFragmentIDChain = _lastClickedNotification?.textFragmentIDChain;\n        } else {\n            activeWebView = win.READIUM2.getFirstWebView();\n        }\n        setTimeout(async () => {\n            if (activeWebView && activeWebView.READIUM2.link) {\n                await playMediaOverlaysForLink(activeWebView.READIUM2.link, textFragmentIDChain);\n            }\n        }, 0);\n    } else {\n        if (IS_DEV) {\n            debug(\"mediaOverlaysPlay() - mediaOverlaysResume()\");\n        }\n        mediaOverlaysResume();\n    }\n}\n\nexport function mediaOverlaysPause() {\n    if (IS_DEV) {\n        debug(\"mediaOverlaysPause()\");\n    }\n    if (!win.READIUM2 || !win.READIUM2.publication) {\n        return;\n    }\n\n    moHighlight(undefined, undefined);\n\n    ensureOnTimeUpdate(true);\n    if (_currentAudioElement) {\n        _currentAudioElement.pause();\n    }\n\n    if (_mediaOverlaysListener) {\n        _mediaOverlaysListener(MediaOverlaysStateEnum.PAUSED);\n    }\n}\n\nexport function mediaOverlaysInterrupt() {\n    if (!win.READIUM2 || !win.READIUM2.publication) {\n        return;\n    }\n    if (!publicationHasMediaOverlays(win.READIUM2.publication)) {\n        return;\n    }\n    if (IS_DEV) {\n        debug(\"mediaOverlaysInterrupt()\");\n    }\n    mediaOverlaysStop(_mediaOverlayActive);\n}\nexport function mediaOverlaysStop(stayActive?: boolean) {\n    if (IS_DEV) {\n        debug(\"mediaOverlaysStop()\");\n    }\n    if (!win.READIUM2 || !win.READIUM2.publication) {\n        return;\n    }\n\n    _mediaOverlayActive = stayActive ? true : false;\n\n    mediaOverlaysPause();\n\n    _mediaOverlayRoot = undefined;\n    _mediaOverlayTextAudioPair = undefined;\n    _mediaOverlayTextId = undefined;\n\n    if (!_mediaOverlayActive) {\n        if (_mediaOverlaysListener) {\n            _mediaOverlaysListener(MediaOverlaysStateEnum.STOPPED);\n        }\n    }\n}\n\nexport function mediaOverlaysResume() {\n    if (IS_DEV) {\n        debug(\"mediaOverlaysResume()\");\n    }\n    if (!win.READIUM2 || !win.READIUM2.publication) {\n        return;\n    }\n\n    if (_mediaOverlayRoot && _mediaOverlayTextAudioPair) {\n        if (IS_DEV) {\n            debug(\"mediaOverlaysResume() - _currentAudioElement.play()\");\n        }\n        ensureOnTimeUpdate(false);\n        if (_currentAudioElement) {\n            setTimeout(async () => {\n                if (_currentAudioElement) {\n                    _currentAudioElement.playbackRate = _mediaOverlaysPlaybackRate;\n                    await _currentAudioElement.play();\n                }\n            }, 0);\n        }\n        if (_mediaOverlaysListener) {\n            _mediaOverlaysListener(MediaOverlaysStateEnum.PLAYING);\n        }\n        moHighlight_(_mediaOverlayTextAudioPair);\n    } else {\n        if (IS_DEV) {\n            debug(\"mediaOverlaysResume() - mediaOverlaysPlay()\");\n        }\n        mediaOverlaysPlay(_mediaOverlaysPlaybackRate);\n    }\n}\n\nexport function mediaOverlaysPrevious() {\n    if (IS_DEV) {\n        debug(\"mediaOverlaysPrevious()\");\n    }\n    if (!win.READIUM2 || !win.READIUM2.publication) {\n        return;\n    }\n    // (currentAudioElement as any).__ontimeupdate = false;\n    // currentAudioElement.removeEventListener(\"timeupdate\", ontimeupdate);\n    ensureOnTimeUpdate(true);\n\n    if (_mediaOverlayRoot && _mediaOverlayTextAudioPair) {\n        const previousTextAudioPair =\n            findPreviousTextAudioPair(_mediaOverlayRoot, _mediaOverlayTextAudioPair, {prev: undefined});\n        if (!previousTextAudioPair) {\n            if (IS_DEV) {\n                debug(\"mediaOverlaysPrevious() - navLeftOrRight()\");\n            }\n            mediaOverlaysStop(true);\n            // metadata-level RTL\n            const rtl = isRTL();\n            navLeftOrRight(!rtl, true, true);\n        } else {\n            let switchDoc = false;\n            if (_mediaOverlayTextAudioPair.Text && previousTextAudioPair.Text) {\n                const hrefUrlObj1 = new URL(\"https://dummy.com/\" + _mediaOverlayTextAudioPair.Text);\n                const hrefUrlObj2 = new URL(\"https://dummy.com/\" + previousTextAudioPair.Text);\n                if (hrefUrlObj1.pathname !== hrefUrlObj2.pathname) { // includes leading slash\n                    if (IS_DEV) {\n                        debug(\"mediaOverlaysPrevious SWITCH! \" + hrefUrlObj1.pathname + \" != \" + hrefUrlObj2.pathname);\n                    }\n                    switchDoc = true;\n                }\n            }\n            if (switchDoc) {\n                mediaOverlaysStop(true);\n\n                const publicationURL = win.READIUM2.publicationURL;\n                // if (publicationURL.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\")) {\n                //     publicationURL = convertCustomSchemeToHttpUrl(publicationURL);\n                // }\n\n                // const url = publicationURL + \"/../\" + previousTextAudioPair.Text;\n                const urlObjFull = new URL(previousTextAudioPair.Text, publicationURL);\n                const urlFull = urlObjFull.toString();\n                if (IS_DEV) {\n                    debug(\"mediaOverlaysPrevious() - handleLinkUrl()\");\n                }\n                const activeWebView = win.READIUM2.getFirstOrSecondWebView();\n                handleLinkUrl(\n                    urlFull,\n                    activeWebView ? activeWebView.READIUM2.readiumCss : undefined);\n            } else {\n                if (IS_DEV) {\n                    debug(\"mediaOverlaysPrevious() - playMediaOverlaysAudio()\");\n                }\n                setTimeout(async () => {\n                    await playMediaOverlaysAudio(previousTextAudioPair, undefined, undefined);\n                }, 0);\n            }\n        }\n    } else {\n        if (IS_DEV) {\n            debug(\"mediaOverlaysPrevious() - navLeftOrRight() 2\");\n        }\n        mediaOverlaysStop(true);\n        // metadata-level RTL\n        const rtl = isRTL();\n        navLeftOrRight(!rtl, true, true);\n        // if (IS_DEV) {\n        //     debug(\"mediaOverlaysPrevious() - mediaOverlaysPlay()\");\n        // }\n        // mediaOverlaysPlay(_mediaOverlaysPlaybackRate);\n    }\n}\n\nexport function mediaOverlaysNext(escape?: boolean) {\n    if (IS_DEV) {\n        debug(\"mediaOverlaysNext()\");\n    }\n    if (!win.READIUM2 || !win.READIUM2.publication) {\n        return;\n    }\n    // (currentAudioElement as any).__ontimeupdate = false;\n    // currentAudioElement.removeEventListener(\"timeupdate\", ontimeupdate);\n    ensureOnTimeUpdate(true);\n\n    if (_mediaOverlayRoot && _mediaOverlayTextAudioPair) {\n        const nextTextAudioPair =\n            findNextTextAudioPair(_mediaOverlayRoot, _mediaOverlayTextAudioPair, {prev: undefined},\n                escape ? true : false);\n        if (!nextTextAudioPair) {\n            if (IS_DEV) {\n                debug(\"mediaOverlaysNext() - navLeftOrRight()\");\n            }\n            mediaOverlaysStop(true);\n            // metadata-level RTL\n            const rtl = isRTL();\n            navLeftOrRight(rtl, true, true);\n        } else {\n            let switchDoc = false;\n            if (_mediaOverlayTextAudioPair.Text && nextTextAudioPair.Text) {\n                const hrefUrlObj1 = new URL(\"https://dummy.com/\" + _mediaOverlayTextAudioPair.Text);\n                const hrefUrlObj2 = new URL(\"https://dummy.com/\" + nextTextAudioPair.Text);\n                if (hrefUrlObj1.pathname !== hrefUrlObj2.pathname) { // includes leading slash\n                    if (IS_DEV) {\n                        debug(\"mediaOverlaysNext() SWITCH! \" + hrefUrlObj1.pathname + \" != \" + hrefUrlObj2.pathname);\n                    }\n                    switchDoc = true;\n                }\n            }\n            if (switchDoc) {\n                mediaOverlaysStop(true);\n\n                const publicationURL = win.READIUM2.publicationURL;\n                // if (publicationURL.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\")) {\n                //     publicationURL = convertCustomSchemeToHttpUrl(publicationURL);\n                // }\n\n                // const url = publicationURL + \"/../\" + nextTextAudioPair.Text;\n                const urlObjFull = new URL(nextTextAudioPair.Text, publicationURL);\n                const urlFull = urlObjFull.toString();\n                if (IS_DEV) {\n                    debug(\"mediaOverlaysNext() - handleLinkUrl()\");\n                }\n                const activeWebView = win.READIUM2.getFirstOrSecondWebView();\n                handleLinkUrl(\n                    urlFull,\n                    activeWebView ? activeWebView.READIUM2.readiumCss : undefined);\n            } else {\n                if (IS_DEV) {\n                    debug(\"mediaOverlaysNext() - playMediaOverlaysAudio()\");\n                }\n                setTimeout(async () => {\n                    await playMediaOverlaysAudio(nextTextAudioPair, undefined, undefined);\n                }, 0);\n            }\n        }\n    } else {\n        if (IS_DEV) {\n            debug(\"mediaOverlaysNext() - navLeftOrRight() 2\");\n        }\n        mediaOverlaysStop(true);\n        // metadata-level RTL\n        const rtl = isRTL();\n        navLeftOrRight(rtl, true, true);\n        // if (IS_DEV) {\n        //     debug(\"mediaOverlaysNext() - mediaOverlaysPlay()\");\n        // }\n        // mediaOverlaysPlay(_mediaOverlaysPlaybackRate);\n    }\n}\n\nexport function mediaOverlaysEscape() {\n    if (!win.READIUM2 || !win.READIUM2.publication) {\n        return;\n    }\n    mediaOverlaysNext(true);\n}\n\nexport function mediaOverlaysEnableCaptionsMode(captionsMode: boolean) {\n    _captionsMode = captionsMode;\n\n    if (IS_DEV) {\n        debug(\"mediaOverlaysEnableCaptionsMode() - mediaOverlaysPause() + mediaOverlaysPlay()\");\n    }\n    mediaOverlaysPause();\n    setTimeout(() => {\n        mediaOverlaysPlay(_mediaOverlaysPlaybackRate);\n    }, 300);\n}\n\nexport function mediaOverlaysClickEnable(doEnable: boolean) {\n    _mediaOverlaysClickEnabled = doEnable;\n    // if (win.READIUM2) {\n    //     win.READIUM2.mediaOverlaysClickEnabled = doEnable;\n    // }\n\n    // const activeWebViews = win.READIUM2.getActiveWebViews();\n\n    // if (!activeWebView) {\n    //     return;\n    // }\n\n    // const payload: IEventPayload_R2_EVENT_MEDIA_OVERLAYS_CLICK_ENABLE = {\n    //     doEnable,\n    // };\n\n    // setTimeout(async () => {\n    //     await activeWebView.send(R2_EVENT_MEDIA_OVERLAYS_CLICK_ENABLE, payload);\n    // }, 0);\n}\n\nexport function mediaOverlaysPlaybackRate(speed: number) {\n    if (!win.READIUM2 || !win.READIUM2.publication) {\n        return;\n    }\n\n    _mediaOverlaysPlaybackRate = speed;\n\n    if (_currentAudioElement) {\n        _currentAudioElement.playbackRate = speed;\n    }\n}\n\nlet _mediaOverlaySkippabilityIsEnabled = true;\nexport function mediaOverlaysEnableSkippability(doEnable: boolean) {\n    _mediaOverlaySkippabilityIsEnabled = doEnable;\n}\n"]}