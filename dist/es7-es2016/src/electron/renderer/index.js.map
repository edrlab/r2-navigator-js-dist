{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../../src/electron/renderer/index.ts"],"names":[],"mappings":"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","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport debounce = require(\"debounce\");\nimport URI = require(\"urijs\");\n\nimport { Publication } from \"@models/publication\";\nimport { Link } from \"@models/publication-link\";\nimport { encodeURIComponent_RFC3986 } from \"@utils/http/UrlUtils\";\nimport { ipcRenderer, shell } from \"electron\";\n\nimport {\n    IEventPayload_R2_EVENT_LINK,\n    IEventPayload_R2_EVENT_PAGE_TURN,\n    IEventPayload_R2_EVENT_READING_LOCATION,\n    IEventPayload_R2_EVENT_READIUMCSS,\n    IEventPayload_R2_EVENT_SCROLLTO,\n    IEventPayload_R2_EVENT_WEBVIEW_READY,\n    R2_EVENT_LINK,\n    R2_EVENT_PAGE_TURN,\n    R2_EVENT_PAGE_TURN_RES,\n    R2_EVENT_READING_LOCATION,\n    R2_EVENT_READIUMCSS,\n    R2_EVENT_SCROLLTO,\n    R2_EVENT_WEBVIEW_READY,\n} from \"../common/events\";\nimport {\n    R2_SESSION_WEBVIEW,\n    READIUM2_ELECTRON_HTTP_PROTOCOL,\n    convertCustomSchemeToHttpUrl,\n    convertHttpUrlToCustomScheme,\n} from \"../common/sessions\";\nimport { URL_PARAM_CSS, URL_PARAM_EPUBREADINGSYSTEM, URL_PARAM_GOTO, URL_PARAM_PREVIOUS } from \"./common/url-params\";\nimport { INameVersion } from \"./webview/epubReadingSystem\";\nimport { IElectronWebviewTag } from \"./webview/state\";\n\nconst IS_DEV = (process.env.NODE_ENV === \"development\" || process.env.NODE_ENV === \"dev\");\n\nexport const DOM_EVENT_HIDE_VIEWPORT = \"r2:hide-content-viewport\";\nexport const DOM_EVENT_SHOW_VIEWPORT = \"r2:show-content-viewport\";\n\nconst ELEMENT_ID_SLIDING_VIEWPORT = \"r2_navigator_sliding_viewport\";\n\n// const queryParams = getURLQueryParams();\n\n// // tslint:disable-next-line:no-string-literal\n// const publicationJsonUrl = queryParams[\"pub\"];\n// console.log(publicationJsonUrl);\n// const publicationJsonUrl_ = publicationJsonUrl.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL) ?\n//     convertCustomSchemeToHttpUrl(publicationJsonUrl) : publicationJsonUrl;\n// console.log(publicationJsonUrl_);\n// const pathBase64 = publicationJsonUrl_.replace(/.*\\/pub\\/(.*)\\/manifest.json/, \"$1\");\n// console.log(pathBase64);\n// const pathDecoded = window.atob(pathBase64);\n// console.log(pathDecoded);\n// const pathFileName = pathDecoded.substr(\n//     pathDecoded.replace(/\\\\/g, \"/\").lastIndexOf(\"/\") + 1,\n//     pathDecoded.length - 1);\n// console.log(pathFileName);\n\n// // tslint:disable-next-line:no-string-literal\n// const lcpHint = queryParams[\"lcpHint\"];\n\nfunction isFixedLayout(link: Link | undefined): boolean {\n    if (link && link.Properties) {\n        if (link.Properties.Layout === \"fixed\") {\n            return true;\n        }\n        if (typeof link.Properties.Layout !== \"undefined\") {\n            return false;\n        }\n    }\n    const isFXL = _publication &&\n        _publication.Metadata &&\n        _publication.Metadata.Rendition &&\n        _publication.Metadata.Rendition.Layout === \"fixed\";\n    return isFXL as boolean;\n}\n\nlet _getEpubReadingSystem: () => INameVersion = () => {\n    return { name: \"Readium2\", version: \"0.0.0\" };\n};\nexport function setEpubReadingSystemJsonGetter(func: () => INameVersion) {\n    _getEpubReadingSystem = func;\n}\n\nfunction __computeReadiumCssJsonMessage(link: Link | undefined): IEventPayload_R2_EVENT_READIUMCSS {\n\n    if (isFixedLayout(link)) {\n        return { injectCSS: \"rollback\", setCSS: \"rollback\", isFixedLayout: true };\n    }\n\n    if (!_computeReadiumCssJsonMessage) {\n        return { injectCSS: \"rollback\", setCSS: \"rollback\", isFixedLayout: false };\n    }\n\n    const readiumCssJsonMessage = _computeReadiumCssJsonMessage();\n    return readiumCssJsonMessage;\n}\nlet _computeReadiumCssJsonMessage: () => IEventPayload_R2_EVENT_READIUMCSS = () => {\n    return { injectCSS: \"rollback\", setCSS: \"rollback\", isFixedLayout: false };\n};\nexport function setReadiumCssJsonGetter(func: () => IEventPayload_R2_EVENT_READIUMCSS) {\n    _computeReadiumCssJsonMessage = func;\n}\n\nlet _saveReadingLocation: (docHref: string, cssSelector: string) => void = (_docHref: string, _cssSelector: string) => {\n    return;\n};\nexport function setReadingLocationSaver(func: (docHref: string, cssSelector: string) => void) {\n    _saveReadingLocation = func;\n}\n\nexport function readiumCssOnOff() {\n\n    if (_webview1) {\n        const payload1 = __computeReadiumCssJsonMessage(_webview1.READIUM2.link);\n        _webview1.send(R2_EVENT_READIUMCSS, payload1); // .getWebContents()\n    }\n\n    if (_webview2) {\n        const payload2 = __computeReadiumCssJsonMessage(_webview2.READIUM2.link);\n        _webview2.send(R2_EVENT_READIUMCSS, payload2); // .getWebContents()\n    }\n}\n\nlet _webview1: IElectronWebviewTag;\nlet _webview2: IElectronWebviewTag;\n\nlet _publication: Publication | undefined;\nlet _publicationJsonUrl: string | undefined;\n\nlet _rootHtmlElement: Element | undefined;\n\nexport function handleLink(href: string, previous: boolean | undefined, useGoto: boolean) {\n\n    let okay = href.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\");\n    if (!okay && _publicationJsonUrl) {\n        const prefix = _publicationJsonUrl.replace(\"manifest.json\", \"\");\n        okay = decodeURIComponent(href).startsWith(decodeURIComponent(prefix));\n    }\n    if (okay) {\n        loadLink(href, previous, useGoto);\n    } else {\n        console.log(\"EXTERNAL LINK:\");\n        console.log(href);\n        shell.openExternal(href);\n    }\n}\n\nexport function installNavigatorDOM(\n    publication: Publication,\n    publicationJsonUrl: string,\n    rootHtmlElementID: string,\n    preloadScriptPath: string,\n    pubDocHrefToLoad: string | undefined,\n    pubDocSelectorToGoto: string | undefined) {\n\n    _publication = publication;\n    _publicationJsonUrl = publicationJsonUrl;\n\n    if (IS_DEV) {\n        // quick debugging from the console\n        (window as any).READIUM2_PUB = _publication;\n        (window as any).READIUM2_PUBURL = _publicationJsonUrl;\n    }\n\n    _rootHtmlElement = document.getElementById(rootHtmlElementID) as HTMLElement;\n    if (!_rootHtmlElement) {\n        console.log(\"!rootHtmlElement ???\");\n        return;\n    }\n\n    const slidingViewport = document.createElement(\"div\");\n    slidingViewport.setAttribute(\"id\", ELEMENT_ID_SLIDING_VIEWPORT);\n    slidingViewport.setAttribute(\"style\", \"display: block; position: absolute; left: 0; width: 200%; \" +\n        \"top: 0; bottom: 0; margin: 0; padding: 0; box-sizing: border-box; background: white; overflow: hidden;\");\n\n    _webview1 = createWebView(preloadScriptPath);\n    _webview1.READIUM2 = {\n        id: 1,\n        link: undefined,\n    };\n    _webview1.setAttribute(\"id\", \"webview1\");\n\n    _webview2 = createWebView(preloadScriptPath);\n    _webview2.READIUM2 = {\n        id: 2,\n        link: undefined,\n    };\n    _webview2.setAttribute(\"id\", \"webview2\");\n\n    slidingViewport.appendChild(_webview1 as Node);\n    slidingViewport.appendChild(_webview2 as Node);\n\n    _rootHtmlElement.appendChild(slidingViewport);\n\n    const isRTL = _publication.Metadata &&\n        _publication.Metadata.Direction &&\n        _publication.Metadata.Direction.toLowerCase() === \"rtl\"; //  any other value is LTR\n    if (isRTL) {\n        _webview1.classList.add(\"posRight\");\n        _webview1.style.left = \"50%\";\n    } else {\n        _webview2.classList.add(\"posRight\");\n        _webview2.style.left = \"50%\";\n    }\n\n    let linkToLoad: Link | undefined;\n    let linkToLoadGoto: string | undefined;\n    if (pubDocHrefToLoad) {\n        if (_publication.Spine && _publication.Spine.length) {\n            linkToLoad = _publication.Spine.find((spineLink) => {\n                return spineLink.Href === pubDocHrefToLoad;\n            });\n            if (linkToLoad && pubDocSelectorToGoto) {\n                linkToLoadGoto = pubDocSelectorToGoto;\n            }\n        }\n        if (!linkToLoad &&\n            _publication.Resources && _publication.Resources.length) {\n            linkToLoad = _publication.Resources.find((resLink) => {\n                return resLink.Href === pubDocHrefToLoad;\n            });\n            if (linkToLoad && pubDocSelectorToGoto) {\n                linkToLoadGoto = pubDocSelectorToGoto;\n            }\n        }\n    }\n    if (!linkToLoad) {\n        if (_publication.Spine && _publication.Spine.length) {\n            const firstLinear = _publication.Spine[0];\n            if (firstLinear) {\n                linkToLoad = firstLinear;\n            }\n        }\n    }\n\n    setTimeout(() => {\n        if (linkToLoad) {\n            const hrefToLoad = _publicationJsonUrl + \"/../\" + linkToLoad.Href +\n                (linkToLoadGoto ? (\"?\" + URL_PARAM_GOTO + \"=\" + encodeURIComponent_RFC3986(linkToLoadGoto)) : \"\");\n            handleLink(hrefToLoad, undefined, true);\n        }\n    }, 100);\n}\n\nexport function navLeftOrRight(left: boolean) {\n    if (!_publication) {\n        return;\n    }\n    const activeWebView = getActiveWebView();\n    const isRTL = _publication.Metadata &&\n        _publication.Metadata.Direction &&\n        _publication.Metadata.Direction.toLowerCase() === \"rtl\"; //  any other value is LTR\n    const goPREVIOUS = left ? !isRTL : isRTL;\n    const payload: IEventPayload_R2_EVENT_PAGE_TURN = {\n        direction: isRTL ? \"RTL\" : \"LTR\",\n        go: goPREVIOUS ? \"PREVIOUS\" : \"NEXT\",\n    };\n    activeWebView.send(R2_EVENT_PAGE_TURN, payload); // .getWebContents()\n}\n\nconst getActiveWebView = (): IElectronWebviewTag => {\n\n    let activeWebView: IElectronWebviewTag;\n\n    const slidingViewport = document.getElementById(ELEMENT_ID_SLIDING_VIEWPORT) as HTMLElement;\n    if (slidingViewport.classList.contains(\"shiftedLeft\")) {\n        if (_webview1.classList.contains(\"posRight\")) {\n            activeWebView = _webview1;\n        } else {\n            activeWebView = _webview2;\n        }\n    } else {\n        if (_webview2.classList.contains(\"posRight\")) {\n            activeWebView = _webview1;\n        } else {\n            activeWebView = _webview2;\n        }\n    }\n\n    return activeWebView;\n};\n\nfunction loadLink(hrefFull: string, previous: boolean | undefined, useGoto: boolean) {\n\n    if (!_publication || !_publicationJsonUrl) {\n        return;\n    }\n\n    if (hrefFull.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\")) {\n        hrefFull = convertCustomSchemeToHttpUrl(hrefFull);\n    }\n\n    const linkUri = new URI(hrefFull);\n    linkUri.search((data: any) => {\n        // overrides existing (leaves others intact)\n\n        if (typeof previous === \"undefined\") {\n            // erase unwanted forward of query param during linking\n            data[URL_PARAM_PREVIOUS] = undefined;\n            // delete data[URL_PARAM_PREVIOUS];\n        } else {\n            data[URL_PARAM_PREVIOUS] = previous ? \"true\" : \"false\";\n        }\n\n        if (!useGoto) {\n            // erase unwanted forward of query param during linking\n            data[URL_PARAM_GOTO] = undefined;\n            // delete data[URL_PARAM_GOTO];\n        }\n    });\n    if (useGoto) {\n        linkUri.hash(\"\").normalizeHash();\n    }\n\n    const pubJsonUri = _publicationJsonUrl.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\") ?\n        convertCustomSchemeToHttpUrl(_publicationJsonUrl) : _publicationJsonUrl;\n    const pubUri = new URI(pubJsonUri);\n\n    // \"/pub/BASE64_PATH/manifest.json\" ==> \"/pub/BASE64_PATH/\"\n    const pathPrefix = decodeURIComponent(pubUri.path().replace(\"manifest.json\", \"\"));\n\n    // \"/pub/BASE64_PATH/epub/chapter.html\" ==> \"epub/chapter.html\"\n    const normPath = decodeURIComponent(linkUri.normalizePath().path());\n    const linkPath = normPath.replace(pathPrefix, \"\");\n\n    let pubLink = _publication.Spine.find((spineLink) => {\n        return spineLink.Href === linkPath;\n    });\n    if (!pubLink) {\n        pubLink = _publication.Resources.find((spineLink) => {\n            return spineLink.Href === linkPath;\n        });\n    }\n\n    if (!pubLink) {\n        console.log(\"FATAL WEBVIEW READIUM2_LINK ??!! \" + hrefFull + \" ==> \" + linkPath);\n        return;\n    }\n\n    const rcssJson = __computeReadiumCssJsonMessage(pubLink);\n    const rcssJsonstr = JSON.stringify(rcssJson, null, \"\");\n    // const str = window.atob(base64);\n    const rcssJsonstrBase64 = window.btoa(rcssJsonstr);\n\n    const rersJson = _getEpubReadingSystem();\n    const rersJsonstr = JSON.stringify(rersJson, null, \"\");\n    // const str = window.atob(base64);\n    const rersJsonstrBase64 = window.btoa(rersJsonstr);\n\n    linkUri.search((data: any) => {\n        // overrides existing (leaves others intact)\n\n        // tslint:disable-next-line:no-string-literal\n        data[URL_PARAM_CSS] = rcssJsonstrBase64;\n\n        // tslint:disable-next-line:no-string-literal\n        data[URL_PARAM_EPUBREADINGSYSTEM] = rersJsonstrBase64;\n    });\n\n    const activeWebView = getActiveWebView();\n    const wv1AlreadyLoaded = _webview1.READIUM2.link === pubLink;\n    const wv2AlreadyLoaded = _webview2.READIUM2.link === pubLink;\n    if (wv1AlreadyLoaded || wv2AlreadyLoaded) {\n        const goto = useGoto ? linkUri.search(true)[URL_PARAM_GOTO] as string : undefined;\n        const hash = useGoto ? undefined : linkUri.fragment(); // without #\n\n        console.log(\"ALREADY LOADED: \" + pubLink.Href);\n\n        const webviewToReuse = wv1AlreadyLoaded ? _webview1 : _webview2;\n        // const otherWebview = webviewToReuse === _webview2 ? _webview1 : _webview2;\n        if (webviewToReuse !== activeWebView) {\n\n            console.log(\"INTO VIEW ...\");\n\n            const slidingView = document.getElementById(ELEMENT_ID_SLIDING_VIEWPORT) as HTMLElement;\n            if (slidingView) {\n                let animate = true;\n                if (goto || hash) {\n                    console.log(\"DISABLE ANIM\");\n                    animate = false;\n                } else if (previous) {\n                    if (!slidingView.classList.contains(\"shiftedLeft\")) {\n                        console.log(\"DISABLE ANIM\");\n                        animate = false;\n                    }\n                }\n                if (animate) {\n                    if (!slidingView.classList.contains(\"animated\")) {\n                        slidingView.classList.add(\"animated\");\n                        slidingView.style.transition = \"left 500ms ease-in-out\";\n                    }\n                } else {\n                    if (slidingView.classList.contains(\"animated\")) {\n                        slidingView.classList.remove(\"animated\");\n                        slidingView.style.transition = \"none\";\n                    }\n                }\n                if (slidingView.classList.contains(\"shiftedLeft\")) {\n                    slidingView.classList.remove(\"shiftedLeft\");\n                    slidingView.style.left = \"0\";\n\n                    // if (_webview1.classList.contains(\"posRight\")) {\n                    //     // activeWebView === _webview1;\n                    // } else {\n                    //     // activeWebView === _webview2;\n                    // }\n                } else {\n                    slidingView.classList.add(\"shiftedLeft\");\n                    slidingView.style.left = \"-100%\";\n\n                    // if (_webview2.classList.contains(\"posRight\")) {\n                    //     // activeWebView === _webview1;\n                    // } else {\n                    //     // activeWebView === _webview2;\n                    // }\n                }\n            }\n        }\n\n        // const msgJson = {\n        //     goto: ,\n        //     hash: ,\n        //     previous,\n        // };\n\n        const payload: IEventPayload_R2_EVENT_SCROLLTO = {\n            goto,\n            hash,\n            previous: previous ? true : false,\n        };\n\n        const msgStr = JSON.stringify(payload);\n        console.log(msgStr);\n\n        webviewToReuse.send(R2_EVENT_SCROLLTO, payload); // .getWebContents()\n\n        return;\n    }\n\n    if (!isFixedLayout(pubLink)) {\n        if (_rootHtmlElement) {\n            _rootHtmlElement.dispatchEvent(new Event(DOM_EVENT_HIDE_VIEWPORT));\n        }\n    }\n\n    const uriStr = linkUri.toString();\n    console.log(\"####### >>> ---\");\n    console.log(activeWebView.READIUM2.id);\n    console.log(pubLink.Href);\n    console.log(linkUri.hash()); // with #\n    console.log(linkUri.fragment()); // without #\n    // tslint:disable-next-line:no-string-literal\n    console.log(linkUri.search(true)[URL_PARAM_GOTO]);\n    // tslint:disable-next-line:no-string-literal\n    console.log(linkUri.search(true)[URL_PARAM_PREVIOUS]);\n    console.log(\"####### >>> ---\");\n    activeWebView.READIUM2.link = pubLink;\n\n    const needConvert = _publicationJsonUrl.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\");\n    const uriStr_ = uriStr.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\") ?\n        uriStr : (needConvert ? convertHttpUrlToCustomScheme(uriStr) : uriStr);\n    console.log(\"setAttribute SRC:\");\n    console.log(uriStr_);\n    activeWebView.setAttribute(\"src\", uriStr_);\n    // activeWebView.getWebContents().loadURL(uriStr_, { extraHeaders: \"pragma: no-cache\\n\" });\n    // activeWebView.loadURL(uriStr_, { extraHeaders: \"pragma: no-cache\\n\" });\n\n    // ALWAYS FALSE => let's comment for now...\n    // const enableOffScreenRenderPreload = false;\n    // if (enableOffScreenRenderPreload) {\n    //     setTimeout(() => {\n    //         if (!_publication || !pubLink) {\n    //             return;\n    //         }\n\n    //         const otherWebview = activeWebView === _webview2 ? _webview1 : _webview2;\n\n    //         // let inSpine = true;\n    //         const index = _publication.Spine.indexOf(pubLink);\n    //         // if (!index) {\n    //         //     inSpine = false;\n    //         //     index = _publication.Resources.indexOf(pubLink);\n    //         // }\n    //         if (index >= 0 &&\n    //             previous && (index - 1) >= 0 ||\n    //             !previous && (index + 1) < _publication.Spine.length\n    //             // (index + 1) < (inSpine ? _publication.Spine.length : _publication.Resources.length)\n    //         ) {\n    //             const nextPubLink = _publication.Spine[previous ? (index - 1) : (index + 1)];\n    //             // (inSpine ? _publication.Spine[index + 1] : _publication.Resources[index + 1]);\n\n    //             if (otherWebview.READIUM2.link !== nextPubLink) {\n    //                 const linkUriNext = new URI(_publicationJsonUrl + \"/../\" + nextPubLink.Href);\n    //                 linkUriNext.normalizePath();\n    //                 linkUriNext.search((data: any) => {\n    //                     // overrides existing (leaves others intact)\n\n    //                     // tslint:disable-next-line:no-string-literal\n    //                     data[URL_PARAM_CSS] = rcssJsonstrBase64;\n    //                 });\n    //                 const uriStrNext = linkUriNext.toString();\n\n    //                 console.log(\"####### ======\");\n    //                 console.log(otherWebview.READIUM2.id);\n    //                 console.log(nextPubLink.Href);\n    //                 console.log(linkUriNext.hash()); // with #\n    //                 console.log(linkUriNext.fragment()); // without #\n    //                 // tslint:disable-next-line:no-string-literal\n    //                 console.log(linkUriNext.search(true)[URL_PARAM_GOTO]);\n    //                 // tslint:disable-next-line:no-string-literal\n    //                 console.log(linkUriNext.search(true)[URL_PARAM_PREVIOUS]);\n    //                 console.log(\"####### ======\");\n    //                 otherWebview.READIUM2.link = nextPubLink;\n    //                 otherWebview.setAttribute(\"src\", uriStrNext);\n    //             }\n    //         }\n    //     }, 300);\n    // }\n}\n\nfunction createWebView(preloadScriptPath: string): IElectronWebviewTag {\n    const wv = document.createElement(\"webview\");\n    wv.setAttribute(\"webpreferences\",\n        \"nodeIntegration=0, nodeIntegrationInWorker=0, sandbox=0, javascript=1, \" +\n        \"contextIsolation=0, webSecurity=1, allowRunningInsecureContent=0\");\n    wv.setAttribute(\"partition\", R2_SESSION_WEBVIEW);\n    if (_publicationJsonUrl) {\n        // const ref = _publicationJsonUrl.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\") ?\n        //     _publicationJsonUrl : convertHttpUrlToCustomScheme(_publicationJsonUrl);\n        wv.setAttribute(\"httpreferrer\", _publicationJsonUrl);\n    }\n    wv.setAttribute(\"style\", \"display: flex; margin: 0; padding: 0; box-sizing: border-box; \" +\n        \"position: absolute; left: 0; width: 50%; bottom: 0; top: 0;\");\n    wv.setAttribute(\"preload\", preloadScriptPath);\n    wv.setAttribute(\"disableguestresize\", \"\");\n    setTimeout(() => {\n        wv.removeAttribute(\"tabindex\");\n    }, 500);\n\n    wv.addEventListener(\"dom-ready\", () => {\n        // wv.openDevTools();\n        wv.clearHistory();\n    });\n\n    wv.addEventListener(\"ipc-message\", (event: Electron.IpcMessageEvent) => {\n        const webview = event.currentTarget as IElectronWebviewTag;\n        const activeWebView = getActiveWebView();\n        if (webview !== activeWebView) {\n            return;\n        }\n\n        if (event.channel === R2_EVENT_LINK) {\n            const payload = event.args[0] as IEventPayload_R2_EVENT_LINK;\n            handleLink(payload.url, undefined, false);\n        } else if (event.channel === R2_EVENT_WEBVIEW_READY) {\n            const payload = event.args[0] as IEventPayload_R2_EVENT_WEBVIEW_READY;\n            console.log(\"WEBVIEW READY: \" + payload.href);\n\n            if (_rootHtmlElement) {\n                _rootHtmlElement.dispatchEvent(new Event(DOM_EVENT_SHOW_VIEWPORT));\n            }\n        } else if (event.channel === R2_EVENT_READING_LOCATION) {\n            const payload = event.args[0] as IEventPayload_R2_EVENT_READING_LOCATION;\n            if (webview.READIUM2.link && _saveReadingLocation) {\n                _saveReadingLocation(webview.READIUM2.link.Href, payload.cssSelector);\n            }\n        } else if (event.channel === R2_EVENT_PAGE_TURN_RES) {\n            if (!_publication) {\n                return;\n            }\n            // const isRTL = _publication.Metadata &&\n            // _publication.Metadata.Direction &&\n            // _publication.Metadata.Direction.toLowerCase() === \"rtl\"; //  any other value is LTR\n\n            const payload = event.args[0] as IEventPayload_R2_EVENT_PAGE_TURN;\n\n            // const isRTL = messageJson.direction === \"RTL\"; //  any other value is LTR\n            const goPREVIOUS = payload.go === \"PREVIOUS\"; // any other value is NEXT\n\n            if (!webview.READIUM2.link) {\n                console.log(\"WEBVIEW READIUM2_LINK ??!!\");\n                return;\n            }\n\n            let nextOrPreviousSpineItem: Link | undefined;\n            for (let i = 0; i < _publication.Spine.length; i++) {\n                if (_publication.Spine[i] === webview.READIUM2.link) {\n                    if (goPREVIOUS && (i - 1) >= 0) {\n                        nextOrPreviousSpineItem = _publication.Spine[i - 1];\n                    } else if (!goPREVIOUS && (i + 1) < _publication.Spine.length) {\n                        nextOrPreviousSpineItem = _publication.Spine[i + 1];\n                    }\n                    break;\n                }\n            }\n            if (!nextOrPreviousSpineItem) {\n                return;\n            }\n            if (_publicationJsonUrl) {\n                const linkHref = _publicationJsonUrl + \"/../\" + nextOrPreviousSpineItem.Href;\n                handleLink(linkHref, goPREVIOUS, false);\n            }\n        } else {\n            console.log(\"webview1 ipc-message\");\n            console.log(event.channel);\n        }\n    });\n\n    return wv as IElectronWebviewTag;\n}\n\nconst adjustResize = (webview: IElectronWebviewTag) => {\n    const width = webview.clientWidth;\n    const height = webview.clientHeight;\n    const wc = webview.getWebContents();\n    if (wc && width && height) {\n        wc.setSize({\n            normal: {\n                height,\n                width,\n            },\n        });\n    }\n};\n\nconst onResizeDebounced = debounce(() => {\n    adjustResize(_webview1);\n    adjustResize(_webview2);\n\n    setTimeout(() => {\n        if (_rootHtmlElement) {\n            _rootHtmlElement.dispatchEvent(new Event(DOM_EVENT_SHOW_VIEWPORT));\n        }\n    }, 1000);\n}, 200);\n\nwindow.addEventListener(\"resize\", () => {\n    if (!isFixedLayout(_webview1.READIUM2.link)) {\n        if (_rootHtmlElement) {\n            _rootHtmlElement.dispatchEvent(new Event(DOM_EVENT_HIDE_VIEWPORT));\n        }\n    }\n    onResizeDebounced();\n});\n\nipcRenderer.on(R2_EVENT_LINK, (_event: any, payload: IEventPayload_R2_EVENT_LINK) => {\n    console.log(\"R2_EVENT_LINK\");\n    console.log(payload.url);\n    handleLink(payload.url, undefined, false);\n});\n"]}