{"version":3,"file":"audiobook.js","sourceRoot":"","sources":["../../../../../../src/electron/renderer/webview/audiobook.ts"],"names":[],"mappings":"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","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport { debounce } from \"debounce\";\nimport { ipcRenderer } from \"electron\";\n\nimport { DEBUG_AUDIO } from \"../../common/audiobook\";\nimport {\n    IEventPayload_R2_EVENT_AUDIO_PLAYBACK_RATE, IEventPayload_R2_EVENT_PAGE_TURN,\n    IEventPayload_R2_EVENT_READING_LOCATION, R2_EVENT_AUDIO_DO_PAUSE, R2_EVENT_AUDIO_DO_PLAY,\n    R2_EVENT_AUDIO_FORWARD, R2_EVENT_AUDIO_PLAYBACK_RATE, R2_EVENT_AUDIO_REWIND,\n    R2_EVENT_AUDIO_TOGGLE_PLAY_PAUSE, R2_EVENT_PAGE_TURN_RES, R2_EVENT_READING_LOCATION,\n} from \"../../common/events\";\nimport {\n    AUDIO_BUFFER_CANVAS_ID, AUDIO_COVER_ID, AUDIO_FORWARD_ID, AUDIO_ID, AUDIO_NEXT_ID,\n    AUDIO_PERCENT_ID, AUDIO_PLAYPAUSE_ID, AUDIO_PREVIOUS_ID, AUDIO_PROGRESS_CLASS, AUDIO_RATE_ID,\n    AUDIO_REWIND_ID, AUDIO_SLIDER_ID, AUDIO_TIME_ID,\n} from \"../../common/styles\";\nimport { IReadiumElectronWebviewWindow } from \"./state\";\n\nconst win = (global as any).window as IReadiumElectronWebviewWindow;\n\nfunction throttle(fn: (...argz: any[]) => any, time: number) {\n    let called = false;\n    return (...args: any[]) => {\n        if (!called) {\n            fn(...args);\n            called = true;\n            setTimeout(() => {\n                called = false;\n            }, time);\n        }\n    };\n}\n\nexport function setupAudioBook(_docTitle: string | undefined, audioPlaybackRate: number | undefined) {\n\n    win.document.documentElement.classList.add(AUDIO_PROGRESS_CLASS);\n\n    const coverElement = win.document.getElementById(AUDIO_COVER_ID) as HTMLImageElement;\n    const audioElement = win.document.getElementById(AUDIO_ID) as HTMLAudioElement;\n    const sliderElement = win.document.getElementById(AUDIO_SLIDER_ID) as HTMLInputElement;\n    const timeElement = win.document.getElementById(AUDIO_TIME_ID) as HTMLSpanElement;\n    const percentElement = win.document.getElementById(AUDIO_PERCENT_ID) as HTMLSpanElement;\n    const playPauseElement = win.document.getElementById(AUDIO_PLAYPAUSE_ID) as HTMLButtonElement;\n    const previousElement = win.document.getElementById(AUDIO_PREVIOUS_ID) as HTMLButtonElement;\n    const nextElement = win.document.getElementById(AUDIO_NEXT_ID) as HTMLButtonElement;\n    const rewindElement = win.document.getElementById(AUDIO_REWIND_ID) as HTMLButtonElement;\n    const forwardElement = win.document.getElementById(AUDIO_FORWARD_ID) as HTMLButtonElement;\n    const rateElement = win.document.getElementById(AUDIO_RATE_ID) as HTMLSelectElement;\n\n    if (audioPlaybackRate) {\n        rateElement.value = `${audioPlaybackRate}`;\n    } else {\n        rateElement.value = `${audioElement.playbackRate}`;\n    }\n    rateElement.addEventListener(\"change\", () => {\n        const speed = parseFloat(rateElement.value);\n        audioElement.playbackRate = speed;\n\n        const payload: IEventPayload_R2_EVENT_AUDIO_PLAYBACK_RATE = {\n            speed,\n        };\n        ipcRenderer.sendToHost(R2_EVENT_AUDIO_PLAYBACK_RATE, payload);\n    });\n    // audioElement.addEventListener(\"ratechange\", () => {\n    //     // TODO: what if select/option does not include the string value?\n    //     rateElement.value = `${audioElement.playbackRate}`;\n    // });\n\n    function refreshTimeElements(p: number) {\n\n        const prettyPercent = (percentElement as any).displayAlt ? `${p}%` : `${formatTime(audioElement.duration)}`;\n        percentElement.innerText = prettyPercent;\n\n        // const prettyTime = `${formatTime(audioElement.currentTime)} / ${formatTime(audioElement.duration)}`;\n        const prettyTime = (timeElement as any).displayAlt ?\n            `-${formatTime(audioElement.duration - audioElement.currentTime)}` :\n            `${formatTime(audioElement.currentTime)}`;\n        timeElement.innerText = prettyTime;\n    }\n\n    function onTimeElementsClick(el: any) {\n\n        if (el.displayAlt) {\n            el.displayAlt = false;\n        } else {\n            el.displayAlt = true;\n        }\n\n        const percent = audioElement.currentTime / audioElement.duration;\n        const p = Math.round(percent * 100);\n        refreshTimeElements(p);\n    }\n    timeElement.addEventListener(\"click\", () => {\n        onTimeElementsClick(timeElement);\n    });\n    percentElement.addEventListener(\"click\", () => {\n        onTimeElementsClick(percentElement);\n    });\n\n    const bufferCanvasElement = DEBUG_AUDIO ?\n        win.document.getElementById(AUDIO_BUFFER_CANVAS_ID) as HTMLCanvasElement : undefined;\n    if (bufferCanvasElement) {\n        const context = bufferCanvasElement.getContext(\"2d\");\n        if (context) {\n\n            const refreshBufferCanvas = () => {\n                const pixelsPerSecond = bufferCanvasElement.width / audioElement.duration;\n\n                context.fillStyle = \"red\";\n                context.fillRect(0, 0, bufferCanvasElement.width, bufferCanvasElement.height);\n\n                context.fillStyle = \"green\";\n                context.strokeStyle = \"magenta\";\n\n                console.log(`audio -- buffered.length: ${audioElement.buffered.length}`);\n                for (let i = 0; i < audioElement.buffered.length; i++) {\n\n                    const start = audioElement.buffered.start(i);\n                    const end = audioElement.buffered.end(i);\n\n                    console.log(`audio -- buffered: ${start} ... ${end}`);\n\n                    const x1 = start * pixelsPerSecond;\n                    const x2 = end * pixelsPerSecond;\n                    const w = x2 - x1;\n\n                    context.fillRect(x1, 0, w, bufferCanvasElement.height);\n                    context.rect(x1, 0, w, bufferCanvasElement.height);\n                    context.stroke();\n                }\n            };\n            const refreshBufferCanvasThrottled = throttle(() => {\n                refreshBufferCanvas();\n            }, 500);\n\n            context.fillStyle = \"silver\";\n            context.fillRect(0, 0, bufferCanvasElement.width, bufferCanvasElement.height);\n\n            audioElement.addEventListener(\"timeupdate\", () => {\n                if (audioElement.duration <= 0) {\n                    return;\n                }\n                refreshBufferCanvasThrottled();\n            });\n        }\n    }\n\n    function rewind() {\n        const newTime = Math.max(0, audioElement.currentTime - 30);\n        audioElement.currentTime = newTime;\n        // if (newTime < 0.5) {\n        //     const payload: IEventPayload_R2_EVENT_PAGE_TURN = {\n        //         direction: \"LTR\",\n        //         go: \"PREVIOUS\",\n        //     };\n        //     ipcRenderer.sendToHost(R2_EVENT_PAGE_TURN_RES, payload);\n        // } else {\n        //     audioElement.currentTime = newTime;\n        // }\n    }\n    rewindElement.addEventListener(\"click\", () => {\n        rewind();\n    });\n    function forward() {\n        const newTime = Math.min(audioElement.duration, audioElement.currentTime + 30);\n        audioElement.currentTime = newTime;\n        // if (newTime >= audioElement.duration - 0.5) {\n        //     const payload: IEventPayload_R2_EVENT_PAGE_TURN = {\n        //         direction: \"LTR\",\n        //         go: \"NEXT\",\n        //     };\n        //     ipcRenderer.sendToHost(R2_EVENT_PAGE_TURN_RES, payload);\n        // } else {\n        //     audioElement.currentTime = newTime;\n        // }\n    }\n    forwardElement.addEventListener(\"click\", () => {\n        forward();\n    });\n\n    previousElement.addEventListener(\"click\", () => {\n        const payload: IEventPayload_R2_EVENT_PAGE_TURN = {\n            direction: \"LTR\",\n            go: \"PREVIOUS\",\n        };\n        ipcRenderer.sendToHost(R2_EVENT_PAGE_TURN_RES, payload);\n    });\n    nextElement.addEventListener(\"click\", () => {\n        const payload: IEventPayload_R2_EVENT_PAGE_TURN = {\n            direction: \"LTR\",\n            go: \"NEXT\",\n        };\n        ipcRenderer.sendToHost(R2_EVENT_PAGE_TURN_RES, payload);\n    });\n\n    // const debounceSlider = debounce((wasPlaying: boolean | undefined) => {\n    //     const p = sliderElement.valueAsNumber / 100;\n    //     audioElement.currentTime = audioElement.duration * p;\n    //     if (wasPlaying) {\n    //         setTimeout(async () => {\n    //             await audioElement.play();\n    //         }, 200);\n    //     }\n    // }, 500);\n    sliderElement.addEventListener(\"input\", () => {\n\n        const p = sliderElement.valueAsNumber / 100;\n        audioElement.currentTime = audioElement.duration * p;\n\n        sliderElement.style.setProperty(\"--audiopercent\", `${sliderElement.valueAsNumber}%`);\n\n        // const wasPlaying = win.READIUM2.locationHashOverrideInfo?.audioPlaybackInfo?.isPlaying;\n        // audioElement.pause();\n        // debounceSlider(wasPlaying);\n    });\n    function togglePlayPause() {\n        if (win.READIUM2.locationHashOverrideInfo &&\n            win.READIUM2.locationHashOverrideInfo.audioPlaybackInfo) {\n            const isPlaying = win.READIUM2.locationHashOverrideInfo.audioPlaybackInfo.isPlaying;\n            if (isPlaying) {\n                audioElement.pause();\n            } else {\n                if (audioElement.currentTime >= audioElement.duration - 0.5) {\n                    const payload: IEventPayload_R2_EVENT_PAGE_TURN = {\n                        direction: \"LTR\",\n                        go: \"NEXT\",\n                    };\n                    ipcRenderer.sendToHost(R2_EVENT_PAGE_TURN_RES, payload);\n                } else {\n                    setTimeout(async () => {\n                        await audioElement.play();\n                    }, 0);\n                }\n            }\n        }\n    }\n    coverElement.addEventListener(\"mouseup\", (ev) => {\n        if (ev.button === 0) {\n            togglePlayPause();\n        }\n    });\n    playPauseElement.addEventListener(\"click\", () => {\n        togglePlayPause();\n    });\n\n    function formatTime(seconds: number): string {\n        const secondsPerMinute = 60;\n        const minutesPerHours = 60;\n        const secondsPerHour = minutesPerHours * secondsPerMinute;\n        let remainingSeconds = seconds;\n        const nHours = Math.floor(remainingSeconds / secondsPerHour);\n        remainingSeconds -= (nHours * secondsPerHour);\n        if (remainingSeconds < 0) {\n            remainingSeconds = 0;\n        }\n        const nMinutes = Math.floor(remainingSeconds / secondsPerMinute);\n        remainingSeconds -= (nMinutes * secondsPerMinute);\n        if (remainingSeconds < 0) {\n            remainingSeconds = 0;\n        }\n        remainingSeconds = Math.floor(remainingSeconds);\n        return `${nHours > 0 ? (nHours.toString().padStart(2, \"0\") + \":\") : ``}${nMinutes > 0 ? (nMinutes.toString().padStart(2, \"0\") + \":\") : `00:`}${remainingSeconds > 0 ? (remainingSeconds.toString().padStart(2, \"0\")) : `00`}`;\n    }\n\n    function notifyPlaybackLocation() {\n        const percent = audioElement.currentTime / audioElement.duration;\n        const p = Math.round(percent * 100);\n\n        refreshTimeElements(p);\n\n        // sliderElement.value = \"\" + p;\n        sliderElement.valueAsNumber = p;\n        sliderElement.style.setProperty(\"--audiopercent\", `${p}%`);\n\n        win.READIUM2.locationHashOverrideInfo = {\n            audioPlaybackInfo: {\n                globalDuration: undefined,\n                globalProgression: undefined,\n                globalTime: undefined,\n                isPlaying: (audioElement as any).isPlaying,\n                localDuration: audioElement.duration,\n                localProgression: percent,\n                localTime: audioElement.currentTime,\n            },\n            docInfo: {\n                isFixedLayout: false,\n                isRightToLeft: false,\n                isVerticalWritingMode: false,\n            },\n            epubPage: undefined,\n            href: \"\", // filled-in from host index.js renderer\n            locations: {\n                cfi: undefined,\n                cssSelector: undefined,\n                    // calculated in host index.js renderer, where publication object is available\n                position: undefined,\n                progression: percent,\n            },\n            paginationInfo: undefined,\n            selectionInfo: undefined,\n            selectionIsNew: undefined,\n            text: undefined,\n            title: _docTitle,\n        };\n        const payload: IEventPayload_R2_EVENT_READING_LOCATION = win.READIUM2.locationHashOverrideInfo;\n        ipcRenderer.sendToHost(R2_EVENT_READING_LOCATION, payload);\n    }\n    const notifyPlaybackLocationThrottled = throttle(() => {\n        notifyPlaybackLocation();\n    }, 1000);\n\n    // const notifyPlaybackLocationDebounced = debounce(() => {\n    //     notifyPlaybackLocation();\n    // }, 200);\n\n    const progressDebounced = debounce((progress: boolean) => {\n        if (progress) {\n            win.document.documentElement.classList.add(AUDIO_PROGRESS_CLASS);\n        } else {\n            win.document.documentElement.classList.remove(AUDIO_PROGRESS_CLASS);\n        }\n    }, 150);\n\n    audioElement.addEventListener(\"play\", () => {\n        (audioElement as any).isPlaying = true;\n        playPauseElement.classList.add(\"pause\");\n        notifyPlaybackLocation();\n    });\n    audioElement.addEventListener(\"pause\", () => {\n        (audioElement as any).isPlaying = false;\n        playPauseElement.classList.remove(\"pause\");\n        notifyPlaybackLocation();\n    });\n    audioElement.addEventListener(\"seeking\", () => {\n        progressDebounced(true);\n    });\n    audioElement.addEventListener(\"canplay\", () => {\n        progressDebounced(false);\n    });\n    audioElement.addEventListener(\"ended\", () => {\n        (audioElement as any).isPlaying = false;\n        playPauseElement.classList.remove(\"pause\");\n        notifyPlaybackLocation();\n        const payload: IEventPayload_R2_EVENT_PAGE_TURN = {\n            direction: \"LTR\",\n            go: \"NEXT\",\n        };\n        ipcRenderer.sendToHost(R2_EVENT_PAGE_TURN_RES, payload);\n    });\n\n    audioElement.addEventListener(\"timeupdate\", () => {\n        // (audioElement as any).isPlaying = true;\n        notifyPlaybackLocationThrottled();\n    });\n\n    ipcRenderer.on(R2_EVENT_AUDIO_DO_PLAY, async (_event: any) => {\n        await audioElement.play();\n    });\n    ipcRenderer.on(R2_EVENT_AUDIO_DO_PAUSE, (_event: any) => {\n        audioElement.pause();\n    });\n    ipcRenderer.on(R2_EVENT_AUDIO_DO_PLAY, async (_event: any) => {\n        await audioElement.play();\n    });\n    ipcRenderer.on(R2_EVENT_AUDIO_TOGGLE_PLAY_PAUSE, (_event: any) => {\n        togglePlayPause();\n    });\n    ipcRenderer.on(R2_EVENT_AUDIO_REWIND, (_event: any) => {\n        rewind();\n    });\n    ipcRenderer.on(R2_EVENT_AUDIO_FORWARD, (_event: any) => {\n        forward();\n    });\n    // ipcRenderer.on(R2_EVENT_AUDIO_PLAYBACK_RATE,\n    //     (_event: any, payload: IEventPayload_R2_EVENT_AUDIO_PLAYBACK_RATE) => {\n\n    //     audioElement.playbackRate = payload.speed;\n    // });\n}\n"]}