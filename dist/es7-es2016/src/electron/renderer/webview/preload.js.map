{"version":3,"file":"preload.js","sourceRoot":"","sources":["../../../../../../src/electron/renderer/webview/preload.ts"],"names":[],"mappings":"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","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport ResizeSensor = require(\"css-element-queries/src/ResizeSensor\");\n// import ResizeSensor = require(\"resize-sensor/ResizeSensor\");\n\nimport debounce = require(\"debounce\");\n\nimport { ipcRenderer } from \"electron\";\n\nimport {\n    IEventPayload_R2_EVENT_LINK,\n    IEventPayload_R2_EVENT_PAGE_TURN,\n    IEventPayload_R2_EVENT_READING_LOCATION,\n    IEventPayload_R2_EVENT_SCROLLTO,\n    IEventPayload_R2_EVENT_WEBVIEW_READY,\n    R2_EVENT_LINK,\n    R2_EVENT_PAGE_TURN,\n    R2_EVENT_PAGE_TURN_RES,\n    R2_EVENT_READING_LOCATION,\n    R2_EVENT_SCROLLTO,\n    R2_EVENT_WEBVIEW_READY,\n} from \"../../common/events\";\n// import { READIUM2_ELECTRON_HTTP_PROTOCOL } from \"../../common/sessions\";\nimport { IPropertyAnimationState, animateProperty } from \"../common/animateProperty\";\nimport { fullQualifiedSelector } from \"../common/cssselector\";\nimport { easings } from \"../common/easings\";\nimport { getURLQueryParams } from \"../common/querystring\";\nimport { URL_PARAM_CSS, URL_PARAM_EPUBREADINGSYSTEM, URL_PARAM_GOTO, URL_PARAM_PREVIOUS } from \"../common/url-params\";\nimport { setWindowNavigatorEpubReadingSystem } from \"./epubReadingSystem\";\nimport {\n    DEBUG_VISUALS,\n    configureFixedLayout,\n    injectDefaultCSS,\n    injectReadPosCSS,\n    isRTL,\n    isVerticalWritingMode,\n    readiumCSS,\n} from \"./readium-css\";\nimport { IElectronWebviewTagWindow } from \"./state\";\n\nimport { consoleRedirect } from \"../console-redirect\";\n\n// const releaseConsoleRedirect =\nconsoleRedirect(\"r2:navigator#electron/renderer/webview/preload\", process.stdout, process.stderr, true);\n\n// webFrame.registerURLSchemeAsSecure(READIUM2_ELECTRON_HTTP_PROTOCOL);\n// webFrame.registerURLSchemeAsBypassingCSP(READIUM2_ELECTRON_HTTP_PROTOCOL);\n// webFrame.registerURLSchemeAsPrivileged(READIUM2_ELECTRON_HTTP_PROTOCOL, {\n//     allowServiceWorkers: false,\n//     bypassCSP: false,\n//     corsEnabled: false,\n//     secure: true,\n//     supportFetchAPI: false,\n// });\n\nconst win = (global as any).window as IElectronWebviewTagWindow;\nwin.READIUM2 = {\n    fxlViewportHeight: 0,\n    fxlViewportWidth: 0,\n    hashElement: null,\n    isFixedLayout: false,\n    locationHashOverride: undefined,\n    locationHashOverrideCFI: undefined,\n    locationHashOverrideCSSselector: undefined,\n    readyEventSent: false,\n    readyPassDone: false,\n    urlQueryParams: undefined,\n};\n\nwin.READIUM2.urlQueryParams = win.location.search ? getURLQueryParams(win.location.search) : undefined;\n\nif (win.READIUM2.urlQueryParams) {\n    let readiumEpubReadingSystemJson: any = {};\n\n    // tslint:disable-next-line:no-string-literal\n    const base64EpubReadingSystem = win.READIUM2.urlQueryParams[URL_PARAM_EPUBREADINGSYSTEM];\n    if (base64EpubReadingSystem) {\n        try {\n            const str = window.atob(base64EpubReadingSystem);\n            readiumEpubReadingSystemJson = JSON.parse(str);\n        } catch (err) {\n            console.log(err);\n        }\n    }\n\n    if (readiumEpubReadingSystemJson) {\n        setWindowNavigatorEpubReadingSystem(win, readiumEpubReadingSystemJson);\n    }\n}\n\n// console.log(\"-----\");\n// console.log(win.location.href);\n// console.log(win.location.origin);\n// console.log(win.location.pathname);\n// console.log(win.location.search);\n// console.log(win.location.hash);\n\nipcRenderer.on(R2_EVENT_SCROLLTO, (_event: any, payload: IEventPayload_R2_EVENT_SCROLLTO) => {\n    // console.log(\"R2_EVENT_SCROLLTO\");\n    // console.log(payload);\n\n    if (!win.READIUM2.urlQueryParams) {\n        win.READIUM2.urlQueryParams = {};\n    }\n    if (payload.previous) {\n        // tslint:disable-next-line:no-string-literal\n        win.READIUM2.urlQueryParams[URL_PARAM_PREVIOUS] = \"true\";\n    } else {\n        // tslint:disable-next-line:no-string-literal\n        if (typeof win.READIUM2.urlQueryParams[URL_PARAM_PREVIOUS] !== \"undefined\") {\n            // tslint:disable-next-line:no-string-literal\n            delete win.READIUM2.urlQueryParams[URL_PARAM_PREVIOUS];\n        }\n    }\n    if (payload.goto) {\n        // tslint:disable-next-line:no-string-literal\n        win.READIUM2.urlQueryParams[URL_PARAM_GOTO] = payload.goto;\n    } else {\n        // tslint:disable-next-line:no-string-literal\n        if (typeof win.READIUM2.urlQueryParams[URL_PARAM_GOTO] !== \"undefined\") {\n            // tslint:disable-next-line:no-string-literal\n            delete win.READIUM2.urlQueryParams[URL_PARAM_GOTO];\n        }\n    }\n\n    let delayScrollIntoView = false;\n    if (payload.hash) {\n        console.log(\"R2_EVENT_SCROLLTO payload.hash: \" + payload.hash);\n        win.READIUM2.hashElement = win.document.getElementById(payload.hash);\n\n        win.location.href = \"#\" + payload.hash;\n        delayScrollIntoView = true;\n\n        // unfortunately, does not sync CSS :target pseudo-class :(\n        // win.history.replaceState({}, undefined, \"#\" + payload.hash);\n    } else {\n        win.READIUM2.hashElement = null;\n    }\n\n    win.READIUM2.readyEventSent = false;\n    win.READIUM2.locationHashOverride = undefined;\n\n    if (delayScrollIntoView) {\n        setTimeout(() => {\n            scrollToHashRaw(false);\n        }, 100);\n    } else {\n        scrollToHashRaw(false);\n    }\n\n    // const payload: IEventPayload_R2_EVENT_WEBVIEW_READY = {\n    //     href: win.location.href,\n    // };\n    // ipcRenderer.sendToHost(R2_EVENT_WEBVIEW_READY, payload);\n    // notifyReadingLocation();\n});\n\nlet _lastAnimState: IPropertyAnimationState | undefined;\n\nipcRenderer.on(R2_EVENT_PAGE_TURN, (_event: any, payload: IEventPayload_R2_EVENT_PAGE_TURN) => {\n    if (win.READIUM2.isFixedLayout || !win.document.body) {\n        ipcRenderer.sendToHost(R2_EVENT_PAGE_TURN_RES, payload);\n        return;\n    }\n\n    if (!win.document || !win.document.documentElement) {\n        return;\n    }\n\n    // console.log(\"---\");\n    // console.log(\"webview.innerWidth: \" + win.innerWidth);\n    // console.log(\"document.offsetWidth: \" + win.document.documentElement.offsetWidth);\n    // console.log(\"document.clientWidth: \" + win.document.documentElement.clientWidth);\n    // console.log(\"document.scrollWidth: \" + win.document.documentElement.scrollWidth);\n    // console.log(\"document.scrollLeft: \" + win.document.documentElement.scrollLeft);\n    // console.log(\"body.offsetWidth: \" + win.document.body.offsetWidth);\n    // console.log(\"body.clientWidth: \" + win.document.body.clientWidth);\n    // console.log(\"body.scrollWidth: \" + win.document.body.scrollWidth);\n    // console.log(\"body.scrollLeft: \" + win.document.body.scrollLeft);\n    // console.log(\"---\");\n    // console.log(\"webview.innerHeight: \" + win.innerHeight);\n    // console.log(\"document.offsetHeight: \" + win.document.documentElement.offsetHeight);\n    // console.log(\"document.clientHeight: \" + win.document.documentElement.clientHeight);\n    // console.log(\"document.scrollHeight: \" + win.document.documentElement.scrollHeight);\n    // console.log(\"document.scrollTop: \" + win.document.documentElement.scrollTop);\n    // console.log(\"body.offsetHeight: \" + win.document.body.offsetHeight);\n    // console.log(\"body.clientHeight: \" + win.document.body.clientHeight);\n    // console.log(\"body.scrollHeight: \" + win.document.body.scrollHeight);\n    // console.log(\"body.scrollTop: \" + win.document.body.scrollTop);\n    // console.log(\"---\");\n\n    // win.document.body.offsetWidth === single column width (takes into account column gap?)\n    // win.document.body.clientWidth === same\n    // win.document.body.scrollWidth === full document width (all columns)\n\n    // win.document.body.offsetHeight === full document height (sum of all columns minus trailing blank space?)\n    // win.document.body.clientHeight === same\n    // win.document.body.scrollHeight === visible viewport height\n\n    // win.document.body.scrollLeft === positive number for horizontal shift\n    // win.document.body.scrollTop === positive number for vertical shift\n\n    const isPaged = win.document.documentElement.classList.contains(\"readium-paginated\");\n    // console.log(\"isPaged: \" + isPaged);\n    // const isTwoPage = isPaged && (win.document.documentElement.offsetWidth === (win.document.body.offsetWidth * 2));\n    // const isTwoPage = isPaged && (win.document.documentElement.offsetWidth > win.document.body.offsetWidth);\n    // console.log(\"isTwoPage: \" + isTwoPage);\n    // const nColumns = isPaged ? (win.document.body.offsetHeight / win.document.body.scrollHeight) : 0;\n    // console.log(\"nColumns: \" + nColumns);\n\n    const maxHeightShift = isPaged ?\n        ((isVerticalWritingMode() ?\n            (win.document.body.scrollHeight - win.document.documentElement.offsetHeight) :\n            (win.document.body.scrollWidth - win.document.documentElement.offsetWidth))) :\n        ((isVerticalWritingMode() ?\n            (win.document.body.scrollWidth - win.document.documentElement.clientWidth) :\n            (win.document.body.scrollHeight - win.document.documentElement.clientHeight)));\n    // console.log(\"maxHeightShift: \" + maxHeightShift);\n\n    const goPREVIOUS = payload.go === \"PREVIOUS\"; // any other value is NEXT\n\n    // const isRTL = messageJson.direction === \"RTL\"; //  any other value is LTR\n    // console.log(JSON.stringify(messageJson, null, \"  \"));\n\n    if (!goPREVIOUS) { // goPREVIOUS && isRTL() || !goPREVIOUS && !isRTL()) { // right\n        if (isPaged) {\n            // console.log(\"element.scrollLeft: \" + win.document.body.scrollLeft);\n            if (Math.abs(win.document.body.scrollLeft) < maxHeightShift) { // not at end\n                if (_lastAnimState && _lastAnimState.animating) {\n                    win.cancelAnimationFrame(_lastAnimState.id);\n                    _lastAnimState.object[_lastAnimState.property] = _lastAnimState.destVal;\n                }\n                const newVal = win.document.body.scrollLeft +\n                    (isRTL() ? -1 : 1) * win.document.documentElement.offsetWidth;\n                // console.log(\"element.scrollLeft NEW: \" + newVal);\n                _lastAnimState = animateProperty(\n                    win.cancelAnimationFrame,\n                    undefined,\n                    // (cancelled: boolean) => {\n                    //     console.log(cancelled);\n                    // },\n                    \"scrollLeft\",\n                    300,\n                    win.document.body,\n                    newVal,\n                    win.requestAnimationFrame,\n                    easings.easeInOutQuad,\n                );\n                return;\n            }\n        } else {\n            // console.log(\"element.scrollTop: \" + win.document.body.scrollTop);\n            if (isVerticalWritingMode() && (Math.abs(win.document.body.scrollLeft) < maxHeightShift) ||\n                !isVerticalWritingMode() && (Math.abs(win.document.body.scrollTop) < maxHeightShift)) {\n                if (_lastAnimState && _lastAnimState.animating) {\n                    win.cancelAnimationFrame(_lastAnimState.id);\n                    _lastAnimState.object[_lastAnimState.property] = _lastAnimState.destVal;\n                }\n                const newVal = isVerticalWritingMode() ?\n                    (win.document.body.scrollLeft +\n                        (isRTL() ? -1 : 1) * win.document.documentElement.clientWidth) :\n                    (win.document.body.scrollTop +\n                        win.document.documentElement.clientHeight);\n                // console.log(\"element.scrollTop NEW: \" + newVal);\n                _lastAnimState = animateProperty(\n                    win.cancelAnimationFrame,\n                    undefined,\n                    // (cancelled: boolean) => {\n                    //     console.log(cancelled);\n                    // },\n                    isVerticalWritingMode() ? \"scrollLeft\" : \"scrollTop\",\n                    300,\n                    win.document.body,\n                    newVal,\n                    win.requestAnimationFrame,\n                    easings.easeInOutQuad,\n                );\n                return;\n            }\n        }\n    } else if (goPREVIOUS) { //  && !isRTL() || !goPREVIOUS && isRTL()) { // left\n        if (isPaged) {\n            if (Math.abs(win.document.body.scrollLeft) > 0) { // not at begin\n                if (_lastAnimState && _lastAnimState.animating) {\n                    win.cancelAnimationFrame(_lastAnimState.id);\n                    _lastAnimState.object[_lastAnimState.property] = _lastAnimState.destVal;\n                }\n                const newVal = win.document.body.scrollLeft -\n                    (isRTL() ? -1 : 1) * win.document.documentElement.offsetWidth;\n                // console.log(\"element.scrollLeft NEW: \" + newVal);\n                _lastAnimState = animateProperty(\n                    win.cancelAnimationFrame,\n                    undefined,\n                    // (cancelled: boolean) => {\n                    //     console.log(cancelled);\n                    // },\n                    \"scrollLeft\",\n                    300,\n                    win.document.body,\n                    newVal,\n                    win.requestAnimationFrame,\n                    easings.easeInOutQuad,\n                );\n                return;\n            }\n        } else {\n            if (isVerticalWritingMode() && (Math.abs(win.document.body.scrollLeft) > 0) ||\n                !isVerticalWritingMode() && (Math.abs(win.document.body.scrollTop) > 0)) {\n                if (_lastAnimState && _lastAnimState.animating) {\n                    win.cancelAnimationFrame(_lastAnimState.id);\n                    _lastAnimState.object[_lastAnimState.property] = _lastAnimState.destVal;\n                }\n                const newVal = isVerticalWritingMode() ?\n                    (win.document.body.scrollLeft -\n                        (isRTL() ? -1 : 1) * win.document.documentElement.clientWidth) :\n                    (win.document.body.scrollTop -\n                        win.document.documentElement.clientHeight);\n                // console.log(\"element.scrollTop NEW: \" + newVal);\n                _lastAnimState = animateProperty(\n                    win.cancelAnimationFrame,\n                    undefined,\n                    // (cancelled: boolean) => {\n                    //     console.log(cancelled);\n                    // },\n                    isVerticalWritingMode() ? \"scrollLeft\" : \"scrollTop\",\n                    300,\n                    win.document.body,\n                    newVal,\n                    win.requestAnimationFrame,\n                    easings.easeInOutQuad,\n                );\n                return;\n            }\n        }\n    }\n\n    ipcRenderer.sendToHost(R2_EVENT_PAGE_TURN_RES, payload);\n});\n\nconst checkReadyPass = () => {\n    if (win.READIUM2.readyPassDone) {\n        return;\n    }\n    win.READIUM2.readyPassDone = true;\n\n    if (DEBUG_VISUALS) {\n        if (win.READIUM2.hashElement) {\n            win.READIUM2.hashElement.classList.add(\"readium2-read-pos\");\n        }\n    }\n\n    // assumes debounced from outside (Electron's webview object embedded in main renderer process HTML)\n    win.addEventListener(\"resize\", () => {\n        configureFixedLayout(win.READIUM2.isFixedLayout);\n\n        scrollToHashRaw(false);\n        // scrollToHash(); // debounced\n    });\n\n    // const docElement = win.document.documentElement;\n    // let skipFirstResize = docElement.getAttribute(\"data-readiumcss\") || false;\n    // let skipFirstScroll = skipFirstResize;\n\n    setTimeout(() => {\n        if (!win.READIUM2.isFixedLayout) {\n            scrollToHashRaw(true);\n        }\n\n        win.addEventListener(\"scroll\", (_ev: Event) => {\n\n            if (_ignoreScrollEvent) {\n                _ignoreScrollEvent = false;\n                return;\n            }\n            // if (skipFirstScroll) {\n            //     skipFirstScroll = false;\n            //     return;\n            // }\n\n            if (!win.document || !win.document.documentElement) {\n                return;\n            }\n\n            const x = (isRTL() ? win.document.documentElement.offsetWidth - 1 : 0);\n            processXY(x, 0);\n        });\n\n    }, 800);\n\n    const useResizeSensor = !win.READIUM2.isFixedLayout;\n    if (useResizeSensor && win.document.body) {\n\n        setTimeout(() => {\n            window.requestAnimationFrame((_timestamp) => {\n                // tslint:disable-next-line:no-unused-expression\n                new ResizeSensor(win.document.body, () => {\n\n                    console.log(\"ResizeSensor\");\n\n                    scrollToHash();\n\n                    // if (skipFirstResize) {\n                    //     console.log(\"ResizeSensor SKIP FIRST\");\n\n                    //     skipFirstResize = false;\n                    //     return;\n                    // } else {\n                    //     console.log(\"ResizeSensor\");\n                    // }\n                });\n            });\n        }, 2000);\n    }\n\n    if (win.document.body) {\n\n        win.document.body.addEventListener(\"click\", (ev: MouseEvent) => {\n\n            const x = ev.clientX; // win.document.body.scrollLeft;\n            const y = ev.clientY; // win.document.body.scrollTop;\n\n            processXY(x, y);\n        });\n    }\n};\n\nconst notifyReady = () => {\n    if (win.READIUM2.readyEventSent) {\n        return;\n    }\n    win.READIUM2.readyEventSent = true;\n\n    const payload: IEventPayload_R2_EVENT_WEBVIEW_READY = {\n        href: win.location.href,\n    };\n    ipcRenderer.sendToHost(R2_EVENT_WEBVIEW_READY, payload);\n};\n\nfunction scrollIntoView(element: HTMLElement) {\n\n    if (!win.document || !win.document.documentElement) {\n        return;\n    }\n\n    if (!win.document.body) {\n        return;\n    }\n    // console.log(\"element.offsetTop: \" + element.offsetTop);\n    // console.log(\"win.document.body.scrollHeight: \" + win.document.body.scrollHeight);\n\n    // TODO: element.offsetTop probably breaks in nested DOM / CSS box contexts (relative to...)\n\n    let colIndex = (element.offsetTop + (isRTL() ? -20 : +20)) / win.document.body.scrollHeight;\n    // console.log(\"colIndex: \" + colIndex);\n    colIndex = Math.ceil(colIndex); // 1-based index\n\n    const isTwoPage = win.document.documentElement.offsetWidth > win.document.body.offsetWidth;\n    const spreadIndex = isTwoPage ? Math.ceil(colIndex / 2) : colIndex;\n    // console.log(\"spreadIndex: \" + spreadIndex);\n\n    // console.log(\"element.getBoundingClientRect().top: \" + element.getBoundingClientRect().top);\n    // console.log(\"element.getBoundingClientRect().left: \" + element.getBoundingClientRect().left);\n\n    // const top = (colIndex * win.document.body.scrollHeight) + element.getBoundingClientRect().top;\n    // console.log(\"top: \" + top);\n\n    // const left = (colIndex * win.document.body.offsetWidth);\n    const left = ((spreadIndex - 1) * win.document.documentElement.offsetWidth);\n    // console.log(\"left: \" + left);\n\n    win.document.body.scrollLeft = (isRTL() ? -1 : 1) * left;\n}\n\nconst scrollToHashRaw = (firstCall: boolean) => {\n\n    // console.log(\"scrollToHash: \" + firstCall);\n\n    if (!win.document || !win.document.documentElement) {\n        return;\n    }\n\n    const isPaged = win.document.documentElement.classList.contains(\"readium-paginated\");\n\n    if (win.READIUM2.locationHashOverride) {\n\n        // console.log(\"win.READIUM2.locationHashOverride\");\n\n        if (win.READIUM2.locationHashOverride === win.document.body) {\n            console.log(\"body...\");\n\n            return;\n        }\n\n        notifyReady();\n        notifyReadingLocation();\n\n        _ignoreScrollEvent = true;\n        if (isPaged) {\n            scrollIntoView(win.READIUM2.locationHashOverride as HTMLElement);\n        } else {\n            win.READIUM2.locationHashOverride.scrollIntoView({\n                behavior: \"instant\",\n                block: \"start\",\n                inline: \"start\",\n            });\n        }\n\n        return;\n    } else if (win.READIUM2.hashElement) {\n\n        console.log(\"win.READIUM2.hashElement\");\n\n        win.READIUM2.locationHashOverride = win.READIUM2.hashElement;\n        // win.READIUM2.locationHashOverrideCSSselector =\n        // fullQualifiedSelector(win.READIUM2.locationHashOverride, false);\n\n        notifyReady();\n        notifyReadingLocation();\n\n        if (!firstCall) {\n            _ignoreScrollEvent = true;\n            if (isPaged) {\n                scrollIntoView(win.READIUM2.hashElement as HTMLElement);\n            } else {\n                win.READIUM2.hashElement.scrollIntoView({\n                    behavior: \"instant\",\n                    block: \"start\",\n                    inline: \"start\",\n                });\n            }\n        }\n\n        // win.READIUM2.hashElement.classList.add(\"readium2-hash\");\n        // setTimeout(() => {\n        //     if (win.READIUM2.hashElement) {\n        //         win.READIUM2.hashElement.classList.remove(\"readium2-hash\");\n        //     }\n        // }, 1000);\n\n        return;\n    } else {\n        if (win.document.body) {\n\n            if (win.READIUM2.urlQueryParams) {\n                // tslint:disable-next-line:no-string-literal\n                const previous = win.READIUM2.urlQueryParams[URL_PARAM_PREVIOUS];\n                const isPreviousNavDirection = previous === \"true\";\n                if (isPreviousNavDirection) {\n\n                    console.log(URL_PARAM_PREVIOUS);\n\n                    const maxHeightShift = isPaged ?\n                        ((isVerticalWritingMode() ?\n                            (win.document.body.scrollHeight - win.document.documentElement.offsetHeight) :\n                            (win.document.body.scrollWidth - win.document.documentElement.offsetWidth))) :\n                        ((isVerticalWritingMode() ?\n                            (win.document.body.scrollWidth - win.document.documentElement.clientWidth) :\n                            (win.document.body.scrollHeight - win.document.documentElement.clientHeight)));\n                    // console.log(\"maxHeightShift: \" + maxHeightShift);\n\n                    _ignoreScrollEvent = true;\n                    if (isPaged) {\n                        if (isVerticalWritingMode()) {\n                            win.document.body.scrollLeft = 0;\n                            win.document.body.scrollTop = maxHeightShift;\n                        } else {\n                            win.document.body.scrollLeft = (isRTL() ? -1 : 1) * maxHeightShift;\n                            win.document.body.scrollTop = 0;\n                        }\n                    } else {\n                        if (isVerticalWritingMode()) {\n                            win.document.body.scrollLeft = (isRTL() ? -1 : 1) * maxHeightShift;\n                            win.document.body.scrollTop = 0;\n                        } else {\n                            win.document.body.scrollLeft = 0;\n                            win.document.body.scrollTop = maxHeightShift;\n                        }\n                    }\n\n                    win.READIUM2.locationHashOverride = undefined;\n                    win.READIUM2.locationHashOverrideCSSselector = undefined;\n                    processXYRaw(0,\n                        (isPaged ?\n                            (isVerticalWritingMode() ?\n                                win.document.documentElement.offsetWidth :\n                                win.document.documentElement.offsetHeight) :\n                            (isVerticalWritingMode() ?\n                                win.document.documentElement.clientWidth :\n                                win.document.documentElement.clientHeight))\n                        - 1);\n\n                    console.log(\"BOTTOM (previous):\");\n                    console.log(win.READIUM2.locationHashOverride);\n\n                    notifyReady();\n                    notifyReadingLocation();\n                    return;\n                }\n\n                // tslint:disable-next-line:no-string-literal\n                let gotoCssSelector = win.READIUM2.urlQueryParams[URL_PARAM_GOTO];\n                if (gotoCssSelector) {\n                    gotoCssSelector = gotoCssSelector.replace(/\\+/g, \" \");\n                    // console.log(\"GOTO: \" + gotoCssSelector);\n                    let selected: Element | null = null;\n                    try {\n                        selected = document.querySelector(gotoCssSelector);\n                    } catch (err) {\n                        console.log(err);\n                    }\n                    if (selected) {\n\n                        // console.log(URL_PARAM_GOTO);\n\n                        win.READIUM2.locationHashOverride = selected;\n                        win.READIUM2.locationHashOverrideCSSselector = gotoCssSelector;\n\n                        notifyReady();\n                        notifyReadingLocation();\n\n                        _ignoreScrollEvent = true;\n                        if (isPaged) {\n                            scrollIntoView(selected as HTMLElement);\n                        } else {\n                            selected.scrollIntoView({\n                                behavior: \"instant\",\n                                block: \"start\",\n                                inline: \"start\",\n                            });\n                        }\n\n                        return;\n                    }\n                }\n            }\n\n            console.log(\"win.READIUM2.locationHashOverride = win.document.body\");\n\n            win.READIUM2.locationHashOverride = win.document.body;\n            win.READIUM2.locationHashOverrideCSSselector = undefined;\n\n            _ignoreScrollEvent = true;\n            win.document.body.scrollLeft = 0;\n            win.document.body.scrollTop = 0;\n        }\n    }\n\n    notifyReady();\n    notifyReadingLocation();\n};\n\nconst scrollToHash = debounce(() => {\n    scrollToHashRaw(false);\n}, 500);\n\nlet _ignoreScrollEvent = false;\n\n// const injectResizeSensor = () => {\n//     ensureHead();\n//     const scriptElement = win.document.createElement(\"script\");\n//     scriptElement.setAttribute(\"id\", \"Readium2-ResizeSensor\");\n//     scriptElement.setAttribute(\"type\", \"application/javascript\");\n//     scriptElement.setAttribute(\"src\", urlResizeSensor);\n//     scriptElement.appendChild(win.document.createTextNode(\" \"));\n//     win.document.head.appendChild(scriptElement);\n//     scriptElement.addEventListener(\"load\", () => {\n//         console.log(\"ResizeSensor LOADED\");\n//     });\n// };\n\n// after DOMContentLoaded\nwin.addEventListener(\"load\", () => {\n    // console.log(\"PRELOAD WIN LOAD\");\n    checkReadyPass();\n});\n\n// // does not occur when re-using same webview (src=\"href\")\n// win.addEventListener(\"unload\", () => {\n//     console.log(\"PRELOAD WIN UNLOAD\");\n//     resetInitialState();\n// });\n\nwin.addEventListener(\"DOMContentLoaded\", () => {\n\n    // const linkUri = new URI(win.location.href);\n\n    if (win.location.hash && win.location.hash.length > 1) {\n        win.READIUM2.hashElement = win.document.getElementById(win.location.hash.substr(1));\n    }\n\n    // resetInitialState();\n    win.READIUM2.locationHashOverride = undefined;\n    win.READIUM2.readyPassDone = false;\n    win.READIUM2.readyEventSent = false;\n\n    let readiumcssJson: any = {};\n    if (win.READIUM2.urlQueryParams) {\n        // tslint:disable-next-line:no-string-literal\n        const base64ReadiumCSS = win.READIUM2.urlQueryParams[URL_PARAM_CSS];\n        // if (!base64ReadiumCSS) {\n        //     console.log(\"!readiumcss BASE64 ??!\");\n        //     const token = URL_PARAM_CSS + \"=\";\n        //     const i = win.location.search.indexOf(token);\n        //     if (i > 0) {\n        //         base64ReadiumCSS = win.location.search.substr(i + token.length);\n        //         const j = base64ReadiumCSS.indexOf(\"&\");\n        //         if (j > 0) {\n        //             base64ReadiumCSS = base64ReadiumCSS.substr(0, j);\n        //         }\n        //         base64ReadiumCSS = decodeURIComponent(base64ReadiumCSS);\n        //     }\n        // }\n        if (base64ReadiumCSS) {\n            try {\n                const str = window.atob(base64ReadiumCSS);\n                readiumcssJson = JSON.parse(str);\n            } catch (err) {\n                console.log(err);\n            }\n        }\n    }\n\n    win.READIUM2.isFixedLayout = readiumcssJson && readiumcssJson.isFixedLayout;\n    configureFixedLayout(win.READIUM2.isFixedLayout);\n    if (win.READIUM2.isFixedLayout) {\n        notifyReady();\n    }\n\n    injectDefaultCSS();\n\n    if (DEBUG_VISUALS) {\n        injectReadPosCSS();\n    }\n\n    // // DEBUG\n    // win.document.body.addEventListener(\"focus\", (ev: any) => {\n    //     console.log(\"focus:\");\n    //     console.log(ev.target);\n    // }, true);\n    // win.document.body.addEventListener(\"focusin\", (ev: any) => {\n    //     console.log(\"focusin:\");\n    //     console.log(ev.target);\n    // });\n    // // DEBUG\n\n    win.document.body.addEventListener(\"focusin\", (ev: any) => {\n\n        if (!win.document || !win.document.documentElement) {\n            return;\n        }\n\n        const isPaged = win.document.documentElement.classList.contains(\"readium-paginated\");\n        if (isPaged) {\n            setTimeout(() => {\n                win.READIUM2.locationHashOverride = ev.target;\n                scrollIntoView(ev.target as HTMLElement);\n            }, 30);\n        }\n    });\n\n    win.document.addEventListener(\"click\", (e) => {\n        const href = (e.target as any).href;\n        if (!href) {\n            return;\n        }\n\n        // console.log(\"+++++\");\n        // console.log(href);\n\n        e.preventDefault();\n        e.stopPropagation();\n\n        const payload: IEventPayload_R2_EVENT_LINK = {\n            url: href,\n        };\n        ipcRenderer.sendToHost(R2_EVENT_LINK, payload);\n        return false;\n    }, true);\n\n    // injectResizeSensor();\n\n    if (readiumcssJson) {\n        readiumCSS(readiumcssJson);\n    }\n});\n\nconst processXYRaw = (x: number, y: number) => {\n    // console.log(\"processXY: \" + x + \", \" + y);\n\n    // const elems = document.elementsFromPoint(x, y);\n    // // console.log(elems);\n    // let element: Element | undefined = elems && elems.length ? elems[0] : undefined;\n    let element: Element | undefined;\n\n    // if ((document as any).caretPositionFromPoint) {\n    //     console.log(\"caretPositionFromPoint\");\n    //     const range = (document as any).caretPositionFromPoint(x, y);\n    //     const node = range.offsetNode;\n    //     const offset = range.offset;\n    // } else if (document.caretRangeFromPoint) {\n    //     console.log(\"caretRangeFromPoint\");\n    // }\n\n    // let textNode: Node | undefined;\n    // let textNodeOffset = 0;\n\n    const range = document.caretRangeFromPoint(x, y);\n    if (range) {\n        const node = range.startContainer;\n        // const offset = range.startOffset;\n\n        if (node) {\n            if (node.nodeType === Node.ELEMENT_NODE) {\n                element = node as Element;\n            } else if (node.nodeType === Node.TEXT_NODE) {\n                // textNode = node;\n                // textNodeOffset = offset;\n                if (node.parentNode && node.parentNode.nodeType === Node.ELEMENT_NODE) {\n                    element = node.parentNode as Element;\n                }\n            }\n        }\n    }\n\n    if (DEBUG_VISUALS) {\n        const existings = document.querySelectorAll(\".readium2-read-pos, .readium2-read-pos2\");\n        existings.forEach((existing) => {\n            existing.classList.remove(\"readium2-read-pos\");\n            existing.classList.remove(\"readium2-read-pos2\");\n        });\n    }\n    if (element) {\n        win.READIUM2.locationHashOverride = element;\n        notifyReadingLocation();\n\n        // console.log(\"element.offsetTop: \" + (element as HTMLElement).offsetTop);\n        // console.log(\"element.getBoundingClientRect().top: \" + element.getBoundingClientRect().top);\n        // console.log(\"element.offsetLeft: \" + (element as HTMLElement).offsetLeft);\n        // console.log(\"element.getBoundingClientRect().left: \" + element.getBoundingClientRect().left);\n\n        if (DEBUG_VISUALS) {\n            element.classList.add(\"readium2-read-pos2\");\n\n            // // console.log(\"fullQualifiedSelector TRUE\");\n            // // const sel1 = fullQualifiedSelector(element, true);\n            // // console.log(sel1);\n\n            // // console.log(\"fullQualifiedSelector FALSE\");\n            // const sel2 = fullQualifiedSelector(element, false);\n            // // console.log(sel2);\n\n            // const selecteds = document.querySelectorAll(sel2);\n            // selecteds.forEach((selected) => {\n            //     selected.classList.remove(\"readium2-read-pos\");\n            //     selected.classList.add(\"readium2-read-pos2\");\n            // });\n        }\n    }\n};\nconst processXY = debounce((x: number, y: number) => {\n    processXYRaw(x, y);\n}, 300);\n\nexport const computeCFI = (node: Node): string | undefined => {\n\n    // TODO: handle character position inside text node\n    if (node.nodeType !== Node.ELEMENT_NODE) {\n        return undefined;\n    }\n\n    let cfi = \"\";\n\n    let currentElement = node as Element;\n    while (currentElement.parentNode && currentElement.parentNode.nodeType === Node.ELEMENT_NODE) {\n        const currentElementChildren = (currentElement.parentNode as Element).children;\n        let currentElementIndex = -1;\n        for (let i = 0; i < currentElementChildren.length; i++) {\n            if (currentElement === currentElementChildren[i]) {\n                currentElementIndex = i;\n                break;\n            }\n        }\n        if (currentElementIndex >= 0) {\n            const cfiIndex = (currentElementIndex + 1) * 2;\n            cfi = cfiIndex +\n                (currentElement.id ? (\"[\" + currentElement.id + \"]\") : \"\") +\n                (cfi.length ? (\"/\" + cfi) : \"\");\n        }\n        currentElement = currentElement.parentNode as Element;\n    }\n\n    return \"/\" + cfi;\n};\n\nconst notifyReadingLocation = () => {\n    if (!win.READIUM2.locationHashOverride) {\n        return;\n    }\n\n    // win.READIUM2.locationHashOverride.nodeType === ELEMENT_NODE\n\n    win.READIUM2.locationHashOverrideCSSselector = fullQualifiedSelector(win.READIUM2.locationHashOverride, false);\n    win.READIUM2.locationHashOverrideCFI = computeCFI(win.READIUM2.locationHashOverride);\n\n    const payload: IEventPayload_R2_EVENT_READING_LOCATION = {\n        cfi: win.READIUM2.locationHashOverrideCFI,\n        cssSelector: win.READIUM2.locationHashOverrideCSSselector,\n    };\n    ipcRenderer.sendToHost(R2_EVENT_READING_LOCATION, payload);\n\n    if (DEBUG_VISUALS) {\n        win.READIUM2.locationHashOverride.classList.add(\"readium2-read-pos\");\n\n        console.log(\"notifyReadingLocation CSS SELECTOR: \" + win.READIUM2.locationHashOverrideCSSselector);\n        console.log(\"notifyReadingLocation CFI: \" + win.READIUM2.locationHashOverrideCFI);\n    }\n};\n"]}