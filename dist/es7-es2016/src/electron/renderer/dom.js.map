{"version":3,"file":"dom.js","sourceRoot":"","sources":["../../../../../src/electron/renderer/dom.ts"],"names":[],"mappings":"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","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nconst IS_DEV = (process.env.NODE_ENV === \"development\" || process.env.NODE_ENV === \"dev\");\n\nimport { debounce } from \"debounce\";\nimport * as debug_ from \"debug\";\nimport { remote, webContents } from \"electron\";\n\nimport { Locator } from \"@r2-shared-js/models/locator\";\nimport { Publication } from \"@r2-shared-js/models/publication\";\n\nimport {\n    IEventPayload_R2_EVENT_CLIPBOARD_COPY, IEventPayload_R2_EVENT_DEBUG_VISUALS,\n    IEventPayload_R2_EVENT_READIUMCSS, IEventPayload_R2_EVENT_WEBVIEW_KEYDOWN,\n    IEventPayload_R2_EVENT_WEBVIEW_KEYUP, IKeyboardEvent, R2_EVENT_CLIPBOARD_COPY,\n    R2_EVENT_DEBUG_VISUALS, R2_EVENT_READIUMCSS, R2_EVENT_WEBVIEW_KEYDOWN, R2_EVENT_WEBVIEW_KEYUP,\n} from \"../common/events\";\nimport { R2_SESSION_WEBVIEW } from \"../common/sessions\";\nimport { URL_PARAM_DEBUG_VISUALS } from \"./common/url-params\";\nimport { ENABLE_WEBVIEW_RESIZE } from \"./common/webview-resize\";\nimport { highlightsHandleIpcMessage } from \"./highlight\";\nimport {\n    getCurrentReadingLocation, handleLinkLocator, locationHandleIpcMessage, shiftWebview,\n} from \"./location\";\nimport { ttsClickEnable, ttsHandleIpcMessage } from \"./readaloud\";\nimport { adjustReadiumCssJsonMessageForFixedLayout, obtainReadiumCss } from \"./readium-css\";\nimport { IReadiumElectronBrowserWindow, IReadiumElectronWebview } from \"./webview/state\";\n\n// import { registerProtocol } from \"@r2-navigator-js/electron/renderer/common/protocol\";\n// registerProtocol();\n\n// const CLASS_POS_RIGHT = \"r2_posRight\";\n// const CLASS_SHIFT_LEFT = \"r2_shiftedLeft\";\n// const CLASS_ANIMATED = \"r2_animated\";\n\nconst ELEMENT_ID_SLIDING_VIEWPORT = \"r2_navigator_sliding_viewport\";\n\nconst debug = debug_(\"r2:navigator#electron/renderer/index\");\n\nconst win = window as IReadiumElectronBrowserWindow;\n\n// const queryParams = getURLQueryParams();\n\n// // tslint:disable-next-line:no-string-literal\n// const publicationJsonUrl = queryParams[\"pub\"];\n// debug(publicationJsonUrl);\n// const publicationJsonUrl_ = publicationJsonUrl.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL) ?\n//     convertCustomSchemeToHttpUrl(publicationJsonUrl) : publicationJsonUrl;\n// debug(publicationJsonUrl_);\n// const pathBase64 = publicationJsonUrl_.replace(/.*\\/pub\\/(.*)\\/manifest.json/, \"$1\");\n// debug(pathBase64);\n// const pathDecoded = Buffer.from(decodeURIComponent(pathBase64), \"base64\").toString(\"utf8\");\n// debug(pathDecoded);\n// const pathFileName = pathDecoded.substr(\n//     pathDecoded.replace(/\\\\/g, \"/\").lastIndexOf(\"/\") + 1,\n//     pathDecoded.length - 1);\n// debug(pathFileName);\n\n// // tslint:disable-next-line:no-string-literal\n// const lcpHint = queryParams[\"lcpHint\"];\n\n// legacy function, old confusing name (see readiumCssUpdate() below)\nexport function readiumCssOnOff(rcss?: IEventPayload_R2_EVENT_READIUMCSS) {\n\n    const activeWebView = win.READIUM2.getActiveWebView();\n    if (activeWebView) {\n        const loc = getCurrentReadingLocation();\n\n        const actualReadiumCss = obtainReadiumCss(rcss);\n        activeWebView.READIUM2.readiumCss = actualReadiumCss;\n\n        const payloadRcss = adjustReadiumCssJsonMessageForFixedLayout(activeWebView.READIUM2.link, actualReadiumCss);\n\n        if (activeWebView.style.transform !== \"none\") {\n            setTimeout(async () => {\n                await activeWebView.send(\"R2_EVENT_HIDE\");\n            }, 0);\n\n            setTimeout(async () => {\n                shiftWebview(activeWebView, 0, undefined); // reset\n                await activeWebView.send(R2_EVENT_READIUMCSS, payloadRcss);\n            }, 10);\n        } else {\n            setTimeout(async () => {\n                await activeWebView.send(R2_EVENT_READIUMCSS, payloadRcss);\n            }, 0);\n        }\n\n        if (loc) {\n            setTimeout(() => {\n                handleLinkLocator(loc.locator, activeWebView.READIUM2.readiumCss);\n            }, 60);\n        }\n    }\n}\nexport function readiumCssUpdate(rcss: IEventPayload_R2_EVENT_READIUMCSS) {\n    return readiumCssOnOff(rcss);\n}\n\nlet _webview1: IReadiumElectronWebview;\n\nfunction createWebViewInternal(preloadScriptPath: string): IReadiumElectronWebview {\n\n    // Unfortunately the Chromium web inspector crashes when closing preload :(\n    // Also, the debugger fails to open the sourcemaps (maybe related issue?)\n    // process.stderr.write(\"\\n####\\n\" + preloadScriptPath + \"\\n####\\n\");\n    // TODO: what are the critical features needed from Node context\n    // that justify using webview.preload? Can we instead use regular DOM code?\n    // The ReadiumCSS injection is now streamer-based (best performance / timing)\n    // and we can use postMessage instead of Electron IPC.\n    // Also, preload really does most of its processing once DOM-ready.\n    // Perhaps the main problem would be exposing the internal logic of navigator\n    // into EPUB content documents? (preload is good for isolating app code)\n\n    const wv = document.createElement(\"webview\");\n    // tslint:disable-next-line:max-line-length\n    // https://github.com/electron/electron/blob/master/docs/tutorial/security.md#3-enable-context-isolation-for-remote-content\n    wv.setAttribute(\"webpreferences\",\n        \"nodeIntegration=0, nodeIntegrationInWorker=0, sandbox=0, javascript=1, \" +\n        \"contextIsolation=0, webSecurity=1, allowRunningInsecureContent=0, enableRemoteModule=0\");\n    wv.setAttribute(\"partition\", R2_SESSION_WEBVIEW);\n\n    const publicationURL_ = win.READIUM2.publicationURL;\n    if (publicationURL_) {\n        // const ref = publicationURL_.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\") ?\n        //     publicationURL_ : convertHttpUrlToCustomScheme(publicationURL_);\n        wv.setAttribute(\"httpreferrer\", publicationURL_);\n    }\n    wv.setAttribute(\"style\", \"display: flex; margin: 0; padding: 0; box-sizing: border-box; \" +\n        \"position: absolute; left: 0; width: 50%; bottom: 0; top: 0;\");\n    wv.setAttribute(\"preload\", preloadScriptPath); // \"file://\"\n\n    if (ENABLE_WEBVIEW_RESIZE) {\n        wv.setAttribute(\"disableguestresize\", \"\");\n    }\n\n    setTimeout(() => {\n        wv.removeAttribute(\"tabindex\");\n    }, 500);\n\n    wv.addEventListener(\"dom-ready\", () => {\n        // https://github.com/electron/electron/blob/v3.0.0/docs/api/breaking-changes.md#webcontents\n\n        wv.clearHistory();\n\n        if (IS_DEV) {\n            const wc = remote.webContents.fromId(wv.getWebContentsId());\n            // const wc = wv.getWebContents();\n\n            wc.on(\"context-menu\", (_ev, params) => {\n                const { x, y } = params;\n                const openDevToolsAndInspect = () => {\n                    const devToolsOpened = () => {\n                        wc.off(\"devtools-opened\", devToolsOpened);\n                        wc.inspectElement(x, y);\n\n                        setTimeout(() => {\n                            if (wc.isDevToolsOpened()) {\n                                wc.devToolsWebContents.focus();\n                            }\n                        }, 500);\n                    };\n                    wc.on(\"devtools-opened\", devToolsOpened);\n                    wc.openDevTools({ activate: true, mode: \"detach\" });\n                };\n                remote.Menu.buildFromTemplate([{\n                    click: () => {\n                        const wasOpened = wc.isDevToolsOpened();\n                        if (!wasOpened) {\n                            openDevToolsAndInspect();\n                        } else {\n                            if (!wc.isDevToolsFocused()) {\n                                // wc.toggleDevTools();\n                                wc.closeDevTools();\n\n                                setImmediate(() => {\n                                    openDevToolsAndInspect();\n                                });\n                            } else {\n                                // right-click context menu normally occurs when focus\n                                // is in BrowserWindow / WebView's WebContents,\n                                // but some platforms (e.g. MacOS) allow mouse interaction\n                                // when the window is in the background.\n                                wc.inspectElement(x, y);\n                            }\n                        }\n                    },\n                    label: \"Inspect element\",\n                }]).popup({window: remote.getCurrentWindow()});\n            });\n        }\n\n        if (win.READIUM2) {\n            ttsClickEnable(win.READIUM2.ttsClickEnabled);\n        }\n    });\n\n    wv.addEventListener(\"ipc-message\", (event: Electron.IpcMessageEvent) => {\n        const webview = event.currentTarget as IReadiumElectronWebview;\n        const activeWebView = win.READIUM2.getActiveWebView();\n        if (webview !== activeWebView) {\n            return;\n        }\n        if (event.channel === R2_EVENT_WEBVIEW_KEYDOWN) {\n            const payload = event.args[0] as IEventPayload_R2_EVENT_WEBVIEW_KEYDOWN;\n            if (_keyDownEventHandler) {\n                _keyDownEventHandler(payload, payload.elementName, payload.elementAttributes);\n            }\n        } else if (event.channel === R2_EVENT_WEBVIEW_KEYUP) {\n            const payload = event.args[0] as IEventPayload_R2_EVENT_WEBVIEW_KEYUP;\n            if (_keyUpEventHandler) {\n                _keyUpEventHandler(payload, payload.elementName, payload.elementAttributes);\n            }\n        } else if (event.channel === R2_EVENT_CLIPBOARD_COPY) {\n            const clipboardInterceptor = win.READIUM2.clipboardInterceptor;\n            if (clipboardInterceptor) {\n                const payload = event.args[0] as IEventPayload_R2_EVENT_CLIPBOARD_COPY;\n                clipboardInterceptor(payload);\n            }\n        } else if (!highlightsHandleIpcMessage(event.channel, event.args, webview) &&\n            !ttsHandleIpcMessage(event.channel, event.args, webview) &&\n            !locationHandleIpcMessage(event.channel, event.args, webview)) {\n\n            debug(\"webview1 ipc-message\");\n            debug(event.channel);\n        }\n    });\n\n    return wv as IReadiumElectronWebview;\n}\nif (ENABLE_WEBVIEW_RESIZE) {\n    // https://github.com/electron/electron/blob/v3.0.0/docs/api/breaking-changes.md#webcontents\n    // https://github.com/electron/electron/blob/v3.0.0/docs/api/breaking-changes.md#webview\n    // wv.setAttribute(\"disableguestresize\", \"\");\n    const adjustResize = (webview: IReadiumElectronWebview) => {\n        // https://javascript.info/size-and-scroll\n        // offsetW/H: excludes margin, includes border, scrollbar, padding.\n        // clientW/H: excludes margin, border, scrollbar, includes padding.\n        // scrollW/H: like client, but includes hidden (overflow) areas\n        const width = webview.clientWidth;\n        const height = webview.clientHeight;\n\n        const wc = webContents.fromId(webview.getWebContentsId());\n        // const wc = webview.getWebContents();\n\n        if (wc && (wc as any).setSize && width && height) {\n            (wc as any).setSize({ // wc is WebContents, works in Electron < 3.0\n                normal: {\n                    height,\n                    width,\n                },\n            });\n        }\n    };\n    const onResizeDebounced = debounce(() => {\n        const activeWebView = win.READIUM2.getActiveWebView();\n        if (activeWebView) {\n            adjustResize(activeWebView);\n        }\n    }, 200);\n    window.addEventListener(\"resize\", () => {\n        // const activeWebView = win.READIUM2.getActiveWebView();\n        // if (!isFixedLayout(activeWebView.READIUM2.link)) {\n        //     if (_rootHtmlElement) {\n        //         _rootHtmlElement.dispatchEvent(new Event(DOM_EVENT_HIDE_VIEWPORT));\n        //     }\n        // }\n        onResizeDebounced();\n    });\n}\n\nfunction createWebView() {\n    const preloadScriptPath = win.READIUM2.preloadScriptPath;\n    _webview1 = createWebViewInternal(preloadScriptPath);\n    _webview1.READIUM2 = {\n        id: 1,\n        link: undefined,\n        readiumCss: undefined,\n    };\n    _webview1.setAttribute(\"id\", \"webview1\");\n\n    const domSlidingViewport = win.READIUM2.domSlidingViewport;\n    domSlidingViewport.appendChild(_webview1 as Node);\n    // domSlidingViewport.appendChild(_webview2 as Node);\n\n    // if (isRTL()) {\n    //     _webview1.classList.add(CLASS_POS_RIGHT);\n    //     _webview1.style.left = \"50%\";\n    // }\n    // else {\n    //     _webview2.classList.add(CLASS_POS_RIGHT);\n    //     _webview2.style.left = \"50%\";\n    // }\n}\n\nfunction destroyWebView(): void {\n    const domSlidingViewport = win.READIUM2.domSlidingViewport;\n    domSlidingViewport.removeChild(_webview1 as Node);\n    (_webview1 as any).READIUM2 = undefined;\n    (_webview1 as any) = undefined;\n}\n\nexport function installNavigatorDOM(\n    publication: Publication,\n    publicationURL: string,\n    rootHtmlElementID: string,\n    preloadScriptPath: string,\n    location: Locator | undefined,\n    enableScreenReaderAccessibilityWebViewHardRefresh: boolean,\n    clipboardInterceptor: ((data: IEventPayload_R2_EVENT_CLIPBOARD_COPY) => void) | undefined,\n    sessionInfo: string | undefined,\n    rcss: IEventPayload_R2_EVENT_READIUMCSS | undefined,\n    ) {\n\n    const domRootElement = document.getElementById(rootHtmlElementID) as HTMLElement;\n    if (!domRootElement) {\n        debug(\"!rootHtmlElementID ???\");\n        return;\n    }\n\n    const domSlidingViewport = document.createElement(\"div\");\n    domSlidingViewport.setAttribute(\"id\", ELEMENT_ID_SLIDING_VIEWPORT);\n    domSlidingViewport.setAttribute(\"style\", \"display: block; position: absolute; left: 0; width: 200%; \" +\n        \"top: 0; bottom: 0; margin: 0; padding: 0; box-sizing: border-box; background: white; overflow: hidden;\");\n\n    win.READIUM2 = {\n        DEBUG_VISUALS: false,\n        clipboardInterceptor,\n        createActiveWebView: createWebView,\n        destroyActiveWebView: destroyWebView,\n        domRootElement,\n        domSlidingViewport,\n        enableScreenReaderAccessibilityWebViewHardRefresh:\n            enableScreenReaderAccessibilityWebViewHardRefresh ? true : false,\n        getActiveWebView: (): IReadiumElectronWebview => {\n            return _webview1;\n\n            // let activeWebView: IReadiumElectronWebview;\n\n            // const slidingViewport = document.getElementById(ELEMENT_ID_SLIDING_VIEWPORT) as HTMLElement;\n            // if (slidingViewport.classList.contains(CLASS_SHIFT_LEFT)) {\n            //     if (_webview1.classList.contains(CLASS_POS_RIGHT)) {\n            //         activeWebView = _webview1;\n            //     } else {\n            //         activeWebView = _webview2;\n            //     }\n            // } else {\n            //     if (_webview2.classList.contains(CLASS_POS_RIGHT)) {\n            //         activeWebView = _webview1;\n            //     } else {\n            //         activeWebView = _webview2;\n            //     }\n            // }\n\n            // return activeWebView;\n        },\n        preloadScriptPath,\n        publication,\n        publicationURL,\n        sessionInfo,\n        ttsClickEnabled: false,\n    };\n\n    if (IS_DEV) {\n        debug(\"||||||++||||| installNavigatorDOM: \", JSON.stringify(location));\n\n        const debugVisualz = (window.localStorage &&\n            window.localStorage.getItem(URL_PARAM_DEBUG_VISUALS) === \"true\") ? true : false;\n        debug(\"debugVisuals GET: \", debugVisualz);\n\n        win.READIUM2.DEBUG_VISUALS = debugVisualz;\n\n        (window as any).READIUM2.debug = (debugVisuals: boolean) => {\n            debug(\"debugVisuals SET: \", debugVisuals);\n            win.READIUM2.DEBUG_VISUALS = debugVisuals;\n\n            const activeWebView = win.READIUM2.getActiveWebView();\n            if (activeWebView) {\n                const payload: IEventPayload_R2_EVENT_DEBUG_VISUALS\n                    = { debugVisuals };\n                setTimeout(async () => {\n                    await activeWebView.send(R2_EVENT_DEBUG_VISUALS, payload);\n                }, 0);\n            }\n            if (window.localStorage) {\n                window.localStorage.setItem(URL_PARAM_DEBUG_VISUALS, debugVisuals ? \"true\" : \"false\");\n            }\n            setTimeout(() => {\n                const loc = getCurrentReadingLocation();\n                if (loc) {\n                    handleLinkLocator(\n                        loc.locator,\n                        activeWebView ? activeWebView.READIUM2.readiumCss : undefined,\n                    );\n                }\n            }, 100);\n        };\n\n        (window as any).READIUM2.debugItems =\n            (cssSelector: string, cssClass: string, cssStyles: string | undefined) => {\n\n                if (cssStyles) {\n                    debug(\"debugVisuals ITEMS: \", `${cssSelector} --- ${cssClass} --- ${cssStyles}`);\n                }\n\n                const activeWebView = win.READIUM2.getActiveWebView();\n                // let delay = 0;\n                // if (!win.READIUM2.DEBUG_VISUALS) {\n                //     (window as any).READIUM2.debug(true);\n                //     delay = 200;\n                // }\n                // setTimeout(() => {\n                //     if (activeWebView) {\n                //         const payload: IEventPayload_R2_EVENT_DEBUG_VISUALS\n                //             = { debugVisuals: true, cssSelector, cssClass, cssStyles };\n                //         activeWebView.send(R2_EVENT_DEBUG_VISUALS, payload);\n                //     }\n                // }, delay);\n\n                if (activeWebView) {\n                    const d = win.READIUM2.DEBUG_VISUALS;\n                    const payload: IEventPayload_R2_EVENT_DEBUG_VISUALS\n                        = { debugVisuals: d, cssSelector, cssClass, cssStyles };\n\n                    setTimeout(async () => {\n                        await activeWebView.send(R2_EVENT_DEBUG_VISUALS, payload);\n                    }, 0);\n                }\n            };\n    }\n\n    domRootElement.appendChild(domSlidingViewport);\n\n    createWebView();\n\n    setTimeout(() => {\n        handleLinkLocator(location, rcss);\n    }, 100);\n}\n\nlet _keyDownEventHandler: (\n    ev: IKeyboardEvent,\n    elementName: string,\n    elementAttributes: {[name: string]: string},\n) => void;\nexport function setKeyDownEventHandler(func: (\n    ev: IKeyboardEvent,\n    elementName: string,\n    elementAttributes: {[name: string]: string},\n) => void) {\n\n    _keyDownEventHandler = func;\n}\n\nlet _keyUpEventHandler: (\n    ev: IKeyboardEvent,\n    elementName: string,\n    elementAttributes: {[name: string]: string},\n) => void;\nexport function setKeyUpEventHandler(func: (\n    ev: IKeyboardEvent,\n    elementName: string,\n    elementAttributes: {[name: string]: string},\n) => void) {\n\n    _keyUpEventHandler = func;\n}\n"]}