{"version":3,"file":"dom.js","sourceRoot":"","sources":["../../../../../src/electron/renderer/dom.ts"],"names":[],"mappings":"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","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nconst IS_DEV = (process.env.NODE_ENV === \"development\" || process.env.NODE_ENV === \"dev\");\n\nimport * as debug_ from \"debug\";\nimport { remote } from \"electron\";\n\nimport { Locator } from \"@r2-shared-js/models/locator\";\nimport { Publication } from \"@r2-shared-js/models/publication\";\n\nimport {\n    IEventPayload_R2_EVENT_CLIPBOARD_COPY, IEventPayload_R2_EVENT_DEBUG_VISUALS,\n    IEventPayload_R2_EVENT_READIUMCSS, IEventPayload_R2_EVENT_WEBVIEW_KEYDOWN,\n    IEventPayload_R2_EVENT_WEBVIEW_KEYUP, IKeyboardEvent, R2_EVENT_CLIPBOARD_COPY,\n    R2_EVENT_DEBUG_VISUALS, R2_EVENT_READIUMCSS, R2_EVENT_WEBVIEW_KEYDOWN, R2_EVENT_WEBVIEW_KEYUP,\n} from \"../common/events\";\nimport { R2_SESSION_WEBVIEW } from \"../common/sessions\";\nimport { WebViewSlotEnum } from \"../common/styles\";\nimport { URL_PARAM_DEBUG_VISUALS } from \"./common/url-params\";\nimport { highlightsHandleIpcMessage } from \"./highlight\";\nimport {\n    LocatorExtended, getCurrentReadingLocation, handleLinkLocator, locationHandleIpcMessage,\n    setWebViewStyle, shiftWebview,\n} from \"./location\";\nimport { mediaOverlaysHandleIpcMessage } from \"./media-overlays\";\nimport { ttsClickEnable, ttsHandleIpcMessage } from \"./readaloud\";\nimport {\n    adjustReadiumCssJsonMessageForFixedLayout, isFixedLayout, obtainReadiumCss,\n} from \"./readium-css\";\nimport { soundtrackHandleIpcMessage } from \"./soundtrack\";\nimport { IReadiumElectronBrowserWindow, IReadiumElectronWebview } from \"./webview/state\";\n\n// import { registerProtocol } from \"@r2-navigator-js/electron/renderer/common/protocol\";\n// registerProtocol();\n\n// const CLASS_POS_RIGHT = \"r2_posRight\";\n// const CLASS_SHIFT_LEFT = \"r2_shiftedLeft\";\n// const CLASS_ANIMATED = \"r2_animated\";\n\nconst ELEMENT_ID_SLIDING_VIEWPORT = \"r2_navigator_sliding_viewport\";\n\nconst debug = debug_(\"r2:navigator#electron/renderer/index\");\n\nconst win = window as IReadiumElectronBrowserWindow;\n\n// const queryParams = getURLQueryParams();\n\n// // tslint:disable-next-line:no-string-literal\n// const publicationJsonUrl = queryParams[\"pub\"];\n// debug(publicationJsonUrl);\n// const publicationJsonUrl_ = publicationJsonUrl.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL) ?\n//     convertCustomSchemeToHttpUrl(publicationJsonUrl) : publicationJsonUrl;\n// debug(publicationJsonUrl_);\n// const pathBase64 = publicationJsonUrl_.replace(/.*\\/pub\\/(.*)\\/manifest.json/, \"$1\");\n// debug(pathBase64);\n// const pathDecoded = Buffer.from(decodeURIComponent(pathBase64), \"base64\").toString(\"utf8\");\n// debug(pathDecoded);\n// const pathFileName = pathDecoded.substr(\n//     pathDecoded.replace(/\\\\/g, \"/\").lastIndexOf(\"/\") + 1,\n//     pathDecoded.length - 1);\n// debug(pathFileName);\n\n// // tslint:disable-next-line:no-string-literal\n// const lcpHint = queryParams[\"lcpHint\"];\n\nfunction readiumCssApplyToWebview(\n    loc: LocatorExtended | undefined,\n    activeWebView: IReadiumElectronWebview,\n    rcss?: IEventPayload_R2_EVENT_READIUMCSS) {\n\n    const actualReadiumCss = obtainReadiumCss(rcss);\n    activeWebView.READIUM2.readiumCss = actualReadiumCss;\n\n    const payloadRcss = adjustReadiumCssJsonMessageForFixedLayout(activeWebView, actualReadiumCss);\n\n    if (activeWebView.style.transform &&\n        activeWebView.style.transform !== \"none\") {\n\n        setTimeout(async () => {\n            await activeWebView.send(\"R2_EVENT_HIDE\",\n                activeWebView.READIUM2.link ? isFixedLayout(activeWebView.READIUM2.link) : null);\n        }, 0);\n\n        setTimeout(async () => {\n            shiftWebview(activeWebView, 0, undefined); // reset\n            await activeWebView.send(R2_EVENT_READIUMCSS, payloadRcss);\n        }, 10);\n    } else {\n        setTimeout(async () => {\n            await activeWebView.send(R2_EVENT_READIUMCSS, payloadRcss);\n        }, 0);\n    }\n\n    if (loc && loc.locator.href === activeWebView.READIUM2.link?.Href) {\n\n        setTimeout(() => {\n            debug(`readiumCssOnOff -> handleLinkLocator`);\n            handleLinkLocator(loc.locator, actualReadiumCss);\n        }, 60);\n    }\n}\n// legacy function, old confusing name (see readiumCssUpdate() below)\nexport function readiumCssOnOff(rcss?: IEventPayload_R2_EVENT_READIUMCSS) {\n\n    const loc = getCurrentReadingLocation();\n\n    const activeWebViews = win.READIUM2.getActiveWebViews();\n    for (const activeWebView of activeWebViews) {\n        readiumCssApplyToWebview(loc, activeWebView, rcss);\n    }\n}\nexport function readiumCssUpdate(rcss: IEventPayload_R2_EVENT_READIUMCSS) {\n    return readiumCssOnOff(rcss);\n}\n\nlet _webview1: IReadiumElectronWebview | undefined;\nlet _webview2: IReadiumElectronWebview | undefined;\n\nfunction createWebViewInternal(preloadScriptPath: string): IReadiumElectronWebview {\n\n    const wv = document.createElement(\"webview\");\n    // tslint:disable-next-line:max-line-length\n    // https://github.com/electron/electron/blob/master/docs/tutorial/security.md#3-enable-context-isolation-for-remote-content\n    wv.setAttribute(\"webpreferences\",\n        \"nodeIntegration=0, nodeIntegrationInWorker=0, sandbox=0, javascript=1, \" +\n        \"contextIsolation=0, webSecurity=1, allowRunningInsecureContent=0, enableRemoteModule=0\");\n    wv.setAttribute(\"partition\", R2_SESSION_WEBVIEW);\n\n    const publicationURL_ = win.READIUM2.publicationURL;\n    if (publicationURL_) {\n        // const ref = publicationURL_.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\") ?\n        //     publicationURL_ : convertHttpUrlToCustomScheme(publicationURL_);\n        wv.setAttribute(\"httpreferrer\", publicationURL_);\n    }\n    setWebViewStyle(wv as IReadiumElectronWebview, WebViewSlotEnum.center);\n    wv.setAttribute(\"preload\", preloadScriptPath); // \"file://\"\n\n    // if (ENABLE_WEBVIEW_RESIZE) {\n    //     wv.setAttribute(\"disableguestresize\", \"\");\n    // }\n\n    setTimeout(() => {\n        wv.removeAttribute(\"tabindex\");\n    }, 500);\n\n    wv.addEventListener(\"dom-ready\", () => {\n        // https://github.com/electron/electron/blob/v3.0.0/docs/api/breaking-changes.md#webcontents\n\n        wv.clearHistory();\n\n        if (IS_DEV) {\n            const wc = remote.webContents.fromId(wv.getWebContentsId());\n            // const wc = wv.getWebContents();\n\n            wc.on(\"context-menu\", (_ev, params) => {\n                const { x, y } = params;\n                const openDevToolsAndInspect = () => {\n                    const devToolsOpened = () => {\n                        wc.off(\"devtools-opened\", devToolsOpened);\n                        wc.inspectElement(x, y);\n\n                        setTimeout(() => {\n                            if (wc.devToolsWebContents && wc.isDevToolsOpened()) {\n                                wc.devToolsWebContents.focus();\n                            }\n                        }, 500);\n                    };\n                    wc.on(\"devtools-opened\", devToolsOpened);\n                    wc.openDevTools({ activate: true, mode: \"detach\" });\n                };\n                remote.Menu.buildFromTemplate([{\n                    click: () => {\n                        const wasOpened = wc.isDevToolsOpened();\n                        if (!wasOpened) {\n                            openDevToolsAndInspect();\n                        } else {\n                            if (!wc.isDevToolsFocused()) {\n                                // wc.toggleDevTools();\n                                wc.closeDevTools();\n\n                                setImmediate(() => {\n                                    openDevToolsAndInspect();\n                                });\n                            } else {\n                                // right-click context menu normally occurs when focus\n                                // is in BrowserWindow / WebView's WebContents,\n                                // but some platforms (e.g. MacOS) allow mouse interaction\n                                // when the window is in the background.\n                                wc.inspectElement(x, y);\n                            }\n                        }\n                    },\n                    label: \"Inspect element\",\n                }]).popup({window: remote.getCurrentWindow()});\n            });\n        }\n\n        if (win.READIUM2) {\n            ttsClickEnable(win.READIUM2.ttsClickEnabled);\n        }\n\n        // mediaOverlaysNotifyDocumentLoaded();\n    });\n\n    wv.addEventListener(\"ipc-message\", (event: Electron.IpcMessageEvent) => {\n        const webview = event.currentTarget as IReadiumElectronWebview;\n        if (webview !== wv) {\n            console.log(\"Wrong navigator webview?!\");\n            return;\n        }\n        if (event.channel === R2_EVENT_WEBVIEW_KEYDOWN) {\n            const payload = event.args[0] as IEventPayload_R2_EVENT_WEBVIEW_KEYDOWN;\n            if (_keyDownEventHandler) {\n                _keyDownEventHandler(payload, payload.elementName, payload.elementAttributes);\n            }\n        } else if (event.channel === R2_EVENT_WEBVIEW_KEYUP) {\n            const payload = event.args[0] as IEventPayload_R2_EVENT_WEBVIEW_KEYUP;\n            if (_keyUpEventHandler) {\n                _keyUpEventHandler(payload, payload.elementName, payload.elementAttributes);\n            }\n        } else if (event.channel === R2_EVENT_CLIPBOARD_COPY) {\n            const clipboardInterceptor = win.READIUM2.clipboardInterceptor;\n            if (clipboardInterceptor) {\n                const payload = event.args[0] as IEventPayload_R2_EVENT_CLIPBOARD_COPY;\n                clipboardInterceptor(payload);\n            }\n        } else if (!highlightsHandleIpcMessage(event.channel, event.args, webview) &&\n            !ttsHandleIpcMessage(event.channel, event.args, webview) &&\n            !locationHandleIpcMessage(event.channel, event.args, webview) &&\n            !mediaOverlaysHandleIpcMessage(event.channel, event.args, webview) &&\n            !soundtrackHandleIpcMessage(event.channel, event.args, webview)) {\n\n            debug(\"webview ipc-message\");\n            debug(event.channel);\n        }\n    });\n\n    return wv as IReadiumElectronWebview;\n}\n\n// if (ENABLE_WEBVIEW_RESIZE) {\n//     // https://github.com/electron/electron/blob/v3.0.0/docs/api/breaking-changes.md#webcontents\n//     // https://github.com/electron/electron/blob/v3.0.0/docs/api/breaking-changes.md#webview\n//     // wv.setAttribute(\"disableguestresize\", \"\");\n//     const adjustResize = (webview: IReadiumElectronWebview) => {\n//         // https://javascript.info/size-and-scroll\n//         // offsetW/H: excludes margin, includes border, scrollbar, padding.\n//         // clientW/H: excludes margin, border, scrollbar, includes padding.\n//         // scrollW/H: like client, but includes hidden (overflow) areas\n//         const width = webview.clientWidth;\n//         const height = webview.clientHeight;\n\n//         const wc = webContents.fromId(webview.getWebContentsId());\n//         // const wc = webview.getWebContents();\n\n//         if (wc && (wc as any).setSize && width && height) {\n//             (wc as any).setSize({ // wc is WebContents, works in Electron < 3.0\n//                 normal: {\n//                     height,\n//                     width,\n//                 },\n//             });\n//         }\n//     };\n//     const onResizeDebounced = debounce(() => {\n//         const activeWebViews = win.READIUM2.getActiveWebViews();\n//         if (activeWebView) {\n//             adjustResize(activeWebView);\n//         }\n//     }, 200);\n//     window.addEventListener(\"resize\", () => {\n//         // const activeWebViews = win.READIUM2.getActiveWebViews();\n//         // if (!isFixedLayout(activeWebView.READIUM2.link)) {\n//         //     if (_rootHtmlElement) {\n//         //         _rootHtmlElement.dispatchEvent(new Event(DOM_EVENT_HIDE_VIEWPORT));\n//         //     }\n//         // }\n//         onResizeDebounced();\n//     });\n// }\n\nfunction createWebView(second?: boolean) {\n    const preloadScriptPath = win.READIUM2.preloadScriptPath;\n    const domSlidingViewport = win.READIUM2.domSlidingViewport;\n\n    if (second) {\n        if (_webview2) {\n            destroyWebView(true);\n        }\n        _webview2 = createWebViewInternal(preloadScriptPath);\n        _webview2.READIUM2 = {\n            id: 2,\n            link: undefined,\n            readiumCss: undefined,\n        };\n        _webview2.setAttribute(\"id\", \"r2_webview2\");\n        domSlidingViewport.appendChild(_webview2 as Node);\n    } else {\n        if (_webview1) {\n            destroyWebView(false);\n        }\n        _webview1 = createWebViewInternal(preloadScriptPath);\n        _webview1.READIUM2 = {\n            id: 1,\n            link: undefined,\n            readiumCss: undefined,\n        };\n        _webview1.setAttribute(\"id\", \"r2_webview1\");\n        domSlidingViewport.appendChild(_webview1 as Node);\n    }\n}\n\nfunction destroyWebView(second?: boolean): void {\n    const domSlidingViewport = win.READIUM2.domSlidingViewport;\n    if (second) {\n        if (_webview2) {\n            domSlidingViewport.removeChild(_webview2 as Node);\n            (_webview2 as any).READIUM2 = undefined;\n            (_webview2 as any) = undefined;\n        }\n    } else {\n        if (_webview1) {\n            domSlidingViewport.removeChild(_webview1 as Node);\n            (_webview1 as any).READIUM2 = undefined;\n            (_webview1 as any) = undefined;\n        }\n    }\n}\n\nexport function installNavigatorDOM(\n    publication: Publication,\n    publicationURL: string,\n    rootHtmlElementID: string,\n    preloadScriptPath: string,\n    location: Locator | undefined,\n    enableScreenReaderAccessibilityWebViewHardRefresh: boolean,\n    clipboardInterceptor: ((data: IEventPayload_R2_EVENT_CLIPBOARD_COPY) => void) | undefined,\n    sessionInfo: string | undefined,\n    rcss: IEventPayload_R2_EVENT_READIUMCSS | undefined,\n    ) {\n\n    // debug(JSON.stringify(publication, null, 4));\n    // debug(util.inspect(publication,\n    //     { showHidden: false, depth: 1000, colors: true, customInspect: true }));\n\n    const domRootElement = document.getElementById(rootHtmlElementID) as HTMLElement;\n    if (!domRootElement) {\n        debug(\"!rootHtmlElementID ???\");\n        return;\n    }\n\n    const domSlidingViewport = document.createElement(\"div\");\n    domSlidingViewport.setAttribute(\"id\", ELEMENT_ID_SLIDING_VIEWPORT);\n    domSlidingViewport.setAttribute(\"style\", \"display: block; position: absolute; left: 0; right: 0; \" +\n        \"top: 0; bottom: 0; margin: 0; padding: 0; box-sizing: border-box; background: white; overflow: hidden;\");\n\n    win.READIUM2 = {\n        DEBUG_VISUALS: false,\n        clipboardInterceptor,\n        createFirstWebView: createWebView,\n        createSecondWebView: () => {\n            createWebView(true);\n        },\n        destroyFirstWebView: destroyWebView,\n        destroySecondWebView: () => {\n            destroyWebView(true);\n        },\n        domRootElement,\n        domSlidingViewport,\n        enableScreenReaderAccessibilityWebViewHardRefresh:\n        enableScreenReaderAccessibilityWebViewHardRefresh ? true : false,\n        getActiveWebViews: (): IReadiumElectronWebview[] => {\n            const arr = [];\n            if (_webview1) {\n                arr.push(_webview1);\n            }\n            if (_webview2) {\n                arr.push(_webview2);\n            }\n            return arr;\n        },\n        getFirstOrSecondWebView: (): IReadiumElectronWebview | undefined => {\n            return _webview1 ? _webview1 : _webview2;\n        },\n        getFirstWebView: (): IReadiumElectronWebview | undefined => {\n            return _webview1;\n        },\n        getSecondWebView: (create: boolean): IReadiumElectronWebview | undefined => {\n            if (!_webview2 && create) {\n                createWebView(true);\n            }\n            return _webview2;\n        },\n        preloadScriptPath,\n        publication,\n        publicationURL,\n        sessionInfo,\n        ttsClickEnabled: false,\n        ttsPlaybackRate: 1,\n    };\n\n    if (IS_DEV) {\n        debug(\"||||||++||||| installNavigatorDOM: \", JSON.stringify(location));\n\n        const debugVisualz = (window.localStorage &&\n            window.localStorage.getItem(URL_PARAM_DEBUG_VISUALS) === \"true\") ? true : false;\n        debug(\"debugVisuals GET: \", debugVisualz);\n\n        win.READIUM2.DEBUG_VISUALS = debugVisualz;\n\n        (window as any).READIUM2.debug = async (debugVisuals: boolean) => {\n            debug(\"debugVisuals SET: \", debugVisuals);\n            win.READIUM2.DEBUG_VISUALS = debugVisuals;\n            if (window.localStorage) {\n                window.localStorage.setItem(URL_PARAM_DEBUG_VISUALS, debugVisuals ? \"true\" : \"false\");\n            }\n\n            const loc = getCurrentReadingLocation();\n\n            const activeWebViews = win.READIUM2.getActiveWebViews();\n            for (const activeWebView of activeWebViews) {\n                const payload: IEventPayload_R2_EVENT_DEBUG_VISUALS = { debugVisuals };\n                setTimeout(async () => {\n                    await activeWebView.send(R2_EVENT_DEBUG_VISUALS, payload);\n                }, 0);\n                if (loc && loc.locator.href === activeWebView.READIUM2.link?.Href) {\n\n                    await new Promise((res, _rej) => {\n                        setTimeout(() => {\n                            debug(`READIUM2.debug -> handleLinkLocator`);\n                            handleLinkLocator(\n                                loc.locator,\n                                activeWebView.READIUM2.readiumCss,\n                            );\n                            res();\n                        }, 100);\n                    });\n                }\n            }\n        };\n\n        (window as any).READIUM2.debugItems =\n            (href: string, cssSelector: string, cssClass: string, cssStyles: string | undefined) => {\n\n                if (cssStyles) {\n                    debug(\"debugVisuals ITEMS: \", `${cssSelector} --- ${cssClass} --- ${cssStyles}`);\n                }\n\n                const activeWebViews = win.READIUM2.getActiveWebViews();\n                for (const activeWebView of activeWebViews) {\n                    if (activeWebView.READIUM2.link?.Href !== href) {\n                        continue;\n                    }\n                    // let delay = 0;\n                    // if (!win.READIUM2.DEBUG_VISUALS) {\n                    //     (window as any).READIUM2.debug(true);\n                    //     delay = 200;\n                    // }\n                    // setTimeout(() => {\n                    //     if (activeWebView) {\n                    //         const payload: IEventPayload_R2_EVENT_DEBUG_VISUALS\n                    //             = { debugVisuals: true, cssSelector, cssClass, cssStyles };\n                    //         activeWebView.send(R2_EVENT_DEBUG_VISUALS, payload);\n                    //     }\n                    // }, delay);\n\n                    const d = win.READIUM2.DEBUG_VISUALS;\n                    const payload: IEventPayload_R2_EVENT_DEBUG_VISUALS\n                        = { debugVisuals: d, cssSelector, cssClass, cssStyles };\n\n                    setTimeout(async () => {\n                        await activeWebView.send(R2_EVENT_DEBUG_VISUALS, payload);\n                    }, 0);\n                }\n            };\n    }\n\n    domRootElement.appendChild(domSlidingViewport);\n\n    createWebView();\n\n    setTimeout(() => {\n        debug(`installNavigatorDOM -> handleLinkLocator`);\n        handleLinkLocator(location, rcss);\n    }, 100);\n}\n\nlet _keyDownEventHandler: (\n    ev: IKeyboardEvent,\n    elementName: string,\n    elementAttributes: {[name: string]: string},\n) => void;\nexport function setKeyDownEventHandler(func: (\n    ev: IKeyboardEvent,\n    elementName: string,\n    elementAttributes: {[name: string]: string},\n) => void) {\n\n    _keyDownEventHandler = func;\n}\n\nlet _keyUpEventHandler: (\n    ev: IKeyboardEvent,\n    elementName: string,\n    elementAttributes: {[name: string]: string},\n) => void;\nexport function setKeyUpEventHandler(func: (\n    ev: IKeyboardEvent,\n    elementName: string,\n    elementAttributes: {[name: string]: string},\n) => void) {\n\n    _keyUpEventHandler = func;\n}\n"]}