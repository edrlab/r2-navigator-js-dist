{"version":3,"file":"readium-css.js","sourceRoot":"","sources":["../../../../../src/electron/main/readium-css.ts"],"names":[],"mappings":";;AASA,qEAAmE;AACnE,+EAA2E;AAE3E,mCAAmC;AAGnC,qEAA6D;AAC7D,yEAAsE;AAEtE,SAAgB,eAAe,CAC3B,MAAc,EAAE,UAAkB,EAClC,gBAA6F;IAG7F,MAAM,aAAa,GAAG;QAClB,QAAQ,EAAE,QAAQ;QAClB,IAAI,EAAE,IAAI;QACV,WAAW,EAAE,KAAK;QAClB,SAAS,EAAE,IAAI;QACf,KAAK,EAAE,KAAK;QACZ,MAAM,EAAE,IAAI;QACZ,QAAQ,EAAE,KAAK;QAEf,UAAU,EAAE,CAAC,GAAqB,EAAE,KAAa,EAAE,KAAU,EAAE,EAAE;YAE7D,MAAM,CAAC,eAAe,CAAC,GAAG,CAAC,CAAC;QAChC,CAAC;KACJ,CAAC;IAEF,MAAM,CAAC,UAAU,CAAC,GAAG,GAAG,2CAAoB,EAAE,OAAO,CAAC,MAAM,CAAC,UAAU,EAAE,aAAa,CAAC,CAAC,CAAC;IAEzF,IAAI,gBAAgB,EAAE;QAClB,MAAM,WAAW,GAAG,CAAC,WAAwB,EAAE,IAAU,EAAE,GAAW,EAAU,EAAE;YAG9E,IAAI,SAAS,GAAG,uBAAuB,CAAC;YACxC,IAAI,IAAI,IAAI,IAAI,CAAC,QAAQ,EAAE;gBACvB,SAAS,GAAG,IAAI,CAAC,QAAQ,CAAC;aAC7B;YAED,MAAM,cAAc,GAAG,gBAAgB,CAAC,WAAW,EAAE,IAAI,CAAC,CAAC;YAC3D,IAAI,cAAc,EAAE;gBAChB,OAAO,kCAAa,CAAC,GAAG,EAAE,cAAc,EAAE,SAAS,CAAC,CAAC;aACxD;iBAAM;gBACH,OAAO,GAAG,CAAC;aACd;QACL,CAAC,CAAC;QACF,0BAAY,CAAC,QAAQ,EAAE,CAAC,GAAG,CAAC,IAAI,kCAAe,CAAC,WAAW,CAAC,CAAC,CAAC;KACjE;AACL,CAAC;AAxCD,0CAwCC","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport { Publication } from \"@r2-shared-js/models/publication\";\nimport { Link } from \"@r2-shared-js/models/publication-link\";\nimport { Transformers } from \"@r2-shared-js/transform/transformer\";\nimport { TransformerHTML } from \"@r2-shared-js/transform/transformer-html\";\nimport { Server } from \"@r2-streamer-js/http/server\";\nimport * as express from \"express\";\n\nimport { IEventPayload_R2_EVENT_READIUMCSS } from \"../common/events\";\nimport { transformHTML } from \"../common/readium-css-inject\";\nimport { READIUM_CSS_URL_PATH } from \"../common/readium-css-settings\";\n\nexport function setupReadiumCSS(\n    server: Server, folderPath: string,\n    readiumCssGetter: (publication: Publication, link: Link) => IEventPayload_R2_EVENT_READIUMCSS) {\n\n    // https://expressjs.com/en/4x/api.html#express.static\n    const staticOptions = {\n        dotfiles: \"ignore\",\n        etag: true,\n        fallthrough: false,\n        immutable: true,\n        index: false,\n        maxAge: \"1d\",\n        redirect: false,\n        // extensions: [\"css\", \"otf\"],\n        setHeaders: (res: express.Response, _path: string, _stat: any) => {\n            //   res.set('x-timestamp', Date.now())\n            server.setResponseCORS(res);\n        },\n    };\n\n    server.expressUse(\"/\" + READIUM_CSS_URL_PATH, express.static(folderPath, staticOptions));\n\n    if (readiumCssGetter) {\n        const transformer = (publication: Publication, link: Link, str: string): string => {\n\n            // import * as mime from \"mime-types\";\n            let mediaType = \"application/xhtml+xml\"; // mime.lookup(link.Href);\n            if (link && link.TypeLink) {\n                mediaType = link.TypeLink;\n            }\n\n            const readiumcssJson = readiumCssGetter(publication, link);\n            if (readiumcssJson) {\n                return transformHTML(str, readiumcssJson, mediaType);\n            } else {\n                return str;\n            }\n        };\n        Transformers.instance().add(new TransformerHTML(transformer));\n    }\n}\n"]}