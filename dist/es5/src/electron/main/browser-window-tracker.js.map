{"version":3,"file":"browser-window-tracker.js","sourceRoot":"","sources":["../../../../../src/electron/main/browser-window-tracker.ts"],"names":[],"mappings":";;;AAOA,8BAAgC;AAChC,qCAA+B;AAE/B,2CAA8E;AAI9E,IAAM,KAAK,GAAG,MAAM,CAAC,mDAAmD,CAAC,CAAC;AAE1E,IAAI,uBAAiD,CAAC;AAItD,SAAgB,kBAAkB,CAAC,GAA2B,EAAE,UAAmB;IAI/E,IAAI,CAAC,uBAAuB,EAAE;QAC1B,uBAAuB,GAAG,EAAE,CAAC;KAChC;IACD,uBAAuB,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;IAElC,GAAG,CAAC,EAAE,CAAC,QAAQ,EAAE;QACb,IAAM,CAAC,GAAG,uBAAuB,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;QAC/C,IAAI,CAAC,GAAG,CAAC,EAAE;YACP,OAAO;SACV;QACD,uBAAuB,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;IACzC,CAAC,CAAC,CAAC;AACP,CAAC;AAhBD,gDAgBC;AAGD,cAAG,CAAC,EAAE,CAAC,sBAAsB,EAAE,UAAC,IAAI,EAAE,EAAE;IACpC,EAAE,CAAC,EAAE,CAAC,qBAAqB,EAAE,UAAC,MAAM,EAAE,cAAc,EAAE,MAAM;QACxD,KAAK,CAAC,6BAA6B,CAAC,CAAC;QACrC,IAAI,MAAM,CAAC,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,UAAU,CAAC,OAAO,CAAC,EAAE;YAC/C,KAAK,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;SACrB;QAKD,cAAc,CAAC,gBAAgB,GAAG,KAAK,CAAC;QACxC,cAAc,CAAC,UAAU,GAAG,IAAI,CAAC;QACjC,cAAc,CAAC,WAAW,GAAG,IAAI,CAAC;QAClC,cAAc,CAAC,eAAe,GAAG,KAAK,CAAC;QACvC,cAAc,CAAC,uBAAuB,GAAG,KAAK,CAAC;QAC/C,cAAc,CAAC,2BAA2B,GAAG,KAAK,CAAC;QAGnD,cAAc,CAAC,kBAAkB,GAAG,KAAK,CAAC;IAa9C,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,EAAE,CAAC,eAAe,EAAE;QACrB,OAAO;KACV;IAED,IAAI,CAAC,uBAAuB,IAAI,CAAC,uBAAuB,CAAC,MAAM,EAAE;QAC7D,OAAO;KACV;IACD,uBAAuB,CAAC,OAAO,CAAC,UAAC,GAAG;QAChC,IAAI,EAAE,CAAC,eAAe,CAAC,EAAE,KAAK,GAAG,CAAC,WAAW,CAAC,EAAE,EAAE;YAC9C,KAAK,CAAC,8BAA8B,CAAC,CAAC;YAEtC,EAAE,CAAC,EAAE,CAAC,eAAe,EAAE,UAAC,KAAK,EAAE,GAAG;gBAC9B,KAAK,CAAC,6CAA6C,CAAC,CAAC;gBACrD,KAAK,CAAC,GAAG,CAAC,CAAC;gBACX,KAAK,CAAC,cAAc,EAAE,CAAC;gBAavB,IAAI,KAAK,EAAE;oBACP,KAAK,CAAC,0BAA0B,CAAC,CAAC;oBAClC,OAAO;iBACV;gBAED,IAAM,OAAO,GAAgC;oBACzC,GAAG,KAAA;iBACN,CAAC;gBAEF,GAAG,CAAC,WAAW,CAAC,IAAI,CAAC,sBAAa,EAAE,OAAO,CAAC,CAAC;YACjD,CAAC,CAAC,CAAC;SACN;IACL,CAAC,CAAC,CAAC;AACP,CAAC,CAAC,CAAC","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport * as debug_ from \"debug\";\nimport { app } from \"electron\";\n\nimport { IEventPayload_R2_EVENT_LINK, R2_EVENT_LINK } from \"../common/events\";\n\n// import { READIUM2_ELECTRON_HTTP_PROTOCOL } from \"../common/sessions\";\n\nconst debug = debug_(\"r2:navigator#electron/main/browser-window-tracker\");\n\nlet _electronBrowserWindows: Electron.BrowserWindow[];\n\n// let _serverURL: string | undefined;\n\nexport function trackBrowserWindow(win: Electron.BrowserWindow, _serverURL?: string) {\n\n    // _serverURL = serverURL;\n\n    if (!_electronBrowserWindows) {\n        _electronBrowserWindows = [];\n    }\n    _electronBrowserWindows.push(win);\n\n    win.on(\"closed\", () => {\n        const i = _electronBrowserWindows.indexOf(win);\n        if (i < 0) {\n            return;\n        }\n        _electronBrowserWindows.splice(i, 1);\n    });\n}\n\n// https://github.com/electron/electron/blob/master/docs/tutorial/security.md#how-9\napp.on(\"web-contents-created\", (_evt, wc) => {\n    wc.on(\"will-attach-webview\", (_event, webPreferences, params) => {\n        debug(\"WEBVIEW will-attach-webview\");\n        if (params.src && !params.src.startsWith(\"data:\")) {\n            debug(params.src);\n        }\n\n        // delete webPreferences.preload;\n        // delete webPreferences.preloadURL;\n\n        webPreferences.contextIsolation = false;\n        webPreferences.javascript = true;\n        webPreferences.webSecurity = true;\n        webPreferences.nodeIntegration = false;\n        webPreferences.nodeIntegrationInWorker = false;\n        webPreferences.allowRunningInsecureContent = false;\n\n        // works in Electron v3 because webPreferences is any instead of WebPreferences\n        webPreferences.enableRemoteModule = false;\n\n        // TODO: prevent loading remote publications?\n        // const fail = !params.src.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL) &&\n        //     (_serverURL ? !params.src.startsWith(_serverURL) :\n        //         !(/^http[s]?:\\/\\/127\\.0\\.0\\.1/.test(params.src))\n        //         // (!params.src.startsWith(\"https://127.0.0.1\") && !params.src.startsWith(\"http://127.0.0.1\"))\n        //         );\n\n        // if (fail) {\n        //     debug(\"WEBVIEW will-attach-webview FAIL: \" + params.src);\n        //     event.preventDefault();\n        // }\n    });\n\n    if (!wc.hostWebContents) {\n        return;\n    }\n\n    if (!_electronBrowserWindows || !_electronBrowserWindows.length) {\n        return;\n    }\n    _electronBrowserWindows.forEach((win) => {\n        if (wc.hostWebContents.id === win.webContents.id) {\n            debug(\"WEBVIEW web-contents-created\");\n\n            wc.on(\"will-navigate\", (event, url) => {\n                debug(\"webview.getWebContents().on('will-navigate'\");\n                debug(url);\n                event.preventDefault();\n\n                // Note that event.stopPropagation() and event.url\n                // only exists on WebView `will-navigate` event,\n                // but not WebContents! However the WebView event.preventDefault() does NOT prevent link loading!\n                // https://www.electronjs.org/docs/api/webview-tag#event-will-navigate\n                // vs.:\n                // https://www.electronjs.org/docs/api/web-contents#event-will-navigate\n                // TODO: see if we can intercept `will-navigate` in the renderer process\n                // directly where WebView elements are created. Perhaps the infinite loop problem\n                // (see below) does not occur in this alternative context.\n\n                // unfortunately 'will-navigate' enters an infinite loop with HTML <base href=\"HTTP_URL\" /> ! :(\n                if (event) { // THIS IS ALWAYS TRUE (intentionally)\n                    debug(\"'will-navigate' SKIPPED.\");\n                    return;\n                }\n\n                const payload: IEventPayload_R2_EVENT_LINK = {\n                    url,\n                };\n                // ipcMain.emit\n                win.webContents.send(R2_EVENT_LINK, payload);\n            });\n        }\n    });\n});\n"]}