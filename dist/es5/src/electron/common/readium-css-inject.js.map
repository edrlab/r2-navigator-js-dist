{"version":3,"file":"readium-css-inject.js","sourceRoot":"","sources":["../../../../../src/electron/common/readium-css-inject.ts"],"names":[],"mappings":"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","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport * as debug_ from \"debug\";\n\nimport { parseDOM, serializeDOM } from \"./dom\";\nimport { IEventPayload_R2_EVENT_READIUMCSS } from \"./events\";\nimport { IwidthHeight } from \"./fxl\";\nimport { READIUM_CSS_URL_PATH } from \"./readium-css-settings\";\nimport { READIUM2_ELECTRON_HTTP_PROTOCOL, convertCustomSchemeToHttpUrl } from \"./sessions\";\nimport {\n    CLASS_PAGINATED, ROOT_CLASS_FIXED_LAYOUT, ROOT_CLASS_INVISIBLE_MASK,\n    ROOT_CLASS_INVISIBLE_MASK_REMOVED, ROOT_CLASS_MATHJAX, ROOT_CLASS_NO_FOOTNOTES,\n    ROOT_CLASS_REDUCE_MOTION, WebViewSlotEnum, audioCssStyles, focusCssStyles, footnotesCssStyles,\n    mediaOverlaysCssStyles, readPosCssStyles, scrollBarCssStyles, selectionCssStyles,\n    targetCssStyles, ttsCssStyles, visibilityMaskCssStyles,\n} from \"./styles\";\n\nexport const READIUM2_BASEURL_ID = \"r2_BASEURL_ID\";\n\n// now match with :root[style*=\"readium-night-on\"]\n// const CSS_CLASS_DARK_THEME = \"mdc-theme--dark\";\n\n// tslint:disable-next-line:max-line-length\n// https://github.com/readium/readium-css/blob/develop/docs/CSS16-internationalization.md\n// tslint:disable-next-line:max-line-length\n// https://github.com/readium/readium-css/blob/develop/docs/CSS12-user_prefs.md#user-settings-can-be-language-specific\n\nconst IS_DEV = (process.env.NODE_ENV === \"development\" || process.env.NODE_ENV === \"dev\");\n\nconst debug = debug_(\"r2:navigator#electron/common/readium-css-inject\");\n\n// import { IReadiumElectronWebviewWindow } from \"../renderer/webview/state\";\n// ((global as any).window as IReadiumElectronWebviewWindow).READIUM2.DEBUG_VISUALS\nfunction isDEBUG_VISUALS(documant: Document): boolean {\n    if (!IS_DEV) {\n        return false;\n    }\n    if (documant.defaultView && (documant.defaultView as any).READIUM2 &&\n        (documant.defaultView as any).READIUM2.DEBUG_VISUALS) {\n        return true;\n    }\n    return false;\n}\n\nexport function isDocVertical(documant: Document): boolean {\n    if (!documant || !documant.documentElement) {\n        return false;\n    }\n\n    // let vertical = false;\n\n    // let langAttr = documant.documentElement.getAttribute(\"lang\");\n    // if (!langAttr) {\n    //     langAttr = documant.documentElement.getAttribute(\"xml:lang\");\n    // }\n    // if (!langAttr) {\n    //     langAttr = documant.documentElement.getAttributeNS(\"http://www.w3.org/XML/1998/\", \"lang\");\n    // }\n    // if (langAttr &&\n    //     (langAttr === \"zh\" || langAttr.startsWith(\"zh-\") ||\n    //     langAttr === \"ja\" || langAttr.startsWith(\"ja-\") ||\n    //     langAttr === \"ko\" || langAttr.startsWith(\"ko-\"))) {\n    //     // foundLang = true;\n    //     vertical = true;\n    // }\n\n    // return vertical;\n\n    return false;\n}\n\nexport function isDocRTL(documant: Document): boolean {\n    if (!documant || !documant.documentElement) {\n        return false;\n    }\n\n    let rtl = false;\n\n    let foundDir = false;\n\n    let dirAttr = documant.documentElement.getAttribute(\"dir\");\n    if (dirAttr === \"rtl\") {\n        foundDir = true;\n        rtl = true;\n    }\n    if (!rtl && documant.body) {\n        dirAttr = documant.body.getAttribute(\"dir\");\n        if (dirAttr === \"rtl\") {\n            foundDir = true;\n            rtl = true;\n        }\n    }\n\n    // let foundLang = false;\n\n    if (!rtl) {\n        let langAttr = documant.documentElement.getAttribute(\"lang\");\n        if (!langAttr) {\n            langAttr = documant.documentElement.getAttribute(\"xml:lang\");\n        }\n        if (!langAttr) {\n            langAttr = documant.documentElement.getAttributeNS(\"http://www.w3.org/XML/1998/\", \"lang\");\n        }\n        if (langAttr &&\n            (langAttr === \"ar\" || langAttr.startsWith(\"ar-\") ||\n            langAttr === \"he\" || langAttr.startsWith(\"he-\") ||\n            langAttr === \"fa\" || langAttr.startsWith(\"fa-\")) ||\n            langAttr === \"zh-Hant\" ||\n            langAttr === \"zh-TW\"\n            ) {\n            // foundLang = true;\n            rtl = true;\n        }\n    }\n    if (rtl) {\n        if (!foundDir) {\n            documant.documentElement.setAttribute(\"dir\", \"rtl\");\n        }\n        // really?\n        // if (!foundLang) {\n        //     documant.documentElement.setAttribute(\"lang\", \"ar\");\n        //     // documant.documentElement.setAttributeNS(\"http://www.w3.org/XML/1998/\", \"lang\", \"ar\");\n        //     documant.documentElement.setAttribute(\"xml:lang\", \"ar\");\n        // }\n    }\n    return rtl;\n}\n\nexport function isPaginated(documant: Document): boolean {\n    return documant && documant.documentElement &&\n        documant.documentElement.classList.contains(CLASS_PAGINATED);\n}\n\n// tslint:disable-next-line:max-line-length\n// https://github.com/readium/readium-css/blob/develop/docs/CSS12-user_prefs.md\n// tslint:disable-next-line:max-line-length\n// https://github.com/readium/readium-css/blob/develop/docs/ReadiumCSS-user_variables.css\n// tslint:disable-next-line:max-line-length\n// https://github.com/readium/readium-css/blob/develop/docs/CSS19-api.md#user-settings\nexport function readiumCSSSet(\n    documant: Document,\n    messageJson: IEventPayload_R2_EVENT_READIUMCSS,\n    isVerticalWritingMode: boolean, isRTL: boolean) {\n\n    if (!messageJson) {\n        return;\n    }\n\n    if (!documant || !documant.documentElement) {\n        return;\n    }\n\n    if (!messageJson.urlRoot) {\n        // can be \"null\" with data: URL (such as audiobooks HTML template)\n        // let origin = win.location.origin;\n        // let href = win.location.href;\n        const baseEl = documant.getElementById(READIUM2_BASEURL_ID);\n        if (baseEl) {\n            const baseUrl = baseEl.getAttribute(\"href\");\n            if (baseUrl) {\n                let u = baseUrl;\n                if (baseUrl.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\")) {\n                    u = convertCustomSchemeToHttpUrl(baseUrl);\n                }\n                u = u.replace(/\\/pub\\/.*/, \"\");\n                messageJson.urlRoot = u;\n            }\n        }\n    }\n\n    if (IS_DEV) {\n        debug(\"_____ readiumCssJson.urlRoot (readiumCSSSet()): \", messageJson.urlRoot);\n    }\n\n    const docElement = documant.documentElement;\n\n    if (messageJson.isFixedLayout) {\n        // docElement.style.overflow = \"hidden\";\n        docElement.classList.add(ROOT_CLASS_FIXED_LAYOUT);\n        return; // exit early\n    }\n\n    const setCSS = messageJson.setCSS;\n    if (!setCSS) {\n\n        docElement.classList.remove(ROOT_CLASS_NO_FOOTNOTES);\n\n        docElement.removeAttribute(\"data-readiumcss\");\n        removeAllCSS(documant);\n        // removeAllCSSInline(documant);\n\n        if (messageJson.isFixedLayout) {\n            docElement.style.overflow = \"hidden\";\n        } else {\n            docElement.style.overflow = \"auto\";\n        }\n\n        const toRemove: string[] = [];\n        for (let i = 0; i < docElement.style.length; i++) {\n            const item = docElement.style.item(i);\n            if (item.indexOf(\"--USER__\") === 0) {\n                toRemove.push(item);\n            }\n        }\n        toRemove.forEach((item) => {\n            docElement.style.removeProperty(item);\n        });\n\n        // docElement.classList.remove(CSS_CLASS_DARK_THEME);\n\n        return;\n    }\n\n    if (!docElement.hasAttribute(\"data-readiumcss\")) {\n        docElement.setAttribute(\"data-readiumcss\", \"yes\");\n\n        let needsDefaultCSS = true;\n\n        // Not in XMLDOM :(\n        // if (documant.head && documant.head.childElementCount) {\n        //     let elem = documant.head.firstElementChild;\n        //     while (elem) {\n        //         // ...\n        //         elem = elem.nextElementSibling;\n        //     }\n        // }\n        if (documant.head && documant.head.childNodes && documant.head.childNodes.length) {\n            // tslint:disable-next-line: prefer-for-of\n            for (let i = 0; i < documant.head.childNodes.length; i++) {\n                const child = documant.head.childNodes[i];\n                if (child.nodeType === 1) { // Node.ELEMENT_NODE\n                    const element = child as Element;\n                    if ((element.localName && element.localName.toLowerCase() === \"style\") ||\n                        (element.getAttribute &&\n                            (element.getAttribute(\"rel\") === \"stylesheet\" ||\n                                element.getAttribute(\"type\") === \"text/css\" ||\n                                (element.getAttribute(\"src\") &&\n                                    (element.getAttribute(\"src\") as string).endsWith(\".css\"))))) {\n                        needsDefaultCSS = false;\n                        break;\n                    }\n                }\n            }\n        }\n\n        if (needsDefaultCSS && documant.body) {\n            // Not in XMLDOM :(\n            // querySelector(\"*[style]\");\n            const styleAttr = documant.body.getAttribute(\"style\");\n            if (styleAttr) {\n                needsDefaultCSS = false;\n            }\n        }\n\n        const urlRoot = messageJson.urlRoot + \"/\" + READIUM_CSS_URL_PATH + \"/\";\n\n        appendCSS(documant, \"before\", urlRoot);\n        if (needsDefaultCSS) {\n            appendCSS(documant, \"default\", urlRoot);\n        }\n        appendCSS(documant, \"after\", urlRoot);\n    }\n\n    if (isDEBUG_VISUALS(documant)) {\n        debug(\"---- setCSS -----\");\n        debug(setCSS);\n        debug(\"-----\");\n    }\n\n    if (setCSS.noFootnotes) {\n        docElement.classList.add(ROOT_CLASS_NO_FOOTNOTES);\n    } else {\n        docElement.classList.remove(ROOT_CLASS_NO_FOOTNOTES);\n    }\n\n    if (setCSS.mathJax) {\n        docElement.classList.add(ROOT_CLASS_MATHJAX);\n    } else {\n        docElement.classList.remove(ROOT_CLASS_MATHJAX);\n    }\n\n    if (setCSS.reduceMotion) {\n        docElement.classList.add(ROOT_CLASS_REDUCE_MOTION);\n    } else {\n        docElement.classList.remove(ROOT_CLASS_REDUCE_MOTION);\n    }\n\n    // if (setCSS.night) {\n    //     // documant.body\n    //     docElement.classList.add(CSS_CLASS_DARK_THEME);\n    // } else {\n    //     // documant.body\n    //     docElement.classList.remove(CSS_CLASS_DARK_THEME);\n    // }\n\n    const needsAdvanced = true; // textAlign, bodyHyphens, fontSize, etc.\n\n    // readium-advanced-on | readium-advanced-off\n    docElement.style.setProperty(\"--USER__advancedSettings\",\n        needsAdvanced ? \"readium-advanced-on\" : \"readium-advanced-off\");\n\n    // readium-darken-on | readium-darken-off\n    if (typeof setCSS.darken === \"undefined\") {\n        docElement.style.removeProperty(\"--USER__darkenFilter\");\n    } else {\n        docElement.style.setProperty(\"--USER__darkenFilter\",\n            setCSS.darken ? \"readium-darken-on\" : \"readium-darken-off\");\n    }\n\n    // readium-invert-on | readium-invert-off\n    if (typeof setCSS.invert === \"undefined\") {\n        docElement.style.removeProperty(\"--USER__invertFilter\");\n    } else {\n        docElement.style.setProperty(\"--USER__invertFilter\",\n            setCSS.invert ? \"readium-invert-on\" : \"readium-invert-off\");\n    }\n\n    // readium-default-on | readium-sepia-on | readium-night-on\n    docElement.style.setProperty(\"--USER__appearance\",\n        setCSS.sepia ? \"readium-sepia-on\" :\n        (setCSS.night ? \"readium-night-on\" : \"readium-default-on\"));\n\n    // readium-paged-on | readium-scroll-on\n    docElement.style.setProperty(\"--USER__view\",\n        setCSS.paged ? \"readium-paged-on\" : \"readium-scroll-on\");\n    if (setCSS.paged) {\n        docElement.style.overflow = \"hidden\";\n        docElement.classList.add(CLASS_PAGINATED);\n    } else {\n        docElement.style.overflow = \"auto\";\n        docElement.classList.remove(CLASS_PAGINATED);\n    }\n\n    const defaultPublisherFont = !setCSS.font || setCSS.font === \"DEFAULT\";\n\n    const a11yNormalize = ((typeof setCSS.a11yNormalize !== \"undefined\") ?\n        (setCSS.a11yNormalize ? \"readium-a11y-on\" : \"readium-a11y-off\") :\n        \"readium-a11y-off\" // will remove, because undefined\n        );\n\n    const needsFontOverride = a11yNormalize === \"readium-a11y-on\" || !defaultPublisherFont;\n\n    // readium-font-on | readium-font-off\n    docElement.style.setProperty(\"--USER__fontOverride\",\n        needsFontOverride ? \"readium-font-on\" : \"readium-font-off\");\n\n    // readium-a11y-on | readium-a11y-off\n    if (typeof setCSS.a11yNormalize === \"undefined\") {\n        docElement.style.removeProperty(\"--USER__a11yNormalize\");\n    } else {\n        docElement.style.setProperty(\"--USER__a11yNormalize\", a11yNormalize);\n    }\n\n    if (defaultPublisherFont) {\n        docElement.style.removeProperty(\"--USER__fontFamily\");\n    } else {\n        const font = setCSS.font;\n        let fontValue = \"\";\n        if (font === \"DUO\" || font === \"IA Writer Duospace\") {\n            fontValue = \"IA Writer Duospace\";\n        } else if (font === \"DYS\" || font === \"AccessibleDfa\") {\n            fontValue = \"AccessibleDfa\";\n        } else if (font === \"OLD\" || font === \"oldStyleTf\") {\n            fontValue = \"var(--RS__oldStyleTf)\";\n        } else if (font === \"MODERN\" || font === \"modernTf\") {\n            fontValue = \"var(--RS__modernTf)\";\n        } else if (font === \"SANS\" || font === \"sansTf\") {\n            fontValue = \"var(--RS__sansTf)\";\n        } else if (font === \"HUMAN\" || font === \"humanistTf\") {\n            fontValue = \"var(--RS__humanistTf)\";\n        } else if (font === \"MONO\" || font === \"monospaceTf\") {\n            fontValue = \"var(--RS__monospaceTf)\";\n        } else if (font === \"JA\" || font === \"serif-ja\") {\n            fontValue = \"var(--RS__serif-ja)\";\n        } else if (font === \"JA-SANS\" || font === \"sans-serif-ja\") {\n            fontValue = \"var(--RS__sans-serif-ja)\";\n        } else if (font === \"JA-V\" || font === \"serif-ja-v\") {\n            fontValue = \"var(--RS__serif-ja-v)\";\n        } else if (font === \"JA-V-SANS\" || font === \"sans-serif-ja-v\") {\n            fontValue = \"var(--RS__sans-serif-ja-v)\";\n        } else if (typeof font === \"string\") {\n            fontValue = font;\n        }\n        if (fontValue) {\n            docElement.style.setProperty(\"--USER__fontFamily\", fontValue);\n        } else {\n            docElement.style.removeProperty(\"--USER__fontFamily\");\n        }\n    }\n\n    if (setCSS.fontSize && setCSS.fontSize.trim() !== \"0\" && setCSS.fontSize.trim() !== \"100%\") {\n        docElement.style.setProperty(\"--USER__fontSize\", setCSS.fontSize);\n    } else {\n        docElement.style.removeProperty(\"--USER__fontSize\");\n    }\n\n    if (setCSS.lineHeight && setCSS.lineHeight.trim() !== \"0\") {\n        docElement.style.setProperty(\"--USER__lineHeight\", setCSS.lineHeight);\n    } else {\n        docElement.style.removeProperty(\"--USER__lineHeight\");\n    }\n\n    if (setCSS.typeScale && setCSS.typeScale.trim() !== \"0\") {\n        docElement.style.setProperty(\"--USER__typeScale\", setCSS.typeScale);\n    } else {\n        docElement.style.removeProperty(\"--USER__typeScale\");\n    }\n\n    if (setCSS.paraSpacing && setCSS.paraSpacing.trim() !== \"0\") {\n        docElement.style.setProperty(\"--USER__paraSpacing\", setCSS.paraSpacing);\n    } else {\n        docElement.style.removeProperty(\"--USER__paraSpacing\");\n    }\n\n    const isCJK = false; // TODO, lang tag?\n    if (isVerticalWritingMode || (isRTL || isCJK)) {\n        docElement.style.removeProperty(\"--USER__bodyHyphens\");\n\n        docElement.style.removeProperty(\"--USER__wordSpacing\");\n\n        docElement.style.removeProperty(\"--USER__letterSpacing\");\n\n        if (isVerticalWritingMode || isCJK) {\n            if (isVerticalWritingMode) {\n                docElement.style.removeProperty(\"--USER__colCount\");\n            }\n\n            docElement.style.removeProperty(\"--USER__paraIndent\");\n\n            docElement.style.removeProperty(\"--USER__textAlign\");\n\n        } else if (isRTL) {\n            if (setCSS.ligatures) {\n                docElement.style.setProperty(\"--USER__ligatures\", setCSS.ligatures);\n            } else {\n                docElement.style.removeProperty(\"--USER__ligatures\");\n            }\n        }\n    } else {\n        if (setCSS.bodyHyphens) {\n            docElement.style.setProperty(\"--USER__bodyHyphens\", setCSS.bodyHyphens);\n        } else {\n            docElement.style.removeProperty(\"--USER__bodyHyphens\");\n        }\n\n        if (setCSS.wordSpacing && setCSS.wordSpacing.trim() !== \"0\") {\n            docElement.style.setProperty(\"--USER__wordSpacing\", setCSS.wordSpacing);\n        } else {\n            docElement.style.removeProperty(\"--USER__wordSpacing\");\n        }\n\n        if (setCSS.letterSpacing && setCSS.letterSpacing.trim() !== \"0\") {\n            docElement.style.setProperty(\"--USER__letterSpacing\", setCSS.letterSpacing);\n        } else {\n            docElement.style.removeProperty(\"--USER__letterSpacing\");\n        }\n    }\n\n    if (!isVerticalWritingMode) {\n        if (setCSS.colCount) {\n            docElement.style.setProperty(\"--USER__colCount\", setCSS.colCount);\n        } else {\n            docElement.style.removeProperty(\"--USER__colCount\");\n        }\n\n        if (setCSS.paraIndent && setCSS.paraIndent.trim() !== \"0\") {\n            docElement.style.setProperty(\"--USER__paraIndent\", setCSS.paraIndent);\n        } else {\n            docElement.style.removeProperty(\"--USER__paraIndent\");\n        }\n\n        if (setCSS.textAlign) {\n            docElement.style.setProperty(\"--USER__textAlign\", setCSS.textAlign);\n        } else {\n            docElement.style.removeProperty(\"--USER__textAlign\");\n        }\n    } else if (!isRTL) {\n        docElement.style.removeProperty(\"--USER__ligatures\");\n    }\n\n    if (setCSS.pageMargins && setCSS.pageMargins.trim() !== \"0\") {\n        docElement.style.setProperty(\"--USER__pageMargins\", setCSS.pageMargins);\n    } else {\n        docElement.style.removeProperty(\"--USER__pageMargins\");\n    }\n\n    if (setCSS.backgroundColor) {\n        docElement.style.setProperty(\"--USER__backgroundColor\", setCSS.backgroundColor);\n    } else {\n        docElement.style.removeProperty(\"--USER__backgroundColor\");\n    }\n    if (setCSS.textColor) {\n        docElement.style.setProperty(\"--USER__textColor\", setCSS.textColor);\n    } else {\n        docElement.style.removeProperty(\"--USER__textColor\");\n    }\n}\n\nexport function configureFixedLayout(\n        documant: Document,\n        isFixedLayout: boolean,\n        fxlViewportWidth: number, fxlViewportHeight: number,\n        innerWidth: number, innerHeight: number,\n        wvSlot: WebViewSlotEnum,\n        // 0 => use innerWidth/innerHeight to fit within viewport\n        // 100 => original document dimensions, 50 => half, etc.\n        zoomPercent: number,\n    ): IwidthHeight | undefined {\n\n    if (!documant || !documant.head || !documant.body) {\n        return undefined;\n    }\n    debug(\"configureFixedLayout zoomPercent \", zoomPercent);\n\n    let wh: IwidthHeight | undefined;\n\n    let width: number = fxlViewportWidth;\n    let height: number = fxlViewportHeight;\n\n    if (!width || !height) {\n        let metaViewport: Element | null = null;\n        // Not in XMLDOM :(\n        if (documant.head.querySelector) {\n            metaViewport = documant.head.querySelector(\"meta[name=viewport]\");\n        } else {\n            if (documant.head.childNodes && documant.head.childNodes.length) {\n                // tslint:disable-next-line: prefer-for-of\n                for (let i = 0; i < documant.head.childNodes.length; i++) {\n                    const child = documant.head.childNodes[i];\n                    if (child.nodeType === 1) { // Node.ELEMENT_NODE\n                        const element = child as Element;\n                        if (element.localName && element.localName.toLowerCase() === \"meta\") {\n                            if (element.getAttribute(\"name\") === \"viewport\") {\n                                metaViewport = element;\n                                break;\n                            }\n                        }\n                    }\n                }\n            }\n        }\n        if (!metaViewport) {\n            if (isDEBUG_VISUALS(documant)) {\n                debug(\"configureFixedLayout NO meta[name=viewport]\");\n            }\n            return undefined;\n        }\n        const attr = metaViewport.getAttribute(\"content\");\n        if (!attr) {\n            if (isDEBUG_VISUALS(documant)) {\n                debug(\"configureFixedLayout NO meta[name=viewport && content]\");\n            }\n            return undefined;\n        }\n        const wMatch = attr.match(/\\s*width\\s*=\\s*([0-9]+)/);\n        if (wMatch && wMatch.length >= 2) {\n            try {\n                width = parseInt(wMatch[1], 10);\n            } catch (err) {\n                debug(err);\n                // ignore\n            }\n        } else {\n            if (isDEBUG_VISUALS(documant)) {\n                debug(\"configureFixedLayout NO meta[name=viewport && content WIDTH]\");\n            }\n        }\n        const hMatch = attr.match(/\\s*height\\s*=\\s*([0-9]+)/);\n        if (hMatch && hMatch.length >= 2) {\n            try {\n                height = parseInt(hMatch[1], 10);\n            } catch (err) {\n                debug(err);\n                // ignore\n            }\n        } else {\n            if (isDEBUG_VISUALS(documant)) {\n                debug(\"configureFixedLayout NO meta[name=viewport && content HEIGHT]\");\n            }\n        }\n\n        if (width && height) {\n            if (isDEBUG_VISUALS(documant)) {\n                debug(\"READIUM_FXL_VIEWPORT_WIDTH: \" + width);\n                debug(\"READIUM_FXL_VIEWPORT_HEIGHT: \" + height);\n            }\n\n            wh = {\n                height,\n                scale: 1,\n                tx: 0,\n                ty: 0,\n                width,\n            };\n        }\n    } else {\n        wh = {\n            height,\n            scale: 1,\n            tx: 0,\n            ty: 0,\n            width,\n        };\n    }\n    if (innerWidth && innerHeight && width && height && isFixedLayout\n        && documant && documant.documentElement && documant.body) {\n\n        // documant.documentElement.style.overflow = \"hidden\";\n        documant.documentElement.classList.add(ROOT_CLASS_FIXED_LAYOUT);\n\n        // Many FXL EPUBs lack the body dimensions (only viewport meta)\n        documant.body.style.width = width + \"px\";\n        documant.body.style.height = height + \"px\";\n        documant.body.style.overflow = \"hidden\";\n        documant.body.style.margin = \"0\"; // 8px by default!\n\n        if (isDEBUG_VISUALS(documant)) {\n            debug(\"FXL width: \" + width);\n            debug(\"FXL height: \" + height);\n        }\n\n        const visibleWidth = innerWidth;\n        const visibleHeight = innerHeight;\n        if (isDEBUG_VISUALS(documant)) {\n            debug(\"FXL visible width: \" + visibleWidth);\n            debug(\"FXL visible height: \" + visibleHeight);\n        }\n\n        const ratioX = visibleWidth / width;\n        const ratioY = visibleHeight / height;\n        const ratio = zoomPercent === 0 ? Math.min(ratioX, ratioY) : (zoomPercent / 100);\n\n        const tx = (visibleWidth - (width * ratio)) *\n            (wvSlot === WebViewSlotEnum.center ? 0.5 : (wvSlot === WebViewSlotEnum.right ? 0 : 1));\n        const ty = (visibleHeight - (height * ratio)) / 2;\n        if (isDEBUG_VISUALS(documant)) {\n            debug(\"FXL trans X: \" + tx);\n            debug(\"FXL trans Y: \" + ty);\n            debug(\"FXL scale XY: \" + ratio);\n        }\n\n        if (wh) {\n            wh.scale = ratio;\n            wh.tx = tx;\n            wh.ty = ty;\n        }\n        documant.documentElement.style.transformOrigin = \"0 0\";\n        // tslint:disable-next-line:max-line-length\n        // documant.documentElement.style.transform = `translateX(${tx}px) translateY(${ty}px) scale3d(${ratio}, ${ratio}, 0)`;\n        // documant.documentElement.style.transform = `translate(${tx}px, ${ty}px) scale(${ratio})`;\n        documant.documentElement.style.transform = `scale(${ratio})`;\n    }\n    return wh;\n}\n\nexport function ensureHead(documant: Document) {\n\n    if (!documant || !documant.documentElement) {\n        return;\n    }\n\n    const docElement = documant.documentElement;\n\n    if (!documant.head) {\n        const headElement = documant.createElement(\"head\");\n        if (documant.body) {\n            docElement.insertBefore(headElement, documant.body);\n        } else {\n            docElement.appendChild(headElement);\n        }\n    }\n}\n\nexport function appendCSSInline(documant: Document, id: string, css: string) {\n    ensureHead(documant);\n\n    if (!documant || !documant.head) {\n        return;\n    }\n\n    const idz = \"Readium2-\" + id;\n    const s = documant.getElementById(idz);\n    if (s) {\n        return; // already injected via streamer?\n    }\n    const styleElement = documant.createElement(\"style\");\n    styleElement.setAttribute(\"id\", idz);\n    styleElement.setAttribute(\"type\", \"text/css\");\n    styleElement.appendChild(documant.createTextNode(css));\n    documant.head.appendChild(styleElement);\n}\n\n// unused (for now)\n// export function removeCSSInline(documant: Document, id: string) {\n//     const styleElement = documant.getElementById(\"Readium2-\" + id);\n//     if (styleElement && styleElement.parentNode) {\n//         styleElement.parentNode.removeChild(styleElement);\n//     }\n// }\n\nexport function appendCSS(documant: Document, mod: string, urlRoot: string) {\n    ensureHead(documant);\n\n    if (!documant || !documant.head) {\n        return;\n    }\n\n    const idz = \"ReadiumCSS-\" + mod;\n    const s = documant.getElementById(idz);\n    if (s) {\n        return; // already injected via streamer?\n    }\n    const linkElement = documant.createElement(\"link\");\n    linkElement.setAttribute(\"id\", idz);\n    linkElement.setAttribute(\"rel\", \"stylesheet\");\n    linkElement.setAttribute(\"type\", \"text/css\");\n    linkElement.setAttribute(\"href\", urlRoot + \"ReadiumCSS-\" + mod + \".css\");\n\n    // Not in XMLDOM :(\n    let childElementCount = 0;\n    let firstElementChild: Element | null = null;\n    if (typeof documant.head.childElementCount !== \"undefined\") {\n        childElementCount = documant.head.childElementCount;\n        firstElementChild = documant.head.firstElementChild;\n    } else {\n        if (documant.head && documant.head.childNodes && documant.head.childNodes.length) {\n            // tslint:disable-next-line: prefer-for-of\n            for (let i = 0; i < documant.head.childNodes.length; i++) {\n                const child = documant.head.childNodes[i];\n                if (child.nodeType === 1) { // Node.ELEMENT_NODE\n                    childElementCount++;\n                    if (!firstElementChild) {\n                        firstElementChild = child as Element;\n                    }\n                }\n            }\n        }\n    }\n\n    if (mod === \"before\" && childElementCount && firstElementChild) {\n        documant.head.insertBefore(linkElement, firstElementChild);\n    } else {\n        documant.head.appendChild(linkElement);\n    }\n}\n\nexport function removeCSS(documant: Document, mod: string) {\n    const linkElement = documant.getElementById(\"ReadiumCSS-\" + mod);\n    if (linkElement && linkElement.parentNode) {\n        linkElement.parentNode.removeChild(linkElement);\n    }\n}\n\n// export function removeAllCSSInline(_documant: Document) {\n//     // removeCSSInline(\"electron-selection\");\n//     // removeCSSInline(\"electron-focus\");\n//     // removeCSSInline(\"electron-scrollbars\");\n// }\n\nexport function removeAllCSS(documant: Document) {\n    removeCSS(documant, \"before\");\n    removeCSS(documant, \"after\");\n    // removeCSS(\"base\");\n    // removeCSS(\"html5patch\");\n    // removeCSS(\"safeguards\");\n    removeCSS(documant, \"default\");\n    // removeCSS(\"highlights\");\n    // removeCSS(\"scroll\");\n    // removeCSS(\"pagination\");\n    // removeCSS(\"night_mode\");\n    // removeCSS(\"pagination\");\n    // removeCSS(\"os_a11y\");\n    // removeCSS(\"user_settings\");\n    // removeCSS(\"fs_normalize\");\n}\n\nexport function injectDefaultCSS(documant: Document) {\n    appendCSSInline(documant, \"electron-mo\", mediaOverlaysCssStyles);\n    appendCSSInline(documant, \"electron-tts\", ttsCssStyles);\n    appendCSSInline(documant, \"electron-footnotes\", footnotesCssStyles);\n    appendCSSInline(documant, \"electron-selection\", selectionCssStyles);\n    appendCSSInline(documant, \"electron-focus\", focusCssStyles);\n    appendCSSInline(documant, \"electron-target\", targetCssStyles);\n    appendCSSInline(documant, \"electron-scrollbars\", scrollBarCssStyles);\n    appendCSSInline(documant, \"electron-visibility-mask\", visibilityMaskCssStyles);\n    appendCSSInline(documant, \"electron-audiobook\", audioCssStyles);\n}\n\nexport function injectReadPosCSS(documant: Document) {\n    // if (!isDEBUG_VISUALS(documant)) {\n    //     return;\n    // }\n    appendCSSInline(documant, \"electron-readPos\", readPosCssStyles);\n}\n\nexport function readiumCssTransformHtml(\n    htmlStr: string,\n    readiumcssJson: IEventPayload_R2_EVENT_READIUMCSS | undefined,\n    mediaType: string | undefined): string {\n\n    // debug(mediaType);\n    // debug(htmlStr);\n\n    // let's remove the DOCTYPE (which can contain entities)\n    // let's replace the body with empty txt (we only need the body start tag, not the element contents)\n\n    const iHtmlStart = htmlStr.indexOf(\"<html\");\n    if (iHtmlStart < 0) {\n        return htmlStr;\n    }\n    const iBodyStart = htmlStr.indexOf(\"<body\");\n    if (iBodyStart < 0) {\n        return htmlStr;\n    }\n    const iBodyEnd = htmlStr.indexOf(\">\", iBodyStart);\n    if (iBodyEnd <= 0) {\n        return htmlStr;\n    }\n\n    const parseableChunk = htmlStr.substr(iHtmlStart, iBodyEnd - iHtmlStart + 1);\n    // debug(parseableChunk);\n    const htmlStrToParse = `<?xml version=\"1.0\" encoding=\"utf-8\"?>${parseableChunk}TXT</body></html>`;\n    // debug(htmlStrToParse);\n\n    const documant = parseDOM(htmlStrToParse, mediaType);\n\n    documant.documentElement.setAttribute(\"data-readiumcss-injected\", \"yes\");\n\n    documant.documentElement.classList.add(ROOT_CLASS_INVISIBLE_MASK);\n    documant.documentElement.classList.remove(ROOT_CLASS_INVISIBLE_MASK_REMOVED);\n\n    // const wh = configureFixedLayout(doc, win.READIUM2.isFixedLayout,\n    //     win.READIUM2.fxlViewportWidth, win.READIUM2.fxlViewportHeight,\n    //     win.innerWidth, win.innerHeight);\n    // if (wh) {\n    //     win.READIUM2.fxlViewportWidth = wh.width;\n    //     win.READIUM2.fxlViewportHeight = wh.height;\n    // }\n\n    const rtl = isDocRTL(documant);\n    const vertical = isDocVertical(documant);\n    if (readiumcssJson) {\n        if (IS_DEV) {\n            debug(\"_____ readiumCssJson.urlRoot (readiumCssTransformHtml()): \", readiumcssJson.urlRoot);\n        }\n\n        readiumCSSSet(\n            documant,\n            readiumcssJson,\n            vertical,\n            rtl);\n    }\n\n    injectDefaultCSS(documant);\n    if (IS_DEV) { // isDEBUG_VISUALS(documant)\n        injectReadPosCSS(documant);\n    }\n\n    const serialized = serializeDOM(documant);\n    // debug(\"serialized:\");\n    // debug(serialized);\n\n    const prefix = htmlStr.substr(0, iHtmlStart);\n    // debug(\"prefix:\");\n    // debug(prefix);\n    const suffix = htmlStr.substr(iBodyEnd + 1);\n    // debug(\"suffix:\");\n    // debug(suffix);\n\n    const iHtmlStart_ = serialized.indexOf(\"<html\");\n    if (iHtmlStart_ < 0) {\n        return htmlStr;\n    }\n    const iBodyStart_ = serialized.indexOf(\"<body\");\n    if (iBodyStart_ < 0) {\n        return htmlStr;\n    }\n    const iBodyEnd_ = serialized.indexOf(\">\", iBodyStart_);\n    if (iBodyEnd_ <= 0) {\n        return htmlStr;\n    }\n\n    const middle = serialized.substr(iHtmlStart_, iBodyEnd_ - iHtmlStart_ + 1);\n    // debug(\"middle:\");\n    // debug(middle);\n    const newStr = `${prefix}${middle}${suffix}`;\n    // debug(\"newStr:\");\n    // debug(newStr);\n    return newStr;\n}\n"]}