{"version":3,"file":"readium-css-inject.js","sourceRoot":"","sources":["../../../../../src/electron/common/readium-css-inject.ts"],"names":[],"mappings":"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","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport * as xmldom from \"xmldom\";\n\nimport {\n    IEventPayload_R2_EVENT_READIUMCSS,\n} from \"./events\";\nimport { READIUM_CSS_URL_PATH } from \"./readium-css-settings\";\nimport {\n    focusCssStyles,\n    readPosCssStyles,\n    scrollBarCssStyles,\n    selectionCssStyles,\n    targetCssStyles,\n} from \"./styles\";\n\nexport const DEBUG_VISUALS = false;\n\n// TODO DARK THEME\nconst CSS_CLASS_DARK_THEME = \"mdc-theme--dark\";\n\n// tslint:disable-next-line:max-line-length\n// https://github.com/readium/readium-css/blob/develop/docs/CSS16-internationalization.md\n// tslint:disable-next-line:max-line-length\n// https://github.com/readium/readium-css/blob/develop/docs/CSS12-user_prefs.md#user-settings-can-be-language-specific\n\nexport function isDocVertical(document: Document): boolean {\n    if (!document || !document.documentElement) {\n        return false;\n    }\n\n    // let vertical = false;\n\n    // let langAttr = document.documentElement.getAttribute(\"lang\");\n    // if (!langAttr) {\n    //     langAttr = document.documentElement.getAttribute(\"xml:lang\");\n    // }\n    // if (!langAttr) {\n    //     langAttr = document.documentElement.getAttributeNS(\"http://www.w3.org/XML/1998/\", \"lang\");\n    // }\n    // if (langAttr &&\n    //     (langAttr === \"zh\" || langAttr.startsWith(\"zh-\") ||\n    //     langAttr === \"ja\" || langAttr.startsWith(\"ja-\") ||\n    //     langAttr === \"ko\" || langAttr.startsWith(\"ko-\"))) {\n    //     // foundLang = true;\n    //     vertical = true;\n    // }\n\n    // return vertical;\n\n    return false;\n}\n\nexport function isDocRTL(document: Document): boolean {\n    if (!document || !document.documentElement) {\n        return false;\n    }\n\n    let rtl = false;\n\n    let foundDir = false;\n\n    let dirAttr = document.documentElement.getAttribute(\"dir\");\n    if (dirAttr === \"rtl\") {\n        foundDir = true;\n        rtl = true;\n    }\n    if (!rtl && document.body) {\n        dirAttr = document.body.getAttribute(\"dir\");\n        if (dirAttr === \"rtl\") {\n            foundDir = true;\n            rtl = true;\n        }\n    }\n\n    // let foundLang = false;\n\n    if (!rtl) {\n        let langAttr = document.documentElement.getAttribute(\"lang\");\n        if (!langAttr) {\n            langAttr = document.documentElement.getAttribute(\"xml:lang\");\n        }\n        if (!langAttr) {\n            langAttr = document.documentElement.getAttributeNS(\"http://www.w3.org/XML/1998/\", \"lang\");\n        }\n        if (langAttr &&\n            (langAttr === \"ar\" || langAttr.startsWith(\"ar-\") ||\n            langAttr === \"he\" || langAttr.startsWith(\"he-\") ||\n            langAttr === \"fa\" || langAttr.startsWith(\"fa-\")) ||\n            langAttr === \"zh-Hant\" ||\n            langAttr === \"zh-TW\"\n            ) {\n            // foundLang = true;\n            rtl = true;\n        }\n    }\n    if (rtl) {\n        if (!foundDir) {\n            document.documentElement.setAttribute(\"dir\", \"rtl\");\n        }\n        // really?\n        // if (!foundLang) {\n        //     document.documentElement.setAttribute(\"lang\", \"ar\");\n        //     // document.documentElement.setAttributeNS(\"http://www.w3.org/XML/1998/\", \"lang\", \"ar\");\n        //     document.documentElement.setAttribute(\"xml:lang\", \"ar\");\n        // }\n    }\n    return rtl;\n}\n\nexport function isPaginated(document: Document): boolean {\n    return document && document.documentElement &&\n        document.documentElement.classList.contains(\"readium-paginated\");\n}\n\n// tslint:disable-next-line:max-line-length\n// https://github.com/readium/readium-css/blob/develop/docs/CSS12-user_prefs.md\n// tslint:disable-next-line:max-line-length\n// https://github.com/readium/readium-css/blob/develop/docs/ReadiumCSS-user_variables.css\n// tslint:disable-next-line:max-line-length\n// https://github.com/readium/readium-css/blob/develop/docs/CSS19-api.md#user-settings\nexport function readiumCSSSet(\n    document: Document,\n    messageJson: IEventPayload_R2_EVENT_READIUMCSS,\n    urlRootReadiumCSS: string | undefined,\n    isVerticalWritingMode: boolean, isRTL: boolean) {\n\n    if (!messageJson) {\n        return;\n    }\n\n    if (!document || !document.documentElement) {\n        return;\n    }\n\n    const docElement = document.documentElement;\n\n    if (!messageJson.setCSS) {\n\n        docElement.removeAttribute(\"data-readiumcss\");\n        removeAllCSS(document);\n        // removeAllCSSInline(document);\n\n        if (messageJson.isFixedLayout) {\n            docElement.style.overflow = \"hidden\";\n        } else {\n            docElement.style.overflow = \"auto\";\n        }\n\n        const toRemove: string[] = [];\n        for (let i = 0; i < docElement.style.length; i++) {\n            const item = docElement.style.item(i);\n            if (item.indexOf(\"--USER__\") === 0) {\n                toRemove.push(item);\n            }\n        }\n        toRemove.forEach((item) => {\n            docElement.style.removeProperty(item);\n        });\n\n        docElement.classList.remove(CSS_CLASS_DARK_THEME);\n\n        return;\n    }\n\n    if (!docElement.hasAttribute(\"data-readiumcss\")) {\n        docElement.setAttribute(\"data-readiumcss\", \"yes\");\n\n        let needsDefaultCSS = true;\n\n        // Not in XMLDOM :(\n        // if (document.head && document.head.childElementCount) {\n        //     let elem = document.head.firstElementChild;\n        //     while (elem) {\n        //         // ...\n        //         elem = elem.nextElementSibling;\n        //     }\n        // }\n        if (document.head && document.head.childNodes && document.head.childNodes.length) {\n            // tslint:disable-next-line: prefer-for-of\n            for (let i = 0; i < document.head.childNodes.length; i++) {\n                const child = document.head.childNodes[i];\n                if (child.nodeType === 1) { // Node.ELEMENT_NODE\n                    const element = child as Element;\n                    if ((element.localName && element.localName.toLowerCase() === \"style\") ||\n                        (element.getAttribute &&\n                            (element.getAttribute(\"rel\") === \"stylesheet\" ||\n                                element.getAttribute(\"type\") === \"text/css\" ||\n                                (element.getAttribute(\"src\") &&\n                                    (element.getAttribute(\"src\") as string).endsWith(\".css\"))))) {\n                        needsDefaultCSS = false;\n                        break;\n                    }\n                }\n            }\n        }\n\n        if (needsDefaultCSS && document.body) {\n            // Not in XMLDOM :(\n            // querySelector(\"*[style]\");\n            const styleAttr = document.body.getAttribute(\"style\");\n            if (styleAttr) {\n                needsDefaultCSS = false;\n            }\n        }\n\n        const urlRoot = messageJson.urlRoot ?\n            (messageJson.urlRoot + \"/\" + READIUM_CSS_URL_PATH + \"/\") :\n            (urlRootReadiumCSS ? urlRootReadiumCSS : (\"/\" + READIUM_CSS_URL_PATH + \"/\"));\n\n        appendCSS(document, \"before\", urlRoot);\n        if (needsDefaultCSS) {\n            appendCSS(document, \"default\", urlRoot);\n        }\n        appendCSS(document, \"after\", urlRoot);\n    }\n\n    const setCSS = messageJson.setCSS;\n\n    if (DEBUG_VISUALS) {\n        console.log(\"---- setCSS -----\");\n        console.log(setCSS);\n        console.log(\"-----\");\n    }\n\n    if (setCSS.night) {\n        // document.body\n        docElement.classList.add(CSS_CLASS_DARK_THEME);\n    } else {\n        // document.body\n        docElement.classList.remove(CSS_CLASS_DARK_THEME);\n    }\n\n    const needsAdvanced = true; // textAlign, bodyHyphens, fontSize, etc.\n\n    // readium-advanced-on | readium-advanced-off\n    docElement.style.setProperty(\"--USER__advancedSettings\",\n        needsAdvanced ? \"readium-advanced-on\" : \"readium-advanced-off\");\n\n    // readium-darken-on | readium-darken-off\n    if (typeof setCSS.darken === \"undefined\") {\n        docElement.style.removeProperty(\"--USER__darkenFilter\");\n    } else {\n        docElement.style.setProperty(\"--USER__darkenFilter\",\n            setCSS.darken ? \"readium-darken-on\" : \"readium-darken-off\");\n    }\n\n    // readium-invert-on | readium-invert-off\n    if (typeof setCSS.invert === \"undefined\") {\n        docElement.style.removeProperty(\"--USER__invertFilter\");\n    } else {\n        docElement.style.setProperty(\"--USER__invertFilter\",\n            setCSS.invert ? \"readium-invert-on\" : \"readium-invert-off\");\n    }\n\n    // readium-default-on | readium-sepia-on | readium-night-on\n    docElement.style.setProperty(\"--USER__appearance\",\n        setCSS.sepia ? \"readium-sepia-on\" :\n        (setCSS.night ? \"readium-night-on\" : \"readium-default-on\"));\n\n    // readium-paged-on | readium-scroll-on\n    docElement.style.setProperty(\"--USER__view\",\n        setCSS.paged ? \"readium-paged-on\" : \"readium-scroll-on\");\n    if (setCSS.paged) {\n        docElement.style.overflow = \"hidden\";\n        docElement.classList.add(\"readium-paginated\");\n    } else {\n        docElement.style.overflow = \"auto\";\n        docElement.classList.remove(\"readium-paginated\");\n    }\n\n    const defaultPublisherFont = !setCSS.font || setCSS.font === \"DEFAULT\";\n\n    const a11yNormalize = ((typeof setCSS.a11yNormalize !== \"undefined\") ?\n        (setCSS.a11yNormalize ? \"readium-a11y-on\" : \"readium-a11y-off\") :\n        \"readium-a11y-off\" // will remove, because undefined\n        );\n\n    const needsFontOverride = a11yNormalize === \"readium-a11y-on\" || !defaultPublisherFont;\n\n    // readium-font-on | readium-font-off\n    docElement.style.setProperty(\"--USER__fontOverride\",\n        needsFontOverride ? \"readium-font-on\" : \"readium-font-off\");\n\n    // readium-a11y-on | readium-a11y-off\n    if (typeof setCSS.a11yNormalize === \"undefined\") {\n        docElement.style.removeProperty(\"--USER__a11yNormalize\");\n    } else {\n        docElement.style.setProperty(\"--USER__a11yNormalize\", a11yNormalize);\n    }\n\n    if (defaultPublisherFont) {\n        docElement.style.removeProperty(\"--USER__fontFamily\");\n    } else {\n        const font = setCSS.font;\n        let fontValue = \"\";\n        if (font === \"DUO\" || font === \"IA Writer Duospace\") {\n            fontValue = \"IA Writer Duospace\";\n        } else if (font === \"DYS\" || font === \"AccessibleDfa\") {\n            fontValue = \"AccessibleDfa\";\n        } else if (font === \"OLD\" || font === \"oldStyleTf\") {\n            fontValue = \"var(--RS__oldStyleTf)\";\n        } else if (font === \"MODERN\" || font === \"modernTf\") {\n            fontValue = \"var(--RS__modernTf)\";\n        } else if (font === \"SANS\" || font === \"sansTf\") {\n            fontValue = \"var(--RS__sansTf)\";\n        } else if (font === \"HUMAN\" || font === \"humanistTf\") {\n            fontValue = \"var(--RS__humanistTf)\";\n        } else if (font === \"MONO\" || font === \"monospaceTf\") {\n            fontValue = \"var(--RS__monospaceTf)\";\n        } else if (font === \"JA\" || font === \"serif-ja\") {\n            fontValue = \"var(--RS__serif-ja)\";\n        } else if (font === \"JA-SANS\" || font === \"sans-serif-ja\") {\n            fontValue = \"var(--RS__sans-serif-ja)\";\n        } else if (font === \"JA-V\" || font === \"serif-ja-v\") {\n            fontValue = \"var(--RS__serif-ja-v)\";\n        } else if (font === \"JA-V-SANS\" || font === \"sans-serif-ja-v\") {\n            fontValue = \"var(--RS__sans-serif-ja-v)\";\n        } else if (typeof font === \"string\") {\n            fontValue = font;\n        }\n        if (fontValue) {\n            docElement.style.setProperty(\"--USER__fontFamily\", fontValue);\n        } else {\n            docElement.style.removeProperty(\"--USER__fontFamily\");\n        }\n    }\n\n    if (setCSS.fontSize) {\n        docElement.style.setProperty(\"--USER__fontSize\", setCSS.fontSize);\n    } else {\n        docElement.style.removeProperty(\"--USER__fontSize\");\n    }\n\n    if (setCSS.lineHeight) {\n        docElement.style.setProperty(\"--USER__lineHeight\", setCSS.lineHeight);\n    } else {\n        docElement.style.removeProperty(\"--USER__lineHeight\");\n    }\n\n    if (setCSS.typeScale) {\n        docElement.style.setProperty(\"--USER__typeScale\", setCSS.typeScale);\n    } else {\n        docElement.style.removeProperty(\"--USER__typeScale\");\n    }\n\n    if (setCSS.paraSpacing) {\n        docElement.style.setProperty(\"--USER__paraSpacing\", setCSS.paraSpacing);\n    } else {\n        docElement.style.removeProperty(\"--USER__paraSpacing\");\n    }\n\n    const isCJK = false; // TODO, lang tag?\n    if (isVerticalWritingMode || (isRTL || isCJK)) {\n        docElement.style.removeProperty(\"--USER__bodyHyphens\");\n\n        docElement.style.removeProperty(\"--USER__wordSpacing\");\n\n        docElement.style.removeProperty(\"--USER__letterSpacing\");\n\n        if (isVerticalWritingMode || isCJK) {\n            if (isVerticalWritingMode) {\n                docElement.style.removeProperty(\"--USER__colCount\");\n            }\n\n            docElement.style.removeProperty(\"--USER__paraIndent\");\n\n            docElement.style.removeProperty(\"--USER__textAlign\");\n\n        } else if (isRTL) {\n            if (setCSS.ligatures) {\n                docElement.style.setProperty(\"--USER__ligatures\", setCSS.ligatures);\n            } else {\n                docElement.style.removeProperty(\"--USER__ligatures\");\n            }\n        }\n    } else {\n        if (setCSS.bodyHyphens) {\n            docElement.style.setProperty(\"--USER__bodyHyphens\", setCSS.bodyHyphens);\n        } else {\n            docElement.style.removeProperty(\"--USER__bodyHyphens\");\n        }\n\n        if (setCSS.wordSpacing) {\n            docElement.style.setProperty(\"--USER__wordSpacing\", setCSS.wordSpacing);\n        } else {\n            docElement.style.removeProperty(\"--USER__wordSpacing\");\n        }\n\n        if (setCSS.letterSpacing) {\n            docElement.style.setProperty(\"--USER__letterSpacing\", setCSS.letterSpacing);\n        } else {\n            docElement.style.removeProperty(\"--USER__letterSpacing\");\n        }\n\n        if (!isVerticalWritingMode) {\n            if (setCSS.colCount) {\n                docElement.style.setProperty(\"--USER__colCount\", setCSS.colCount);\n            } else {\n                docElement.style.removeProperty(\"--USER__colCount\");\n            }\n\n            if (setCSS.paraIndent) {\n                docElement.style.setProperty(\"--USER__paraIndent\", setCSS.paraIndent);\n            } else {\n                docElement.style.removeProperty(\"--USER__paraIndent\");\n            }\n\n            if (setCSS.textAlign) {\n                docElement.style.setProperty(\"--USER__textAlign\", setCSS.textAlign);\n            } else {\n                docElement.style.removeProperty(\"--USER__textAlign\");\n            }\n        } else if (!isRTL) {\n            docElement.style.removeProperty(\"--USER__ligatures\");\n        }\n    }\n\n    if (setCSS.pageMargins) {\n        docElement.style.setProperty(\"--USER__pageMargins\", setCSS.pageMargins);\n    } else {\n        docElement.style.removeProperty(\"--USER__pageMargins\");\n    }\n\n    if (setCSS.backgroundColor) {\n        docElement.style.setProperty(\"--USER__backgroundColor\", setCSS.backgroundColor);\n    } else {\n        docElement.style.removeProperty(\"--USER__backgroundColor\");\n    }\n    if (setCSS.textColor) {\n        docElement.style.setProperty(\"--USER__textColor\", setCSS.textColor);\n    } else {\n        docElement.style.removeProperty(\"--USER__textColor\");\n    }\n}\n\nexport interface IwidthHeight {\n    width: number;\n    height: number;\n}\nexport function configureFixedLayout(\n        document: Document,\n        isFixedLayout: boolean,\n        fxlViewportWidth: number, fxlViewportHeight: number,\n        innerWidth: number, innerHeight: number): IwidthHeight | undefined {\n\n    if (!document || !document.head || !document.body) {\n        return undefined;\n    }\n\n    let wh: IwidthHeight | undefined;\n\n    let width: number = fxlViewportWidth;\n    let height: number = fxlViewportHeight;\n\n    if (!width || !height) {\n        let metaViewport: Element | null = null;\n        // Not in XMLDOM :(\n        if (document.head.querySelector) {\n            metaViewport = document.head.querySelector(\"meta[name=viewport]\");\n        } else {\n            if (document.head.childNodes && document.head.childNodes.length) {\n                // tslint:disable-next-line: prefer-for-of\n                for (let i = 0; i < document.head.childNodes.length; i++) {\n                    const child = document.head.childNodes[i];\n                    if (child.nodeType === 1) { // Node.ELEMENT_NODE\n                        const element = child as Element;\n                        if (element.localName && element.localName.toLowerCase() === \"meta\") {\n                            if (element.getAttribute(\"name\") === \"viewport\") {\n                                metaViewport = element;\n                                break;\n                            }\n                        }\n                    }\n                }\n            }\n        }\n        if (!metaViewport) {\n            console.log(\"configureFixedLayout NO meta[name=viewport]\");\n            return undefined;\n        }\n        const attr = metaViewport.getAttribute(\"content\");\n        if (!attr) {\n            console.log(\"configureFixedLayout NO meta[name=viewport && content]\");\n            return undefined;\n        }\n        const wMatch = attr.match(/\\s*width\\s*=\\s*([0-9]+)/);\n        if (wMatch && wMatch.length >= 2) {\n            try {\n                width = parseInt(wMatch[1], 10);\n            } catch (err) {\n                console.log(err);\n                // ignore\n            }\n        } else {\n            console.log(\"configureFixedLayout NO meta[name=viewport && content WIDTH]\");\n        }\n        const hMatch = attr.match(/\\s*height\\s*=\\s*([0-9]+)/);\n        if (hMatch && hMatch.length >= 2) {\n            try {\n                height = parseInt(hMatch[1], 10);\n            } catch (err) {\n                console.log(err);\n                // ignore\n            }\n        } else {\n            console.log(\"configureFixedLayout NO meta[name=viewport && content HEIGHT]\");\n        }\n\n        if (width && height) {\n            console.log(\"READIUM_FXL_VIEWPORT_WIDTH: \" + width);\n            console.log(\"READIUM_FXL_VIEWPORT_HEIGHT: \" + height);\n\n            wh = {\n                height,\n                width,\n            };\n        }\n    }\n\n    if (innerWidth && innerHeight && width && height && isFixedLayout\n        && document && document.documentElement && document.body) {\n        document.documentElement.style.overflow = \"hidden\";\n\n        // Many FXL EPUBs lack the body dimensions (only viewport meta)\n        document.body.style.width = width + \"px\";\n        document.body.style.height = height + \"px\";\n        document.body.style.overflow = \"hidden\";\n        document.body.style.margin = \"0\"; // 8px by default!\n\n        console.log(\"FXL width: \" + width);\n        console.log(\"FXL height: \" + height);\n\n        const visibleWidth = innerWidth;\n        const visibleHeight = innerHeight;\n        console.log(\"FXL visible width: \" + visibleWidth);\n        console.log(\"FXL visible height: \" + visibleHeight);\n\n        const ratioX = visibleWidth / width;\n        const ratioY = visibleHeight / height;\n        const ratio = Math.min(ratioX, ratioY);\n\n        const tx = (visibleWidth - (width * ratio)) / 2;\n        const ty = (visibleHeight - (height * ratio)) / 2;\n        console.log(\"FXL trans X: \" + tx);\n        console.log(\"FXL trans Y: \" + ty);\n\n        document.documentElement.style.transformOrigin = \"0 0\";\n        document.documentElement.style.transform = `translateX(${tx}px) translateY(${ty}px) scale(${ratio})`;\n    }\n\n    return wh;\n}\n\nexport function ensureHead(document: Document) {\n\n    if (!document || !document.documentElement) {\n        return;\n    }\n\n    const docElement = document.documentElement;\n\n    if (!document.head) {\n        const headElement = document.createElement(\"head\");\n        if (document.body) {\n            docElement.insertBefore(headElement, document.body);\n        } else {\n            docElement.appendChild(headElement);\n        }\n    }\n}\n\nexport function appendCSSInline(document: Document, id: string, css: string) {\n    ensureHead(document);\n\n    if (!document || !document.head) {\n        return;\n    }\n\n    const styleElement = document.createElement(\"style\");\n    styleElement.setAttribute(\"id\", \"Readium2-\" + id);\n    styleElement.setAttribute(\"type\", \"text/css\");\n    styleElement.appendChild(document.createTextNode(css));\n    document.head.appendChild(styleElement);\n}\n\n// unused (for now)\n// export function removeCSSInline(document: Document, id: string) {\n//     const styleElement = document.getElementById(\"Readium2-\" + id);\n//     if (styleElement && styleElement.parentNode) {\n//         styleElement.parentNode.removeChild(styleElement);\n//     }\n// }\n\nexport function appendCSS(document: Document, mod: string, urlRoot: string) {\n    ensureHead(document);\n\n    if (!document || !document.head) {\n        return;\n    }\n\n    const linkElement = document.createElement(\"link\");\n    linkElement.setAttribute(\"id\", \"ReadiumCSS-\" + mod);\n    linkElement.setAttribute(\"rel\", \"stylesheet\");\n    linkElement.setAttribute(\"type\", \"text/css\");\n    linkElement.setAttribute(\"href\", urlRoot + \"ReadiumCSS-\" + mod + \".css\");\n\n    // Not in XMLDOM :(\n    let childElementCount = 0;\n    let firstElementChild: Element | null = null;\n    if (typeof document.head.childElementCount !== \"undefined\") {\n        childElementCount = document.head.childElementCount;\n        firstElementChild = document.head.firstElementChild;\n    } else {\n        if (document.head && document.head.childNodes && document.head.childNodes.length) {\n            // tslint:disable-next-line: prefer-for-of\n            for (let i = 0; i < document.head.childNodes.length; i++) {\n                const child = document.head.childNodes[i];\n                if (child.nodeType === 1) { // Node.ELEMENT_NODE\n                    childElementCount++;\n                    if (!firstElementChild) {\n                        firstElementChild = child as Element;\n                    }\n                }\n            }\n        }\n    }\n\n    if (mod === \"before\" && childElementCount && firstElementChild) {\n        document.head.insertBefore(linkElement, firstElementChild);\n    } else {\n        document.head.appendChild(linkElement);\n    }\n}\n\nexport function removeCSS(document: Document, mod: string) {\n    const linkElement = document.getElementById(\"ReadiumCSS-\" + mod);\n    if (linkElement && linkElement.parentNode) {\n        linkElement.parentNode.removeChild(linkElement);\n    }\n}\n\n// export function removeAllCSSInline(_document: Document) {\n//     // removeCSSInline(\"electron-selection\");\n//     // removeCSSInline(\"electron-focus\");\n//     // removeCSSInline(\"electron-scrollbars\");\n// }\n\nexport function removeAllCSS(document: Document) {\n    removeCSS(document, \"before\");\n    removeCSS(document, \"after\");\n    // removeCSS(\"base\");\n    // removeCSS(\"html5patch\");\n    // removeCSS(\"safeguards\");\n    removeCSS(document, \"default\");\n    // removeCSS(\"highlights\");\n    // removeCSS(\"scroll\");\n    // removeCSS(\"pagination\");\n    // removeCSS(\"night_mode\");\n    // removeCSS(\"pagination\");\n    // removeCSS(\"os_a11y\");\n    // removeCSS(\"user_settings\");\n    // removeCSS(\"fs_normalize\");\n}\n\nexport function injectDefaultCSS(document: Document) {\n    appendCSSInline(document, \"electron-selection\", selectionCssStyles);\n    appendCSSInline(document, \"electron-focus\", focusCssStyles);\n    appendCSSInline(document, \"electron-target\", targetCssStyles);\n    appendCSSInline(document, \"electron-scrollbars\", scrollBarCssStyles);\n}\n\nexport function injectReadPosCSS(document: Document) {\n    // if (!DEBUG_VISUALS) {\n    //     return;\n    // }\n    appendCSSInline(document, \"electron-readPos\", readPosCssStyles);\n}\n\n// export function injectResizeSensor(document: Document, urlResizeSensor: string) {\n//     ensureHead(document);\n//     const scriptElement = document.createElement(\"script\");\n//     scriptElement.setAttribute(\"id\", \"Readium2-ResizeSensor\");\n//     scriptElement.setAttribute(\"type\", \"application/javascript\");\n//     scriptElement.setAttribute(\"src\", urlResizeSensor);\n//     scriptElement.appendChild(document.createTextNode(\" \"));\n//     document.head.appendChild(scriptElement);\n//     scriptElement.addEventListener(\"load\", () => {\n//         console.log(\"ResizeSensor LOADED\");\n//     });\n// };\n\nfunction definePropertyGetterSetter_DocHeadBody(docu: Document, elementName: string) {\n\n    Object.defineProperty(docu, elementName, {\n        get() {\n            const doc = this as Document;\n\n            const key = elementName + \"_\";\n            if ((doc as any)[key]) {\n                return (doc as any)[key]; // cached\n            }\n            if (doc.documentElement.childNodes && doc.documentElement.childNodes.length) {\n                // tslint:disable-next-line: prefer-for-of\n                for (let i = 0; i < doc.documentElement.childNodes.length; i++) {\n                    const child = doc.documentElement.childNodes[i];\n                    if (child.nodeType === 1) { // Node.ELEMENT_NODE\n                        const element = child as Element;\n                        if (element.localName && element.localName.toLowerCase() === elementName) {\n                            (doc as any)[key] = element; // cache\n                            if (DEBUG_VISUALS) {\n                                console.log(`XMLDOM - cached document.${elementName}`);\n                            }\n                            return element;\n                        }\n                    }\n                }\n            }\n            return undefined;\n        },\n        set(_val) {\n            console.log(\"document.\" + elementName + \" CANNOT BE SET!!\");\n        },\n    });\n}\nfunction cssSetProperty(this: any, cssProperty: string, val: string) {\n    const style = this;\n    const elem = style.element;\n\n    // console.log(`XMLDOM - cssSetProperty: ${cssProperty}: ${val};`);\n    cssStyleSet(cssProperty, val, elem);\n}\nfunction cssRemoveProperty(this: any, cssProperty: string) {\n    const style = this;\n    const elem = style.element;\n\n    // console.log(`XMLDOM - cssRemoveProperty: ${cssProperty}`);\n    cssStyleSet(cssProperty, undefined, elem);\n}\nfunction cssStyleItem(this: any, i: number): string | undefined {\n    const style = this;\n    const elem = style.element;\n    if (DEBUG_VISUALS) {\n        console.log(`XMLDOM - cssStyleItem: ${i}`);\n    }\n    const styleAttr = elem.getAttribute(\"style\");\n    if (!styleAttr) {\n        return undefined;\n    }\n    let count = -1;\n    const cssProps = styleAttr.split(\";\");\n    for (const cssProp of cssProps) {\n        const trimmed = cssProp.trim();\n        if (trimmed.length) {\n            count++;\n            if (count === i) {\n                const regExStr = `(.+)[\\s]*:[\\s]*(.+)`;\n                const regex = new RegExp(regExStr, \"g\");\n                const regexMatch = regex.exec(trimmed);\n                if (regexMatch) {\n                    if (DEBUG_VISUALS) {\n                        console.log(`XMLDOM - cssStyleItem: ${i} => ${regexMatch[1]}`);\n                    }\n                    return regexMatch[1];\n                }\n            }\n        }\n    }\n    return undefined;\n}\nfunction cssStyleGet(cssProperty: string, elem: Element): string | undefined {\n    if (DEBUG_VISUALS) {\n        console.log(`XMLDOM - cssStyleGet: ${cssProperty}`);\n    }\n\n    const styleAttr = elem.getAttribute(\"style\");\n    if (!styleAttr) {\n        return undefined;\n    }\n    const regExStr = `${cssProperty}[\\s]*:[\\s]*(.+)`;\n    const cssProps = styleAttr.split(\";\");\n    let cssPropertyValue: string | undefined;\n    for (const cssProp of cssProps) {\n        const regex = new RegExp(regExStr, \"g\");\n        const regexMatch = regex.exec(cssProp.trim());\n        if (regexMatch) {\n            cssPropertyValue = regexMatch[1];\n            if (DEBUG_VISUALS) {\n                console.log(`XMLDOM - cssStyleGet: ${cssProperty} => ${cssPropertyValue}`);\n            }\n            break;\n        }\n    }\n    return cssPropertyValue ? cssPropertyValue : undefined;\n}\nfunction cssStyleSet(cssProperty: string, val: string | undefined, elem: Element) {\n    if (DEBUG_VISUALS) {\n        console.log(`XMLDOM - cssStyleSet: ${cssProperty}: ${val};`);\n    }\n\n    const str = val ? `${cssProperty}: ${val}` : undefined;\n\n    const styleAttr = elem.getAttribute(\"style\");\n    if (!styleAttr) {\n        if (str) {\n            elem.setAttribute(\"style\", str);\n        }\n    } else {\n        const regExStr = `${cssProperty}[\\s]*:[\\s]*(.+)`;\n        const regex = new RegExp(regExStr, \"g\");\n        const regexMatch = regex.exec(styleAttr);\n        if (regexMatch) {\n            elem.setAttribute(\"style\", styleAttr.replace(regex, str ? `${str}` : \"\"));\n        } else {\n            if (str) {\n                elem.setAttribute(\"style\", `${styleAttr}; ${str}`);\n            }\n        }\n    }\n}\nfunction definePropertyGetterSetter_ElementStyle(element: Element) {\n    const styleObj: any = {};\n    styleObj.element = element;\n\n    styleObj.setProperty = cssSetProperty.bind(styleObj);\n    styleObj.removeProperty = cssRemoveProperty.bind(styleObj);\n\n    styleObj.item = cssStyleItem.bind(styleObj);\n    Object.defineProperty(styleObj, \"length\", {\n        get() {\n            const style = this as any;\n            const elem = style.element;\n\n            if (DEBUG_VISUALS) {\n                console.log(`XMLDOM - style.length`);\n            }\n\n            const styleAttr = elem.getAttribute(\"style\");\n            if (!styleAttr) {\n                return 0;\n            }\n            let count = 0;\n            const cssProps = styleAttr.split(\";\");\n            for (const cssProp of cssProps) {\n                if (cssProp.trim().length) {\n                    count++;\n                }\n            }\n            if (DEBUG_VISUALS) {\n                console.log(`XMLDOM - style.length: ${count}`);\n            }\n            return count;\n        },\n        set(_val) {\n            console.log(\"style.length CANNOT BE SET!!\");\n        },\n    });\n\n    const cssProperties = [\"overflow\", \"width\", \"height\", \"margin\", \"transformOrigin\", \"transform\"];\n    cssProperties.forEach((cssProperty) => {\n\n        Object.defineProperty(styleObj, cssProperty, {\n            get() {\n                const style = this as any;\n                const elem = style.element;\n\n                return cssStyleGet(cssProperty, elem);\n            },\n            set(val) {\n                const style = this as any;\n                const elem = style.element;\n\n                cssStyleSet(cssProperty, val, elem);\n            },\n        });\n    });\n\n    (element as any).style = styleObj;\n}\nfunction classListContains(this: any, className: string): boolean {\n    const style = this;\n    const elem = style.element;\n    if (DEBUG_VISUALS) {\n        console.log(`XMLDOM - classListContains: ${className}`);\n    }\n\n    const classAttr = elem.getAttribute(\"class\");\n    if (!classAttr) {\n        return false;\n    }\n    const classes = classAttr.split(\" \");\n    for (const clazz of classes) {\n        if (clazz === className) {\n            if (DEBUG_VISUALS) {\n                console.log(`XMLDOM - classListContains TRUE: ${className}`);\n            }\n            return true;\n        }\n    }\n    return false;\n}\nfunction classListAdd(this: any, className: string) {\n    const style = this;\n    const elem = style.element;\n\n    if (DEBUG_VISUALS) {\n        console.log(`XMLDOM - classListAdd: ${className}`);\n    }\n\n    const classAttr = elem.getAttribute(\"class\");\n    if (!classAttr) {\n        elem.setAttribute(\"class\", className);\n        return;\n    }\n    let needsAdding = true;\n    const classes = classAttr.split(\" \");\n    for (const clazz of classes) {\n        if (clazz === className) {\n            needsAdding = false;\n            break;\n        }\n    }\n    if (needsAdding) {\n        elem.setAttribute(\"class\", `${classAttr} ${className}`);\n    }\n}\nfunction classListRemove(this: any, className: string) {\n    const style = this;\n    const elem = style.element;\n\n    if (DEBUG_VISUALS) {\n        console.log(`XMLDOM - classListRemove: ${className}`);\n    }\n\n    const classAttr = elem.getAttribute(\"class\");\n    if (!classAttr) {\n        return;\n    }\n    const arr: string[] = [];\n    const classes = classAttr.split(\" \");\n    for (const clazz of classes) {\n        if (clazz !== className) {\n            arr.push(clazz);\n        }\n    }\n    elem.setAttribute(\"class\", arr.join(\" \"));\n}\nfunction definePropertyGetterSetter_ElementClassList(element: Element) {\n    const classListObj: any = {};\n    classListObj.element = element;\n\n    classListObj.contains = classListContains.bind(classListObj);\n    classListObj.add = classListAdd.bind(classListObj);\n    classListObj.remove = classListRemove.bind(classListObj);\n\n    (element as any).classList = classListObj;\n}\n\nexport function transformHTML(\n    htmlStr: string,\n    readiumcssJson: IEventPayload_R2_EVENT_READIUMCSS | undefined,\n    mediaType: string | undefined): string {\n\n    const doc = typeof mediaType === \"string\" ?\n        new xmldom.DOMParser().parseFromString(htmlStr, mediaType) :\n        new xmldom.DOMParser().parseFromString(htmlStr);\n\n    if (!doc.head) {\n        definePropertyGetterSetter_DocHeadBody(doc, \"head\");\n    }\n    if (!doc.body) {\n        definePropertyGetterSetter_DocHeadBody(doc, \"body\");\n    }\n    if (!doc.documentElement.style) {\n        definePropertyGetterSetter_ElementStyle(doc.documentElement);\n    }\n    if (!doc.body.style) {\n        definePropertyGetterSetter_ElementStyle(doc.body);\n    }\n    if (!doc.documentElement.classList) {\n        definePropertyGetterSetter_ElementClassList(doc.documentElement);\n    }\n\n    // const wh = configureFixedLayout(doc, win.READIUM2.isFixedLayout,\n    //     win.READIUM2.fxlViewportWidth, win.READIUM2.fxlViewportHeight,\n    //     win.innerWidth, win.innerHeight);\n    // if (wh) {\n    //     win.READIUM2.fxlViewportWidth = wh.width;\n    //     win.READIUM2.fxlViewportHeight = wh.height;\n    // }\n\n    injectDefaultCSS(doc);\n    if (DEBUG_VISUALS) {\n        injectReadPosCSS(doc);\n    }\n\n    const rtl = isDocRTL(doc);\n    const vertical = isDocVertical(doc);\n    if (readiumcssJson) {\n        readiumCSSSet(doc, readiumcssJson,\n            undefined, // urlRootReadiumCSS\n            vertical,\n            rtl);\n    }\n\n    return new xmldom.XMLSerializer().serializeToString(doc);\n}\n"]}