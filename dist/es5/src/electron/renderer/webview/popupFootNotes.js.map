{"version":3,"file":"popupFootNotes.js","sourceRoot":"","sources":["../../../../../../src/electron/renderer/webview/popupFootNotes.ts"],"names":[],"mappings":";;AAOA,8CAI6B;AAC7B,uDAAqD;AAErD,SAAgB,aAAa,CACzB,OAAoB,EACpB,cAAgE,EAChE,IAAY;IAEZ,IAAM,QAAQ,GAAG,OAAO,CAAC,aAAyB,CAAC;IACnD,IAAI,CAAC,QAAQ,CAAC,eAAe;QACzB,QAAQ,CAAC,eAAe,CAAC,SAAS,CAAC,QAAQ,CAAC,gCAAuB,CAAC,EAAE;QACtE,OAAO,KAAK,CAAC;KAChB;IAED,IAAI,QAAQ,GAAG,OAAO,CAAC,YAAY,CAAC,WAAW,CAAC,CAAC;IACjD,IAAI,CAAC,QAAQ,EAAE;QACX,QAAQ,GAAG,OAAO,CAAC,cAAc,CAAC,8BAA8B,EAAE,MAAM,CAAC,CAAC;KAC7E;IACD,IAAI,CAAC,QAAQ,EAAE;QACX,OAAO,KAAK,CAAC;KAChB;IAKD,IAAM,SAAS,GAAG,QAAQ,CAAC,OAAO,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;IACnD,IAAI,CAAC,SAAS,EAAE;QACZ,OAAO,KAAK,CAAC;KAChB;IAED,IAAM,GAAG,GAAG,IAAI,GAAG,CAAC,IAAI,CAAC,CAAC;IAC1B,IAAI,CAAC,GAAG,CAAC,IAAI,EAAE;QACX,OAAO,KAAK,CAAC;KAChB;IAED,IAAM,aAAa,GAAG,QAAQ,CAAC,aAAa,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;IACvD,IAAI,CAAC,aAAa,EAAE;QAChB,OAAO,KAAK,CAAC;KAChB;IAED,IAAM,SAAS,GAAG,+BAA+B,CAAC;IAClD,IAAM,EAAE,GAAG,SAAS,GAAG,aAAa,CAAC,EAAE,CAAC;IAQxC,IAAI,SAAS,GAAG,aAAa,CAAC,SAAS,CAAC;IACxC,IAAI,CAAC,SAAS,EAAE;QACZ,OAAO,KAAK,CAAC;KAChB;IAED,SAAS,GAAG,SAAS,CAAC,OAAO,CAAC,iDAAiD,EAAE,GAAG,CAAC,CAAC;IACtF,SAAS,GAAG,SAAS,CAAC,OAAO,CAAC,sDAAsD,EAAE,GAAG,CAAC,CAAC;IAC3F,SAAS,GAAG,SAAS,CAAC,OAAO,CAAC,2BAA2B,EAAE,GAAG,CAAC,CAAC;IAChE,SAAS,GAAG,SAAS,CAAC,OAAO,CAAC,uBAAuB,EAAE,GAAG,CAAC,CAAC;IAE5D,IAAM,UAAU,GAAG,yBAAyB,CAAC;IAC7C,IAAM,GAAG,GAAG,UAAU,GAAG,aAAa,CAAC,EAAE,CAAC;IAC1C,SAAS,GAAG,SAAS,CAAC,OAAO,CAAC,mBAAmB,EAAE,UAAO,GAAG,OAAG,CAAC,CAAC;IAElE,SAAS,GAAG,kBAAe,kCAAyB,SAAI,mCAA0B,2DACzC,SAAS,WAAQ,CAAC;IAe3D,SAAS,cAAc,CAAC,EAA2B;QAC/C,IAAI,EAAE,EAAE;YACJ,cAAc,CAAC,EAAE,EAAE,IAAI,CAAC,CAAC;SAC5B;QAED,UAAU,CAAC;YACP,GAAG,CAAC,MAAM,CAAC,MAAM,EAAE,CAAC;QACxB,CAAC,EAAE,EAAE,CAAC,CAAC;IACX,CAAC;IACD,IAAM,GAAG,GAAG,IAAI,0BAAW,CAAC,QAAQ,EAAE,SAAS,EAAE,EAAE,EAAE,cAAc,CAAC,CAAC;IAErE,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;IAClB,OAAO,IAAI,CAAC;AAChB,CAAC;AAzFD,sCAyFC","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport {\n    CSS_CLASS_NO_FOCUS_OUTLINE,\n    FOOTNOTES_CONTAINER_CLASS,\n    ROOT_CLASS_NO_FOOTNOTES,\n} from \"../../common/styles\";\nimport { PopupDialog } from \"../common/popup-dialog\";\n\nexport function popupFootNote(\n    element: HTMLElement,\n    focusScrollRaw: (el: HTMLOrSVGElement, doFocus: boolean) => void,\n    href: string): boolean {\n\n    const documant = element.ownerDocument as Document;\n    if (!documant.documentElement ||\n        documant.documentElement.classList.contains(ROOT_CLASS_NO_FOOTNOTES)) {\n        return false;\n    }\n\n    let epubType = element.getAttribute(\"epub:type\");\n    if (!epubType) {\n        epubType = element.getAttributeNS(\"http://www.idpf.org/2007/ops\", \"type\");\n    }\n    if (!epubType) {\n        return false;\n    }\n\n    // epubType.indexOf(\"biblioref\") >= 0 ||\n    // epubType.indexOf(\"glossref\") >= 0 ||\n    // epubType.indexOf(\"annoref\") >= 0\n    const isNoteref = epubType.indexOf(\"noteref\") >= 0;\n    if (!isNoteref) {\n        return false;\n    }\n\n    const url = new URL(href);\n    if (!url.hash) { // includes #\n        return false;\n    }\n    // const targetElement = win.document.getElementById(url.hash.substr(1));\n    const targetElement = documant.querySelector(url.hash);\n    if (!targetElement) {\n        return false;\n    }\n\n    const ID_PREFIX = \"r2-footnote-popup-dialog-for_\";\n    const id = ID_PREFIX + targetElement.id;\n\n    // const existingDialog = documant.getElementById(id) as IHTMLDialogElementWithPopup;\n    // if (existingDialog && existingDialog.popDialog) {\n    //     existingDialog.popDialog.show(element);\n    //     return true;\n    // }\n\n    let outerHTML = targetElement.outerHTML;\n    if (!outerHTML) {\n        return false;\n    }\n\n    outerHTML = outerHTML.replace(/xmlns=[\"']http:\\/\\/www.w3.org\\/1999\\/xhtml[\"']/g, \" \");\n    outerHTML = outerHTML.replace(/xmlns:epub=[\"']http:\\/\\/www.idpf.org\\/2007\\/ops[\"']/g, \" \");\n    outerHTML = outerHTML.replace(/epub:type=[\"'][^\"']+[\"']/g, \" \");\n    outerHTML = outerHTML.replace(/<script>.+<\\/script>/g, \" \");\n\n    const ID_PREFIX_ = \"r2-footnote-content-of_\";\n    const id_ = ID_PREFIX_ + targetElement.id;\n    outerHTML = outerHTML.replace(/id=[\"'][^\"']+[\"']/, `id=\"${id_}\"`);\n\n    outerHTML = `<div class=\"${FOOTNOTES_CONTAINER_CLASS} ${CSS_CLASS_NO_FOCUS_OUTLINE}\"\n        tabindex=\"0\" autofocus=\"autofocus\">${outerHTML}</div>`;\n\n    // outerHTML = outerHTML.replace(/click=[\"']javascript:.+[\"']/g, \" \");\n    // debug(outerHTML);\n\n    // import * as xmldom from \"xmldom\";\n    // const dom = new xmldom.DOMParser().parseFromString(outerHTML, \"application/xhtml+xml\");\n\n    // const payload_: IEventPayload_R2_EVENT_LINK_FOOTNOTE = {\n    //     hash: url.hash,\n    //     html: outerHTML,\n    //     url: href,\n    // };\n    // ipcRenderer.sendToHost(R2_EVENT_LINK_FOOTNOTE, payload_);\n\n    function onDialogClosed(el: HTMLOrSVGElement | null) {\n        if (el) {\n            focusScrollRaw(el, true);\n        }\n\n        setTimeout(() => {\n            pop.dialog.remove();\n        }, 50);\n    }\n    const pop = new PopupDialog(documant, outerHTML, id, onDialogClosed);\n\n    pop.show(element);\n    return true;\n}\n"]}