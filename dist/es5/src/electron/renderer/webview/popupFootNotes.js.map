{"version":3,"file":"popupFootNotes.js","sourceRoot":"","sources":["../../../../../../src/electron/renderer/webview/popupFootNotes.ts"],"names":[],"mappings":";;AAOA,8CAE6B;AAC7B,uDAAqD;AAErD,SAAgB,aAAa,CACzB,OAAoB,EACpB,cAAgE,EAChE,IAAY,EACZ,oDAAkE,EAClE,iDAAwE;IAGxE,IAAM,QAAQ,GAAG,OAAO,CAAC,aAAyB,CAAC;IACnD,IAAI,CAAC,QAAQ,CAAC,eAAe;QACzB,QAAQ,CAAC,eAAe,CAAC,SAAS,CAAC,QAAQ,CAAC,gCAAuB,CAAC,EAAE;QACtE,OAAO,KAAK,CAAC;KAChB;IAED,IAAI,QAAQ,GAAG,OAAO,CAAC,YAAY,CAAC,WAAW,CAAC,CAAC;IACjD,IAAI,CAAC,QAAQ,EAAE;QACX,QAAQ,GAAG,OAAO,CAAC,cAAc,CAAC,8BAA8B,EAAE,MAAM,CAAC,CAAC;KAC7E;IACD,IAAI,CAAC,QAAQ,EAAE;QACX,OAAO,KAAK,CAAC;KAChB;IAKD,IAAM,SAAS,GAAG,QAAQ,CAAC,OAAO,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;IACnD,IAAI,CAAC,SAAS,EAAE;QACZ,OAAO,KAAK,CAAC;KAChB;IAED,IAAM,GAAG,GAAG,IAAI,GAAG,CAAC,IAAI,CAAC,CAAC;IAC1B,IAAI,CAAC,GAAG,CAAC,IAAI,EAAE;QACX,OAAO,KAAK,CAAC;KAChB;IAED,IAAM,aAAa,GAAG,QAAQ,CAAC,aAAa,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;IACvD,IAAI,CAAC,aAAa,EAAE;QAChB,OAAO,KAAK,CAAC;KAChB;IAQD,IAAI,OAAO,GAAG,aAAa,CAAC,SAAS,CAAC;IACtC,IAAI,CAAC,OAAO,EAAE;QACV,OAAO,KAAK,CAAC;KAChB;IAED,OAAO,GAAG,OAAO,CAAC,OAAO,CAAC,iDAAiD,EAAE,GAAG,CAAC,CAAC;IAClF,OAAO,GAAG,OAAO,CAAC,OAAO,CAAC,sDAAsD,EAAE,GAAG,CAAC,CAAC;IAEvF,OAAO,GAAG,OAAO,CAAC,OAAO,CAAC,uBAAuB,EAAE,GAAG,CAAC,CAAC;IAExD,IAAM,UAAU,GAAG,kBAAkB,CAAC;IACtC,IAAM,GAAG,GAAG,UAAU,GAAG,aAAa,CAAC,EAAE,CAAC;IAE1C,OAAO,GAAG,OAAO,CAAC,OAAO,CAAC,sBAAsB,EAAE,eAAa,CAAC,CAAC;IAGjE,OAAO,GAAG,eAAY,GAAG,mBAAY,kCAAyB,SAAI,mCAA0B,kDAAwC,OAAO,WAAQ,CAAC;IAepJ,IAAM,GAAG,GAAG,oDAAoD,EAAE,CAAC;IAEnE,SAAS,cAAc,CAAC,EAA2B;QAE/C,IAAI,EAAE,EAAE;YACJ,cAAc,CAAC,EAAE,EAAE,IAAI,CAAC,CAAC;SAC5B;aAAM;YACH,iDAAiD,CAAC,GAAG,CAAC,CAAC;SAC1D;QAED,UAAU,CAAC;YACP,GAAG,CAAC,MAAM,CAAC,MAAM,EAAE,CAAC;QACxB,CAAC,EAAE,EAAE,CAAC,CAAC;IACX,CAAC;IACD,IAAM,GAAG,GAAG,IAAI,0BAAW,CAAC,QAAQ,EAAE,OAAO,EAAE,cAAc,CAAC,CAAC;IAE/D,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;IAClB,OAAO,IAAI,CAAC;AAChB,CAAC;AA/FD,sCA+FC","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport {\n    CSS_CLASS_NO_FOCUS_OUTLINE, FOOTNOTES_CONTAINER_CLASS, ROOT_CLASS_NO_FOOTNOTES,\n} from \"../../common/styles\";\nimport { PopupDialog } from \"../common/popup-dialog\";\n\nexport function popupFootNote(\n    element: HTMLElement,\n    focusScrollRaw: (el: HTMLOrSVGElement, doFocus: boolean) => void,\n    href: string,\n    ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable: () => number,\n    ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable: (val: number) => void,\n    ): boolean {\n\n    const documant = element.ownerDocument as Document;\n    if (!documant.documentElement ||\n        documant.documentElement.classList.contains(ROOT_CLASS_NO_FOOTNOTES)) {\n        return false;\n    }\n\n    let epubType = element.getAttribute(\"epub:type\");\n    if (!epubType) {\n        epubType = element.getAttributeNS(\"http://www.idpf.org/2007/ops\", \"type\");\n    }\n    if (!epubType) {\n        return false;\n    }\n\n    // epubType.indexOf(\"biblioref\") >= 0 ||\n    // epubType.indexOf(\"glossref\") >= 0 ||\n    // epubType.indexOf(\"annoref\") >= 0\n    const isNoteref = epubType.indexOf(\"noteref\") >= 0;\n    if (!isNoteref) {\n        return false;\n    }\n\n    const url = new URL(href);\n    if (!url.hash) { // includes #\n        return false;\n    }\n    // const targetElement = win.document.getElementById(url.hash.substr(1));\n    const targetElement = documant.querySelector(url.hash);\n    if (!targetElement) {\n        return false;\n    }\n\n    // const existingDialog = documant.getElementById(id) as IHTMLDialogElementWithPopup;\n    // if (existingDialog && existingDialog.popDialog) {\n    //     existingDialog.popDialog.show(element);\n    //     return true;\n    // }\n\n    let htmltxt = targetElement.innerHTML;\n    if (!htmltxt) {\n        return false;\n    }\n\n    htmltxt = htmltxt.replace(/xmlns=[\"']http:\\/\\/www.w3.org\\/1999\\/xhtml[\"']/g, \" \");\n    htmltxt = htmltxt.replace(/xmlns:epub=[\"']http:\\/\\/www.idpf.org\\/2007\\/ops[\"']/g, \" \");\n    // htmltxt = htmltxt.replace(/epub:type=[\"'][^\"']+[\"']/g, \" \");\n    htmltxt = htmltxt.replace(/<script>.+<\\/script>/g, \" \");\n\n    const ID_PREFIX_ = \"r2-footnote-for_\";\n    const id_ = ID_PREFIX_ + targetElement.id;\n    // htmltxt = htmltxt.replace(/id=[\"'][^\"']+[\"']/, `id=\"${id_}\"`);\n    htmltxt = htmltxt.replace(/id=[\"']([^\"']+)[\"']/g, `idvoid=\"$1\"`); // remove duplicate IDs\n\n    // tslint:disable-next-line:max-line-length\n    htmltxt = `<div id=\"${id_}\" class=\"${FOOTNOTES_CONTAINER_CLASS} ${CSS_CLASS_NO_FOCUS_OUTLINE}\" tabindex=\"0\" autofocus=\"autofocus\">${htmltxt}</div>`;\n\n    // htmltxt = htmltxt.replace(/click=[\"']javascript:.+[\"']/g, \" \");\n    // debug(htmltxt);\n\n    // import * as xmldom from \"xmldom\";\n    // const dom = new xmldom.DOMParser().parseFromString(htmltxt, \"application/xhtml+xml\");\n\n    // const payload_: IEventPayload_R2_EVENT_LINK_FOOTNOTE = {\n    //     hash: url.hash,\n    //     html: htmltxt,\n    //     url: href,\n    // };\n    // ipcRenderer.sendToHost(R2_EVENT_LINK_FOOTNOTE, payload_);\n\n    const val = ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable();\n\n    function onDialogClosed(el: HTMLOrSVGElement | null) {\n\n        if (el) {\n            focusScrollRaw(el, true);\n        } else {\n            ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable(val);\n        }\n\n        setTimeout(() => {\n            pop.dialog.remove();\n        }, 50);\n    }\n    const pop = new PopupDialog(documant, htmltxt, onDialogClosed);\n\n    pop.show(element);\n    return true;\n}\n"]}