{"version":3,"file":"readaloud.js","sourceRoot":"","sources":["../../../../../../src/electron/renderer/webview/readaloud.ts"],"names":[],"mappings":"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","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport { debounce } from \"debounce\";\nimport { ipcRenderer } from \"electron\";\n\nimport {\n    R2_EVENT_TTS_DOC_END, R2_EVENT_TTS_IS_PAUSED, R2_EVENT_TTS_IS_PLAYING, R2_EVENT_TTS_IS_STOPPED,\n} from \"../../common/events\";\nimport {\n    HighlightDrawTypeBackground, HighlightDrawTypeUnderline, IHighlight,\n} from \"../../common/highlight\";\nimport {\n    CSS_CLASS_NO_FOCUS_OUTLINE, POPUP_DIALOG_CLASS_COLLAPSE, ROOT_CLASS_REDUCE_MOTION,\n    TTS_CLASS_IS_ACTIVE, TTS_CLASS_THEME1, TTS_CLASS_UTTERANCE, TTS_CLASS_UTTERANCE_HEADING1,\n    TTS_CLASS_UTTERANCE_HEADING2, TTS_CLASS_UTTERANCE_HEADING3, TTS_CLASS_UTTERANCE_HEADING4,\n    TTS_CLASS_UTTERANCE_HEADING5, TTS_ID_ACTIVE_UTTERANCE, TTS_ID_ACTIVE_WORD, TTS_ID_CONTAINER,\n    TTS_ID_NEXT, TTS_ID_PREVIOUS, TTS_ID_SLIDER, TTS_ID_SPEAKING_DOC_ELEMENT, TTS_NAV_BUTTON_CLASS,\n    TTS_POPUP_DIALOG_CLASS,\n} from \"../../common/styles\";\nimport { IPropertyAnimationState, animateProperty } from \"../common/animateProperty\";\nimport { uniqueCssSelector } from \"../common/cssselector2\";\nimport {\n    ITtsQueueItem, ITtsQueueItemReference, findTtsQueueItemIndex, generateTtsQueue,\n    getTtsQueueItemRef, getTtsQueueItemRefText, getTtsQueueLength, normalizeHtmlText,\n} from \"../common/dom-text-utils\";\nimport { easings } from \"../common/easings\";\nimport { IHTMLDialogElementWithPopup, PopupDialog } from \"../common/popup-dialog\";\nimport { createHighlights, destroyHighlight } from \"./highlight\";\nimport { isRTL } from \"./readium-css\";\nimport { convertRange } from \"./selection\";\nimport { IReadiumElectronWebviewWindow } from \"./state\";\n\nconst IS_DEV = (process.env.NODE_ENV === \"development\" || process.env.NODE_ENV === \"dev\");\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nconst win = (global as any).window as IReadiumElectronWebviewWindow;\n\ninterface IHTMLDialogElementWithTTSState extends IHTMLDialogElementWithPopup {\n\n    domSlider: HTMLInputElement | undefined;\n    domNext: HTMLButtonElement | undefined;\n    domPrevious: HTMLButtonElement | undefined;\n    domText: HTMLDivElement | undefined;\n\n    ttsUtterance: SpeechSynthesisUtterance | undefined;\n    ttsQueue: ITtsQueueItem[] | undefined;\n    ttsQueueLength: number; // index by ITtsQueueItemReference.iGlobal\n    ttsQueueItem: ITtsQueueItemReference | undefined;\n\n    ttsRootElement: Element | undefined;\n\n    ttsOverlayEnabled: boolean;\n\n    focusScrollRaw:\n    ((el: HTMLOrSVGElement, doFocus: boolean, animate: boolean, domRect: DOMRect | undefined) => void) | undefined;\n\n    ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable: (() => number) | undefined;\n    ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable: ((val: number) => void) | undefined;\n}\n\nlet _dialogState: IHTMLDialogElementWithTTSState | undefined;\n\nfunction resetState() {\n    _resumableState = undefined;\n\n    if (_dialogState) {\n        _dialogState.popDialog = undefined;\n        _dialogState.focusScrollRaw = undefined;\n        _dialogState.ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable = undefined;\n        _dialogState.ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable = undefined;\n\n        _dialogState.ttsRootElement = undefined;\n        _dialogState.ttsQueue = undefined;\n        _dialogState.ttsQueueLength = -1;\n        _dialogState.ttsUtterance = undefined;\n        _dialogState.ttsQueueItem = undefined;\n\n        _dialogState.domSlider = undefined;\n        _dialogState.domNext = undefined;\n        _dialogState.domPrevious = undefined;\n        _dialogState.domText = undefined;\n\n        _dialogState.ttsOverlayEnabled = win.READIUM2.ttsOverlayEnabled;\n\n        _dialogState.remove();\n    }\n    _dialogState = undefined;\n\n    win.document.documentElement.classList.remove(TTS_CLASS_IS_ACTIVE);\n    ipcRenderer.sendToHost(R2_EVENT_TTS_IS_STOPPED);\n}\n\nexport function ttsPlay(\n    speed: number,\n    voice: SpeechSynthesisVoice | null,\n    focusScrollRaw:\n        (el: HTMLOrSVGElement, doFocus: boolean, animate: boolean, domRect: DOMRect | undefined) => void,\n    rootElem: Element | undefined,\n    startElem: Element | undefined,\n    startTextNode: Node | undefined,\n    startTextNodeOffset: number,\n    ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable: () => number,\n    ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable: (val: number) => void,\n) {\n\n    ttsStop();\n\n    let rootEl = rootElem;\n\n    if (!rootEl) {\n        rootEl = win.document.body;\n    }\n\n    const splitSentences = win.READIUM2.ttsSentenceDetectionEnabled;\n    const ttsQueue = generateTtsQueue(rootEl, splitSentences);\n    if (!ttsQueue.length) {\n        return;\n    }\n\n    let ttsQueueIndex = -1;\n    if (startElem) {\n        const idx = findTtsQueueItemIndex(ttsQueue, startElem, startTextNode, startTextNodeOffset, rootEl);\n        if (idx >= 0) {\n            ttsQueueIndex = idx;\n        }\n    }\n    if (ttsQueueIndex < 0) {\n        ttsQueueIndex = 0;\n    }\n    setTimeout(() => {\n        startTTSSession(\n            speed,\n            voice,\n            rootEl as Element,\n            ttsQueue,\n            ttsQueueIndex,\n            focusScrollRaw,\n            ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable,\n            ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable);\n    }, 100);\n}\n\nexport function ttsStop() {\n    if (_dialogState) {\n        if (_dialogState.hasAttribute(\"open\")) {\n            _dialogState.close(); // => onDialogClosed()\n            return;\n        }\n    }\n    ttsPause();\n    resetState();\n}\n\nexport function ttsPause() {\n\n    highlights(false);\n\n    // can actually be in paused state!\n    if (win.speechSynthesis.speaking) {\n        // if (win.speechSynthesis.paused) {\n        //     console.log(\"resume\");\n        //     win.speechSynthesis.resume();\n        // } else {\n        //     console.log(\"pause\");\n        //     win.speechSynthesis.pause(); // doesn't seem to work!\n        // }\n\n        if (_dialogState && _dialogState.ttsUtterance) {\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\n            (_dialogState.ttsUtterance as any).r2_cancel = true;\n        }\n        setTimeout(() => {\n            win.speechSynthesis.cancel();\n        }, 0);\n    } else if (win.speechSynthesis.pending) {\n        // we only queue a single utterance, so this isn't really needed.\n\n        if (_dialogState && _dialogState.ttsUtterance) {\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\n            (_dialogState.ttsUtterance as any).r2_cancel = true;\n        }\n        setTimeout(() => {\n            win.speechSynthesis.cancel();\n        }, 0);\n    }\n\n    if (_dialogState && _dialogState.ttsOverlayEnabled) {\n        win.document.documentElement.classList.add(TTS_CLASS_IS_ACTIVE);\n    }\n    ipcRenderer.sendToHost(R2_EVENT_TTS_IS_PAUSED);\n}\n\n// interface SpeechSynthesisVoice {\n//     readonly default: boolean;\n//     readonly lang: string;\n//     readonly localService: boolean;\n//     readonly name: string;\n//     readonly voiceURI: string;\n// }\nexport function ttsVoice(voice: SpeechSynthesisVoice | null) {\n    win.READIUM2.ttsVoice = voice;\n\n    if (_dialogState) {\n        const resumableState = _resumableState;\n        ttsStop();\n        // if (_dialogState.ttsUtterance) {\n        //     _dialogState.ttsUtterance.voice = voice;\n        // }\n        // _dialogState.ttsUtterance = undefined;\n        // _resumableState = {\n        //     ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable:\n        //         _dialogState.ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable,\n        //     ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable:\n        //         _dialogState.ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable,\n        //     focusScrollRaw: _dialogState.focusScrollRaw,\n        //     ttsQueue: _dialogState.ttsQueue,\n        //     ttsQueueIndex: _dialogState.ttsQueueItem.iGlobal, // ttsQueueIndex\n        //     ttsRootElement: _dialogState.ttsRootElement,\n        // };\n\n        setTimeout(() => {\n            _resumableState = resumableState;\n            ttsResume();\n        }, 60);\n    }\n}\n\nexport function ttsPlaybackRate(speed: number) {\n    win.READIUM2.ttsPlaybackRate = speed;\n\n    if (_dialogState) {\n        ttsPause();\n        if (_dialogState.ttsUtterance) {\n            _dialogState.ttsUtterance.rate = speed;\n        }\n        setTimeout(() => {\n            ttsResume();\n        }, 60);\n    }\n}\n\ninterface IResumableState {\n    ttsRootElement: Element;\n    ttsQueue: ITtsQueueItem[];\n    ttsQueueIndex: number;\n    focusScrollRaw:\n    ((el: HTMLOrSVGElement, doFocus: boolean, animate: boolean, domRect: DOMRect | undefined) => void);\n    ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable: (() => number);\n    ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable: ((val: number) => void);\n}\nlet _resumableState: IResumableState | undefined;\n\nexport function ttsResume() {\n\n    if (_dialogState &&\n        _dialogState.ttsUtterance) {\n        highlights(true);\n\n        setTimeout(() => {\n            if (_dialogState &&\n                _dialogState.ttsUtterance) {\n\n                    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n                (_dialogState.ttsUtterance as any).r2_cancel = false;\n                win.speechSynthesis.speak(_dialogState.ttsUtterance);\n            }\n        }, 0);\n\n        if (_dialogState && _dialogState.ttsOverlayEnabled) {\n            win.document.documentElement.classList.add(TTS_CLASS_IS_ACTIVE);\n        }\n        ipcRenderer.sendToHost(R2_EVENT_TTS_IS_PLAYING);\n    } else if (_resumableState) {\n        setTimeout(() => {\n            if (_resumableState) {\n                startTTSSession(\n                    win.READIUM2.ttsPlaybackRate,\n                    win.READIUM2.ttsVoice,\n                    _resumableState.ttsRootElement,\n                    _resumableState.ttsQueue,\n                    _resumableState.ttsQueueIndex,\n                    _resumableState.focusScrollRaw,\n                    _resumableState.ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable,\n                    _resumableState.ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable);\n            }\n        }, 100);\n    }\n}\n\nexport function isTtsPlaying() {\n    return isTtsActive() && !win.speechSynthesis.paused;\n}\n\nexport function isTtsActive() {\n    if (_dialogState && _dialogState.hasAttribute(\"open\") &&\n        (win.speechSynthesis.speaking || win.speechSynthesis.pending)) {\n        return true;\n    }\n    return false;\n}\n\nexport function ttsPauseOrResume() {\n    if (isTtsPlaying()) {\n        ttsPause();\n    } else {\n        ttsResume();\n    }\n}\n\nexport function ttsQueueSize(): number {\n    if (_dialogState && _dialogState.ttsQueue) {\n        getTtsQueueLength(_dialogState.ttsQueue);\n    }\n    return -1;\n}\nexport function ttsQueueCurrentIndex(): number {\n    if (_dialogState && _dialogState.ttsQueueItem) {\n        return _dialogState.ttsQueueItem.iGlobal;\n    }\n    return -1;\n}\nexport function ttsQueueCurrentText(): string | undefined {\n    if (_dialogState && _dialogState.ttsQueueItem) {\n        return getTtsQueueItemRefText(_dialogState.ttsQueueItem);\n    }\n    return undefined;\n}\n\nexport function ttsNext(skipSentences = false) {\n    if (_dialogState && _dialogState.ttsQueueItem) {\n        let j = _dialogState.ttsQueueItem.iGlobal + 1;\n        if (skipSentences &&\n            _dialogState.ttsQueueItem.iSentence !== -1 &&\n            _dialogState.ttsQueueItem.item.combinedTextSentences) {\n            j = _dialogState.ttsQueueItem.iGlobal +\n                (_dialogState.ttsQueueItem.item.combinedTextSentences.length -\n                    _dialogState.ttsQueueItem.iSentence);\n        }\n        if (j >= _dialogState.ttsQueueLength || j < 0) {\n            return;\n        }\n        ttsPause();\n        ttsPlayQueueIndexDebounced(j);\n    }\n}\nexport function ttsPrevious(skipSentences = false) {\n    if (_dialogState && _dialogState.ttsQueueItem) {\n        let j = _dialogState.ttsQueueItem.iGlobal - 1;\n        if (skipSentences &&\n            _dialogState.ttsQueueItem.iSentence !== -1 &&\n            _dialogState.ttsQueueItem.item.combinedTextSentences) {\n            j = _dialogState.ttsQueueItem.iGlobal - _dialogState.ttsQueueItem.iSentence - 1;\n        }\n        if (j >= _dialogState.ttsQueueLength || j < 0) {\n            return;\n        }\n        ttsPause();\n        ttsPlayQueueIndexDebounced(j);\n    }\n}\n\nexport function ttsPreviewAndEventuallyPlayQueueIndex(n: number) {\n\n    ttsPause();\n\n    // if (_dialogState && _dialogState.ttsQueue) {\n    //     updateTTSInfo(getTtsQueueItemRef(_dialogState.ttsQueue, n), -1, undefined);\n    // }\n\n    ttsPlayQueueIndexDebounced(n);\n}\n\nconst _getCssSelectorOptions = {\n    className: (_str: string) => {\n        return true;\n    },\n    idName: (_str: string) => {\n        return true;\n    },\n    tagName: (_str: string) => {\n        return true;\n    },\n};\nfunction getCssSelector(element: Element): string {\n    try {\n        return uniqueCssSelector(element, win.document, _getCssSelectorOptions);\n    } catch (err) {\n        console.log(\"uniqueCssSelector:\");\n        console.log(err);\n        return \"\";\n    }\n}\n\nlet _ttsQueueItemHighlightsSentence: Array<IHighlight | null> | undefined;\nlet _ttsQueueItemHighlightsWord: Array<IHighlight | null> | undefined;\n\nfunction wrapHighlightWord(\n    ttsQueueItemRef: ITtsQueueItemReference,\n    utteranceText: string,\n    charIndex: number,\n    charLength: number,\n    word: string,\n    start: number,\n    end: number) {\n\n    if (_dialogState && _dialogState.ttsOverlayEnabled) {\n        return;\n    }\n\n    if (_ttsQueueItemHighlightsWord) {\n        _ttsQueueItemHighlightsWord.forEach((highlight) => {\n            if (highlight) {\n                destroyHighlight(win.document, highlight.id);\n            }\n        });\n        _ttsQueueItemHighlightsWord = undefined;\n    }\n\n    const ttsQueueItem = ttsQueueItemRef.item;\n    let txtToCheck = ttsQueueItemRef.item.combinedText;\n    let charIndexAdjusted = charIndex;\n    if (ttsQueueItem.combinedTextSentences &&\n        ttsQueueItem.combinedTextSentencesRangeBegin &&\n        ttsQueueItem.combinedTextSentencesRangeEnd &&\n        ttsQueueItemRef.iSentence >= 0) {\n        const sentOffset = ttsQueueItem.combinedTextSentencesRangeBegin[ttsQueueItemRef.iSentence];\n        charIndexAdjusted += sentOffset;\n        txtToCheck = ttsQueueItem.combinedTextSentences[ttsQueueItemRef.iSentence];\n    }\n\n    if (IS_DEV) {\n        if (utteranceText !== txtToCheck) {\n            console.log(\"TTS utteranceText DIFF?? \",\n                `[[${utteranceText}]]`, `[[${txtToCheck}]]`);\n        }\n        const ttsWord = utteranceText.substr(charIndex, charLength);\n        if (ttsWord !== word) {\n            console.log(\"TTS word DIFF?? \",\n                `[[${ttsWord}]]`, `[[${word}]]`,\n                `${charIndex}--${charLength}`, `${start}--${end - start}`);\n        }\n        // console.log(\"HIGHLIGHT WORD DATA:\");\n        // console.log(utteranceText);\n        // console.log(txtToCheck);\n        // console.log(ttsWord);\n        // console.log(word);\n        // console.log(charIndex);\n        // console.log(charLength);\n        // console.log(start);\n        // console.log(end - start);\n    }\n\n    let acc = 0;\n    let rangeStartNode: Node | undefined;\n    let rangeStartOffset = -1;\n    let rangeEndNode: Node | undefined;\n    let rangeEndOffset = -1;\n    const charIndexEnd = charIndexAdjusted + charLength;\n    for (const txtNode of ttsQueueItem.textNodes) {\n        if (!txtNode.nodeValue && txtNode.nodeValue !== \"\") {\n            continue;\n        }\n        const l = txtNode.nodeValue.length;\n        acc += l;\n        if (!rangeStartNode) {\n            if (charIndexAdjusted < acc) {\n                rangeStartNode = txtNode;\n                rangeStartOffset = l - (acc - charIndexAdjusted);\n            }\n        }\n        if (rangeStartNode && charIndexEnd <= acc) {\n            rangeEndNode = txtNode;\n            rangeEndOffset = l - (acc - charIndexEnd);\n            break;\n        }\n    }\n\n    if (rangeStartNode && rangeEndNode) {\n        // console.log(\"HIGHLIGHT WORD\");\n        // console.log(rangeStartOffset);\n        // console.log(rangeEndOffset);\n\n        const range = new Range(); // document.createRange()\n        range.setStart(rangeStartNode, rangeStartOffset);\n        range.setEnd(rangeEndNode, rangeEndOffset);\n\n        if (_dialogState && _dialogState.focusScrollRaw) {\n            const domRect = range.getBoundingClientRect();\n            _dialogState.focusScrollRaw(ttsQueueItemRef.item.parentElement as HTMLElement, false, true, domRect);\n        }\n\n        const rangeInfo = convertRange(\n            range,\n            getCssSelector,\n            (_node: Node) => \"\"); // computeElementCFI\n        if (!rangeInfo) {\n            return;\n        }\n\n        const highlightDefinitions = [\n            {\n                // https://htmlcolorcodes.com/\n                color: {\n                    blue: 0,\n                    green: 147,\n                    red: 255,\n                },\n                drawType: HighlightDrawTypeUnderline,\n                expand: 2,\n                selectionInfo: {\n                    cleanText: \"\",\n                    rangeInfo,\n                    rawText: \"\",\n                },\n            },\n        ];\n        _ttsQueueItemHighlightsWord = createHighlights(\n            win,\n            highlightDefinitions,\n            false, // mouse / pointer interaction\n        );\n    }\n}\nfunction wrapHighlight(\n    doHighlight: boolean,\n    ttsQueueItemRef: ITtsQueueItemReference) {\n\n    if (_dialogState && _dialogState.ttsOverlayEnabled) {\n        return;\n    }\n\n    if (_ttsQueueItemHighlightsWord) {\n        _ttsQueueItemHighlightsWord.forEach((highlight) => {\n            if (highlight) {\n                destroyHighlight(win.document, highlight.id);\n            }\n        });\n        _ttsQueueItemHighlightsWord = undefined;\n    }\n    if (_ttsQueueItemHighlightsSentence) {\n        _ttsQueueItemHighlightsSentence.forEach((highlight) => {\n            if (highlight) {\n                destroyHighlight(win.document, highlight.id);\n            }\n        });\n        _ttsQueueItemHighlightsSentence = undefined;\n    }\n\n    const ttsQueueItem = ttsQueueItemRef.item;\n    if (doHighlight &&\n        ttsQueueItem.parentElement &&\n        ttsQueueItem.textNodes && ttsQueueItem.textNodes.length) {\n\n        let range: Range | undefined;\n        if (ttsQueueItem.combinedTextSentences &&\n            ttsQueueItem.combinedTextSentencesRangeBegin &&\n            ttsQueueItem.combinedTextSentencesRangeEnd &&\n            ttsQueueItemRef.iSentence >= 0) {\n\n            const sentBegin = ttsQueueItem.combinedTextSentencesRangeBegin[ttsQueueItemRef.iSentence];\n            const sentEnd = ttsQueueItem.combinedTextSentencesRangeEnd[ttsQueueItemRef.iSentence];\n\n            let acc = 0;\n            let rangeStartNode: Node | undefined;\n            let rangeStartOffset = -1;\n            let rangeEndNode: Node | undefined;\n            let rangeEndOffset = -1;\n            for (const txtNode of ttsQueueItemRef.item.textNodes) {\n                if (!txtNode.nodeValue && txtNode.nodeValue !== \"\") {\n                    continue;\n                }\n                const l = txtNode.nodeValue.length;\n                acc += l;\n                if (!rangeStartNode) {\n                    if (sentBegin < acc) {\n                        rangeStartNode = txtNode;\n                        rangeStartOffset = l - (acc - sentBegin);\n                    }\n                }\n                if (rangeStartNode && sentEnd <= acc) {\n                    rangeEndNode = txtNode;\n                    rangeEndOffset = l - (acc - sentEnd);\n                    break;\n                }\n            }\n\n            if (rangeStartNode && rangeEndNode) {\n                // console.log(\"HIGHLIGHT WORD\");\n                // console.log(rangeStartOffset);\n                // console.log(rangeEndOffset);\n\n                range = new Range(); // document.createRange()\n                range.setStart(rangeStartNode, rangeStartOffset);\n                range.setEnd(rangeEndNode, rangeEndOffset);\n            }\n        } else { // ttsQueueItem.combinedText\n\n            range = new Range(); // document.createRange()\n\n            const firstTextNode = ttsQueueItem.textNodes[0];\n            if (!firstTextNode.nodeValue && firstTextNode.nodeValue !== \"\") {\n                return;\n            }\n            range.setStart(firstTextNode, 0);\n\n            const lastTextNode = ttsQueueItem.textNodes[ttsQueueItem.textNodes.length - 1];\n            if (!lastTextNode.nodeValue && lastTextNode.nodeValue !== \"\") {\n                return;\n            }\n            range.setEnd(lastTextNode, lastTextNode.nodeValue.length);\n        }\n\n        if (range) {\n\n            if (_dialogState && _dialogState.focusScrollRaw) {\n                const domRect = range.getBoundingClientRect();\n                _dialogState.focusScrollRaw(ttsQueueItemRef.item.parentElement as HTMLElement, false, true, domRect);\n            }\n\n            const rangeInfo = convertRange(\n                range,\n                getCssSelector,\n                (_node: Node) => \"\"); // computeElementCFI\n            if (!rangeInfo) {\n                return;\n            }\n\n            const highlightDefinitions = [\n                {\n                    // https://htmlcolorcodes.com/\n                    color: {\n                        blue: 116, // 204,\n                        green: 248, // 218,\n                        red: 248, // 255,\n                    },\n                    drawType: HighlightDrawTypeBackground,\n                    expand: 4,\n                    selectionInfo: {\n                        cleanText: \"\",\n                        rangeInfo,\n                        rawText: \"\",\n                    },\n                },\n            ];\n            _ttsQueueItemHighlightsSentence = createHighlights(\n                win,\n                highlightDefinitions,\n                false, // mouse / pointer interaction\n            );\n        }\n    }\n}\n\nfunction highlights(doHighlight: boolean) {\n\n    if (_dialogState && _dialogState.ttsOverlayEnabled) {\n        return;\n    }\n    if (!_dialogState) {\n        return;\n    }\n    if (doHighlight) {\n        if (_dialogState.ttsQueueItem) {\n            wrapHighlight(true, _dialogState.ttsQueueItem);\n        }\n        if (win.READIUM2.DEBUG_VISUALS &&\n            _dialogState.ttsRootElement) {\n            _dialogState.ttsRootElement.classList.add(TTS_ID_SPEAKING_DOC_ELEMENT);\n        }\n    } else {\n        if (_dialogState.ttsQueueItem) {\n            wrapHighlight(false, _dialogState.ttsQueueItem);\n        }\n        if (// win.READIUM2.DEBUG_VISUALS &&\n            _dialogState.ttsRootElement) {\n            _dialogState.ttsRootElement.classList.remove(TTS_ID_SPEAKING_DOC_ELEMENT);\n        }\n    }\n}\n\nlet _lastAnimState: IPropertyAnimationState | undefined;\nconst animationTime = 400;\n\nconst scrollIntoViewSpokenTextDebounced = debounce((id: string) => {\n    scrollIntoViewSpokenText(id);\n}, 200);\nfunction scrollIntoViewSpokenText(id: string) {\n\n    const reduceMotion = win.document.documentElement.classList.contains(ROOT_CLASS_REDUCE_MOTION);\n\n    const span = win.document.getElementById(id) as HTMLElement;\n    if (span && _dialogState && _dialogState.domText) {\n        const rect = span.getBoundingClientRect();\n        const rect2 = _dialogState.domText.getBoundingClientRect();\n        const scrollTopMax = _dialogState.domText.scrollHeight - _dialogState.domText.clientHeight;\n        let offset = _dialogState.domText.scrollTop + (rect.top - rect2.top - (_dialogState.domText.clientHeight / 2));\n        if (offset > scrollTopMax) {\n            offset = scrollTopMax;\n        } else if (offset < 0) {\n            offset = 0;\n        }\n        const diff = Math.abs(_dialogState.domText.scrollTop - offset);\n        if (diff < 20) {\n            return; // prevents jittering\n        }\n\n        if (_lastAnimState && _lastAnimState.animating) {\n            win.cancelAnimationFrame(_lastAnimState.id);\n            _lastAnimState.object[_lastAnimState.property] = _lastAnimState.destVal;\n        }\n\n        // _dialogState.domText.scrollTop = offset;\n        const targetObj = _dialogState.domText;\n        const targetProp = \"scrollTop\";\n        if (reduceMotion) {\n            _lastAnimState = undefined;\n            targetObj[targetProp] = offset;\n        } else {\n            // _lastAnimState = undefined;\n            // (targetObj as HTMLElement).style.transition = \"\";\n            // (targetObj as HTMLElement).style.transform = \"none\";\n            // (targetObj as HTMLElement).style.transition =\n            //     `transform ${animationTime}ms ease-in-out 0s`;\n            // (targetObj as HTMLElement).style.transform =\n            //     isVerticalWritingMode() ?\n            //     `translateY(${unit}px)` :\n            //     `translateX(${(isRTL() ? -1 : 1) * unit}px)`;\n            // setTimeout(() => {\n            //     (targetObj as HTMLElement).style.transition = \"\";\n            //     (targetObj as HTMLElement).style.transform = \"none\";\n            //     targetObj[targetProp] = offset;\n            // }, animationTime);\n            _lastAnimState = animateProperty(\n                win.cancelAnimationFrame,\n                undefined,\n                // (cancelled: boolean) => {\n                //     debug(cancelled);\n                // },\n                targetProp,\n                animationTime,\n                targetObj,\n                offset,\n                win.requestAnimationFrame,\n                easings.easeInOutQuad,\n            );\n        }\n        // span.focus();\n        // span.scrollIntoView({\n        //     // TypeScript lib.dom.d.ts difference in 3.2.1\n        //     // ScrollBehavior = \"auto\" | \"instant\" | \"smooth\" VS ScrollBehavior = \"auto\" | \"smooth\"\n        //     behavior: \"auto\",\n        //     // ScrollLogicalPosition = \"start\" | \"center\" | \"end\" | \"nearest\"\n        //     block: \"center\",\n        //     // ScrollLogicalPosition = \"start\" | \"center\" | \"end\" | \"nearest\"\n        //     inline: \"nearest\",\n        // } as ScrollIntoViewOptions);\n    }\n}\n\nconst R2_DATA_ATTR_UTTERANCE_INDEX = \"data-r2-tts-utterance-index\";\n\nfunction updateTTSInfo(\n    // ttsQueueItemPreview: ITtsQueueItemReference | undefined,\n    charIndex: number,\n    charLength: number,\n    utteranceText: string | undefined): string | undefined {\n\n    if (!_dialogState || !_dialogState.hasAttribute(\"open\") || !_dialogState.domText ||\n        !_dialogState.ttsQueue || !_dialogState.ttsQueueItem) {\n        return undefined;\n    }\n\n    const ttsQueueItem = _dialogState.ttsQueueItem;\n    if (!ttsQueueItem) {\n        return undefined;\n    }\n\n    const isWordBoundary = charIndex >= 0 && utteranceText;\n\n    if (_dialogState.ttsOverlayEnabled &&\n        !isWordBoundary &&\n        _dialogState.focusScrollRaw &&\n        ttsQueueItem.item.parentElement) {\n\n        // let domRect: DOMRect | undefined;\n        // if (ttsQueueItem.item.textNodes && ttsQueueItem.item.textNodes.length) {\n        //     const txtNode = ttsQueueItem.item.textNodes[0];\n        //     const range = new Range(); // documant.createRange();\n        //     try {\n        //         range.selectNode(txtNode);\n        //         domRect = range.getBoundingClientRect();\n        //         range.detach();\n        //     } catch (err) {\n        //         console.log(err);\n        //     }\n        // }\n        _dialogState.focusScrollRaw(ttsQueueItem.item.parentElement as HTMLElement, false, true, undefined); // domRect\n    }\n\n    const ttsQueueItemText = utteranceText ? utteranceText : getTtsQueueItemRefText(ttsQueueItem);\n\n    let ttsQueueItemMarkup = ttsQueueItemText;\n\n    if (charIndex >= 0 && utteranceText) { // isWordBoundary\n        const start = utteranceText.slice(0, charIndex + 1).search(/\\S+$/);\n        const right = utteranceText.slice(charIndex).search(/\\s/);\n        const word = right < 0 ? utteranceText.slice(start) : utteranceText.slice(start, right + charIndex);\n        const end = start + word.length;\n        // debug(word);\n\n        if (_dialogState && _dialogState.ttsOverlayEnabled) {\n            const prefix = `<span id=\"${TTS_ID_ACTIVE_WORD}\">`;\n            const suffix = \"</span>\";\n\n            const before = utteranceText.substr(0, start);\n            const after = utteranceText.substr(end);\n            const l = before.length + word.length + after.length;\n            ttsQueueItemMarkup = (l === utteranceText.length) ?\n                `${normalizeHtmlText(before)}${prefix}${normalizeHtmlText(word)}${suffix}${normalizeHtmlText(after)}` :\n                normalizeHtmlText(utteranceText);\n        } else {\n            // tslint:disable-next-line:max-line-length\n            wrapHighlightWord(ttsQueueItem, utteranceText, charIndex, charLength, word, start, end);\n        }\n    }\n\n    if (!(_dialogState && _dialogState.ttsOverlayEnabled)) {\n        return ttsQueueItemText;\n    }\n\n    let activeUtteranceElem = _dialogState.domText.ownerDocument ?\n        _dialogState.domText.ownerDocument.getElementById(TTS_ID_ACTIVE_UTTERANCE) :\n        _dialogState.domText.querySelector(`#${TTS_ID_ACTIVE_UTTERANCE}`);\n    if (activeUtteranceElem) {\n        const indexStr = activeUtteranceElem.getAttribute(R2_DATA_ATTR_UTTERANCE_INDEX);\n        if (indexStr && indexStr !== `${ttsQueueItem.iGlobal}`) {\n            activeUtteranceElem.removeAttribute(\"id\");\n            const activeWordElem = activeUtteranceElem.ownerDocument ?\n                activeUtteranceElem.ownerDocument.getElementById(TTS_ID_ACTIVE_WORD) :\n                activeUtteranceElem.querySelector(`#${TTS_ID_ACTIVE_WORD}`);\n            if (activeWordElem) {\n                const index = parseInt(indexStr, 10);\n                if (!isNaN(index)) {\n                    const ttsQItem = getTtsQueueItemRef(_dialogState.ttsQueue, index);\n                    if (ttsQItem) {\n                        const txt = getTtsQueueItemRefText(ttsQItem);\n                        try {\n                            activeUtteranceElem.innerHTML = normalizeHtmlText(txt);\n                        } catch (err) {\n                            console.log(err);\n                            console.log(txt);\n                            activeUtteranceElem.innerHTML = \"txt\";\n                        }\n                    }\n                }\n            }\n\n            activeUtteranceElem = _dialogState.domText.querySelector(\n                `[${R2_DATA_ATTR_UTTERANCE_INDEX}=\"${ttsQueueItem.iGlobal}\"]`);\n            if (activeUtteranceElem) {\n                activeUtteranceElem.setAttribute(\"id\", TTS_ID_ACTIVE_UTTERANCE);\n            }\n        }\n        if (activeUtteranceElem) {\n            try {\n                activeUtteranceElem.innerHTML = ttsQueueItemMarkup;\n            } catch (err) {\n                console.log(err);\n                console.log(ttsQueueItemMarkup);\n                activeUtteranceElem.innerHTML = \"ttsQueueItemMarkup\";\n            }\n        }\n    } else {\n        let fullMarkup = \"\";\n        for (let i = 0; i < _dialogState.ttsQueueLength; i++) {\n            const ttsQItem = getTtsQueueItemRef(_dialogState.ttsQueue, i);\n            if (!ttsQItem) {\n                continue;\n            }\n            let ttsQItemMarkup = ttsQueueItemMarkup;\n\n            let isHeadingLevel1 = false;\n            let isHeadingLevel2 = false;\n            let isHeadingLevel3 = false;\n            let isHeadingLevel4 = false;\n            let isHeadingLevel5 = false;\n            let p: Element | null = ttsQItem.item.parentElement;\n            while (p && p.tagName) {\n                const tagName = p.tagName.toLowerCase();\n                if (tagName === \"h1\") {\n                    isHeadingLevel1 = true;\n                    break;\n                } else if (tagName === \"h2\") {\n                    isHeadingLevel2 = true;\n                    break;\n                } else if (tagName === \"h3\") {\n                    isHeadingLevel3 = true;\n                    break;\n                } else if (tagName === \"h4\") {\n                    isHeadingLevel4 = true;\n                    break;\n                } else if (tagName === \"h5\") {\n                    isHeadingLevel5 = true;\n                    break;\n                }\n                p = p.parentNode as (Element | null);\n            }\n            const classes = TTS_CLASS_UTTERANCE +\n                (isHeadingLevel1 ? ` ${TTS_CLASS_UTTERANCE_HEADING1}` :\n                    (isHeadingLevel2 ? ` ${TTS_CLASS_UTTERANCE_HEADING2}` :\n                        (isHeadingLevel3 ? ` ${TTS_CLASS_UTTERANCE_HEADING3}` :\n                            (isHeadingLevel4 ? ` ${TTS_CLASS_UTTERANCE_HEADING4}` :\n                                (isHeadingLevel5 ? ` ${TTS_CLASS_UTTERANCE_HEADING5}` : \"\")))));\n\n            // tslint:disable-next-line:max-line-length\n            let ttsQItemMarkupAttributes = `${R2_DATA_ATTR_UTTERANCE_INDEX}=\"${ttsQItem.iGlobal}\" class=\"${classes}\"`;\n            if (ttsQItem.iGlobal === ttsQueueItem.iGlobal) {\n                ttsQItemMarkupAttributes += ` id=\"${TTS_ID_ACTIVE_UTTERANCE}\" `;\n            } else {\n                ttsQItemMarkup = normalizeHtmlText(getTtsQueueItemRefText(ttsQItem));\n            }\n            let imageMarkup = \"\";\n            if (ttsQItem.item.parentElement && ttsQItem.item.parentElement.tagName &&\n                ttsQItem.item.parentElement.tagName.toLowerCase() === \"img\" &&\n                (ttsQItem.item.parentElement as HTMLImageElement).src) {\n\n                imageMarkup = `<img src=\"${(ttsQItem.item.parentElement as HTMLImageElement).src}\" />`;\n            }\n            if (ttsQItem.item.parentElement && ttsQItem.item.parentElement.tagName &&\n                ttsQItem.item.parentElement.tagName.toLowerCase() === \"svg\") {\n\n                imageMarkup = ttsQItem.item.parentElement.outerHTML;\n            }\n            if (ttsQItem.item.dir) {\n                ttsQItemMarkupAttributes += ` dir=\"${ttsQItem.item.dir}\" `;\n            }\n            if (ttsQItem.item.lang) {\n                ttsQItemMarkupAttributes += ` lang=\"${ttsQItem.item.lang}\" xml:lang=\"${ttsQItem.item.lang}\" `;\n            }\n            fullMarkup += `${imageMarkup}<div ${ttsQItemMarkupAttributes}>${ttsQItemMarkup}</div>`;\n        }\n\n        try {\n            _dialogState.domText.insertAdjacentHTML(\"beforeend\", fullMarkup);\n        } catch (err) {\n            console.log(err);\n            console.log(fullMarkup);\n            try {\n                _dialogState.domText.innerHTML = fullMarkup;\n            } catch (err) {\n                console.log(err);\n                console.log(fullMarkup);\n                _dialogState.domText.innerHTML = \"fullMarkup\";\n            }\n        }\n    }\n\n    // if (!isWordBoundary) {\n    //     if (_dialogState.domInfo) {\n    //         _dialogState.domInfo.innerText = (ttsQueueItem.iGlobal + 1) + \"/\" + _dialogState.ttsQueueLength;\n    //     }\n    // }\n\n    scrollIntoViewSpokenTextDebounced(isWordBoundary ? TTS_ID_ACTIVE_WORD : TTS_ID_ACTIVE_UTTERANCE);\n\n    return ttsQueueItemText;\n}\n\nconst ttsPlayQueueIndexDebounced = debounce((ttsQueueIndex: number) => {\n    ttsPlayQueueIndex(ttsQueueIndex);\n}, 150);\n\nexport function ttsPlayQueueIndex(ttsQueueIndex: number) {\n\n    if (!_dialogState ||\n        !_dialogState.ttsRootElement ||\n        !_dialogState.focusScrollRaw ||\n        !_dialogState.ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable ||\n        !_dialogState.ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable ||\n        !_dialogState.ttsQueue ||\n        !_dialogState.hasAttribute(\"open\")) {\n        ttsStop();\n        return;\n    }\n\n    _dialogState.ttsQueueItem = undefined;\n    _dialogState.ttsUtterance = undefined;\n\n    if (_dialogState.domSlider) {\n        // _dialogState.domSlider.value = \"\" + ttsQueueIndex;\n        _dialogState.domSlider.valueAsNumber = ttsQueueIndex;\n    }\n\n    if (ttsQueueIndex < 0) {\n        ttsStop();\n        return;\n    }\n    if (ttsQueueIndex >= _dialogState.ttsQueueLength) {\n        ttsStop();\n\n        setTimeout(() => {\n            ipcRenderer.sendToHost(R2_EVENT_TTS_DOC_END);\n            // const payload: IEventPayload_R2_EVENT_PAGE_TURN = {\n            //     direction: \"LTR\",\n            //     go: \"NEXT\",\n            // };\n            // ipcRenderer.sendToHost(R2_EVENT_PAGE_TURN_RES, payload);\n        }, 400);\n\n        return;\n    }\n    const ttsQueueItem = getTtsQueueItemRef(_dialogState.ttsQueue, ttsQueueIndex);\n    if (!ttsQueueItem) {\n        ttsStop();\n        return;\n    }\n    _dialogState.ttsQueueItem = ttsQueueItem;\n\n    highlights(true);\n\n    const txtStr = updateTTSInfo(-1, -1, undefined);\n    if (!txtStr) {\n        ttsStop();\n        return;\n    }\n\n    const utterance = new SpeechSynthesisUtterance(txtStr);\n    _dialogState.ttsUtterance = utterance;\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    (utterance as any).r2_ttsQueueIndex = ttsQueueIndex;\n\n    // TODO:\n    // utterance.voice\n    // utterance.rate\n    // utterance.pitch\n    // utterance.volume\n    if (_dialogState.ttsQueueItem.item.lang) {\n        utterance.lang = _dialogState.ttsQueueItem.item.lang;\n    }\n    if (win.READIUM2.ttsPlaybackRate >= 0.1 && win.READIUM2.ttsPlaybackRate <= 10) {\n        utterance.rate = win.READIUM2.ttsPlaybackRate;\n    }\n\n    utterance.voice = speechSynthesis.getVoices().find((voice) => {\n        // exact match\n        // tslint:disable-next-line:max-line-length\n        return win.READIUM2.ttsVoice && (voice.name === win.READIUM2.ttsVoice.name && voice.lang === win.READIUM2.ttsVoice.lang && voice.voiceURI === win.READIUM2.ttsVoice.voiceURI && voice.default === win.READIUM2.ttsVoice.default && voice.localService === win.READIUM2.ttsVoice.localService);\n    }) || null;\n\n    utterance.onboundary = (ev: SpeechSynthesisEvent) => {\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        if ((utterance as any).r2_cancel) {\n            return;\n        }\n        if (!_dialogState || !_dialogState.ttsQueueItem) {\n            return;\n        }\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        if ((utterance as any).r2_ttsQueueIndex !== _dialogState.ttsQueueItem.iGlobal) {\n            return;\n        }\n\n        if (ev.name !== \"word\") {\n            return;\n        }\n\n        updateTTSInfo(ev.charIndex, ev.charLength, utterance.text);\n    };\n\n    utterance.onend = (_ev: SpeechSynthesisEvent) => {\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        if ((utterance as any).r2_cancel) {\n            return;\n        }\n        if (!_dialogState || !_dialogState.ttsQueueItem) {\n            return;\n        }\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        if ((utterance as any).r2_ttsQueueIndex !== _dialogState.ttsQueueItem.iGlobal) {\n            return;\n        }\n\n        highlights(false);\n\n        ttsPlayQueueIndexDebounced(ttsQueueIndex + 1);\n    };\n\n    _resumableState = {\n        ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable:\n            _dialogState.ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable,\n        ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable:\n            _dialogState.ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable,\n        focusScrollRaw: _dialogState.focusScrollRaw,\n        ttsQueue: _dialogState.ttsQueue,\n        ttsQueueIndex: _dialogState.ttsQueueItem.iGlobal, // ttsQueueIndex\n        ttsRootElement: _dialogState.ttsRootElement,\n    };\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    (utterance as any).r2_cancel = false;\n    setTimeout(() => {\n        win.speechSynthesis.speak(utterance);\n    }, 0);\n\n    if (_dialogState && _dialogState.ttsOverlayEnabled) {\n        win.document.documentElement.classList.add(TTS_CLASS_IS_ACTIVE);\n    }\n    ipcRenderer.sendToHost(R2_EVENT_TTS_IS_PLAYING);\n}\n\nfunction startTTSSession(\n    speed: number,\n    voice: SpeechSynthesisVoice | null,\n    ttsRootElement: Element,\n    ttsQueue: ITtsQueueItem[],\n    ttsQueueIndexStart: number,\n    focusScrollRaw:\n        (el: HTMLOrSVGElement, doFocus: boolean, animate: boolean, domRect: DOMRect | undefined) => void,\n    ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable: () => number,\n    ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable: (val: number) => void,\n) {\n    win.READIUM2.ttsPlaybackRate = speed;\n    win.READIUM2.ttsVoice = voice;\n\n    const ttsQueueItemStart = getTtsQueueItemRef(ttsQueue, ttsQueueIndexStart);\n    if (!ttsQueueItemStart) {\n        ttsStop();\n        return;\n    }\n    const ttsQueueLength = getTtsQueueLength(ttsQueue);\n\n    // TODO: SSML?\n    // https://github.com/guest271314/SpeechSynthesisSSMLParser\n    // speechApiTxt = `<?xml version=\"1.0\" encoding=\"utf-8\"?>\n    //     <speak version=\"1.1\" xmlns=\"http://www.w3.org/2001/10/synthesis\"\n    //     xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n    //     xsi:schemaLocation=\"http://www.w3.org/2001/10/synthesis\n    //                         http://www.w3.org/TR/speech-synthesis/synthesis.xsd\"\n    //     xml:lang=\"${language}\">${txt}</speak>`;\n\n    const val = win.READIUM2.ttsOverlayEnabled ? ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable() : undefined;\n\n    function onDialogClosed(el: HTMLOrSVGElement | null) {\n        ttsPause();\n\n        if (_dialogState && _dialogState.focusScrollRaw) {\n            let toScrollTo = el;\n            if (_dialogState.ttsQueueItem && _dialogState.ttsQueueItem.item.parentElement) {\n                toScrollTo = _dialogState.ttsQueueItem.item.parentElement as HTMLElement;\n            }\n            if (toScrollTo && _dialogState.ttsOverlayEnabled) {\n                _dialogState.focusScrollRaw(toScrollTo, false, true, undefined);\n            } else if (typeof val !== \"undefined\") {\n                ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable(val);\n            }\n        }\n\n        setTimeout(() => {\n            resetState();\n        }, 50);\n    }\n\n    // &#x21E0;\n    // &#x21E2;\n    const outerHTML =\n        `<div id=\"${TTS_ID_CONTAINER}\"\n    class=\"${CSS_CLASS_NO_FOCUS_OUTLINE} ${TTS_CLASS_THEME1}\"\n    dir=\"ltr\"\n    lang=\"en\"\n    xml:lang=\"en\"\n    tabindex=\"0\" autofocus=\"autofocus\"></div>\n${win.READIUM2.ttsOverlayEnabled ?\n            `\n<button id=\"${TTS_ID_PREVIOUS}\" class=\"${TTS_NAV_BUTTON_CLASS}\" title=\"previous\"><span>&#9668;</span></button>\n<button id=\"${TTS_ID_NEXT}\" class=\"${TTS_NAV_BUTTON_CLASS}\" title=\"next\"><span>&#9658;</span></button>\n<input id=\"${TTS_ID_SLIDER}\" type=\"range\" min=\"0\" max=\"${ttsQueueLength - 1}\" value=\"0\"\n    ${isRTL() ? \"dir=\\\"rtl\\\"\" : \"dir=\\\"ltr\\\"\"}  title=\"progress\"/>\n`\n            : \"\"}\n`;\n\n    const pop = new PopupDialog(\n        win.document,\n        outerHTML,\n        onDialogClosed,\n        `${TTS_POPUP_DIALOG_CLASS}${win.READIUM2.ttsOverlayEnabled ? \"\" : ` ${POPUP_DIALOG_CLASS_COLLAPSE}`}`,\n        true);\n    pop.show(ttsQueueItemStart.item.parentElement);\n\n    _dialogState = pop.dialog as IHTMLDialogElementWithTTSState;\n    if (!_dialogState) {\n        return;\n    }\n    _dialogState.ttsOverlayEnabled = win.READIUM2.ttsOverlayEnabled;\n\n    _dialogState.focusScrollRaw = focusScrollRaw;\n    _dialogState.ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable =\n        ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable;\n    _dialogState.ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable =\n        ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable;\n\n    _dialogState.ttsRootElement = ttsRootElement;\n\n    _dialogState.domSlider = win.document.getElementById(TTS_ID_SLIDER) as HTMLInputElement;\n    _dialogState.domPrevious = win.document.getElementById(TTS_ID_PREVIOUS) as HTMLButtonElement;\n    _dialogState.domNext = win.document.getElementById(TTS_ID_NEXT) as HTMLButtonElement;\n    _dialogState.domText = win.document.getElementById(TTS_ID_CONTAINER) as HTMLDivElement;\n\n    _dialogState.ttsQueue = ttsQueue;\n    _dialogState.ttsQueueLength = ttsQueueLength;\n\n    if (_dialogState.domSlider) {\n        _dialogState.domSlider.addEventListener(\"input\", (_ev: Event) => {\n            if (_dialogState && _dialogState.domSlider) {\n                // const n = parseInt(_dialogState.domSlider.value, 10);\n                const n = _dialogState.domSlider.valueAsNumber;\n\n                ttsPreviewAndEventuallyPlayQueueIndex(n);\n            }\n        });\n    }\n\n    if (_dialogState.domPrevious) {\n        _dialogState.domPrevious.addEventListener(\"click\", (ev: MouseEvent) => {\n\n            const skipSentences = ev.shiftKey && ev.altKey;\n            if (isRTL()) {\n                ttsNext(skipSentences);\n            } else {\n                ttsPrevious(skipSentences);\n            }\n        });\n    }\n    if (_dialogState.domNext) {\n        _dialogState.domNext.addEventListener(\"click\", (ev: MouseEvent) => {\n\n            const skipSentences = ev.shiftKey && ev.altKey;\n            if (!isRTL()) {\n                ttsNext(skipSentences);\n            } else {\n                ttsPrevious(skipSentences);\n            }\n        });\n    }\n\n    if (_dialogState.domText) {\n        _dialogState.domText.addEventListener(\"click\", (ev: MouseEvent) => {\n            if (ev.target && _dialogState && _dialogState.ttsQueue && _dialogState.ttsQueueItem) {\n                const indexStr = (ev.target as Element).getAttribute(R2_DATA_ATTR_UTTERANCE_INDEX);\n                if (indexStr) {\n                    const index = parseInt(indexStr, 10);\n                    if (!isNaN(index)) {\n                        const ttsQItem = getTtsQueueItemRef(_dialogState.ttsQueue, index);\n                        if (ttsQItem) {\n                            if (ttsQItem.iGlobal !== _dialogState.ttsQueueItem.iGlobal) {\n                                ttsPause();\n                                ttsPlayQueueIndexDebounced(index);\n                                return;\n                            }\n                        }\n                    }\n                }\n            }\n\n            ttsPauseOrResume();\n        });\n    }\n\n    ttsPlayQueueIndexDebounced(ttsQueueIndexStart);\n}\n"]}