{"version":3,"file":"readaloud.js","sourceRoot":"","sources":["../../../../../../src/electron/renderer/webview/readaloud.ts"],"names":[],"mappings":"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","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport { debounce } from \"debounce\";\nimport { ipcRenderer } from \"electron\";\n\nimport {\n    R2_EVENT_TTS_IS_PAUSED,\n    R2_EVENT_TTS_IS_PLAYING,\n    R2_EVENT_TTS_IS_STOPPED,\n} from \"../../common/events\";\nimport {\n    CSS_CLASS_NO_FOCUS_OUTLINE,\n    TTS_CLASS_INJECTED_SPAN,\n    TTS_CLASS_INJECTED_SUBSPAN,\n    TTS_ID_ACTIVE_WORD,\n    TTS_ID_CONTAINER,\n    TTS_ID_INFO,\n    TTS_ID_INJECTED_PARENT,\n    TTS_ID_NEXT,\n    TTS_ID_PREVIOUS,\n    TTS_ID_SLIDER,\n    TTS_ID_SPEAKING_DOC_ELEMENT,\n    TTS_NAV_BUTTON_CLASS,\n} from \"../../common/styles\";\nimport {\n    ITtsQueueItem,\n    ITtsQueueItemReference,\n    findTtsQueueItemIndex,\n    generateTtsQueue,\n    getTtsQueueItemRef,\n    getTtsQueueItemRefText,\n    getTtsQueueLength,\n    wrapHighlight,\n} from \"../common/dom-text-utils\";\nimport { IHTMLDialogElementWithPopup, PopupDialog } from \"../common/popup-dialog\";\nimport { IReadiumElectronWebviewWindow } from \"./state\";\n\nconst win = (global as any).window as IReadiumElectronWebviewWindow;\n\ninterface IHTMLDialogElementWithTTSState extends IHTMLDialogElementWithPopup {\n\n    domSlider: HTMLInputElement | undefined;\n    domNext: HTMLButtonElement | undefined;\n    domPrevious: HTMLButtonElement | undefined;\n    domText: HTMLDivElement | undefined;\n    domInfo: HTMLDivElement | undefined;\n\n    ttsUtterance: SpeechSynthesisUtterance | undefined;\n    ttsQueue: ITtsQueueItem[] | undefined;\n    ttsQueueLength: number; // index by ITtsQueueItemReference.iGlobal\n    ttsQueueItem: ITtsQueueItemReference | undefined;\n\n    ttsRootElement: Element | undefined;\n\n    focusScrollRaw: ((el: HTMLOrSVGElement, doFocus: boolean) => void) | undefined;\n\n    ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable: (() => number) | undefined;\n    ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable: ((val: number) => void) | undefined;\n}\n\nlet _dialogState: IHTMLDialogElementWithTTSState | undefined;\n\nfunction resetState() {\n    _resumableState = undefined;\n\n    if (_dialogState) {\n        _dialogState.popDialog = undefined;\n        _dialogState.focusScrollRaw = undefined;\n        _dialogState.ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable = undefined;\n        _dialogState.ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable = undefined;\n\n        _dialogState.ttsRootElement = undefined;\n        _dialogState.ttsQueue = undefined;\n        _dialogState.ttsQueueLength = -1;\n        _dialogState.ttsUtterance = undefined;\n        _dialogState.ttsQueueItem = undefined;\n\n        _dialogState.domSlider = undefined;\n        _dialogState.domNext = undefined;\n        _dialogState.domPrevious = undefined;\n        _dialogState.domText = undefined;\n        _dialogState.domInfo = undefined;\n\n        _dialogState.remove();\n    }\n    _dialogState = undefined;\n\n    ipcRenderer.sendToHost(R2_EVENT_TTS_IS_STOPPED);\n}\n\nexport function ttsPlay(\n    focusScrollRaw: (el: HTMLOrSVGElement, doFocus: boolean) => void,\n    rootElem: Element | undefined,\n    startElem: Element | undefined,\n    ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable: () => number,\n    ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable: (val: number) => void,\n    ) {\n\n    ttsStop();\n\n    let rootEl = rootElem;\n\n    if (!rootEl) {\n        rootEl = win.document.body;\n    }\n\n    const ttsQueue = generateTtsQueue(rootEl);\n    if (!ttsQueue.length) {\n        return;\n    }\n\n    let ttsQueueIndex = -1;\n    if (startElem) {\n        const idx = findTtsQueueItemIndex(ttsQueue, startElem, rootEl);\n        if (idx >= 0) {\n            ttsQueueIndex = idx;\n        }\n    }\n    if (ttsQueueIndex < 0) {\n        ttsQueueIndex = 0;\n    }\n    setTimeout(() => {\n        startTTSSession(\n            rootEl as Element,\n            ttsQueue,\n            ttsQueueIndex,\n            focusScrollRaw,\n            ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable,\n            ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable);\n    }, 100);\n}\n\nexport function ttsStop() {\n    if (_dialogState) {\n        if (_dialogState.hasAttribute(\"open\")) {\n            _dialogState.close(); // => onDialogClosed()\n            return;\n        }\n    }\n    ttsPause();\n    resetState();\n}\n\nlet _doNotProcessNextQueueItemOnUtteranceEnd = false;\n\nexport function ttsPause() {\n\n    highlights(false);\n\n    // can actually be in paused state!\n    if (win.speechSynthesis.speaking) {\n        // if (win.speechSynthesis.paused) {\n        //     console.log(\"resume\");\n        //     win.speechSynthesis.resume();\n        // } else {\n        //     console.log(\"pause\");\n        //     win.speechSynthesis.pause(); // doesn't seem to work!\n        // }\n\n        // make sure the playback state machine doesn't move to the next utterance.\n        _doNotProcessNextQueueItemOnUtteranceEnd = true; // add/removeEventListener(\"end\") does not work.\n\n        setTimeout(() => {\n            win.speechSynthesis.cancel();\n        }, 0);\n    } else if (win.speechSynthesis.pending) {\n        // we only queue a single utterance, so this isn't really needed.\n        setTimeout(() => {\n            win.speechSynthesis.cancel();\n        }, 0);\n    }\n\n    ipcRenderer.sendToHost(R2_EVENT_TTS_IS_PAUSED);\n}\n\ninterface IResumableState {\n    ttsRootElement: Element;\n    ttsQueue: ITtsQueueItem[];\n    ttsQueueIndex: number;\n    focusScrollRaw: ((el: HTMLOrSVGElement, doFocus: boolean) => void);\n    ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable: (() => number);\n    ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable: ((val: number) => void);\n}\nlet _resumableState: IResumableState | undefined;\n\nexport function ttsResume() {\n\n    if (_dialogState &&\n        _dialogState.ttsUtterance) {\n        highlights(true);\n\n        setTimeout(() => {\n            if (_dialogState &&\n                _dialogState.ttsUtterance) {\n                win.speechSynthesis.speak(_dialogState.ttsUtterance);\n            }\n        }, 0);\n\n        ipcRenderer.sendToHost(R2_EVENT_TTS_IS_PLAYING);\n    } else if (_resumableState) {\n        setTimeout(() => {\n            if (_resumableState) {\n                startTTSSession(\n                    _resumableState.ttsRootElement,\n                    _resumableState.ttsQueue,\n                    _resumableState.ttsQueueIndex,\n                    _resumableState.focusScrollRaw,\n                    _resumableState.ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable,\n                    _resumableState.ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable);\n            }\n        }, 100);\n    }\n}\n\nexport function isTtsPlaying() {\n    return isTtsActive() && !win.speechSynthesis.paused;\n}\n\nexport function isTtsActive() {\n    if (_dialogState && _dialogState.hasAttribute(\"open\") &&\n        (win.speechSynthesis.speaking || win.speechSynthesis.pending)) {\n        return true;\n    }\n    return false;\n}\n\nexport function ttsPauseOrResume() {\n    if (isTtsPlaying()) {\n        ttsPause();\n    } else {\n        ttsResume();\n    }\n}\n\nexport function ttsQueueSize(): number {\n    if (_dialogState && _dialogState.ttsQueue) {\n        getTtsQueueLength(_dialogState.ttsQueue);\n    }\n    return -1;\n}\nexport function ttsQueueCurrentIndex(): number {\n    if (_dialogState && _dialogState.ttsQueueItem) {\n        return _dialogState.ttsQueueItem.iGlobal;\n    }\n    return -1;\n}\nexport function ttsQueueCurrentText(): string | undefined {\n    if (_dialogState && _dialogState.ttsQueueItem) {\n        return getTtsQueueItemRefText(_dialogState.ttsQueueItem);\n    }\n    return undefined;\n}\n\nexport function ttsNext() {\n    if (_dialogState && _dialogState.ttsQueueItem) {\n        const j = _dialogState.ttsQueueItem.iGlobal + 1;\n        if (j >= _dialogState.ttsQueueLength || j < 0) {\n            return;\n        }\n        ttsPause();\n        ttsPlayQueueIndexDebounced(j);\n    }\n}\nexport function ttsPrevious() {\n    if (_dialogState && _dialogState.ttsQueueItem) {\n        const j = _dialogState.ttsQueueItem.iGlobal - 1;\n        if (j >= _dialogState.ttsQueueLength || j < 0) {\n            return;\n        }\n        ttsPause();\n        ttsPlayQueueIndexDebounced(j);\n    }\n}\n\nexport function ttsPreviewAndEventuallyPlayQueueIndex(n: number) {\n\n    ttsPause();\n\n    if (_dialogState && _dialogState.ttsQueue) {\n\n        updateTTSInfo(getTtsQueueItemRef(_dialogState.ttsQueue, n));\n    }\n\n    ttsPlayQueueIndexDebouncedMore(n);\n}\n\nfunction highlights(doHighlight: boolean) {\n\n    if (!_dialogState) {\n        return;\n    }\n    if (typeof (_dialogState as any).FALSY_TO_DISABLE_HIGHLIGHTS === \"undefined\") {\n        return;\n    }\n    if (doHighlight) {\n        if (_dialogState.ttsQueueItem) {\n            // tslint:disable-next-line:max-line-length\n            wrapHighlight(true, _dialogState.ttsQueueItem, TTS_ID_INJECTED_PARENT, TTS_CLASS_INJECTED_SPAN, TTS_CLASS_INJECTED_SUBSPAN, undefined, -1, -1);\n        }\n        if (_dialogState.ttsRootElement) {\n            _dialogState.ttsRootElement.classList.add(TTS_ID_SPEAKING_DOC_ELEMENT);\n        }\n    } else {\n        if (_dialogState.ttsQueueItem) {\n            // tslint:disable-next-line:max-line-length\n            wrapHighlight(false, _dialogState.ttsQueueItem, TTS_ID_INJECTED_PARENT, TTS_CLASS_INJECTED_SPAN, TTS_CLASS_INJECTED_SUBSPAN, undefined, -1, -1);\n        }\n        if (_dialogState.ttsRootElement) {\n            _dialogState.ttsRootElement.classList.remove(TTS_ID_SPEAKING_DOC_ELEMENT);\n        }\n    }\n}\n\nfunction handleWordBoundary(utteranceText: string, charIndex: number) {\n\n    if (!_dialogState || !_dialogState.hasAttribute(\"open\") || !_dialogState.domText || !_dialogState.ttsQueueItem) {\n        return;\n    }\n\n    const text = utteranceText;\n    const start = text.slice(0, charIndex + 1).search(/\\S+$/);\n    const right = text.slice(charIndex).search(/\\s/);\n    const word = right < 0 ? text.slice(start) : text.slice(start, right + charIndex);\n    const end = start + word.length;\n    // debug(word);\n\n    const prefix = `<span id=\"${TTS_ID_ACTIVE_WORD}\">`;\n    const suffix = \"</span>\";\n\n    const before = text.substr(0, start);\n    const after = text.substr(end);\n    const l = before.length + word.length + after.length;\n    const innerHTML = (l === text.length) ? `${before}${prefix}${word}${suffix}${after}` : text;\n\n    try {\n        _dialogState.domText.innerHTML = innerHTML;\n    } catch (err) {\n        console.log(err);\n        console.log(innerHTML);\n        _dialogState.domText.innerHTML = \"...\";\n    }\n\n    // tslint:disable-next-line:max-line-length\n    wrapHighlight(true, _dialogState.ttsQueueItem, TTS_ID_INJECTED_PARENT, TTS_CLASS_INJECTED_SPAN, TTS_CLASS_INJECTED_SUBSPAN, word, start, end);\n\n    setTimeout(() => {\n        scrollIntoViewSpokenText();\n    }, 80);\n}\n\nfunction scrollIntoViewSpokenText() {\n\n    const span = win.document.getElementById(TTS_ID_ACTIVE_WORD) as HTMLElement;\n    if (span && _dialogState && _dialogState.domText) {\n        const rect = span.getBoundingClientRect();\n        const rect2 = _dialogState.domText.getBoundingClientRect();\n        const scrollTopMax = _dialogState.domText.scrollHeight - _dialogState.domText.clientHeight;\n        let offset = _dialogState.domText.scrollTop + (rect.top - rect2.top - (_dialogState.domText.clientHeight / 2));\n        if (offset > scrollTopMax) {\n            offset = scrollTopMax;\n        } else if (offset < 0) {\n            offset = 0;\n        }\n        _dialogState.domText.scrollTop = offset;\n\n        // span.focus();\n        // span.scrollIntoView({\n        //     // TypeScript lib.dom.d.ts difference in 3.2.1\n        //     // ScrollBehavior = \"auto\" | \"instant\" | \"smooth\" VS ScrollBehavior = \"auto\" | \"smooth\"\n        //     behavior: \"auto\",\n        //     // ScrollLogicalPosition = \"start\" | \"center\" | \"end\" | \"nearest\"\n        //     block: \"center\",\n        //     // ScrollLogicalPosition = \"start\" | \"center\" | \"end\" | \"nearest\"\n        //     inline: \"nearest\",\n        // } as ScrollIntoViewOptions);\n    }\n}\n\nfunction updateTTSInfo(ttsQueueItem: ITtsQueueItemReference | undefined): string | undefined {\n\n    if (!_dialogState || !ttsQueueItem) {\n        return undefined;\n    }\n\n    if (_dialogState.focusScrollRaw && ttsQueueItem.item.parentElement) {\n        _dialogState.focusScrollRaw(ttsQueueItem.item.parentElement as HTMLElement, false);\n    }\n\n    const ttsQueueItemText = getTtsQueueItemRefText(ttsQueueItem);\n\n    if (_dialogState.domText) {\n        try {\n            // const prefix = `<span id=\"${TTS_ID_ACTIVE_WORD}\">`;\n            // const suffix = \"</span>\";\n            // _dialogState.domText.innerHTML = prefix + ttsQueueItemText + suffix;\n            _dialogState.domText.innerHTML = ttsQueueItemText;\n        } catch (err) {\n            console.log(err);\n            console.log(ttsQueueItemText);\n            _dialogState.domText.innerHTML = \"...\";\n        }\n        if (ttsQueueItem.item.dir) {\n            _dialogState.domText.setAttribute(\"dir\", ttsQueueItem.item.dir as string);\n        } else {\n            _dialogState.domText.removeAttribute(\"dir\");\n        }\n        if (ttsQueueItem.item.lang) {\n            const str = ttsQueueItem.item.lang as string;\n            _dialogState.domText.setAttribute(\"lang\", str);\n            _dialogState.domText.setAttribute(\"xml:lang\", str);\n            // _dialogState.domText.setAttributeNS(\"http://www.w3.org/XML/1998/\", \"lang\", str);\n        } else {\n            _dialogState.domText.removeAttribute(\"lang\");\n        }\n    }\n    if (_dialogState.domInfo) {\n        _dialogState.domInfo.innerText = (ttsQueueItem.iGlobal + 1) + \"/\" + _dialogState.ttsQueueLength;\n    }\n\n    return ttsQueueItemText;\n}\n\nconst ttsPlayQueueIndexDebounced = debounce((ttsQueueIndex: number) => {\n    ttsPlayQueueIndex(ttsQueueIndex);\n}, 150);\n\nconst ttsPlayQueueIndexDebouncedMore = debounce((ttsQueueIndex: number) => {\n    ttsPlayQueueIndex(ttsQueueIndex);\n}, 300);\n\nexport function ttsPlayQueueIndex(ttsQueueIndex: number) {\n\n    if (!_dialogState ||\n        !_dialogState.ttsRootElement ||\n        !_dialogState.focusScrollRaw ||\n        !_dialogState.ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable ||\n        !_dialogState.ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable ||\n        !_dialogState.ttsQueue ||\n        !_dialogState.hasAttribute(\"open\")) {\n        ttsStop();\n        return;\n    }\n\n    _dialogState.ttsQueueItem = undefined;\n    _dialogState.ttsUtterance = undefined;\n\n    if (_dialogState.domSlider) {\n        _dialogState.domSlider.value = \"\" + ttsQueueIndex;\n    }\n\n    if (ttsQueueIndex >= _dialogState.ttsQueueLength || ttsQueueIndex < 0) {\n        ttsStop();\n        return;\n    }\n    const ttsQueueItem = getTtsQueueItemRef(_dialogState.ttsQueue, ttsQueueIndex);\n    if (!ttsQueueItem) {\n        ttsStop();\n        return;\n    }\n    _dialogState.ttsQueueItem = ttsQueueItem;\n\n    highlights(true);\n\n    const txtStr = updateTTSInfo(_dialogState.ttsQueueItem);\n    if (!txtStr) {\n        ttsStop();\n        return;\n    }\n\n    const utterance = new SpeechSynthesisUtterance(txtStr);\n    _dialogState.ttsUtterance = utterance;\n\n    // TODO:\n    // utterance.voice\n    // utterance.rate\n    // utterance.pitch\n    // utterance.volume\n    if (_dialogState.ttsQueueItem.item.lang) {\n        utterance.lang = _dialogState.ttsQueueItem.item.lang;\n    }\n\n    utterance.onboundary = (ev: SpeechSynthesisEvent) => {\n        if (ev.name !== \"word\") {\n            return;\n        }\n        handleWordBoundary(utterance.text, ev.charIndex);\n    };\n\n    utterance.onend = (_ev: SpeechSynthesisEvent) => {\n\n        highlights(false);\n\n        if (_doNotProcessNextQueueItemOnUtteranceEnd) {\n            _doNotProcessNextQueueItemOnUtteranceEnd = false;\n            return;\n        }\n\n        setTimeout(() => {\n            ttsPlayQueueIndex(ttsQueueIndex + 1);\n        }, 100);\n    };\n\n    _doNotProcessNextQueueItemOnUtteranceEnd = false;\n\n    _resumableState = {\n        ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable:\n            _dialogState.ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable,\n        ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable:\n            _dialogState.ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable,\n        focusScrollRaw: _dialogState.focusScrollRaw,\n        ttsQueue: _dialogState.ttsQueue,\n        ttsQueueIndex: _dialogState.ttsQueueItem.iGlobal,\n        ttsRootElement: _dialogState.ttsRootElement,\n    };\n\n    setTimeout(() => {\n        win.speechSynthesis.speak(utterance);\n    }, 0);\n\n    ipcRenderer.sendToHost(R2_EVENT_TTS_IS_PLAYING);\n}\n\nfunction startTTSSession(\n    ttsRootElement: Element,\n    ttsQueue: ITtsQueueItem[],\n    ttsQueueIndexStart: number,\n    focusScrollRaw: (el: HTMLOrSVGElement, doFocus: boolean) => void,\n    ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable: () => number,\n    ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable: (val: number) => void,\n    ) {\n\n    const ttsQueueItemStart = getTtsQueueItemRef(ttsQueue, ttsQueueIndexStart);\n    if (!ttsQueueItemStart) {\n        ttsStop();\n        return;\n    }\n    const ttsQueueLength = getTtsQueueLength(ttsQueue);\n\n    // TODO: SSML?\n    // https://github.com/guest271314/SpeechSynthesisSSMLParser\n    // speechApiTxt = `<?xml version=\"1.0\" encoding=\"utf-8\"?>\n    //     <speak version=\"1.1\" xmlns=\"http://www.w3.org/2001/10/synthesis\"\n    //     xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n    //     xsi:schemaLocation=\"http://www.w3.org/2001/10/synthesis\n    //                         http://www.w3.org/TR/speech-synthesis/synthesis.xsd\"\n    //     xml:lang=\"${language}\">${txt}</speak>`;\n\n    const val = ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable();\n\n    function onDialogClosed(el: HTMLOrSVGElement | null) {\n        ttsPause();\n\n        if (_dialogState && _dialogState.focusScrollRaw) {\n            let toScrollTo = el;\n            if (_dialogState.ttsQueueItem && _dialogState.ttsQueueItem.item.parentElement) {\n                toScrollTo = _dialogState.ttsQueueItem.item.parentElement as HTMLElement;\n            }\n            if (toScrollTo) {\n                _dialogState.focusScrollRaw(toScrollTo, false);\n            } else {\n                ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable(val);\n            }\n        }\n\n        setTimeout(() => {\n            resetState();\n        }, 50);\n    }\n\n    // &#x21E0;\n    // &#x21E2;\n    const outerHTML =\n    `<div id=\"${TTS_ID_CONTAINER}\"\n        class=\"${CSS_CLASS_NO_FOCUS_OUTLINE}\"\n        dir=\"ltr\"\n        lang=\"en\"\n        xml:lang=\"en\"\n        tabindex=\"0\" autofocus=\"autofocus\">...</div>\n    <div id=\"${TTS_ID_INFO}\"> </div>\n    <button id=\"${TTS_ID_PREVIOUS}\" class=\"${TTS_NAV_BUTTON_CLASS}\"><span>&#9668;</span></button>\n    <button id=\"${TTS_ID_NEXT}\" class=\"${TTS_NAV_BUTTON_CLASS}\"><span>&#9658;</span></button>\n    <input id=\"${TTS_ID_SLIDER}\" type=\"range\" min=\"0\" max=\"${ttsQueueLength - 1}\" value=\"0\" />`;\n\n    const pop = new PopupDialog(win.document, outerHTML, onDialogClosed);\n    pop.show(ttsQueueItemStart.item.parentElement);\n\n    _dialogState = pop.dialog as IHTMLDialogElementWithTTSState;\n    if (!_dialogState) {\n        return;\n    }\n    _dialogState.focusScrollRaw = focusScrollRaw;\n    _dialogState.ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable =\n        ensureTwoPageSpreadWithOddColumnsIsOffsetTempDisable;\n    _dialogState.ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable =\n        ensureTwoPageSpreadWithOddColumnsIsOffsetReEnable;\n\n    _dialogState.ttsRootElement = ttsRootElement;\n\n    _dialogState.domSlider = win.document.getElementById(TTS_ID_SLIDER) as HTMLInputElement;\n    _dialogState.domPrevious = win.document.getElementById(TTS_ID_PREVIOUS) as HTMLButtonElement;\n    _dialogState.domNext = win.document.getElementById(TTS_ID_NEXT) as HTMLButtonElement;\n    _dialogState.domText = win.document.getElementById(TTS_ID_CONTAINER) as HTMLDivElement;\n    _dialogState.domInfo = win.document.getElementById(TTS_ID_INFO) as HTMLDivElement;\n\n    _dialogState.ttsQueue = ttsQueue;\n    _dialogState.ttsQueueLength = ttsQueueLength;\n\n    if (_dialogState.domSlider) {\n        _dialogState.domSlider.addEventListener(\"input\", (_ev: Event) => {\n            if (_dialogState && _dialogState.domSlider) {\n                const n = parseInt(_dialogState.domSlider.value, 10);\n\n                ttsPreviewAndEventuallyPlayQueueIndex(n);\n            }\n        });\n    }\n\n    if (_dialogState.domPrevious) {\n        _dialogState.domPrevious.addEventListener(\"click\", (_ev: MouseEvent) => {\n\n            ttsPrevious();\n        });\n    }\n    if (_dialogState.domNext) {\n        _dialogState.domNext.addEventListener(\"click\", (_ev: MouseEvent) => {\n\n            ttsNext();\n        });\n    }\n\n    if (_dialogState.domText) {\n        _dialogState.domText.addEventListener(\"click\", (_ev: MouseEvent) => {\n            ttsPauseOrResume();\n        });\n    }\n\n    ttsPlayQueueIndex(ttsQueueIndexStart);\n}\n"]}