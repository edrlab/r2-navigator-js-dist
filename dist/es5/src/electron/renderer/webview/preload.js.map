{"version":3,"file":"preload.js","sourceRoot":"","sources":["../../../../../../src/electron/renderer/webview/preload.ts"],"names":[],"mappings":"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","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nconst IS_DEV = (process.env.NODE_ENV === \"development\" || process.env.NODE_ENV === \"dev\");\n\n// import { consoleRedirect } from \"../common/console-redirect\";\nif (IS_DEV) {\n    // tslint:disable-next-line:no-var-requires\n    const cr = require(\"../common/console-redirect\");\n    // const releaseConsoleRedirect =\n    cr.consoleRedirect(\"r2:navigator#electron/renderer/webview/preload\", process.stdout, process.stderr, true);\n}\n\nimport { LocatorLocations } from \"@r2-shared-js/models/locator\";\nimport { debounce } from \"debounce\";\nimport * as debug_ from \"debug\";\nimport { ipcRenderer } from \"electron\";\nimport * as tabbable from \"tabbable\";\n\nimport {\n    IEventPayload_R2_EVENT_LINK,\n    IEventPayload_R2_EVENT_LOCATOR_VISIBLE,\n    IEventPayload_R2_EVENT_PAGE_TURN,\n    IEventPayload_R2_EVENT_READING_LOCATION,\n    IEventPayload_R2_EVENT_READING_LOCATION_PAGINATION_INFO,\n    IEventPayload_R2_EVENT_READIUMCSS,\n    IEventPayload_R2_EVENT_SCROLLTO,\n    IEventPayload_R2_EVENT_SHIFT_VIEW_X,\n    IEventPayload_R2_EVENT_TTS_CLICK_ENABLE,\n    IEventPayload_R2_EVENT_TTS_DO_PLAY,\n    R2_EVENT_DEBUG_VISUALS,\n    R2_EVENT_LINK,\n    R2_EVENT_LOCATOR_VISIBLE,\n    R2_EVENT_PAGE_TURN,\n    R2_EVENT_PAGE_TURN_RES,\n    R2_EVENT_READING_LOCATION,\n    R2_EVENT_READIUMCSS,\n    R2_EVENT_SCROLLTO,\n    R2_EVENT_SHIFT_VIEW_X,\n    R2_EVENT_TTS_CLICK_ENABLE,\n    R2_EVENT_TTS_DO_NEXT,\n    R2_EVENT_TTS_DO_PAUSE,\n    R2_EVENT_TTS_DO_PLAY,\n    R2_EVENT_TTS_DO_PREVIOUS,\n    R2_EVENT_TTS_DO_RESUME,\n    R2_EVENT_TTS_DO_STOP,\n} from \"../../common/events\";\nimport {\n    CLASS_PAGINATED,\n    configureFixedLayout,\n    injectDefaultCSS,\n    injectReadPosCSS,\n    isPaginated,\n} from \"../../common/readium-css-inject\";\nimport {\n    POPUP_DIALOG_CLASS,\n    ROOT_CLASS_INVISIBLE_MASK,\n    ROOT_CLASS_KEYBOARD_INTERACT,\n    ROOT_CLASS_NO_FOOTNOTES,\n    ROOT_CLASS_REDUCE_MOTION,\n    TTS_CLASS_INJECTED_SPAN,\n    TTS_CLASS_INJECTED_SUBSPAN,\n    TTS_ID_INJECTED_PARENT,\n    TTS_ID_SPEAKING_DOC_ELEMENT,\n    readPosCssStylesAttr1,\n    readPosCssStylesAttr2,\n    readPosCssStylesAttr3,\n    readPosCssStylesAttr4,\n} from \"../../common/styles\";\n// import { READIUM2_ELECTRON_HTTP_PROTOCOL } from \"../../common/sessions\";\nimport { IPropertyAnimationState, animateProperty } from \"../common/animateProperty\";\nimport { uniqueCssSelector } from \"../common/cssselector2\";\nimport { easings } from \"../common/easings\";\nimport { closePopupDialogs, isPopupDialogOpen } from \"../common/popup-dialog\";\nimport { getURLQueryParams } from \"../common/querystring\";\nimport {\n    URL_PARAM_CSS,\n    URL_PARAM_DEBUG_VISUALS,\n    URL_PARAM_EPUBREADINGSYSTEM,\n    URL_PARAM_GOTO,\n    URL_PARAM_PREVIOUS,\n} from \"../common/url-params\";\nimport { INameVersion, setWindowNavigatorEpubReadingSystem } from \"./epubReadingSystem\";\nimport { popupFootNote } from \"./popupFootNotes\";\nimport { ttsNext, ttsPause, ttsPlay, ttsPrevious, ttsResume, ttsStop } from \"./readaloud\";\nimport {\n    calculateColumnDimension,\n    calculateMaxScrollShift,\n    calculateTotalColumns,\n    checkHiddenFootNotes,\n    computeVerticalRTL,\n    isRTL,\n    isTwoPageSpread,\n    isVerticalWritingMode,\n    readiumCSS,\n} from \"./readium-css\";\nimport { IElectronWebviewTagWindow } from \"./state\";\n\nimport ResizeSensor = require(\"css-element-queries/src/ResizeSensor\");\n// import ResizeSensor = require(\"resize-sensor/ResizeSensor\");\n\n// import { registerProtocol } from \"@r2-navigator-js/electron/renderer/common/protocol\";\n// registerProtocol();\n\nconst debug = debug_(\"r2:navigator#electron/renderer/webview/preload\");\n\nconst win = (global as any).window as IElectronWebviewTagWindow;\nwin.READIUM2 = {\n    DEBUG_VISUALS: false,\n    // dialogs = [],\n    fxlViewportHeight: 0,\n    fxlViewportWidth: 0,\n    hashElement: null,\n    isFixedLayout: false,\n    locationHashOverride: undefined,\n    locationHashOverrideInfo: {\n        href: \"\",\n        locations: {\n            cfi: undefined,\n            cssSelector: undefined,\n            position: undefined,\n            progression: undefined,\n        },\n        paginationInfo: undefined,\n    },\n    ttsClickEnabled: false,\n    urlQueryParams: undefined,\n};\n\n// const _winAlert = win.alert;\nwin.alert = (...args: any[]) => {\n    console.log.apply(win, args);\n};\n// const _winConfirm = win.confirm;\nwin.confirm = (...args: any[]): boolean => {\n    console.log.apply(win, args);\n    return false;\n};\n// const _winPrompt = win.prompt;\nwin.prompt = (...args: any[]): string => {\n    console.log.apply(win, args);\n    return \"\";\n};\n\n// setTimeout(() => {\n//     if (window.alert) {\n//         window.alert(\"window.alert!\");\n//     }\n//     if (window.confirm) {\n//         const ok = window.confirm(\"window.confirm?\");\n//         console.log(ok);\n//     }\n//     // NOT SUPPORTED: fatal error in console.\n//     if (window.prompt) {\n//         const str = window.prompt(\"window.prompt:\");\n//         console.log(str);\n//     }\n// }, 2000);\n\nwin.READIUM2.urlQueryParams = win.location.search ? getURLQueryParams(win.location.search) : undefined;\n\nif (win.READIUM2.urlQueryParams) {\n    let readiumEpubReadingSystemJson: INameVersion | undefined;\n\n    // tslint:disable-next-line:no-string-literal\n    const base64EpubReadingSystem = win.READIUM2.urlQueryParams[URL_PARAM_EPUBREADINGSYSTEM];\n    if (base64EpubReadingSystem) {\n        try {\n            const str = new Buffer(base64EpubReadingSystem, \"base64\").toString(\"utf8\");\n            readiumEpubReadingSystemJson = JSON.parse(str);\n        } catch (err) {\n            debug(err);\n        }\n    }\n\n    if (readiumEpubReadingSystemJson) {\n        setWindowNavigatorEpubReadingSystem(win, readiumEpubReadingSystemJson);\n    }\n\n    win.READIUM2.DEBUG_VISUALS = win.READIUM2.urlQueryParams[URL_PARAM_DEBUG_VISUALS] === \"true\";\n}\n\nif (IS_DEV) {\n    ipcRenderer.on(R2_EVENT_DEBUG_VISUALS, (_event: any, payload: string) => {\n        win.READIUM2.DEBUG_VISUALS = payload === \"true\";\n\n        if (!win.READIUM2.DEBUG_VISUALS) {\n            const existings = win.document.querySelectorAll(\n                // tslint:disable-next-line:max-line-length\n                `*[${readPosCssStylesAttr1}], *[${readPosCssStylesAttr2}], *[${readPosCssStylesAttr3}], *[${readPosCssStylesAttr4}]`);\n            existings.forEach((existing) => {\n                existing.removeAttribute(`${readPosCssStylesAttr1}`);\n                existing.removeAttribute(`${readPosCssStylesAttr2}`);\n                existing.removeAttribute(`${readPosCssStylesAttr3}`);\n                existing.removeAttribute(`${readPosCssStylesAttr4}`);\n            });\n        }\n    });\n}\n\nfunction computeVisibility_(element: Element): boolean {\n    if (win.READIUM2.isFixedLayout) {\n        return true;\n    } else if (!win.document || !win.document.documentElement || !win.document.body) {\n        return false;\n    }\n    if (element === win.document.body || element === win.document.documentElement) {\n        return true;\n    }\n\n    const elStyle = win.getComputedStyle(element);\n    if (elStyle) {\n        const display = elStyle.getPropertyValue(\"display\");\n        if (display === \"none\") {\n            if (IS_DEV) {\n                console.log(\"element DISPLAY NONE\");\n            }\n            // console.log(element.outerHTML);\n            return false;\n        }\n        // Cannot be relied upon, because web browser engine reports\n        // invisible when out of view in scrolled columns!!\n        // const visibility = elStyle.getPropertyValue(\"visibility\");\n        // if (visibility === \"hidden\") {\n        //     if (IS_DEV) {\n        //         console.log(\"element VISIBILITY HIDDEN\");\n        //     }\n        //     console.log(element.outerHTML);\n        //     return false;\n        // }\n        const opacity = elStyle.getPropertyValue(\"opacity\");\n        if (opacity === \"0\") {\n            if (IS_DEV) {\n                console.log(\"element OPACITY ZERO\");\n            }\n            // console.log(element.outerHTML);\n            return false;\n        }\n    }\n\n    const rect = element.getBoundingClientRect();\n    // debug(rect.top);\n    // debug(rect.left);\n    // debug(rect.width);\n    // debug(rect.height);\n\n    if (!isPaginated(win.document)) { // scroll\n\n        // let offset = 0;\n        // if (isVerticalWritingMode()) {\n        //     offset = ((isRTL() ? -1 : 1) * win.document.body.scrollLeft) + rect.left + (isRTL() ? rect.width : 0);\n        // } else {\n        //     offset = win.document.body.scrollTop + rect.top;\n        // }\n        // const progressionRatio = offset /\n        //     (isVerticalWritingMode() ? win.document.body.scrollWidth : win.document.body.scrollHeight);\n\n        // TODO: vertical writing mode\n        if (rect.top >= 0 &&\n            // (rect.top + rect.height) >= 0 &&\n            rect.top <= win.document.documentElement.clientHeight) {\n            return true;\n        }\n        // tslint:disable-next-line:max-line-length\n        // debug(`computeVisibility_ FALSE: getBoundingClientRect() TOP: ${rect.top} -- win.document.documentElement.clientHeight: ${win.document.documentElement.clientHeight}`);\n        return false;\n    }\n\n    // TODO: vertical writing mode\n    if (isVerticalWritingMode()) {\n        return false;\n    }\n\n    const scrollLeftPotentiallyExcessive = getScrollOffsetIntoView(element as HTMLElement);\n\n    // const { maxScrollShift, maxScrollShiftAdjusted } = calculateMaxScrollShift();\n    const extraShift = (win.document.body as any).scrollLeftExtra;\n    // extraShift === maxScrollShiftAdjusted - maxScrollShift\n\n    let currentOffset = win.document.body.scrollLeft;\n    if (extraShift) {\n        currentOffset += (((win.document.body.scrollLeft < 0) ? -1 : 1) * extraShift);\n    }\n\n    if (scrollLeftPotentiallyExcessive >= (currentOffset - 10) &&\n        scrollLeftPotentiallyExcessive <= (currentOffset + 10)) {\n        return true;\n    }\n\n    // // TODO: RTL\n    // if (isRTL()) {\n    //     return false;\n    // }\n    // const threshold = extraShift ? extraShift : 0;\n    // if ((rect.left + rect.width) > threshold) {\n    //     return true;\n    // }\n    // tslint:disable-next-line:max-line-length\n    // debug(`computeVisibility_ FALSE: getScrollOffsetIntoView: ${scrollLeftPotentiallyExcessive} -- win.document.body.scrollLeft: ${currentOffset}`);\n    return false;\n}\nfunction computeVisibility(location: LocatorLocations): boolean {\n\n    let visible = false;\n    if (win.READIUM2.isFixedLayout) {\n        visible = true;\n    } else if (!win.document || !win.document.documentElement || !win.document.body) {\n        visible = false;\n    } else if (!location || !location.cssSelector) {\n        visible = false;\n    } else {\n        // payload.location.cssSelector = payload.location.cssSelector.replace(/\\+/g, \" \");\n        let selected: Element | null = null;\n        try {\n            selected = win.document.querySelector(location.cssSelector);\n        } catch (err) {\n            debug(err);\n        }\n        if (selected) {\n            visible = computeVisibility_(selected);\n        }\n    }\n    return visible;\n}\n\nipcRenderer.on(R2_EVENT_LOCATOR_VISIBLE, (_event: any, payload: IEventPayload_R2_EVENT_LOCATOR_VISIBLE) => {\n\n    payload.visible = computeVisibility(payload.location);\n    ipcRenderer.sendToHost(R2_EVENT_LOCATOR_VISIBLE, payload);\n});\n\nipcRenderer.on(R2_EVENT_SCROLLTO, (_event: any, payload: IEventPayload_R2_EVENT_SCROLLTO) => {\n    showHideContentMask(false);\n\n    closePopupDialogs(win.document);\n\n    _cancelInitialScrollCheck = true;\n\n    if (!win.READIUM2.urlQueryParams) {\n        win.READIUM2.urlQueryParams = {};\n    }\n    if (payload.previous) {\n        // tslint:disable-next-line:no-string-literal\n        win.READIUM2.urlQueryParams[URL_PARAM_PREVIOUS] = \"true\";\n    } else {\n        // tslint:disable-next-line:no-string-literal\n        if (typeof win.READIUM2.urlQueryParams[URL_PARAM_PREVIOUS] !== \"undefined\") {\n            // tslint:disable-next-line:no-string-literal\n            delete win.READIUM2.urlQueryParams[URL_PARAM_PREVIOUS];\n        }\n    }\n    if (payload.goto) {\n        // tslint:disable-next-line:no-string-literal\n        win.READIUM2.urlQueryParams[URL_PARAM_GOTO] = payload.goto; // decodeURIComponent\n    } else {\n        // tslint:disable-next-line:no-string-literal\n        if (typeof win.READIUM2.urlQueryParams[URL_PARAM_GOTO] !== \"undefined\") {\n            // tslint:disable-next-line:no-string-literal\n            delete win.READIUM2.urlQueryParams[URL_PARAM_GOTO];\n        }\n    }\n\n    let delayScrollIntoView = false;\n    if (payload.hash) {\n        win.READIUM2.hashElement = win.document.getElementById(payload.hash);\n        if (win.READIUM2.DEBUG_VISUALS) {\n            if (win.READIUM2.hashElement) {\n                // const existings = win.document.querySelectorAll(`*[${readPosCssStylesAttr1}]`);\n                // existings.forEach((existing) => {\n                //     existing.removeAttribute(`${readPosCssStylesAttr1}`);\n                // });\n                win.READIUM2.hashElement.setAttribute(readPosCssStylesAttr1, \"R2_EVENT_SCROLLTO hashElement\");\n            }\n        }\n\n        win.location.href = \"#\" + payload.hash;\n        delayScrollIntoView = true;\n\n        // unfortunately, does not sync CSS :target pseudo-class :(\n        // win.history.replaceState({}, undefined, \"#\" + payload.hash);\n    } else {\n        win.location.href = \"#\";\n        win.READIUM2.hashElement = null;\n    }\n\n    win.READIUM2.locationHashOverride = undefined;\n    resetLocationHashOverrideInfo();\n\n    if (delayScrollIntoView) {\n        setTimeout(() => {\n            scrollToHashRaw();\n        }, 100);\n    } else {\n        scrollToHashRaw();\n    }\n});\n\nfunction resetLocationHashOverrideInfo() {\n    win.READIUM2.locationHashOverrideInfo = {\n        href: \"\",\n        locations: {\n            cfi: undefined,\n            cssSelector: undefined,\n            position: undefined,\n            progression: undefined,\n        },\n        paginationInfo: undefined,\n        title: undefined,\n    };\n}\n\nlet _lastAnimState: IPropertyAnimationState | undefined;\n\nfunction elementCapturesKeyboardArrowKeys(target: Element): boolean {\n\n    let curElement: Node | null = target;\n    while (curElement && curElement.nodeType === Node.ELEMENT_NODE) {\n\n        const editable = (curElement as Element).getAttribute(\"contenteditable\");\n        if (editable) {\n            return true;\n        }\n\n        const arrayOfKeyboardCaptureElements = [ \"input\", \"textarea\", \"video\", \"audio\", \"select\" ];\n        if (arrayOfKeyboardCaptureElements.indexOf((curElement as Element).tagName.toLowerCase()) >= 0) {\n            return true;\n        }\n\n        curElement = curElement.parentNode;\n    }\n\n    return false;\n}\n\nfunction ensureTwoPageSpreadWithOddColumnsIsOffset(scrollOffset: number, maxScrollShift: number) {\n\n    if (!win || !win.document || !win.document.body || !win.document.documentElement) {\n        return;\n    }\n\n    const noChange = !isPaginated(win.document) || !isTwoPageSpread() ||\n        isVerticalWritingMode() || // TODO: VWM?\n        maxScrollShift <= 0 || Math.abs(scrollOffset) <= maxScrollShift;\n    if (noChange) {\n        (win.document.body as any).scrollLeftExtra = 0;\n\n        // console.log(`\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\" noChange: ${maxScrollShift}`);\n        // win.document.documentElement.classList.remove(\"r2-spread-offset\");\n        ipcRenderer.sendToHost(R2_EVENT_SHIFT_VIEW_X,\n            { offset: 0, backgroundColor: undefined } as IEventPayload_R2_EVENT_SHIFT_VIEW_X);\n        return;\n    }\n    // win.document.body.scrollLeft is maxed-out, we need to simulate further scrolling\n    // isRTL() == val < 0\n    const extraOffset = Math.abs(scrollOffset) - maxScrollShift;\n    // console.log(`\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\" shiftOffset: ${extraOffset}`);\n    // win.document.documentElement.style.setProperty(\"--r2-spread-offset\", `-${shiftOffset}px`);\n    // win.document.documentElement.classList.add(\"r2-spread-offset\");\n    // if (isRTL()) {\n    //     win.document.documentElement.classList.add(\"r2-rtl\");\n    // } else {\n    //     win.document.documentElement.classList.remove(\"r2-rtl\");\n    // }\n\n    // const backgroundColor = win.document.documentElement.style.backgroundColor ?\n    //     win.document.documentElement.style.backgroundColor : win.document.body.style.backgroundColor;\n\n    let backgroundColor: string | undefined;\n    const docStyle = win.getComputedStyle(win.document.documentElement);\n    if (docStyle) {\n        backgroundColor = docStyle.getPropertyValue(\"background-color\");\n    }\n    if (!backgroundColor || backgroundColor === \"transparent\") {\n        const bodyStyle = win.getComputedStyle(win.document.body);\n        backgroundColor = bodyStyle.getPropertyValue(\"background-color\");\n        if (backgroundColor === \"transparent\") {\n            backgroundColor = undefined;\n        }\n    }\n\n    (win.document.body as any).scrollLeftExtra = extraOffset;\n\n    ipcRenderer.sendToHost(R2_EVENT_SHIFT_VIEW_X,\n        {\n            backgroundColor: backgroundColor ? backgroundColor : undefined,\n            offset: (isRTL() ? 1 : -1) * extraOffset,\n        } as IEventPayload_R2_EVENT_SHIFT_VIEW_X);\n}\n\nfunction onEventPageTurn(payload: IEventPayload_R2_EVENT_PAGE_TURN) {\n\n    let leftRightKeyWasUsedInsideKeyboardCapture = false;\n    if (win.document.activeElement &&\n        elementCapturesKeyboardArrowKeys(win.document.activeElement)) {\n\n        if (win.document.hasFocus()) {\n            leftRightKeyWasUsedInsideKeyboardCapture = true;\n        } else {\n            const oldDate = (win.document.activeElement as any).r2_leftrightKeyboardTimeStamp;\n            if (oldDate) {\n                const newDate = new Date();\n                const msDiff = newDate.getTime() - oldDate.getTime();\n                if (msDiff <= 300) {\n                    leftRightKeyWasUsedInsideKeyboardCapture = true;\n                }\n            }\n        }\n    }\n    if (leftRightKeyWasUsedInsideKeyboardCapture) {\n        return;\n    }\n\n    closePopupDialogs(win.document);\n\n    if (win.READIUM2.isFixedLayout || !win.document.body) {\n        ipcRenderer.sendToHost(R2_EVENT_PAGE_TURN_RES, payload);\n        return;\n    }\n\n    if (!win.document || !win.document.documentElement) {\n        return;\n    }\n\n    const reduceMotion = win.document.documentElement.classList.contains(ROOT_CLASS_REDUCE_MOTION);\n\n    const isPaged = isPaginated(win.document);\n\n    const goPREVIOUS = payload.go === \"PREVIOUS\"; // any other value is NEXT\n\n    if (_lastAnimState && _lastAnimState.animating) {\n        win.cancelAnimationFrame(_lastAnimState.id);\n        _lastAnimState.object[_lastAnimState.property] = _lastAnimState.destVal;\n    }\n    if (!goPREVIOUS) { // goPREVIOUS && isRTL() || !goPREVIOUS && !isRTL()) { // right\n\n        const maxScrollShift = calculateMaxScrollShift().maxScrollShift;\n\n        if (isPaged) {\n            if (isVerticalWritingMode() && (Math.abs(win.document.body.scrollTop) < maxScrollShift) ||\n                !isVerticalWritingMode() && (Math.abs(win.document.body.scrollLeft) < maxScrollShift)) { // not at end\n\n                const unit = isVerticalWritingMode() ?\n                    win.document.documentElement.offsetHeight :\n                    win.document.documentElement.offsetWidth;\n                const scrollOffsetPotentiallyExcessive_ = isVerticalWritingMode() ?\n                    (win.document.body.scrollTop + unit) :\n                    (win.document.body.scrollLeft + (isRTL() ? -1 : 1) * unit);\n                // now snap (just in case):\n                const nWholes = Math.floor(scrollOffsetPotentiallyExcessive_ / unit); // retains +/- sign\n                const scrollOffsetPotentiallyExcessive = nWholes * unit;\n                // if (scrollOffsetPotentiallyExcessive !== scrollOffsetPotentiallyExcessive_) {\n                // tslint:disable-next-line:max-line-length\n                //     console.log(`}}}}}}}}}}}}}}}}1 offset!! ${scrollOffsetPotentiallyExcessive} != ${scrollOffsetPotentiallyExcessive_}`);\n                // }\n\n                // if (Math.abs(scrollOffsetPotentiallyExcessive) > maxScrollShift) {\n                //     console.log(\"onEventPageTurn scrollOffset EXCESS\");\n                // }\n                // tslint:disable-next-line:max-line-length\n                ensureTwoPageSpreadWithOddColumnsIsOffset(scrollOffsetPotentiallyExcessive, maxScrollShift);\n\n                const scrollOffset = (scrollOffsetPotentiallyExcessive < 0 ? -1 : 1) *\n                    Math.min(Math.abs(scrollOffsetPotentiallyExcessive), maxScrollShift);\n\n                const targetObj = win.document.body;\n                const targetProp = isVerticalWritingMode() ? \"scrollTop\" : \"scrollLeft\";\n                if (reduceMotion) {\n                    _lastAnimState = undefined;\n                    targetObj[targetProp] = scrollOffset;\n                } else {\n                    _lastAnimState = animateProperty(\n                        win.cancelAnimationFrame,\n                        undefined,\n                        // (cancelled: boolean) => {\n                        //     debug(cancelled);\n                        // },\n                        targetProp,\n                        300,\n                        targetObj,\n                        scrollOffset,\n                        win.requestAnimationFrame,\n                        easings.easeInOutQuad,\n                    );\n                }\n                return;\n            }\n        } else {\n            if (isVerticalWritingMode() && (Math.abs(win.document.body.scrollLeft) < maxScrollShift) ||\n                !isVerticalWritingMode() && (Math.abs(win.document.body.scrollTop) < maxScrollShift)) {\n                const newVal = isVerticalWritingMode() ?\n                    (win.document.body.scrollLeft + (isRTL() ? -1 : 1) * win.document.documentElement.clientWidth) :\n                    (win.document.body.scrollTop + win.document.documentElement.clientHeight);\n\n                const targetObj = win.document.body;\n                const targetProp = isVerticalWritingMode() ? \"scrollLeft\" : \"scrollTop\";\n                if (reduceMotion) {\n                    _lastAnimState = undefined;\n                    targetObj[targetProp] = newVal;\n                } else {\n                    _lastAnimState = animateProperty(\n                        win.cancelAnimationFrame,\n                        undefined,\n                        // (cancelled: boolean) => {\n                        //     debug(cancelled);\n                        // },\n                        targetProp,\n                        300,\n                        targetObj,\n                        newVal,\n                        win.requestAnimationFrame,\n                        easings.easeInOutQuad,\n                    );\n                }\n                return;\n            }\n        }\n    } else if (goPREVIOUS) { //  && !isRTL() || !goPREVIOUS && isRTL()) { // left\n        if (isPaged) {\n            if (isVerticalWritingMode() && (Math.abs(win.document.body.scrollTop) > 0) ||\n                !isVerticalWritingMode() && (Math.abs(win.document.body.scrollLeft) > 0)) { // not at begin\n\n                const unit = isVerticalWritingMode() ?\n                    win.document.documentElement.offsetHeight :\n                    win.document.documentElement.offsetWidth;\n                const scrollOffset_ = isVerticalWritingMode() ?\n                    (win.document.body.scrollTop - unit) :\n                    (win.document.body.scrollLeft - (isRTL() ? -1 : 1) * unit);\n                // now snap (just in case):\n                const nWholes = Math.ceil(scrollOffset_ / unit); // retains +/- sign\n                const scrollOffset = nWholes * unit;\n                // if (scrollOffset !== scrollOffset_) {\n                //     // tslint:disable-next-line:max-line-length\n                //     console.log(`}}}}}}}}}}}}}}}}2 offset!! ${scrollOffset} != ${scrollOffset_}`);\n                // }\n\n                // zero reset\n                ensureTwoPageSpreadWithOddColumnsIsOffset(scrollOffset, 0);\n\n                const targetObj = win.document.body;\n                const targetProp = isVerticalWritingMode() ? \"scrollTop\" : \"scrollLeft\";\n                if (reduceMotion) {\n                    _lastAnimState = undefined;\n                    targetObj[targetProp] = scrollOffset;\n                } else {\n                    _lastAnimState = animateProperty(\n                        win.cancelAnimationFrame,\n                        undefined,\n                        // (cancelled: boolean) => {\n                        //     debug(cancelled);\n                        // },\n                        targetProp,\n                        300,\n                        targetObj,\n                        scrollOffset,\n                        win.requestAnimationFrame,\n                        easings.easeInOutQuad,\n                    );\n                }\n                return;\n            }\n        } else {\n            if (isVerticalWritingMode() && (Math.abs(win.document.body.scrollLeft) > 0) ||\n                !isVerticalWritingMode() && (Math.abs(win.document.body.scrollTop) > 0)) {\n                const newVal = isVerticalWritingMode() ?\n                    (win.document.body.scrollLeft - (isRTL() ? -1 : 1) * win.document.documentElement.clientWidth) :\n                    (win.document.body.scrollTop - win.document.documentElement.clientHeight);\n\n                const targetObj = win.document.body;\n                const targetProp = isVerticalWritingMode() ? \"scrollLeft\" : \"scrollTop\";\n                if (reduceMotion) {\n                    _lastAnimState = undefined;\n                    targetObj[targetProp] = newVal;\n                } else {\n                    _lastAnimState = animateProperty(\n                        win.cancelAnimationFrame,\n                        undefined,\n                        // (cancelled: boolean) => {\n                        //     debug(cancelled);\n                        // },\n                        targetProp,\n                        300,\n                        targetObj,\n                        newVal,\n                        win.requestAnimationFrame,\n                        easings.easeInOutQuad,\n                    );\n                }\n                return;\n            }\n        }\n    }\n\n    ipcRenderer.sendToHost(R2_EVENT_PAGE_TURN_RES, payload);\n}\nipcRenderer.on(R2_EVENT_PAGE_TURN, (_event: any, payload: IEventPayload_R2_EVENT_PAGE_TURN) => {\n    // Because 'r2_leftrightKeyboardTimeStamp' is set AFTER the main window left/right keyboard handler!\n    setTimeout(() => { // we could debounce too?\n        onEventPageTurn(payload);\n    }, 100);\n});\n\nfunction scrollElementIntoView(element: Element) {\n    if (win.READIUM2.DEBUG_VISUALS) {\n        const existings = win.document.querySelectorAll(`*[${readPosCssStylesAttr3}]`);\n        existings.forEach((existing) => {\n            existing.removeAttribute(`${readPosCssStylesAttr3}`);\n        });\n        element.setAttribute(readPosCssStylesAttr3, \"scrollElementIntoView\");\n    }\n\n    const isPaged = isPaginated(win.document);\n    if (isPaged) {\n        scrollIntoView(element as HTMLElement);\n    } else {\n        const rect = element.getBoundingClientRect();\n        // calculateMaxScrollShift()\n        // TODO: vertical writing mode\n        const scrollTopMax = win.document.body.scrollHeight - win.document.documentElement.clientHeight;\n        let offset = win.document.body.scrollTop + (rect.top - (win.document.documentElement.clientHeight / 2));\n        if (offset > scrollTopMax) {\n            offset = scrollTopMax;\n        } else if (offset < 0) {\n            offset = 0;\n        }\n        win.document.body.scrollTop = offset;\n        // element.scrollIntoView({\n        //     // TypeScript lib.dom.d.ts difference in 3.2.1\n        //     // ScrollBehavior = \"auto\" | \"instant\" | \"smooth\" VS ScrollBehavior = \"auto\" | \"smooth\"\n        //     behavior: \"auto\",\n        //     // ScrollLogicalPosition = \"start\" | \"center\" | \"end\" | \"nearest\"\n        //     block: \"center\",\n        //     // ScrollLogicalPosition = \"start\" | \"center\" | \"end\" | \"nearest\"\n        //     inline: \"nearest\",\n        // } as ScrollIntoViewOptions);\n    }\n}\n\n// TODO: vertical writing mode\nfunction getScrollOffsetIntoView(element: HTMLElement): number {\n    if (!win.document || !win.document.documentElement || !win.document.body ||\n        !isPaginated(win.document) || isVerticalWritingMode()) {\n        return 0;\n    }\n\n    const rect = element.getBoundingClientRect();\n\n    const columnDimension = calculateColumnDimension();\n\n    const isTwoPage = isTwoPageSpread();\n\n    const fullOffset = (isRTL() ?\n        ((columnDimension * (isTwoPage ? 2 : 1)) - rect.left) :\n        rect.left) +\n        ((isRTL() ? -1 : 1) * win.document.body.scrollLeft);\n\n    const columnIndex = Math.floor(fullOffset / columnDimension); // 0-based index\n\n    const spreadIndex = isTwoPage ? Math.floor(columnIndex / 2) : columnIndex; // 0-based index\n\n    return (isRTL() ? -1 : 1) *\n        (spreadIndex * (columnDimension * (isTwoPage ? 2 : 1)));\n}\n\n// TODO: vertical writing mode\nfunction scrollIntoView(element: HTMLElement) {\n    if (!win.document || !win.document.documentElement || !win.document.body || !isPaginated(win.document)) {\n        return;\n    }\n    const maxScrollShift = calculateMaxScrollShift().maxScrollShift;\n    const scrollLeftPotentiallyExcessive = getScrollOffsetIntoView(element);\n    // if (Math.abs(scrollLeftPotentiallyExcessive) > maxScrollShift) {\n    //     console.log(\"getScrollOffsetIntoView scrollLeft EXCESS\");\n    // }\n    ensureTwoPageSpreadWithOddColumnsIsOffset(scrollLeftPotentiallyExcessive, maxScrollShift);\n\n    // scrollLeft is capped at maxScrollShift by the browser engine\n    const scrollOffset = (scrollLeftPotentiallyExcessive < 0 ? -1 : 1) *\n        Math.min(Math.abs(scrollLeftPotentiallyExcessive), maxScrollShift);\n    win.document.body.scrollLeft = scrollOffset;\n}\n\nconst scrollToHashRaw = () => {\n    if (!win.document || !win.document.body || !win.document.documentElement) {\n        return;\n    }\n\n    const isPaged = isPaginated(win.document);\n\n    if (win.READIUM2.locationHashOverride) {\n        // if (win.READIUM2.locationHashOverride === win.document.body) {\n        //     notifyReadingLocationDebounced();\n        //     return;\n        // }\n        // _ignoreScrollEvent = true;\n        scrollElementIntoView(win.READIUM2.locationHashOverride);\n\n        notifyReadingLocationDebounced();\n        return;\n    } else if (win.READIUM2.hashElement) {\n        win.READIUM2.locationHashOverride = win.READIUM2.hashElement;\n\n        // _ignoreScrollEvent = true;\n        scrollElementIntoView(win.READIUM2.hashElement);\n\n        // win.READIUM2.hashElement.classList.add(\"readium2-hash\");\n        // setTimeout(() => {\n        //     if (win.READIUM2.hashElement) {\n        //         win.READIUM2.hashElement.classList.remove(\"readium2-hash\");\n        //     }\n        // }, 1000);\n\n        notifyReadingLocationDebounced();\n        return;\n    } else {\n        if (win.READIUM2.urlQueryParams) {\n            // tslint:disable-next-line:no-string-literal\n            const previous = win.READIUM2.urlQueryParams[URL_PARAM_PREVIOUS];\n            const isPreviousNavDirection = previous === \"true\";\n            if (isPreviousNavDirection) {\n                const { maxScrollShift, maxScrollShiftAdjusted } = calculateMaxScrollShift();\n\n                _ignoreScrollEvent = true;\n                if (isPaged) {\n                    if (isVerticalWritingMode()) {\n                        win.document.body.scrollLeft = 0;\n                        win.document.body.scrollTop = maxScrollShift;\n                    } else {\n                        const scrollLeftPotentiallyExcessive = (isRTL() ? -1 : 1) * maxScrollShiftAdjusted;\n                        // tslint:disable-next-line:max-line-length\n                        ensureTwoPageSpreadWithOddColumnsIsOffset(scrollLeftPotentiallyExcessive, maxScrollShift);\n                        const scrollLeft = (isRTL() ? -1 : 1) * maxScrollShift;\n                        win.document.body.scrollLeft = scrollLeft;\n                        win.document.body.scrollTop = 0;\n                    }\n                } else {\n                    if (isVerticalWritingMode()) {\n                        win.document.body.scrollLeft = (isRTL() ? -1 : 1) * maxScrollShift;\n                        win.document.body.scrollTop = 0;\n                    } else {\n                        win.document.body.scrollLeft = 0;\n                        win.document.body.scrollTop = maxScrollShift;\n                    }\n                }\n\n                win.READIUM2.locationHashOverride = undefined;\n                resetLocationHashOverrideInfo();\n\n                setTimeout(() => {\n                    // relative to fixed window top-left corner\n                    // const y = (isPaged ?\n                    //     (isVerticalWritingMode() ?\n                    //         win.document.documentElement.offsetWidth :\n                    //         win.document.documentElement.offsetHeight) :\n                    //     (isVerticalWritingMode() ?\n                    //         win.document.documentElement.clientWidth :\n                    //         win.document.documentElement.clientHeight))\n                    // - 1;\n                    // processXYRaw(0, y, true);\n                    processXYRaw(0, 0, false);\n\n                    showHideContentMask(false);\n\n                    if (!win.READIUM2.locationHashOverride) { // already in processXYRaw()\n                        notifyReadingLocationDebounced();\n                    }\n\n                    setTimeout(() => {\n                        _ignoreScrollEvent = false;\n                    }, 10);\n                }, 60);\n                return;\n            }\n\n            // tslint:disable-next-line:no-string-literal\n            const gto = win.READIUM2.urlQueryParams[URL_PARAM_GOTO];\n            let gotoCssSelector: string | undefined;\n            let gotoProgression: number | undefined;\n            if (gto) {\n                // decodeURIComponent\n                const s = new Buffer(gto, \"base64\").toString(\"utf8\");\n                const js = JSON.parse(s);\n                gotoCssSelector = (js as LocatorLocations).cssSelector;\n                gotoProgression = (js as LocatorLocations).progression;\n                // TODO: CFI, etc.?\n            }\n            if (gotoCssSelector) {\n                gotoCssSelector = gotoCssSelector.replace(/\\+/g, \" \");\n                let selected: Element | null = null;\n                try {\n                    selected = win.document.querySelector(gotoCssSelector);\n                } catch (err) {\n                    debug(err);\n                }\n                if (selected) {\n                    win.READIUM2.locationHashOverride = selected;\n\n                    resetLocationHashOverrideInfo();\n                    if (win.READIUM2.locationHashOverrideInfo) {\n                        win.READIUM2.locationHashOverrideInfo.locations.cssSelector = gotoCssSelector;\n                    }\n\n                    // _ignoreScrollEvent = true;\n                    scrollElementIntoView(selected);\n\n                    notifyReadingLocationDebounced();\n                    return;\n                }\n            } else if (gotoProgression) {\n                const { maxScrollShift } = calculateMaxScrollShift();\n\n                if (isPaged) {\n                    const isTwoPage = isTwoPageSpread();\n                    const nColumns = calculateTotalColumns();\n                    const nUnits = isTwoPage ? Math.ceil(nColumns / 2) : nColumns;\n                    const unitIndex = Math.floor(gotoProgression * nUnits);\n\n                    const unit = isVerticalWritingMode() ?\n                        win.document.documentElement.offsetHeight :\n                        win.document.documentElement.offsetWidth;\n\n                    const scrollOffsetPotentiallyExcessive = isVerticalWritingMode() ?\n                        (unitIndex * unit) :\n                        ((isRTL() ? -1 : 1) * unitIndex * unit);\n\n                    // tslint:disable-next-line:max-line-length\n                    ensureTwoPageSpreadWithOddColumnsIsOffset(scrollOffsetPotentiallyExcessive, maxScrollShift);\n\n                    const scrollOffsetPaged = (scrollOffsetPotentiallyExcessive < 0 ? -1 : 1) *\n                        Math.min(Math.abs(scrollOffsetPotentiallyExcessive), maxScrollShift);\n\n                    _ignoreScrollEvent = true;\n                    if (isVerticalWritingMode()) {\n                        win.document.body.scrollTop = scrollOffsetPaged;\n                    } else {\n                        win.document.body.scrollLeft = scrollOffsetPaged;\n                    }\n                    setTimeout(() => {\n                        _ignoreScrollEvent = false;\n                    }, 10);\n\n                    win.READIUM2.locationHashOverride = win.document.body;\n                    resetLocationHashOverrideInfo();\n\n                    processXYRaw(0, 0, false);\n\n                    if (!win.READIUM2.locationHashOverride) { // already in processXYRaw()\n                        notifyReadingLocationDebounced();\n                    }\n                    return;\n                }\n                // !isPaged\n                const scrollOffset = gotoProgression * maxScrollShift;\n\n                _ignoreScrollEvent = true;\n                if (isVerticalWritingMode()) {\n                    win.document.body.scrollLeft = scrollOffset;\n                } else {\n                    win.document.body.scrollTop = scrollOffset;\n                }\n                setTimeout(() => {\n                    _ignoreScrollEvent = false;\n                }, 10);\n\n                win.READIUM2.locationHashOverride = win.document.body;\n                resetLocationHashOverrideInfo();\n\n                processXYRaw(0, 0, false);\n\n                if (!win.READIUM2.locationHashOverride) { // already in processXYRaw()\n                    notifyReadingLocationDebounced();\n                }\n                return;\n            }\n        }\n\n        _ignoreScrollEvent = true;\n        win.document.body.scrollLeft = 0;\n        win.document.body.scrollTop = 0;\n        setTimeout(() => {\n            _ignoreScrollEvent = false;\n        }, 10);\n\n        win.READIUM2.locationHashOverride = win.document.body;\n        resetLocationHashOverrideInfo();\n\n        processXYRaw(0, 0, false);\n\n        // if (!win.READIUM2.locationHashOverride) { // already in processXYRaw()\n        //     notifyReadingLocationDebounced();\n        //     return;\n        // }\n    }\n\n    notifyReadingLocationDebounced();\n};\n\nconst scrollToHashDebounced = debounce(() => {\n    scrollToHashRaw();\n}, 300);\n\nlet _ignoreScrollEvent = false;\n\n// function testReadiumCSS(readiumcssJson: IEventPayload_R2_EVENT_READIUMCSS | undefined) {\n//     const oldHTML = win.document.documentElement.outerHTML;\n//     const iBody = oldHTML.indexOf(\"<body\");\n//     debug(oldHTML.substr(0, iBody + 100));\n\n//     let newHTML: string | undefined;\n//     try {\n//         newHTML = transformHTML(oldHTML, readiumcssJson, \"application/xhtml+xml\");\n//     } catch (err) {\n//         debug(err);\n//         return;\n//     }\n\n//     const iBody_ = newHTML.indexOf(\"<body\");\n//     debug(newHTML.substr(0, iBody_ + 100));\n// }\n\nipcRenderer.on(\"R2_EVENT_HIDE\", (_event: any) => {\n    showHideContentMask(true);\n});\n\nfunction showHideContentMask(doHide: boolean) {\n    if (doHide) {\n        win.document.body.classList.add(ROOT_CLASS_INVISIBLE_MASK);\n    } else {\n        win.document.body.classList.remove(ROOT_CLASS_INVISIBLE_MASK);\n    }\n}\n\nfunction focusScrollRaw(el: HTMLOrSVGElement, doFocus: boolean) {\n    win.READIUM2.locationHashOverride = el as HTMLElement;\n    scrollElementIntoView(win.READIUM2.locationHashOverride);\n    if (doFocus) {\n        setTimeout(() => {\n            el.focus();\n        }, 10);\n    }\n    notifyReadingLocationDebounced();\n}\nconst focusScrollDebounced = debounce((el: HTMLOrSVGElement, doFocus: boolean) => {\n    focusScrollRaw(el, doFocus);\n}, 80);\n\nlet _ignoreFocusInEvent = false;\n\nfunction handleTab(target: HTMLElement, tabKeyDownEvent: KeyboardEvent | undefined) {\n    if (!target || !win.document.body) {\n        return;\n    }\n\n    // target\n    // tab-keydown => originating element (will leave focus)\n    // focusin => destination element (focuses in)\n\n    // evt\n    // non-nil when tab-keydown\n    // nil when focusin\n    // const isTabKeyDownEvent = typeof evt !== \"undefined\";\n    // const isFocusInEvent = !isTabKeyDownEvent;\n\n    _ignoreFocusInEvent = false;\n\n    // cache problem: temporary tabbables? (e.g. HTML5 details/summary element, expand/collapse)\n    // so right now, resize sensor resets body.tabbables. Is that enough? (other edge cases?)\n    const tabbables = (win.document.body as any).tabbables ?\n        (win.document.body as any).tabbables :\n        ((win.document.body as any).tabbables = tabbable(win.document.body));\n    // const tabbables = tabbable(win.document.body);\n    // debug(tabbables);\n\n    const i = tabbables.indexOf(target);\n    // debug(\"TABBABLE: \" + i);\n\n    if (i === 0) {\n        // debug(\"FIRST TABBABLE\");\n        // prevent the webview from cycling scroll (does its own unwanted focus)\n        if (!tabKeyDownEvent || tabKeyDownEvent.shiftKey) {\n            // debug(\"FIRST TABBABLE focusin or shift-tab\");\n            _ignoreFocusInEvent = true;\n            focusScrollDebounced(target as HTMLElement, true);\n            return;\n        }\n        if (i < (tabbables.length - 1)) {\n            // debug(\"TABBABLE FORWARD >>\");\n            tabKeyDownEvent.preventDefault();\n            const nextTabbable = tabbables[i + 1];\n            focusScrollDebounced(nextTabbable as HTMLElement, true);\n            return;\n        }\n        // debug(\"FIRST TABBABLE ??\");\n    } else if (i === (tabbables.length - 1)) {\n        // debug(\"LAST TABBABLE\");\n        // prevent the webview from cycling scroll (does its own unwanted focus)\n        if (!tabKeyDownEvent || !tabKeyDownEvent.shiftKey) {\n            // debug(\"LAST TABBABLE focusin or no-shift-tab\");\n            _ignoreFocusInEvent = true;\n            focusScrollDebounced(target as HTMLElement, true);\n            return;\n        }\n        if (i > 0) {\n            // debug(\"TABBABLE BACKWARD <<\");\n            tabKeyDownEvent.preventDefault();\n            const previousTabbable = tabbables[i - 1];\n            focusScrollDebounced(previousTabbable as HTMLElement, true);\n            return;\n        }\n        // debug(\"LAST TABBABLE??\");\n    } else if (i > 0) {\n        if (tabKeyDownEvent) {\n            if (tabKeyDownEvent.shiftKey) {\n                // debug(\"TABBABLE BACKWARD <<\");\n                tabKeyDownEvent.preventDefault();\n                const previousTabbable = tabbables[i - 1];\n                focusScrollDebounced(previousTabbable as HTMLElement, true);\n                return;\n            } else {\n                // debug(\"TABBABLE FORWARD >>\");\n                tabKeyDownEvent.preventDefault();\n                const nextTabbable = tabbables[i + 1];\n                focusScrollDebounced(nextTabbable as HTMLElement, true);\n                return;\n            }\n        }\n    }\n    if (!tabKeyDownEvent) {\n        // debug(\"FOCUSIN force\");\n        focusScrollDebounced(target as HTMLElement, true);\n    }\n}\n\nipcRenderer.on(R2_EVENT_READIUMCSS, (_event: any, payload: IEventPayload_R2_EVENT_READIUMCSS) => {\n    showHideContentMask(false);\n    readiumCSS(win.document, payload);\n});\n\nlet _docTitle: string | undefined;\n\nwin.addEventListener(\"DOMContentLoaded\", () => {\n    // console.log(\"############# DOMContentLoaded\");\n    // console.log(win.location);\n\n    const titleElement = win.document.documentElement.querySelector(\"head > title\");\n    if (titleElement && titleElement.textContent) {\n        _docTitle = titleElement.textContent;\n    }\n\n    _cancelInitialScrollCheck = true;\n\n    // const linkUri = new URI(win.location.href);\n\n    if (win.location.hash && win.location.hash.length > 1) {\n        win.READIUM2.hashElement = win.document.getElementById(win.location.hash.substr(1));\n        if (win.READIUM2.DEBUG_VISUALS) {\n            if (win.READIUM2.hashElement) {\n                // const existings = win.document.querySelectorAll(`*[${readPosCssStylesAttr1}]`);\n                // existings.forEach((existing) => {\n                //     existing.removeAttribute(`${readPosCssStylesAttr1}`);\n                // });\n                win.READIUM2.hashElement.setAttribute(readPosCssStylesAttr1, \"DOMContentLoaded hashElement\");\n            }\n        }\n    }\n\n    win.READIUM2.locationHashOverride = undefined;\n    win.READIUM2.ttsClickEnabled = false;\n\n    let readiumcssJson: IEventPayload_R2_EVENT_READIUMCSS | undefined;\n    if (win.READIUM2.urlQueryParams) {\n        // tslint:disable-next-line:no-string-literal\n        const base64ReadiumCSS = win.READIUM2.urlQueryParams[URL_PARAM_CSS];\n        if (base64ReadiumCSS) {\n            let str: string | undefined;\n            try {\n                str = new Buffer(base64ReadiumCSS, \"base64\").toString(\"utf8\");\n                readiumcssJson = JSON.parse(str);\n            } catch (err) {\n                debug(\"################## READIUM CSS PARSE ERROR?!\");\n                debug(base64ReadiumCSS);\n                debug(err);\n                debug(str);\n            }\n        }\n    }\n\n    if (readiumcssJson) {\n        win.READIUM2.isFixedLayout = (typeof readiumcssJson.isFixedLayout !== \"undefined\") ?\n            readiumcssJson.isFixedLayout : false;\n    }\n\n    let didHide = false;\n    if (!win.READIUM2.isFixedLayout) {\n        // only applies to previous nav spine item reading order\n        if (win.READIUM2.urlQueryParams) {\n            // tslint:disable-next-line:no-string-literal\n            const previous = win.READIUM2.urlQueryParams[URL_PARAM_PREVIOUS];\n            const isPreviousNavDirection = previous === \"true\";\n            if (isPreviousNavDirection) {\n                didHide = true;\n                showHideContentMask(true);\n            }\n        }\n    }\n    // ensure visible (can be triggered from host)\n    if (!didHide) {\n        showHideContentMask(false);\n    }\n\n    // testReadiumCSS(readiumcssJson);\n\n    const wh = configureFixedLayout(win.document, win.READIUM2.isFixedLayout,\n        win.READIUM2.fxlViewportWidth, win.READIUM2.fxlViewportHeight,\n        win.innerWidth, win.innerHeight);\n    if (wh) {\n        win.READIUM2.fxlViewportWidth = wh.width;\n        win.READIUM2.fxlViewportHeight = wh.height;\n    }\n\n    const alreadedInjected = win.document.documentElement.hasAttribute(\"data-readiumcss-injected\");\n    if (alreadedInjected) {\n        debug(\">>>>> ReadiumCSS already injected by streamer\");\n        // console.log(\">>>>>2 ReadiumCSS already injected by streamer\");\n    }\n\n    if (!alreadedInjected) {\n        injectDefaultCSS(win.document);\n        if (IS_DEV) { // win.READIUM2.DEBUG_VISUALS\n            injectReadPosCSS(win.document);\n        }\n    }\n\n    computeVerticalRTL();\n    if (readiumcssJson) {\n        // ReadiumCSS already injected at the streamer level?\n        if (isVerticalWritingMode() || // force update, because needs getComputedStyle()\n            !alreadedInjected) {\n\n            debug(\">>>>>> ReadiumCSS inject again\");\n            readiumCSS(win.document, readiumcssJson);\n        }\n    }\n    if (alreadedInjected) { // because querySelector[All]() is not polyfilled\n        checkHiddenFootNotes(win.document);\n    }\n});\n\nlet _cancelInitialScrollCheck = false;\n// after DOMContentLoaded\nwin.addEventListener(\"load\", () => {\n    // console.log(\"############# load\");\n    // console.log(win.location);\n\n    if (!win.READIUM2.isFixedLayout) {\n        setTimeout(() => {\n            scrollToHashRaw();\n        }, 100);\n        _cancelInitialScrollCheck = false;\n        setTimeout(() => {\n            if (_cancelInitialScrollCheck) {\n                return;\n            }\n            // if (!isPaginated(win.document)) {\n            //     // scrollToHashRaw();\n            //     return;\n            // }\n            // let visible = false;\n            // if (win.READIUM2.locationHashOverride === win.document.body ||\n            //     win.READIUM2.hashElement === win.document.body) {\n            //     visible = true;\n            // } else if (win.READIUM2.locationHashOverride) {\n            //     visible = computeVisibility_(win.READIUM2.locationHashOverride);\n            // } else if (win.READIUM2.hashElement) {\n            //     visible = computeVisibility_(win.READIUM2.hashElement);\n            // }\n            // if (!visible) {\n            //     debug(\"!visible (delayed layout pass?) => forcing second scrollToHashRaw()...\");\n            //     if (win.READIUM2.locationHashOverride) {\n            //         debug(uniqueCssSelector(win.READIUM2.locationHashOverride, win.document, undefined));\n            //     }\n            //     scrollToHashRaw();\n            // }\n        }, 500);\n    } else {\n        processXYDebounced(0, 0, false);\n    }\n\n    const useResizeSensor = !win.READIUM2.isFixedLayout;\n    if (useResizeSensor && win.document.body) {\n\n        setTimeout(() => {\n            // let _firstResizeSensor = true;\n            // tslint:disable-next-line:no-unused-expression\n            new ResizeSensor(win.document.body, () => {\n                // if (_firstResizeSensor) {\n                //     _firstResizeSensor = false;\n                //     debug(\"ResizeSensor SKIPPED (FIRST)\");\n                //     return;\n                // }\n                debug(\"ResizeSensor\");\n\n                (win.document.body as any).tabbables = undefined;\n                scrollToHashDebounced();\n            });\n        }, 1000);\n        // window.requestAnimationFrame((_timestamp) => {\n        // });\n    }\n\n    win.document.body.addEventListener(\"focusin\", (ev: any) => {\n\n        if (_ignoreFocusInEvent) {\n            // debug(\"focusin --- IGNORE\");\n            _ignoreFocusInEvent = false;\n            return;\n        }\n\n        if (isPopupDialogOpen(win.document)) {\n            return;\n        }\n\n        if (ev.target) {\n            let mouseClickOnLink = false;\n            if (win.document && win.document.documentElement) {\n                if (!win.document.documentElement.classList.contains(ROOT_CLASS_KEYBOARD_INTERACT)) {\n                    if ((ev.target as HTMLElement).tagName.toLowerCase() === \"a\" && (ev.target as any).href) {\n                        // link mouse click, leave it alone!\n                        mouseClickOnLink = true;\n                    }\n                }\n            }\n            if (!mouseClickOnLink) {\n                handleTab(ev.target as HTMLElement, undefined);\n            }\n        }\n        // if (!win.document) {\n        //     return;\n        // }\n        // const isPaged = isPaginated(win.document);\n        // if (isPaged) {\n        // }\n    });\n\n    win.document.body.addEventListener(\"keydown\", (ev: KeyboardEvent) => {\n        if (isPopupDialogOpen(win.document)) {\n            return;\n        }\n\n        const TAB_KEY = 9;\n        if (ev.which === TAB_KEY) {\n            if (ev.target) {\n                handleTab(ev.target as HTMLElement, ev);\n            }\n        }\n        // if (!win.document) {\n        //     return;\n        // }\n        // const isPaged = isPaginated(win.document);\n        // if (isPaged) {\n        // }\n    }, true);\n\n    win.document.documentElement.addEventListener(\"keydown\", (ev: KeyboardEvent) => {\n\n        if (win.document && win.document.documentElement) {\n            win.document.documentElement.classList.add(ROOT_CLASS_KEYBOARD_INTERACT);\n        }\n        if (ev.keyCode === 37 || ev.keyCode === 39) { // left / right\n            if (ev.target && elementCapturesKeyboardArrowKeys(ev.target as Element)) {\n                (ev.target as any).r2_leftrightKeyboardTimeStamp = new Date();\n            }\n        }\n    }, true);\n\n    win.document.documentElement.addEventListener(\"mousedown\", (_ev: MouseEvent) => {\n\n        if (win.document && win.document.documentElement) {\n            win.document.documentElement.classList.remove(ROOT_CLASS_KEYBOARD_INTERACT);\n        }\n    }, true);\n\n    win.document.addEventListener(\"click\", (e: MouseEvent) => {\n\n        // TODO? xlink:href\n        const href = (e.target as HTMLAnchorElement).href;\n        // const href = (e.target as Element).getAttribute(\"href\");\n        if (!href) {\n            return;\n        }\n\n        e.preventDefault();\n        e.stopPropagation();\n\n        const done = popupFootNote(e.target as HTMLElement, focusScrollRaw, href);\n        if (!done) {\n            focusScrollDebounced.clear();\n            processXYDebounced.clear();\n            notifyReadingLocationDebounced.clear();\n            scrollToHashDebounced.clear();\n\n            const payload: IEventPayload_R2_EVENT_LINK = {\n                url: href,\n            };\n            ipcRenderer.sendToHost(R2_EVENT_LINK, payload);\n        }\n\n        return false;\n    }, true);\n\n    // assumes debounced from outside (Electron's webview object embedded in original renderer process HTML)\n    win.addEventListener(\"resize\", () => {\n        const wh = configureFixedLayout(win.document, win.READIUM2.isFixedLayout,\n            win.READIUM2.fxlViewportWidth, win.READIUM2.fxlViewportHeight,\n            win.innerWidth, win.innerHeight);\n        if (wh) {\n            win.READIUM2.fxlViewportWidth = wh.width;\n            win.READIUM2.fxlViewportHeight = wh.height;\n        }\n\n        scrollToHashRaw();\n        // scrollToHash(); // debounced\n    });\n\n    setTimeout(() => {\n        win.addEventListener(\"scroll\", (_ev: UIEvent) => {\n\n            if (_ignoreScrollEvent) {\n                _ignoreScrollEvent = false;\n                return;\n            }\n\n            if (!win.document || !win.document.documentElement) {\n                return;\n            }\n\n            const x = (isRTL() ? win.document.documentElement.offsetWidth - 1 : 0);\n            processXYDebounced(x, 0, false);\n        });\n    }, 200);\n\n    win.document.body.addEventListener(\"click\", (ev: MouseEvent) => {\n\n        if (isPopupDialogOpen(win.document)) {\n            return;\n        }\n\n        // relative to fixed window top-left corner\n        // (unlike pageX/Y which is relative to top-left rendered content area, subject to scrolling)\n        const x = ev.clientX;\n        const y = ev.clientY;\n\n        processXYDebounced(x, y, false);\n    });\n\n    win.document.body.addEventListener(\"click\", (ev: MouseEvent) => {\n\n        if (isPopupDialogOpen(win.document)) {\n            return;\n        }\n\n        // relative to fixed window top-left corner\n        // (unlike pageX/Y which is relative to top-left rendered content area, subject to scrolling)\n        const x = ev.clientX;\n        const y = ev.clientY;\n\n        // const elems = win.document.elementsFromPoint(x, y);\n\n        // let element: Element | undefined = elems && elems.length ? elems[0] : undefined;\n        let element: Element | undefined;\n\n        // if ((win.document as any).caretPositionFromPoint) {\n        //     const range = (win.document as any).caretPositionFromPoint(x, y);\n        //     const node = range.offsetNode;\n        //     const offset = range.offset;\n        // } else if (win.document.caretRangeFromPoint) {\n        // }\n\n        // let textNode: Node | undefined;\n        // let textNodeOffset = 0;\n\n        const range = win.document.caretRangeFromPoint(x, y);\n        if (range) {\n            const node = range.startContainer;\n            // const offset = range.startOffset;\n\n            if (node) {\n                if (node.nodeType === Node.ELEMENT_NODE) {\n                    element = node as Element;\n                } else if (node.nodeType === Node.TEXT_NODE) {\n                    // textNode = node;\n                    // textNodeOffset = offset;\n                    if (node.parentNode && node.parentNode.nodeType === Node.ELEMENT_NODE) {\n                        element = node.parentNode as Element;\n                    }\n                }\n            }\n        }\n\n        if (win.READIUM2.ttsClickEnabled && element) {\n            if (ev.altKey) {\n                ttsPlay(focusScrollRaw, element, undefined);\n                return;\n            }\n\n            ttsPlay(focusScrollRaw, (element.ownerDocument as Document).body, element);\n        }\n    });\n});\n\n// // does not occur when re-using same webview (src=\"href\")\n// win.addEventListener(\"unload\", () => {\n// });\n\nfunction checkBlacklisted(el: Element): boolean {\n\n    let blacklistedId: string | undefined;\n    const id = el.getAttribute(\"id\");\n    if (id && _blacklistIdClassForCFI.indexOf(id) >= 0) {\n        console.log(\"checkBlacklisted ID: \" + id);\n        blacklistedId = id;\n    }\n    let blacklistedClass: string | undefined;\n    for (const item of _blacklistIdClassForCFI) {\n        if (el.classList.contains(item)) {\n            console.log(\"checkBlacklisted CLASS: \" + item);\n            blacklistedClass = item;\n            break;\n        }\n    }\n    if (blacklistedId || blacklistedClass) {\n        return true;\n    }\n\n    return false;\n}\n\nfunction findFirstVisibleElement(rootElement: Element): Element | undefined {\n\n    const blacklisted = checkBlacklisted(rootElement);\n    if (blacklisted) {\n        return undefined;\n    }\n\n    // tslint:disable-next-line:prefer-for-of\n    for (let i = 0; i < rootElement.children.length; i++) {\n        const child = rootElement.children[i];\n        if (child.nodeType !== Node.ELEMENT_NODE) {\n            continue;\n        }\n        const visibleElement = findFirstVisibleElement(child);\n        if (visibleElement) {\n            return visibleElement;\n        }\n    }\n    if (rootElement !== win.document.body &&\n        rootElement !== win.document.documentElement) {\n\n        const visible = computeVisibility_(rootElement);\n        if (visible) {\n            return rootElement;\n        }\n    }\n    return undefined;\n}\n\n// relative to fixed window top-left corner\nconst processXYRaw = (x: number, y: number, reverse: boolean) => {\n\n    if (isPopupDialogOpen(win.document)) {\n        return;\n    }\n\n    // const elems = win.document.elementsFromPoint(x, y);\n\n    // let element: Element | undefined = elems && elems.length ? elems[0] : undefined;\n    let element: Element | undefined;\n\n    // if ((win.document as any).caretPositionFromPoint) {\n    //     const range = (win.document as any).caretPositionFromPoint(x, y);\n    //     const node = range.offsetNode;\n    //     const offset = range.offset;\n    // } else if (win.document.caretRangeFromPoint) {\n    // }\n\n    // let textNode: Node | undefined;\n    // let textNodeOffset = 0;\n\n    const range = win.document.caretRangeFromPoint(x, y);\n    if (range) {\n        const node = range.startContainer;\n        // const offset = range.startOffset;\n\n        if (node) {\n            if (node.nodeType === Node.ELEMENT_NODE) {\n                element = node as Element;\n            } else if (node.nodeType === Node.TEXT_NODE) {\n                // textNode = node;\n                // textNodeOffset = offset;\n                if (node.parentNode && node.parentNode.nodeType === Node.ELEMENT_NODE) {\n                    element = node.parentNode as Element;\n                }\n            }\n        }\n    }\n\n    if (!element || element === win.document.body || element === win.document.documentElement) {\n        const root = win.document.body; // || win.document.documentElement;\n        element = findFirstVisibleElement(root);\n        if (!element) {\n            debug(\"|||||||||||||| cannot find visible element inside BODY / HTML????\");\n            element = win.document.body;\n        }\n    } else if (!computeVisibility_(element)) { // isPaginated(win.document)\n        let next: Element | undefined = element;\n        let found: Element | undefined;\n        while (next) {\n            // const blacklisted = checkBlacklisted(next);\n            // if (blacklisted) {\n            //     break;\n            // }\n\n            const firstInside = findFirstVisibleElement(next);\n            if (firstInside) {\n                found = firstInside;\n                break;\n            }\n            let sibling: Element | null = reverse ? next.previousElementSibling : next.nextElementSibling;\n            let parent: Node | null = next;\n            while (!sibling) {\n                parent = parent.parentNode;\n                if (!parent || parent.nodeType !== Node.ELEMENT_NODE) {\n                    break;\n                }\n                sibling = reverse ?\n                    (parent as Element).previousElementSibling :\n                    (parent as Element).nextElementSibling;\n            }\n            next = sibling ? sibling : undefined;\n        }\n        if (found) {\n            element = found;\n        } else {\n            debug(\"|||||||||||||| cannot find visible element after current????\");\n        }\n    }\n    // if (element) {\n    //     debug(\"|||||||||||||| SELECTED ELEMENT\");\n    //     debug(element);\n    //     if (element) {\n    //         debug(uniqueCssSelector(element, win.document, undefined));\n    //     }\n    // }\n    if (element === win.document.body || element === win.document.documentElement) {\n        debug(\"|||||||||||||| BODY/HTML selected????\");\n    }\n    if (element) {\n        win.READIUM2.locationHashOverride = element;\n        notifyReadingLocationDebounced();\n\n        if (win.READIUM2.DEBUG_VISUALS) {\n            const existings = win.document.querySelectorAll(`*[${readPosCssStylesAttr2}]`);\n            existings.forEach((existing) => {\n                existing.removeAttribute(`${readPosCssStylesAttr2}`);\n            });\n            element.setAttribute(readPosCssStylesAttr2, \"processXYRaw\");\n        }\n    }\n};\nconst processXYDebounced = debounce((x: number, y: number, reverse: boolean) => {\n    processXYRaw(x, y, reverse);\n}, 300);\n\ninterface IProgressionData {\n    percentRatio: number;\n    paginationInfo: IEventPayload_R2_EVENT_READING_LOCATION_PAGINATION_INFO | undefined;\n}\nexport const computeProgressionData = (): IProgressionData => {\n\n    const isPaged = isPaginated(win.document);\n\n    const isTwoPage = isTwoPageSpread();\n\n    const { maxScrollShift, maxScrollShiftAdjusted } = calculateMaxScrollShift();\n\n    const totalColumns = calculateTotalColumns();\n\n    let progressionRatio = 0;\n\n    // zero-based index: 0 <= currentColumn < totalColumns\n    let currentColumn = 0;\n\n    let extraShift = 0;\n    if (isPaged) {\n        if (maxScrollShift > 0) {\n            if (isVerticalWritingMode()) {\n                progressionRatio = win.document.body.scrollTop / maxScrollShift;\n            } else {\n                extraShift = (win.document.body as any).scrollLeftExtra;\n                // extraShift === maxScrollShiftAdjusted - maxScrollShift\n                if (extraShift) {\n                    progressionRatio = (((isRTL() ? -1 : 1) * win.document.body.scrollLeft) + extraShift) /\n                        maxScrollShiftAdjusted;\n                } else {\n                    progressionRatio = ((isRTL() ? -1 : 1) * win.document.body.scrollLeft) / maxScrollShift;\n                }\n            }\n        }\n\n        // console.log(\")))))))) 0 progressionRatio\");\n        // console.log(progressionRatio);\n\n        // console.log(\"&&&&& EXTRA\");\n        // console.log(extraShift);\n\n        // because maxScrollShift excludes whole viewport width of content (0%-100% scroll but minus last page/spread)\n        const adjustedTotalColumns = (extraShift ? (totalColumns + 1) : totalColumns) - (isTwoPage ? 2 : 1);\n        // tslint:disable-next-line:max-line-length\n        // const adjustedTotalColumns = totalColumns - (isTwoPage ? ((maxScrollShiftAdjusted > maxScrollShift) ? 1 : 2) : 1);\n\n        currentColumn = adjustedTotalColumns * progressionRatio;\n        // console.log(\"%%%%%%%% 0 currentColumn\");\n        // console.log(currentColumn);\n\n        currentColumn = Math.floor(currentColumn);\n    } else {\n        if (maxScrollShift > 0) {\n            if (isVerticalWritingMode()) {\n                progressionRatio = ((isRTL() ? -1 : 1) * win.document.body.scrollLeft) / maxScrollShift;\n            } else {\n                progressionRatio = win.document.body.scrollTop / maxScrollShift;\n            }\n        }\n    }\n\n    if (win.READIUM2.locationHashOverride) {\n        const element = win.READIUM2.locationHashOverride as HTMLElement;\n\n        // imprecise\n        // const offsetTop = computeOffsetTop(element);\n\n        const rect = element.getBoundingClientRect();\n        let offset = 0;\n        // console.log(\"##### RECT TOP LEFT\");\n        // console.log(rect.top);\n        // console.log(rect.left);\n\n        if (isPaged) {\n\n            const visible = computeVisibility_(element);\n            if (visible) {\n                // because getBoundingClientRect() based on visual rendering,\n                // which does not account for extra shift (CSS transform X-translate of the webview)\n                const curCol = extraShift ? (currentColumn - 1) : currentColumn;\n\n                const columnDimension = calculateColumnDimension();\n                // console.log(\"##### columnDimension\");\n                // console.log(columnDimension);\n\n                if (isVerticalWritingMode()) {\n                    offset = (curCol * win.document.body.scrollWidth) + rect.left +\n                        (rect.top >= columnDimension ? win.document.body.scrollWidth : 0);\n                } else {\n                    offset = (curCol * win.document.body.scrollHeight) + rect.top +\n                        (((isRTL() ?\n                            (win.document.documentElement.clientWidth - (rect.left + rect.width)) :\n                            rect.left) >= columnDimension) ? win.document.body.scrollHeight : 0);\n                }\n\n                // console.log(\"##### offset\");\n                // console.log(offset);\n\n                // includes whitespace beyond bottom/end of document, to fill the unnocupied remainder of the column\n                const totalDocumentDimension = ((isVerticalWritingMode() ? win.document.body.scrollWidth :\n                    win.document.body.scrollHeight) * totalColumns);\n                // console.log(\"##### totalDocumentDimension\");\n                // console.log(totalDocumentDimension);\n                progressionRatio = offset / totalDocumentDimension;\n\n                // console.log(\")))))))) 1 progressionRatio\");\n                // console.log(progressionRatio);\n\n                currentColumn = totalColumns * progressionRatio;\n\n                // console.log(\"%%%%%%%% 1 currentColumn\");\n                // console.log(currentColumn);\n\n                currentColumn = Math.floor(currentColumn);\n            }\n        } else {\n            if (isVerticalWritingMode()) {\n                offset = ((isRTL() ? -1 : 1) * win.document.body.scrollLeft) + rect.left + (isRTL() ? rect.width : 0);\n            } else {\n                offset = win.document.body.scrollTop + rect.top;\n            }\n\n            progressionRatio = offset /\n                (isVerticalWritingMode() ? win.document.body.scrollWidth : win.document.body.scrollHeight);\n        }\n    }\n\n    let spreadIndex = 0;\n    if (isPaged) {\n        spreadIndex = isTwoPage ? Math.floor(currentColumn / 2) : currentColumn;\n    }\n\n    return {\n        paginationInfo: isPaged ? {\n            currentColumn,\n            isTwoPageSpread: isTwoPage,\n            spreadIndex,\n            totalColumns,\n        } : undefined,\n        percentRatio: progressionRatio,\n    };\n};\n\n// tslint:disable-next-line:max-line-length\nconst _blacklistIdClassForCssSelectors = [TTS_ID_INJECTED_PARENT, TTS_ID_SPEAKING_DOC_ELEMENT, POPUP_DIALOG_CLASS, TTS_CLASS_INJECTED_SPAN, TTS_CLASS_INJECTED_SUBSPAN, ROOT_CLASS_KEYBOARD_INTERACT, ROOT_CLASS_INVISIBLE_MASK, CLASS_PAGINATED, ROOT_CLASS_NO_FOOTNOTES];\n\n// tslint:disable-next-line:max-line-length\nconst _blacklistIdClassForCFI = [POPUP_DIALOG_CLASS, TTS_CLASS_INJECTED_SPAN, TTS_CLASS_INJECTED_SUBSPAN, \"resize-sensor\"];\n\nexport const computeCFI = (node: Node): string | undefined => {\n\n    // TODO: handle character position inside text node\n    if (node.nodeType !== Node.ELEMENT_NODE) {\n        return undefined;\n    }\n\n    let cfi = \"\";\n\n    let currentElement = node as Element;\n    while (currentElement.parentNode && currentElement.parentNode.nodeType === Node.ELEMENT_NODE) {\n        const blacklisted = checkBlacklisted(currentElement);\n        if (!blacklisted) {\n            const currentElementParentChildren = (currentElement.parentNode as Element).children;\n            let currentElementIndex = -1;\n            for (let i = 0; i < currentElementParentChildren.length; i++) {\n                if (currentElement === currentElementParentChildren[i]) {\n                    currentElementIndex = i;\n                    break;\n                }\n            }\n            if (currentElementIndex >= 0) {\n                const cfiIndex = (currentElementIndex + 1) * 2;\n                cfi = cfiIndex +\n                    (currentElement.id ? (\"[\" + currentElement.id + \"]\") : \"\") +\n                    (cfi.length ? (\"/\" + cfi) : \"\");\n            }\n        }\n        currentElement = currentElement.parentNode as Element;\n    }\n\n    return \"/\" + cfi;\n};\n\nconst notifyReadingLocationRaw = () => {\n    if (!win.READIUM2.locationHashOverride) {\n        return;\n    }\n\n    // win.READIUM2.locationHashOverride.nodeType === ELEMENT_NODE\n\n    let progressionData: IProgressionData | undefined;\n\n    const options = {\n        className: (str: string) => {\n            return _blacklistIdClassForCssSelectors.indexOf(str) < 0;\n        },\n        idName: (str: string) => {\n            return _blacklistIdClassForCssSelectors.indexOf(str) < 0;\n        },\n    };\n    const cssSelector = uniqueCssSelector(win.READIUM2.locationHashOverride, win.document, options);\n    const cfi = computeCFI(win.READIUM2.locationHashOverride);\n    let progression = 0;\n    if (win.READIUM2.isFixedLayout) {\n        progression = 1;\n    } else {\n        progressionData = computeProgressionData();\n        progression = progressionData.percentRatio;\n    }\n\n    const pinfo = (progressionData && progressionData.paginationInfo) ?\n        progressionData.paginationInfo : undefined;\n\n    win.READIUM2.locationHashOverrideInfo = {\n        href: \"\", // TODO\n        locations: {\n            cfi,\n            cssSelector,\n            position: undefined, // calculated in host index.js renderer, where publication object is available\n            progression,\n        },\n        paginationInfo: pinfo,\n        title: _docTitle,\n    };\n    const payload: IEventPayload_R2_EVENT_READING_LOCATION = win.READIUM2.locationHashOverrideInfo;\n    ipcRenderer.sendToHost(R2_EVENT_READING_LOCATION, payload);\n\n    if (win.READIUM2.DEBUG_VISUALS) {\n        const existings = win.document.querySelectorAll(`*[${readPosCssStylesAttr4}]`);\n        existings.forEach((existing) => {\n            existing.removeAttribute(`${readPosCssStylesAttr4}`);\n        });\n        win.READIUM2.locationHashOverride.setAttribute(readPosCssStylesAttr4, \"notifyReadingLocationRaw\");\n    }\n};\nconst notifyReadingLocationDebounced = debounce(() => {\n    notifyReadingLocationRaw();\n}, 250);\n\nipcRenderer.on(R2_EVENT_TTS_DO_PLAY, (_event: any, payload: IEventPayload_R2_EVENT_TTS_DO_PLAY) => {\n    const rootElement = win.document.querySelector(payload.rootElement);\n    const startElement = payload.startElement ? win.document.querySelector(payload.startElement) : null;\n    ttsPlay(focusScrollRaw, rootElement ? rootElement : undefined, startElement ? startElement : undefined);\n});\n\nipcRenderer.on(R2_EVENT_TTS_DO_STOP, (_event: any) => {\n    ttsStop();\n});\n\nipcRenderer.on(R2_EVENT_TTS_DO_PAUSE, (_event: any) => {\n    ttsPause();\n});\n\nipcRenderer.on(R2_EVENT_TTS_DO_RESUME, (_event: any) => {\n    ttsResume();\n});\n\nipcRenderer.on(R2_EVENT_TTS_DO_NEXT, (_event: any) => {\n    ttsNext();\n});\n\nipcRenderer.on(R2_EVENT_TTS_DO_PREVIOUS, (_event: any) => {\n    ttsPrevious();\n});\n\nipcRenderer.on(R2_EVENT_TTS_CLICK_ENABLE, (_event: any, payload: IEventPayload_R2_EVENT_TTS_CLICK_ENABLE) => {\n    win.READIUM2.ttsClickEnabled = payload.doEnable;\n});\n"]}