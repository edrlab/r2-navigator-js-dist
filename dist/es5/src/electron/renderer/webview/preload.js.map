{"version":3,"file":"preload.js","sourceRoot":"","sources":["../../../../../../src/electron/renderer/webview/preload.ts"],"names":[],"mappings":"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","sourcesContent":["import debounce = require(\"debounce\");\r\nimport ResizeSensor = require(\"resize-sensor/ResizeSensor\");\r\n\r\nimport { ipcRenderer } from \"electron\";\r\n\r\nimport {\r\n    R2_EVENT_LINK,\r\n    R2_EVENT_PAGE_TURN,\r\n    R2_EVENT_PAGE_TURN_RES,\r\n    R2_EVENT_READING_LOCATION,\r\n    R2_EVENT_SCROLLTO,\r\n    R2_EVENT_WEBVIEW_READY,\r\n} from \"../../common/events\";\r\nimport { IPropertyAnimationState, animateProperty } from \"../common/animateProperty\";\r\nimport { fullQualifiedSelector } from \"../common/cssselector\";\r\nimport { easings } from \"../common/easings\";\r\nimport { getURLQueryParams } from \"../common/querystring\";\r\nimport {\r\n    DEBUG_VISUALS,\r\n    injectDefaultCSS,\r\n    injectReadPosCSS,\r\n    isRTL,\r\n    isVerticalWritingMode,\r\n    readiumCSS,\r\n} from \"./readium-css\";\r\n\r\nconst win = (global as any).window as Window;\r\n\r\nlet queryParams = win.location.search ? getURLQueryParams(win.location.search) : undefined;\r\n\r\n// console.log(\"-----\");\r\n// console.log(win.location.href);\r\n// console.log(win.location.origin);\r\n// console.log(win.location.pathname);\r\n// console.log(win.location.search);\r\n// console.log(win.location.hash);\r\n\r\nlet _hashElement: Element | null;\r\n\r\nipcRenderer.on(R2_EVENT_SCROLLTO, (_event: any, messageString: any) => {\r\n    // console.log(\"R2_EVENT_SCROLLTO\");\r\n    // console.log(messageString);\r\n\r\n    const messageJson = JSON.parse(messageString);\r\n    if (!queryParams) {\r\n        queryParams = {};\r\n    }\r\n    if (messageJson.previous) {\r\n        // tslint:disable-next-line:no-string-literal\r\n        queryParams[\"readiumprevious\"] = \"true\";\r\n    } else {\r\n        // tslint:disable-next-line:no-string-literal\r\n        if (typeof queryParams[\"readiumprevious\"] !== \"undefined\") {\r\n            // tslint:disable-next-line:no-string-literal\r\n            delete queryParams[\"readiumprevious\"];\r\n        }\r\n    }\r\n    if (messageJson.goto) {\r\n        // tslint:disable-next-line:no-string-literal\r\n        queryParams[\"readiumgoto\"] = \"true\";\r\n    } else {\r\n        // tslint:disable-next-line:no-string-literal\r\n        if (typeof queryParams[\"readiumgoto\"] !== \"undefined\") {\r\n            // tslint:disable-next-line:no-string-literal\r\n            delete queryParams[\"readiumgoto\"];\r\n        }\r\n    }\r\n    if (messageJson.hash) {\r\n        _hashElement = win.document.getElementById(messageJson.hash);\r\n    } else {\r\n        _hashElement = null;\r\n    }\r\n\r\n    _readyEventSent = false;\r\n    _locationHashOverride = undefined;\r\n    scrollToHashRaw(false);\r\n\r\n    // ipcRenderer.sendToHost(R2_EVENT_WEBVIEW_READY, win.location.href);\r\n    // notifyReadingLocation();\r\n});\r\n\r\nlet _lastAnimState: IPropertyAnimationState | undefined;\r\n\r\nipcRenderer.on(R2_EVENT_PAGE_TURN, (_event: any, messageString: any) => {\r\n    if (!win.document.body) {\r\n        ipcRenderer.sendToHost(R2_EVENT_PAGE_TURN_RES, messageString);\r\n        return;\r\n    }\r\n\r\n    // console.log(\"---\");\r\n    // console.log(\"webview.innerWidth: \" + win.innerWidth);\r\n    // console.log(\"document.offsetWidth: \" + win.document.documentElement.offsetWidth);\r\n    // console.log(\"document.clientWidth: \" + win.document.documentElement.clientWidth);\r\n    // console.log(\"document.scrollWidth: \" + win.document.documentElement.scrollWidth);\r\n    // console.log(\"document.scrollLeft: \" + win.document.documentElement.scrollLeft);\r\n    // console.log(\"body.offsetWidth: \" + win.document.body.offsetWidth);\r\n    // console.log(\"body.clientWidth: \" + win.document.body.clientWidth);\r\n    // console.log(\"body.scrollWidth: \" + win.document.body.scrollWidth);\r\n    // console.log(\"body.scrollLeft: \" + win.document.body.scrollLeft);\r\n    // console.log(\"---\");\r\n    // console.log(\"webview.innerHeight: \" + win.innerHeight);\r\n    // console.log(\"document.offsetHeight: \" + win.document.documentElement.offsetHeight);\r\n    // console.log(\"document.clientHeight: \" + win.document.documentElement.clientHeight);\r\n    // console.log(\"document.scrollHeight: \" + win.document.documentElement.scrollHeight);\r\n    // console.log(\"document.scrollTop: \" + win.document.documentElement.scrollTop);\r\n    // console.log(\"body.offsetHeight: \" + win.document.body.offsetHeight);\r\n    // console.log(\"body.clientHeight: \" + win.document.body.clientHeight);\r\n    // console.log(\"body.scrollHeight: \" + win.document.body.scrollHeight);\r\n    // console.log(\"body.scrollTop: \" + win.document.body.scrollTop);\r\n    // console.log(\"---\");\r\n\r\n    // win.document.body.offsetWidth === single column width (takes into account column gap?)\r\n    // win.document.body.clientWidth === same\r\n    // win.document.body.scrollWidth === full document width (all columns)\r\n\r\n    // win.document.body.offsetHeight === full document height (sum of all columns minus trailing blank space?)\r\n    // win.document.body.clientHeight === same\r\n    // win.document.body.scrollHeight === visible viewport height\r\n\r\n    // win.document.body.scrollLeft === positive number for horizontal shift\r\n    // win.document.body.scrollTop === positive number for vertical shift\r\n\r\n    const isPaged = win.document.documentElement.classList.contains(\"readium-paginated\");\r\n    // console.log(\"isPaged: \" + isPaged);\r\n    // const isTwoPage = isPaged && (win.document.documentElement.offsetWidth === (win.document.body.offsetWidth * 2));\r\n    // const isTwoPage = isPaged && (win.document.documentElement.offsetWidth > win.document.body.offsetWidth);\r\n    // console.log(\"isTwoPage: \" + isTwoPage);\r\n    // const nColumns = isPaged ? (win.document.body.offsetHeight / win.document.body.scrollHeight) : 0;\r\n    // console.log(\"nColumns: \" + nColumns);\r\n\r\n    const maxHeightShift = isPaged ?\r\n        ((isVerticalWritingMode() ?\r\n            (win.document.body.scrollHeight - win.document.documentElement.offsetHeight) :\r\n            (win.document.body.scrollWidth - win.document.documentElement.offsetWidth))) :\r\n        ((isVerticalWritingMode() ?\r\n            (win.document.body.scrollWidth - win.document.documentElement.clientWidth) :\r\n            (win.document.body.scrollHeight - win.document.documentElement.clientHeight)));\r\n    // console.log(\"maxHeightShift: \" + maxHeightShift);\r\n\r\n    const messageJson = JSON.parse(messageString);\r\n    const goPREVIOUS = messageJson.go === \"PREVIOUS\"; // any other value is NEXT\r\n\r\n    // const isRTL = messageJson.direction === \"RTL\"; //  any other value is LTR\r\n    // console.log(JSON.stringify(messageJson, null, \"  \"));\r\n\r\n    if (!goPREVIOUS) { // goPREVIOUS && isRTL() || !goPREVIOUS && !isRTL()) { // right\r\n        if (isPaged) {\r\n            // console.log(\"element.scrollLeft: \" + win.document.body.scrollLeft);\r\n            if (Math.abs(win.document.body.scrollLeft) < maxHeightShift) { // not at end\r\n                if (_lastAnimState && _lastAnimState.animating) {\r\n                    win.cancelAnimationFrame(_lastAnimState.id);\r\n                    _lastAnimState.object[_lastAnimState.property] = _lastAnimState.destVal;\r\n                }\r\n                const newVal = win.document.body.scrollLeft +\r\n                    (isRTL() ? -1 : 1) * win.document.documentElement.offsetWidth;\r\n                // console.log(\"element.scrollLeft NEW: \" + newVal);\r\n                _lastAnimState = animateProperty(\r\n                    win.cancelAnimationFrame,\r\n                    undefined,\r\n                    // (cancelled: boolean) => {\r\n                    //     console.log(cancelled);\r\n                    // },\r\n                    \"scrollLeft\",\r\n                    300,\r\n                    win.document.body,\r\n                    newVal,\r\n                    win.requestAnimationFrame,\r\n                    easings.easeInOutQuad,\r\n                );\r\n                return;\r\n            }\r\n        } else {\r\n            // console.log(\"element.scrollTop: \" + win.document.body.scrollTop);\r\n            if (isVerticalWritingMode() && (Math.abs(win.document.body.scrollLeft) < maxHeightShift) ||\r\n                !isVerticalWritingMode() && (Math.abs(win.document.body.scrollTop) < maxHeightShift)) {\r\n                if (_lastAnimState && _lastAnimState.animating) {\r\n                    win.cancelAnimationFrame(_lastAnimState.id);\r\n                    _lastAnimState.object[_lastAnimState.property] = _lastAnimState.destVal;\r\n                }\r\n                const newVal = isVerticalWritingMode() ?\r\n                    (win.document.body.scrollLeft +\r\n                        (isRTL() ? -1 : 1) * win.document.documentElement.clientWidth) :\r\n                    (win.document.body.scrollTop +\r\n                        win.document.documentElement.clientHeight);\r\n                // console.log(\"element.scrollTop NEW: \" + newVal);\r\n                _lastAnimState = animateProperty(\r\n                    win.cancelAnimationFrame,\r\n                    undefined,\r\n                    // (cancelled: boolean) => {\r\n                    //     console.log(cancelled);\r\n                    // },\r\n                    isVerticalWritingMode() ? \"scrollLeft\" : \"scrollTop\",\r\n                    300,\r\n                    win.document.body,\r\n                    newVal,\r\n                    win.requestAnimationFrame,\r\n                    easings.easeInOutQuad,\r\n                );\r\n                return;\r\n            }\r\n        }\r\n    } else if (goPREVIOUS) { //  && !isRTL() || !goPREVIOUS && isRTL()) { // left\r\n        if (isPaged) {\r\n            if (Math.abs(win.document.body.scrollLeft) > 0) { // not at begin\r\n                if (_lastAnimState && _lastAnimState.animating) {\r\n                    win.cancelAnimationFrame(_lastAnimState.id);\r\n                    _lastAnimState.object[_lastAnimState.property] = _lastAnimState.destVal;\r\n                }\r\n                const newVal = win.document.body.scrollLeft -\r\n                    (isRTL() ? -1 : 1) * win.document.documentElement.offsetWidth;\r\n                // console.log(\"element.scrollLeft NEW: \" + newVal);\r\n                _lastAnimState = animateProperty(\r\n                    win.cancelAnimationFrame,\r\n                    undefined,\r\n                    // (cancelled: boolean) => {\r\n                    //     console.log(cancelled);\r\n                    // },\r\n                    \"scrollLeft\",\r\n                    300,\r\n                    win.document.body,\r\n                    newVal,\r\n                    win.requestAnimationFrame,\r\n                    easings.easeInOutQuad,\r\n                );\r\n                return;\r\n            }\r\n        } else {\r\n            if (isVerticalWritingMode() && (Math.abs(win.document.body.scrollLeft) > 0) ||\r\n                !isVerticalWritingMode() && (Math.abs(win.document.body.scrollTop) > 0)) {\r\n                if (_lastAnimState && _lastAnimState.animating) {\r\n                    win.cancelAnimationFrame(_lastAnimState.id);\r\n                    _lastAnimState.object[_lastAnimState.property] = _lastAnimState.destVal;\r\n                }\r\n                const newVal = isVerticalWritingMode() ?\r\n                    (win.document.body.scrollLeft -\r\n                        (isRTL() ? -1 : 1) * win.document.documentElement.clientWidth) :\r\n                    (win.document.body.scrollTop -\r\n                        win.document.documentElement.clientHeight);\r\n                // console.log(\"element.scrollTop NEW: \" + newVal);\r\n                _lastAnimState = animateProperty(\r\n                    win.cancelAnimationFrame,\r\n                    undefined,\r\n                    // (cancelled: boolean) => {\r\n                    //     console.log(cancelled);\r\n                    // },\r\n                    isVerticalWritingMode() ? \"scrollLeft\" : \"scrollTop\",\r\n                    300,\r\n                    win.document.body,\r\n                    newVal,\r\n                    win.requestAnimationFrame,\r\n                    easings.easeInOutQuad,\r\n                );\r\n                return;\r\n            }\r\n        }\r\n    }\r\n\r\n    ipcRenderer.sendToHost(R2_EVENT_PAGE_TURN_RES, messageString);\r\n});\r\n\r\nconst checkReadyPass = () => {\r\n    if (_readyPassDone) {\r\n        return;\r\n    }\r\n    _readyPassDone = true;\r\n\r\n    if (DEBUG_VISUALS) {\r\n        if (_hashElement) {\r\n            _hashElement.classList.add(\"readium2-read-pos\");\r\n        }\r\n    }\r\n\r\n    win.addEventListener(\"resize\", () => {\r\n        scrollToHashRaw(false);\r\n        // scrollToHash(); // debounced\r\n    });\r\n\r\n    // const docElement = win.document.documentElement;\r\n    // let skipFirstResize = docElement.getAttribute(\"data-readiumcss\") || false;\r\n    // let skipFirstScroll = skipFirstResize;\r\n\r\n    setTimeout(() => {\r\n        scrollToHashRaw(true);\r\n\r\n        win.addEventListener(\"scroll\", (_ev: Event) => {\r\n\r\n            if (_ignoreScrollEvent) {\r\n                _ignoreScrollEvent = false;\r\n                return;\r\n            }\r\n            // if (skipFirstScroll) {\r\n            //     skipFirstScroll = false;\r\n            //     return;\r\n            // }\r\n\r\n            const x = (isRTL() ? win.document.documentElement.offsetWidth - 1 : 0);\r\n            processXY(x, 0);\r\n        });\r\n\r\n    }, 800);\r\n\r\n    const useResizeSensor = true;\r\n    if (useResizeSensor && win.document.body) {\r\n\r\n        setTimeout(() => {\r\n            window.requestAnimationFrame((_timestamp) => {\r\n                // new (win as any).\r\n                // tslint:disable-next-line:no-unused-expression\r\n                new ResizeSensor(win.document.body, () => {\r\n\r\n                    console.log(\"ResizeSensor\");\r\n\r\n                    scrollToHash();\r\n\r\n                    // if (skipFirstResize) {\r\n                    //     console.log(\"ResizeSensor SKIP FIRST\");\r\n\r\n                    //     skipFirstResize = false;\r\n                    //     return;\r\n                    // } else {\r\n                    //     console.log(\"ResizeSensor\");\r\n                    // }\r\n                });\r\n            });\r\n        }, 2000);\r\n    }\r\n\r\n    if (win.document.body) {\r\n\r\n        win.document.body.addEventListener(\"click\", (ev: MouseEvent) => {\r\n\r\n            const x = ev.clientX; // win.document.body.scrollLeft;\r\n            const y = ev.clientY; // win.document.body.scrollTop;\r\n\r\n            processXY(x, y);\r\n        });\r\n    }\r\n};\r\n\r\nconst notifyReady = () => {\r\n    if (_readyEventSent) {\r\n        return;\r\n    }\r\n    _readyEventSent = true;\r\n\r\n    ipcRenderer.sendToHost(R2_EVENT_WEBVIEW_READY, win.location.href);\r\n};\r\n\r\nfunction scrollIntoView(element: HTMLElement) {\r\n    if (!win.document.body) {\r\n        return;\r\n    }\r\n    // console.log(\"element.offsetTop: \" + element.offsetTop);\r\n    // console.log(\"win.document.body.scrollHeight: \" + win.document.body.scrollHeight);\r\n\r\n    // TODO: element.offsetTop probably breaks in nested DOM / CSS box contexts (relative to...)\r\n\r\n    let colIndex = (element.offsetTop + (isRTL() ? -20 : +20)) / win.document.body.scrollHeight;\r\n    // console.log(\"colIndex: \" + colIndex);\r\n    colIndex = Math.ceil(colIndex); // 1-based index\r\n\r\n    const isTwoPage = win.document.documentElement.offsetWidth > win.document.body.offsetWidth;\r\n    const spreadIndex = isTwoPage ? Math.ceil(colIndex / 2) : colIndex;\r\n    // console.log(\"spreadIndex: \" + spreadIndex);\r\n\r\n    // console.log(\"element.getBoundingClientRect().top: \" + element.getBoundingClientRect().top);\r\n    // console.log(\"element.getBoundingClientRect().left: \" + element.getBoundingClientRect().left);\r\n\r\n    // const top = (colIndex * win.document.body.scrollHeight) + element.getBoundingClientRect().top;\r\n    // console.log(\"top: \" + top);\r\n\r\n    // const left = (colIndex * win.document.body.offsetWidth);\r\n    const left = ((spreadIndex - 1) * win.document.documentElement.offsetWidth);\r\n    // console.log(\"left: \" + left);\r\n\r\n    win.document.body.scrollLeft = (isRTL() ? -1 : 1) * left;\r\n}\r\n\r\nconst scrollToHashRaw = (firstCall: boolean) => {\r\n\r\n    // console.log(\"scrollToHash: \" + firstCall);\r\n\r\n    const isPaged = win.document.documentElement.classList.contains(\"readium-paginated\");\r\n\r\n    if (_locationHashOverride) {\r\n\r\n        // console.log(\"_locationHashOverride\");\r\n\r\n        if (_locationHashOverride === win.document.body) {\r\n            console.log(\"body...\");\r\n\r\n            return;\r\n        }\r\n\r\n        notifyReady();\r\n        notifyReadingLocation();\r\n\r\n        _ignoreScrollEvent = true;\r\n        if (isPaged) {\r\n            scrollIntoView(_locationHashOverride as HTMLElement);\r\n        } else {\r\n            _locationHashOverride.scrollIntoView({\r\n                behavior: \"instant\",\r\n                block: \"start\",\r\n                inline: \"start\",\r\n            });\r\n        }\r\n\r\n        return;\r\n    } else if (_hashElement) {\r\n\r\n        console.log(\"_hashElement\");\r\n\r\n        _locationHashOverride = _hashElement;\r\n        // _locationHashOverrideCSSselector = fullQualifiedSelector(_locationHashOverride, false);\r\n\r\n        notifyReady();\r\n        notifyReadingLocation();\r\n\r\n        if (!firstCall) {\r\n            _ignoreScrollEvent = true;\r\n            if (isPaged) {\r\n                scrollIntoView(_hashElement as HTMLElement);\r\n            } else {\r\n                _hashElement.scrollIntoView({\r\n                    behavior: \"instant\",\r\n                    block: \"start\",\r\n                    inline: \"start\",\r\n                });\r\n            }\r\n        }\r\n\r\n        // _hashElement.classList.add(\"readium2-hash\");\r\n        // setTimeout(() => {\r\n        //     if (_hashElement) {\r\n        //         _hashElement.classList.remove(\"readium2-hash\");\r\n        //     }\r\n        // }, 1000);\r\n\r\n        return;\r\n    } else {\r\n        if (win.document.body) {\r\n\r\n            if (queryParams) {\r\n                // tslint:disable-next-line:no-string-literal\r\n                const previous = queryParams[\"readiumprevious\"];\r\n                const isPreviousNavDirection = previous === \"true\";\r\n                if (isPreviousNavDirection) {\r\n\r\n                    console.log(\"readiumprevious\");\r\n\r\n                    const maxHeightShift = isPaged ?\r\n                    ((isVerticalWritingMode() ?\r\n                        (win.document.body.scrollHeight - win.document.documentElement.offsetHeight) :\r\n                        (win.document.body.scrollWidth - win.document.documentElement.offsetWidth))) :\r\n                    ((isVerticalWritingMode() ?\r\n                        (win.document.body.scrollWidth - win.document.documentElement.clientWidth) :\r\n                        (win.document.body.scrollHeight - win.document.documentElement.clientHeight)));\r\n                    // console.log(\"maxHeightShift: \" + maxHeightShift);\r\n\r\n                    _ignoreScrollEvent = true;\r\n                    if (isPaged) {\r\n                        if (isVerticalWritingMode()) {\r\n                            win.document.body.scrollLeft = 0;\r\n                            win.document.body.scrollTop = maxHeightShift;\r\n                        } else {\r\n                            win.document.body.scrollLeft = (isRTL() ? -1 : 1) * maxHeightShift;\r\n                            win.document.body.scrollTop = 0;\r\n                        }\r\n                    } else {\r\n                        if (isVerticalWritingMode()) {\r\n                            win.document.body.scrollLeft = (isRTL() ? -1 : 1) * maxHeightShift;\r\n                            win.document.body.scrollTop = 0;\r\n                        } else {\r\n                            win.document.body.scrollLeft = 0;\r\n                            win.document.body.scrollTop = maxHeightShift;\r\n                        }\r\n                    }\r\n\r\n                    _locationHashOverride = undefined;\r\n                    _locationHashOverrideCSSselector = undefined;\r\n                    processXYRaw(0,\r\n                        (isPaged ?\r\n                            (isVerticalWritingMode() ?\r\n                                win.document.documentElement.offsetWidth :\r\n                                win.document.documentElement.offsetHeight) :\r\n                            (isVerticalWritingMode() ?\r\n                                win.document.documentElement.clientWidth :\r\n                                win.document.documentElement.clientHeight))\r\n                        - 1);\r\n\r\n                    console.log(\"BOTTOM (previous):\");\r\n                    console.log(_locationHashOverride);\r\n\r\n                    notifyReady();\r\n                    notifyReadingLocation();\r\n                    return;\r\n                }\r\n\r\n                // tslint:disable-next-line:no-string-literal\r\n                let gotoCssSelector = queryParams[\"readiumgoto\"];\r\n                if (gotoCssSelector) {\r\n                    gotoCssSelector = gotoCssSelector.replace(/\\+/g, \" \");\r\n                    // console.log(\"GOTO: \" + gotoCssSelector);\r\n                    let selected: Element | null = null;\r\n                    try {\r\n                        selected = document.querySelector(gotoCssSelector);\r\n                    } catch (err) {\r\n                        console.log(err);\r\n                    }\r\n                    if (selected) {\r\n\r\n                        // console.log(\"readiumgoto\");\r\n\r\n                        _locationHashOverride = selected;\r\n                        _locationHashOverrideCSSselector = gotoCssSelector;\r\n\r\n                        notifyReady();\r\n                        notifyReadingLocation();\r\n\r\n                        _ignoreScrollEvent = true;\r\n                        if (isPaged) {\r\n                            scrollIntoView(selected as HTMLElement);\r\n                        } else {\r\n                            selected.scrollIntoView({\r\n                                behavior: \"instant\",\r\n                                block: \"start\",\r\n                                inline: \"start\",\r\n                            });\r\n                        }\r\n\r\n                        return;\r\n                    }\r\n                }\r\n            }\r\n\r\n            console.log(\"_locationHashOverride = win.document.body\");\r\n\r\n            _locationHashOverride = win.document.body;\r\n            _locationHashOverrideCSSselector = undefined;\r\n\r\n            _ignoreScrollEvent = true;\r\n            win.document.body.scrollLeft = 0;\r\n            win.document.body.scrollTop = 0;\r\n        }\r\n    }\r\n\r\n    notifyReady();\r\n    notifyReadingLocation();\r\n};\r\n\r\nconst scrollToHash = debounce(() => {\r\n    scrollToHashRaw(false);\r\n}, 500);\r\n\r\nlet _ignoreScrollEvent = false;\r\n\r\n// const injectResizeSensor = () => {\r\n//     ensureHead();\r\n//     const scriptElement = win.document.createElement(\"script\");\r\n//     scriptElement.setAttribute(\"id\", \"Readium2-ResizeSensor\");\r\n//     scriptElement.setAttribute(\"type\", \"application/javascript\");\r\n//     scriptElement.setAttribute(\"src\", urlResizeSensor);\r\n//     scriptElement.appendChild(win.document.createTextNode(\" \"));\r\n//     win.document.head.appendChild(scriptElement);\r\n//     scriptElement.addEventListener(\"load\", () => {\r\n//         console.log(\"ResizeSensor LOADED\");\r\n//     });\r\n// };\r\n\r\nlet _locationHashOverride: Element | undefined;\r\nlet _locationHashOverrideCSSselector: string | undefined;\r\nlet _readyPassDone = false;\r\nlet _readyEventSent = false;\r\n\r\nconst resetInitialState = () => {\r\n    _locationHashOverride = undefined;\r\n    _readyPassDone = false;\r\n    _readyEventSent = false;\r\n};\r\n\r\n// after DOMContentLoaded\r\nwin.addEventListener(\"load\", () => {\r\n    // console.log(\"PRELOAD WIN LOAD\");\r\n    checkReadyPass();\r\n});\r\n\r\n// // does not occur when re-using same webview (src=\"href\")\r\n// win.addEventListener(\"unload\", () => {\r\n//     console.log(\"PRELOAD WIN UNLOAD\");\r\n//     resetInitialState();\r\n// });\r\n\r\nwin.addEventListener(\"DOMContentLoaded\", () => {\r\n\r\n    if (win.location.hash && win.location.hash.length > 1) {\r\n        _hashElement = win.document.getElementById(win.location.hash.substr(1));\r\n    }\r\n\r\n    resetInitialState();\r\n\r\n    injectDefaultCSS();\r\n\r\n    if (DEBUG_VISUALS) {\r\n        injectReadPosCSS();\r\n    }\r\n\r\n    // // DEBUG\r\n    // win.document.body.addEventListener(\"focus\", (ev: any) => {\r\n    //     console.log(\"focus:\");\r\n    //     console.log(ev.target);\r\n    // }, true);\r\n    // win.document.body.addEventListener(\"focusin\", (ev: any) => {\r\n    //     console.log(\"focusin:\");\r\n    //     console.log(ev.target);\r\n    // });\r\n    // // DEBUG\r\n\r\n    win.document.body.addEventListener(\"focusin\", (ev: any) => {\r\n        const isPaged = win.document.documentElement.classList.contains(\"readium-paginated\");\r\n        if (isPaged) {\r\n            setTimeout(() => {\r\n                _locationHashOverride = ev.target;\r\n                scrollIntoView(ev.target as HTMLElement);\r\n            }, 30);\r\n        }\r\n    });\r\n\r\n    win.document.addEventListener(\"click\", (e) => {\r\n        const href = (e.target as any).href;\r\n        if (!href) {\r\n            return;\r\n        }\r\n\r\n        // console.log(\"+++++\");\r\n        // console.log(href);\r\n\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n        ipcRenderer.sendToHost(R2_EVENT_LINK, href);\r\n        return false;\r\n    }, true);\r\n\r\n    // injectResizeSensor();\r\n\r\n    // const linkUri = new URI(win.location.href);\r\n    try {\r\n        if (queryParams) {\r\n            // tslint:disable-next-line:no-string-literal\r\n            const base64 = queryParams[\"readiumcss\"];\r\n            // if (!base64) {\r\n            //     console.log(\"!readiumcss BASE64 ??!\");\r\n            //     const token = \"readiumcss=\";\r\n            //     const i = win.location.search.indexOf(token);\r\n            //     if (i > 0) {\r\n            //         base64 = win.location.search.substr(i + token.length);\r\n            //         const j = base64.indexOf(\"&\");\r\n            //         if (j > 0) {\r\n            //             base64 = base64.substr(0, j);\r\n            //         }\r\n            //         base64 = decodeURIComponent(base64);\r\n            //     }\r\n            // }\r\n            if (base64) {\r\n                // console.log(base64);\r\n                const str = window.atob(base64);\r\n                // console.log(str);\r\n\r\n                const messageJson = JSON.parse(str);\r\n                // console.log(messageJson);\r\n\r\n                readiumCSS(messageJson);\r\n            }\r\n        }\r\n    } catch (err) {\r\n        console.log(err);\r\n    }\r\n});\r\n\r\nconst processXYRaw = (x: number, y: number) => {\r\n    // console.log(\"processXY: \" + x + \", \" + y);\r\n\r\n    // const elems = document.elementsFromPoint(x, y);\r\n    // // console.log(elems);\r\n    // let element: Element | undefined = elems && elems.length ? elems[0] : undefined;\r\n    let element: Element | undefined;\r\n\r\n    // if ((document as any).caretPositionFromPoint) {\r\n    //     console.log(\"caretPositionFromPoint\");\r\n    //     const range = (document as any).caretPositionFromPoint(x, y);\r\n    //     const node = range.offsetNode;\r\n    //     const offset = range.offset;\r\n    // } else if (document.caretRangeFromPoint) {\r\n    //     console.log(\"caretRangeFromPoint\");\r\n    // }\r\n\r\n    // let textNode: Node | undefined;\r\n    // let textNodeOffset = 0;\r\n\r\n    const range = document.caretRangeFromPoint(x, y);\r\n    if (range) {\r\n        const node = range.startContainer;\r\n        // const offset = range.startOffset;\r\n\r\n        if (node) {\r\n            if (node.nodeType === Node.ELEMENT_NODE) {\r\n                element = node as Element;\r\n            } else if (node.nodeType === Node.TEXT_NODE) {\r\n                // textNode = node;\r\n                // textNodeOffset = offset;\r\n                if (node.parentNode && node.parentNode.nodeType === Node.ELEMENT_NODE) {\r\n                    element = node.parentNode as Element;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    if (DEBUG_VISUALS) {\r\n        const existings = document.querySelectorAll(\".readium2-read-pos, .readium2-read-pos2\");\r\n        existings.forEach((existing) => {\r\n            existing.classList.remove(\"readium2-read-pos\");\r\n            existing.classList.remove(\"readium2-read-pos2\");\r\n        });\r\n    }\r\n    if (element) {\r\n        _locationHashOverride = element;\r\n        notifyReadingLocation();\r\n\r\n        // console.log(\"element.offsetTop: \" + (element as HTMLElement).offsetTop);\r\n        // console.log(\"element.getBoundingClientRect().top: \" + element.getBoundingClientRect().top);\r\n        // console.log(\"element.offsetLeft: \" + (element as HTMLElement).offsetLeft);\r\n        // console.log(\"element.getBoundingClientRect().left: \" + element.getBoundingClientRect().left);\r\n\r\n        if (DEBUG_VISUALS) {\r\n            element.classList.add(\"readium2-read-pos2\");\r\n\r\n            // // console.log(\"fullQualifiedSelector TRUE\");\r\n            // // const sel1 = fullQualifiedSelector(element, true);\r\n            // // console.log(sel1);\r\n\r\n            // // console.log(\"fullQualifiedSelector FALSE\");\r\n            // const sel2 = fullQualifiedSelector(element, false);\r\n            // // console.log(sel2);\r\n\r\n            // const selecteds = document.querySelectorAll(sel2);\r\n            // selecteds.forEach((selected) => {\r\n            //     selected.classList.remove(\"readium2-read-pos\");\r\n            //     selected.classList.add(\"readium2-read-pos2\");\r\n            // });\r\n        }\r\n    }\r\n};\r\nconst processXY = debounce((x: number, y: number) => {\r\n    processXYRaw(x, y);\r\n}, 300);\r\n\r\nconst notifyReadingLocation = () => {\r\n    if (!_locationHashOverride) {\r\n        return;\r\n    }\r\n\r\n    if (DEBUG_VISUALS) {\r\n        _locationHashOverride.classList.add(\"readium2-read-pos\");\r\n    }\r\n\r\n    _locationHashOverrideCSSselector = fullQualifiedSelector(_locationHashOverride, false);\r\n    ipcRenderer.sendToHost(R2_EVENT_READING_LOCATION, _locationHashOverrideCSSselector);\r\n};\r\n"]}