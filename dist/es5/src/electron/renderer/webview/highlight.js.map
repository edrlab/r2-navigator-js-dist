{"version":3,"file":"highlight.js","sourceRoot":"","sources":["../../../../../../src/electron/renderer/webview/highlight.ts"],"names":[],"mappings":"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","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport * as crypto from \"crypto\";\nimport * as debounce from \"debounce\";\nimport { ipcRenderer } from \"electron\";\n\nimport {\n    IEventPayload_R2_EVENT_HIGHLIGHT_CLICK, R2_EVENT_HIGHLIGHT_CLICK,\n} from \"../../common/events\";\nimport {\n    HighlightDrawTypeStrikethrough, HighlightDrawTypeUnderline, IColor, IHighlight,\n    IHighlightDefinition,\n} from \"../../common/highlight\";\nimport { isPaginated } from \"../../common/readium-css-inject\";\nimport { ISelectionInfo } from \"../../common/selection\";\nimport { VERBOSE, IRectSimple, getClientRectsNoOverlap, getBoundingRect, IRect, getTextClientRects, DOMRectListToArray } from \"../common/rect-utils\";\nimport { getScrollingElement, isVerticalWritingMode, isTwoPageSpread } from \"./readium-css\";\nimport { convertRangeInfo } from \"./selection\";\nimport { ReadiumElectronWebviewWindow } from \"./state\";\n\nimport { CLASS_HIGHLIGHT_CONTOUR, CLASS_HIGHLIGHT_CONTOUR_MARGIN, ID_HIGHLIGHTS_CONTAINER, CLASS_HIGHLIGHT_CONTAINER, CLASS_HIGHLIGHT_CURSOR2, CLASS_HIGHLIGHT_COMMON, CLASS_HIGHLIGHT_MARGIN, CLASS_HIGHLIGHT_HOVER } from \"../../common/styles\";\n\nimport { isRTL } from \"./readium-css\";\n\n// import offset from \"@flatten-js/polygon-offset\";\nimport {\nPolygon,\nBox,\nBooleanOperations,\nPoint,\nFace,\nORIENTATION,\n// Edge,\n// Segment,\n} from \"@flatten-js/core\";\nconst { unify } = BooleanOperations;\n\nconst IS_DEV = (process.env.NODE_ENV === \"development\" || process.env.NODE_ENV === \"dev\");\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\n(window as any).DEBUG_RECTS = IS_DEV && VERBOSE;\n\n//     const rgb = Math.round(0xffffff * Math.random());\n//     // tslint:disable-next-line:no-bitwise\n//     const r = rgb >> 16;\n//     // tslint:disable-next-line:no-bitwise\n//     const g = rgb >> 8 & 255;\n//     // tslint:disable-next-line:no-bitwise\n//     const b = rgb & 255;\n// rgb(${r}, ${g}, ${b});\n\nconst DEFAULT_BACKGROUND_COLOR: IColor = {\n    blue: 0,\n    green: 0,\n    red: 255,\n};\n\nconst _highlights: IHighlight[] = [];\n\nlet _drawMargin: boolean | string[] = false;\nconst drawMargin = (h: IHighlight) => {\n    if (Array.isArray(_drawMargin)) {\n        if (h.group) {\n            return _drawMargin.includes(h.group);\n        }\n        return false;\n    }\n    return _drawMargin;\n};\nexport const setDrawMargin = (win: ReadiumElectronWebviewWindow, drawMargin: boolean | string[]) => {\n    _drawMargin = drawMargin;\n    if (IS_DEV) {\n        console.log(\"--HIGH WEBVIEW-- _drawMargin: \" + JSON.stringify(_drawMargin, null, 4));\n    }\n    recreateAllHighlightsRaw(win);\n};\n\ninterface IWithRect {\n    rect: IRectSimple;\n    scale: number;\n    // xOffset: number;\n    // yOffset: number;\n}\ninterface IHTMLDivElementWithRect extends HTMLDivElement, IWithRect {\n}\n\ninterface IWithPolygon {\n    polygon: Polygon;\n}\nconst SVG_XML_NAMESPACE = \"http://www.w3.org/2000/svg\";\n// interface ISVGRectElementWithRect extends SVGRectElement, IWithRect {\n// }\n// interface ISVGLineElementWithRect extends SVGLineElement, IWithRect {\n// }\ninterface ISVGElementWithPolygon extends SVGSVGElement, IWithPolygon {\n}\n\n// interface IDocumentBody extends HTMLElement {\n//     _CachedBoundingClientRect: DOMRect | undefined;\n//     _CachedMargins: IRect | undefined;\n// }\nexport function getBoundingClientRectOfDocumentBody(win: ReadiumElectronWebviewWindow): DOMRect {\n    // TODO: does this need to be cached? (performance, notably during mouse hover)\n    return win.document.body.getBoundingClientRect();\n\n    // if (!(win.document.body as IDocumentBody)._CachedBoundingClientRect) {\n    //     (win.document.body as IDocumentBody)._CachedBoundingClientRect = win.document.body.getBoundingClientRect();\n    // }\n    // console.log(\"_CachedBoundingClientRect\",\n    //     JSON.stringify((win.document.body as IDocumentBody)._CachedBoundingClientRect));\n    // return (win.document.body as IDocumentBody)._CachedBoundingClientRect as DOMRect;\n}\n// export function invalidateBoundingClientRectOfDocumentBody(win: ReadiumElectronWebviewWindow) {\n//     (win.document.body as IDocumentBody)._CachedBoundingClientRect = undefined;\n// }\n// function getBodyMargin(win: ReadiumElectronWebviewWindow): IRect {\n//     const bodyStyle = win.getComputedStyle(win.document.body);\n//     if (!(win.document.body as IDocumentBody)._CachedMargins) {\n//         (win.document.body as IDocumentBody)._CachedMargins = {\n//             bottom: parseInt(bodyStyle.marginBottom, 10),\n//             height: 0,\n//             left: parseInt(bodyStyle.marginLeft, 10),\n//             right: parseInt(bodyStyle.marginRight, 10),\n//             top: parseInt(bodyStyle.marginTop, 10),\n//             width: 0,\n//         };\n//     }\n//     console.log(\"_CachedMargins\",\n//         JSON.stringify((win.document.body as IDocumentBody)._CachedMargins));\n//     return (win.document.body as IDocumentBody)._CachedMargins as IRect;\n// }\n\nfunction processMouseEvent(win: ReadiumElectronWebviewWindow, ev: MouseEvent) {\n\n    // const highlightsContainer = documant.getElementById(`${ID_HIGHLIGHTS_CONTAINER}`);\n    if (!_highlightsContainer) {\n        return;\n    }\n\n    const isMouseMove = ev.type === \"mousemove\";\n    if (isMouseMove) {\n        // no hit testing during user selection drag\n        if (ev.buttons > 0) {\n            return;\n        }\n\n        if (!_highlights.length) {\n            return;\n        }\n    }\n\n    const documant = win.document;\n    const scrollElement = getScrollingElement(documant);\n\n    // relative to fixed window top-left corner\n    // (unlike pageX/Y which is relative to top-left rendered content area, subject to scrolling)\n    const x = ev.clientX;\n    const y = ev.clientY;\n\n    const paginated = isPaginated(documant);\n\n    // COSTLY! TODO: cache DOMRect\n    const bodyRect = getBoundingClientRectOfDocumentBody(win);\n\n    const xOffset = paginated ? (-scrollElement.scrollLeft) : bodyRect.left;\n    const yOffset = paginated ? (-scrollElement.scrollTop) : bodyRect.top;\n\n    const scale = 1 / ((win.READIUM2 && win.READIUM2.isFixedLayout) ? win.READIUM2.fxlViewportScale : 1);\n\n    let hit = false;\n    let foundHighlight: IHighlight | undefined;\n    let foundElement: IHTMLDivElementWithRect | undefined;\n    // for (const highlight of _highlights) {\n    for (let i = _highlights.length - 1; i >= 0; i--) {\n        const highlight = _highlights[i];\n\n        let highlightParent = documant.getElementById(`${highlight.id}`);\n        if (!highlightParent) { // ??!!\n            highlightParent = _highlightsContainer.querySelector(`#${highlight.id}`); // .${CLASS_HIGHLIGHT_CONTAINER}\n        }\n        if (!highlightParent) { // what?\n            continue;\n        }\n\n        let highlightFragment = highlightParent.firstElementChild;\n        while (highlightFragment) {\n            if (highlightFragment.namespaceURI === SVG_XML_NAMESPACE) {\n\n                const svg = highlightFragment as ISVGElementWithPolygon;\n                hit = svg.polygon.contains(new Point((x - xOffset) * scale, (y - yOffset) * scale));\n                if (hit) {\n                    break;\n                }\n            }\n\n            highlightFragment = highlightFragment.nextElementSibling;\n        }\n\n        if (hit) {\n            foundHighlight = highlight;\n            foundElement = highlightParent as IHTMLDivElementWithRect;\n            break;\n        }\n    }\n\n    let highlightContainer = _highlightsContainer.firstElementChild;\n    while (highlightContainer) {\n        if (!foundElement || foundElement !== highlightContainer) {\n            highlightContainer.classList.remove(CLASS_HIGHLIGHT_HOVER);\n        }\n\n        // const id = highlightContainer.id || highlightContainer.getAttribute(\"id\");\n        // const highlight = id ? _highlights.find((h) => h.id === id) : undefined;\n        // const drawUnderline = highlight?.drawType === HighlightDrawTypeUnderline;\n        // const drawStrikeThrough = highlight?.drawType === HighlightDrawTypeStrikethrough;\n        // const doDrawMargin = highlight ? drawMargin(highlight) : false;\n\n        highlightContainer = highlightContainer.nextElementSibling;\n    }\n\n    if (!hit) { // !foundHighlight || !foundElement\n\n        // documant.documentElement.classList.remove(CLASS_HIGHLIGHT_CURSOR1);\n        documant.documentElement.classList.remove(CLASS_HIGHLIGHT_CURSOR2);\n        return;\n    }\n\n    if (foundElement && foundHighlight?.pointerInteraction) {\n\n        if (isMouseMove) {\n            foundElement.classList.add(CLASS_HIGHLIGHT_HOVER);\n\n            // const doDrawMargin = drawMargin(foundHighlight);\n            // documant.documentElement.classList.add(doDrawMargin ? CLASS_HIGHLIGHT_CURSOR1 : CLASS_HIGHLIGHT_CURSOR2);\n            documant.documentElement.classList.add(CLASS_HIGHLIGHT_CURSOR2);\n\n        } else if (ev.type === \"mouseup\" || ev.type === \"click\") {\n            // documant.documentElement.classList.remove(CLASS_HIGHLIGHT_CURSOR1);\n            documant.documentElement.classList.remove(CLASS_HIGHLIGHT_CURSOR2);\n\n            ev.preventDefault();\n            ev.stopPropagation();\n\n            const payload: IEventPayload_R2_EVENT_HIGHLIGHT_CLICK = {\n                highlight: foundHighlight,\n                event: {\n                    type: ev.type,\n                    button: ev.button,\n                    alt: ev.altKey,\n                    shift: ev.shiftKey,\n                    ctrl: ev.ctrlKey,\n                    meta: ev.metaKey,\n                    x: ev.clientX,\n                    y: ev.clientY,\n                },\n            };\n            ipcRenderer.sendToHost(R2_EVENT_HIGHLIGHT_CLICK, payload);\n        }\n    }\n}\n\nlet lastMouseDownX = -1;\nlet lastMouseDownY = -1;\nlet bodyEventListenersSet = false;\nlet _highlightsContainer: HTMLElement | null;\nfunction ensureHighlightsContainer(win: ReadiumElectronWebviewWindow): HTMLElement {\n    const documant = win.document;\n\n    if (!_highlightsContainer) {\n\n        // Note that legacy ResizeSensor sets body position to \"relative\" (default static).\n        // Also note that ReadiumCSS default to (via stylesheet :root):\n        // documant.documentElement.style.position = \"relative\";\n        // see styles.js (static CSS injection):\n        // documant.documentElement.style.setProperty(\"height\", \"100vh\", \"important\");\n        // documant.body.style.position = \"relative\";\n        // documant.body.style.setProperty(\"position\", \"relative\", \"important\");\n        // documant.body.style.height = \"inherit\";\n        // https://github.com/edrlab/thorium-reader/issues/1658\n\n        if (!bodyEventListenersSet) {\n            bodyEventListenersSet = true;\n\n            // reminder: mouseenter/mouseleave do not bubble, so no event delegation\n            // documant.body.addEventListener(\"click\", (ev: MouseEvent) => {\n            //     processMouseEvent(win, ev);\n            // }, false);\n            documant.body.addEventListener(\"mousedown\", (ev: MouseEvent) => {\n                lastMouseDownX = ev.clientX;\n                lastMouseDownY = ev.clientY;\n            }, false);\n            documant.body.addEventListener(\"mouseup\", (ev: MouseEvent) => {\n                if ((Math.abs(lastMouseDownX - ev.clientX) < 3) &&\n                    (Math.abs(lastMouseDownY - ev.clientY) < 3)) {\n                    processMouseEvent(win, ev);\n                }\n            }, false);\n            documant.body.addEventListener(\"mousemove\", (ev: MouseEvent) => {\n                processMouseEvent(win, ev);\n            }, false);\n        }\n\n        _highlightsContainer = documant.createElement(\"div\");\n        _highlightsContainer.setAttribute(\"id\", ID_HIGHLIGHTS_CONTAINER);\n        _highlightsContainer.setAttribute(\"class\", CLASS_HIGHLIGHT_COMMON);\n        _highlightsContainer.setAttribute(\"style\",\n            \"width: auto !important; \" +\n            \"height: auto !important; \");\n        documant.body.append(_highlightsContainer);\n    }\n    return _highlightsContainer;\n}\n\nexport function hideAllhighlights(_documant: Document) {\n    if (IS_DEV) {\n        console.log(\"--HIGH WEBVIEW-- hideAllhighlights: \" + _highlights.length);\n    }\n\n    if (_highlightsContainer) {\n        _highlightsContainer.remove();\n        _highlightsContainer = null;\n        // ensureHighlightsContainer(documant); LAZY\n    }\n}\n\nexport function destroyAllhighlights(documant: Document) {\n    if (IS_DEV) {\n        console.log(\"--HIGH WEBVIEW-- destroyAllhighlights: \" + _highlights.length);\n    }\n    hideAllhighlights(documant);\n    _highlights.splice(0, _highlights.length);\n}\n\nexport function destroyHighlight(documant: Document, id: string) {\n    if (IS_DEV) {\n        console.log(\"--HIGH WEBVIEW-- destroyHighlight: \" + id + \" ... \" + _highlights.length);\n    }\n    let i = -1;\n    const highlight = _highlights.find((h, j) => {\n        i = j;\n        return h.id === id;\n    });\n    if (highlight && i >= 0 && i < _highlights.length) {\n        _highlights.splice(i, 1);\n    }\n\n    const highlightContainer = documant.getElementById(id);\n    if (highlightContainer) {\n        highlightContainer.remove();\n    }\n}\n\nexport function destroyHighlightsGroup(documant: Document, group: string) {\n    if (IS_DEV) {\n        console.log(\"--HIGH WEBVIEW-- destroyHighlightsGroup: \" + group + \" ... \" + _highlights.length);\n    }\n    while (true) {\n        let i = -1;\n        const highlight = _highlights.find((h, j) => {\n            i = j;\n            return h.group === group;\n        });\n        if (highlight) {\n            if (i >= 0 && i < _highlights.length) {\n                _highlights.splice(i, 1);\n            }\n\n            const highlightContainer = documant.getElementById(highlight.id);\n            if (highlightContainer) {\n                highlightContainer.remove();\n            }\n        } else {\n            break;\n        }\n    }\n}\n\nexport function recreateAllHighlightsRaw(win: ReadiumElectronWebviewWindow, highlights?: IHighlight[]) {\n    if (IS_DEV) {\n        console.log(\"--HIGH WEBVIEW-- recreateAllHighlightsRaw: \" + _highlights.length + \" ==> \" + highlights?.length);\n    }\n\n    const documant = win.document;\n\n    if (highlights?.length) {\n        if (_highlights.length) {\n            if (IS_DEV) {\n                console.log(\"--HIGH WEBVIEW-- recreateAllHighlightsRaw DESTROY OLD BEFORE RESTORE BACKUP: \" + _highlights.length + \" ==> \" + highlights.length);\n            }\n            destroyAllhighlights(documant);\n        }\n        if (IS_DEV) {\n            console.log(\"--HIGH WEBVIEW-- recreateAllHighlightsRaw RESTORE BACKUP: \" + _highlights.length + \" ==> \" + highlights.length);\n        }\n        _highlights.push(...highlights);\n    }\n\n    if (!_highlights.length) {\n        return;\n    }\n\n    if (!documant.body) {\n        if (IS_DEV) {\n            console.log(\"--HIGH WEBVIEW-- NO BODY?! (retrying...): \" + _highlights.length);\n        }\n        recreateAllHighlightsDebounced(win);\n        return;\n    }\n\n    hideAllhighlights(documant);\n\n    const bodyRect = getBoundingClientRectOfDocumentBody(win);\n    const bodyComputedStyle = win.getComputedStyle(documant.body);\n\n    const docFrag = documant.createDocumentFragment();\n    for (const highlight of _highlights) {\n        const div = createHighlightDom(win, highlight, bodyRect, bodyComputedStyle);\n        if (div) {\n            docFrag.append(div);\n        }\n    }\n\n    const highlightsContainer = ensureHighlightsContainer(win);\n    highlightsContainer.append(docFrag);\n}\n\nexport const recreateAllHighlightsDebounced = debounce((win: ReadiumElectronWebviewWindow) => {\n    if (IS_DEV) {\n        console.log(\"--HIGH WEBVIEW-- recreateAllHighlightsDebounced: \" + _highlights.length);\n    }\n    recreateAllHighlightsRaw(win);\n}, 500);\n\nexport function recreateAllHighlights(win: ReadiumElectronWebviewWindow) {\n    if (IS_DEV) {\n        console.log(\"--HIGH WEBVIEW-- recreateAllHighlights: \" + _highlights.length);\n    }\n    hideAllhighlights(win.document);\n    recreateAllHighlightsDebounced(win);\n}\n\nexport function createHighlights(\n    win: ReadiumElectronWebviewWindow,\n    highDefs: IHighlightDefinition[],\n    pointerInteraction: boolean): Array<IHighlight | null> {\n    if (IS_DEV) {\n        console.log(\"--HIGH WEBVIEW-- createHighlights: \" + highDefs.length + \" ... \" + _highlights.length);\n    }\n\n    const documant = win.document;\n    const highlights: Array<IHighlight | null> = [];\n\n    const bodyRect = getBoundingClientRectOfDocumentBody(win);\n    const bodyComputedStyle = win.getComputedStyle(documant.body);\n\n    const docFrag = documant.createDocumentFragment();\n    for (const highDef of highDefs) {\n        if (!highDef.selectionInfo && !highDef.range) {\n            highlights.push(null);\n            continue;\n        }\n        const [high, div] = createHighlight(\n            win,\n            highDef.selectionInfo,\n            highDef.range,\n            highDef.color,\n            pointerInteraction,\n            highDef.drawType,\n            highDef.expand,\n            highDef.group,\n            bodyRect,\n            bodyComputedStyle);\n        highlights.push(high);\n\n        if (div) {\n            docFrag.append(div);\n        }\n    }\n\n    const highlightsContainer = ensureHighlightsContainer(win);\n    highlightsContainer.append(docFrag);\n\n    return highlights;\n}\n\nconst computeCFI = (node: Node): string | undefined => {\n\n    if (node.nodeType !== Node.ELEMENT_NODE) {\n        if (node.parentNode) {\n            return computeCFI(node.parentNode);\n        }\n        return undefined;\n    }\n\n    let cfi = \"\";\n\n    let currentElement = node as Element;\n    while (currentElement.parentNode && currentElement.parentNode.nodeType === Node.ELEMENT_NODE) {\n        const currentElementParentChildren = (currentElement.parentNode as Element).children;\n        let currentElementIndex = -1;\n        for (let i = 0; i < currentElementParentChildren.length; i++) {\n            if (currentElement === currentElementParentChildren[i]) {\n                currentElementIndex = i;\n                break;\n            }\n        }\n        if (currentElementIndex >= 0) {\n            const cfiIndex = (currentElementIndex + 1) * 2;\n            cfi = cfiIndex +\n                (currentElement.id ? (\"[\" + currentElement.id + \"]\") : \"\") +\n                (cfi.length ? (\"/\" + cfi) : \"\");\n        }\n        currentElement = currentElement.parentNode as Element;\n    }\n\n    return \"/\" + cfi;\n};\n\nexport function createHighlight(\n    win: ReadiumElectronWebviewWindow,\n    selectionInfo: ISelectionInfo | undefined,\n    range: Range | undefined,\n    color: IColor | undefined,\n    pointerInteraction: boolean,\n    drawType: number | undefined,\n    expand: number | undefined,\n    group: string | undefined,\n    bodyRect: DOMRect,\n    bodyComputedStyle: CSSStyleDeclaration): [IHighlight, HTMLDivElement | null] {\n\n    // tslint:disable-next-line:no-string-literal\n    // console.log(\"Chromium: \" + process.versions[\"chrome\"]);\n\n    const uniqueStr = selectionInfo ? `${selectionInfo.rangeInfo.startContainerElementCssSelector}${selectionInfo.rangeInfo.startContainerChildTextNodeIndex}${selectionInfo.rangeInfo.startOffset}${selectionInfo.rangeInfo.endContainerElementCssSelector}${selectionInfo.rangeInfo.endContainerChildTextNodeIndex}${selectionInfo.rangeInfo.endOffset}` : range ? `${range.startOffset}-${range.endOffset}-${computeCFI(range.startContainer)}-${computeCFI(range.endContainer)}` : \"_RANGE_\"; // ${selectionInfo.rangeInfo.cfi} useless\n\n    // console.log(\"RANGE uniqueStr: \" + uniqueStr + \" (( \" + range?.toString());\n\n    // const unique = Buffer.from(JSON.stringify(selectionInfo.rangeInfo, null, \"\")).toString(\"base64\");\n    // const unique = Buffer.from(uniqueStr).toString(\"base64\");\n    // const id = \"R2_HIGHLIGHT_\" + unique.replace(/\\+/, \"_\").replace(/=/, \"-\").replace(/\\//, \".\");\n    const checkSum = crypto.createHash(\"sha1\"); // sha256 slow\n    checkSum.update(uniqueStr);\n    const shaHex = checkSum.digest(\"hex\");\n    const idBase = \"R2_HIGHLIGHT_\" + shaHex;\n    let id = idBase;\n    let idIdx = 0;\n    while (\n        _highlights.find((h) => h.id === id) ||\n        win.document.getElementById(id)) {\n\n        if (IS_DEV) {\n            console.log(\"HIGHLIGHT ID already exists, increment: \" + uniqueStr + \" ==> \" + id);\n        }\n        id = `${idBase}_${idIdx++}`;\n    }\n\n    const highlight: IHighlight = {\n        color: color ? color : DEFAULT_BACKGROUND_COLOR,\n        drawType,\n        expand,\n        id,\n        pointerInteraction,\n        selectionInfo,\n        range,\n        group,\n    };\n    _highlights.push(highlight);\n\n    const div = createHighlightDom(win, highlight, bodyRect, bodyComputedStyle);\n    return [highlight, div];\n}\n\nfunction createHighlightDom(\n    win: ReadiumElectronWebviewWindow,\n    highlight: IHighlight,\n    bodyRect: DOMRect,\n    bodyComputedStyle: CSSStyleDeclaration): HTMLDivElement | null {\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const DEBUG_RECTS = (window as any).DEBUG_RECTS;\n\n    const documant = win.document;\n    const scrollElement = getScrollingElement(documant);\n\n    const range = highlight.selectionInfo ? convertRangeInfo(documant, highlight.selectionInfo.rangeInfo) : highlight.range;\n    if (!range) {\n        return null;\n    }\n\n    const drawUnderline = highlight.drawType === HighlightDrawTypeUnderline;\n    const drawStrikeThrough = highlight.drawType === HighlightDrawTypeStrikethrough;\n\n    const paginated = isPaginated(documant);\n\n    const rtl = isRTL();\n    const vertical = isVerticalWritingMode();\n\n    const doDrawMargin = drawMargin(highlight);\n\n    // checkRangeFix(documant);\n\n    // const highlightsContainer = ensureHighlightsContainer(win);\n\n    const highlightParent = documant.createElement(\"div\") as IHTMLDivElementWithRect;\n    highlightParent.setAttribute(\"id\", highlight.id);\n    highlightParent.setAttribute(\"class\", `${CLASS_HIGHLIGHT_CONTAINER} ${CLASS_HIGHLIGHT_COMMON}`);\n    highlightParent.setAttribute(\"data-type\", `${highlight.drawType}`);\n    if (highlight.group) {\n        highlightParent.setAttribute(\"data-group\", highlight.group);\n    }\n    if (doDrawMargin) {\n        // highlightParent.setAttribute(\"data-margin\", \"true\");\n        highlightParent.classList.add(CLASS_HIGHLIGHT_MARGIN);\n    }\n\n    const styleAttr = win.document.documentElement.getAttribute(\"style\");\n    const isNight = styleAttr ? styleAttr.indexOf(\"readium-night-on\") > 0 : false;\n    // const isSepia = styleAttr ? styleAttr.indexOf(\"readium-sepia-on\") > 0 : false;\n\n    highlightParent.style.setProperty(\n        \"mix-blend-mode\",\n        isNight ? \"hard-light\" : \"multiply\",\n        \"important\");\n\n    // const docStyle = (documant.defaultView as Window).getComputedStyle(documant.documentElement);\n    // const bodyStyle = (documant.defaultView as Window).getComputedStyle(documant.body);\n    // const marginLeft = bodyStyle.getPropertyValue(\"margin-left\");\n    // console.log(\"marginLeft: \" + marginLeft);\n    // const marginTop = bodyStyle.getPropertyValue(\"margin-top\");\n    // console.log(\"marginTop: \" + marginTop);\n\n    // console.log(\"==== bodyRect:\");\n    // console.log(\"width: \" + bodyRect.width);\n    // console.log(\"height: \" + bodyRect.height);\n    // console.log(\"top: \" + bodyRect.top);\n    // console.log(\"bottom: \" + bodyRect.bottom);\n    // console.log(\"left: \" + bodyRect.left);\n    // console.log(\"right: \" + bodyRect.right);\n\n    // const xOffset = paginated ? (bodyRect.left - parseInt(marginLeft, 10)) : bodyRect.left;\n    // const yOffset = paginated ? (bodyRect.top - parseInt(marginTop, 10)) : bodyRect.top;\n\n    const xOffset = paginated ? (-scrollElement.scrollLeft) : bodyRect.left;\n    const yOffset = paginated ? (-scrollElement.scrollTop) : bodyRect.top;\n\n    const scale = 1 / ((win.READIUM2 && win.READIUM2.isFixedLayout) ? win.READIUM2.fxlViewportScale : 1);\n    // const scale = 1;\n\n    // console.log(\"scrollElement.scrollLeft: \" + scrollElement.scrollLeft);\n    // console.log(\"scrollElement.scrollTop: \" + scrollElement.scrollTop);\n\n    const doNotMergeHorizontallyAlignedRects = drawUnderline || drawStrikeThrough;\n\n    let clientRects: IRect[] | undefined;\n\n    const rangeClientRects = DOMRectListToArray(range.getClientRects());\n\n    if (doNotMergeHorizontallyAlignedRects) {\n        // non-solid highlight (underline or strikethrough), cannot merge and reduce/simplify client rectangles much due to importance of line-level decoration (must preserve horizontal/vertical line heights)\n\n        const textClientRects = getTextClientRects(range);\n        const textReducedClientRects = getClientRectsNoOverlap(textClientRects, true, vertical, highlight.expand ? highlight.expand : 0);\n\n        clientRects = (DEBUG_RECTS && drawStrikeThrough) ? textClientRects : textReducedClientRects;\n\n        // const rangeReducedClientRects = getClientRectsNoOverlap(rangeClientRects, false, vertical, 0);\n\n        // // const rangeUnionPolygon = rangeReducedClientRects.reduce((previous, current) => unify(previous, new Polygon(new Box(current.left, current.top, current.left + current.width, current.top + current.height))), new Polygon());\n\n        // // Array.from(rangeUnionPolygon.faces).forEach((face: Face) => {\n        // //     if (face.orientation() !== ORIENTATION.CCW) {\n        // //         if (IS_DEV) {\n        // //             console.log(\"--HIGH WEBVIEW-- removing polygon clockwise face / inner hole (text range))\");\n        // //         }\n        // //         polygonCountourUnionPoly.deleteFace(face);\n        // //     }\n        // // });\n\n        // const textReducedClientRectsToKeep: IRect[] = [];\n        // textReducedClientRectsToKeep.push(...textReducedClientRects);\n\n        // for (const rect of textReducedClientRects) {\n        //     console.log(\"__RECT__ text :: \" + `TOP:${rect.top} BOTTOM:${rect.bottom} LEFT:${rect.left} RIGHT:${rect.right} WIDTH:${rect.width} HEIGHT:${rect.height}`);\n\n        //     let intersections: IRect[] | undefined;\n        //     for (const rectRange of rangeReducedClientRects) {\n        //         console.log(\"__RECT__ range :: \" + `TOP:${rect.top} BOTTOM:${rect.bottom} LEFT:${rect.left} RIGHT:${rect.right} WIDTH:${rect.width} HEIGHT:${rect.height}`);\n        //         const rectIntersection = rectIntersect(rect, rectRange);\n        //         const hasIntersection = rectIntersection.width > 0 || rectIntersection.height > 0;\n        //         if (!hasIntersection) {\n        //             console.log(\"__RECT__ no intersect\");\n        //             continue;\n        //         }\n        //         console.log(\"__RECT__ intersect :: \" + `TOP:${rectIntersection.top} BOTTOM:${rectIntersection.bottom} LEFT:${rectIntersection.left} RIGHT:${rectIntersection.right} WIDTH:${rectIntersection.width} HEIGHT:${rectIntersection.height}`);\n        //         if (!intersections) {\n        //             intersections = [];\n        //         }\n        //         intersections.push(rectIntersection);\n        //     }\n\n        //     if (!intersections?.length) {\n        //         console.log(\"__RECT__ zero intersect, eject rect\");\n        //         textReducedClientRectsToKeep.splice(textReducedClientRectsToKeep.indexOf(rect), 1);\n        //     } else {\n        //         const intersectionsBoundingBox = intersections.reduce((previous, current) => {\n        //             if (current === previous) {\n        //                 return current;\n        //             }\n        //             return getBoundingRect(previous, current);\n        //         }, intersections[0]);\n\n        //         console.log(\"__RECT__ intersect bounds :: \" + `TOP:${intersectionsBoundingBox.top} BOTTOM:${intersectionsBoundingBox.bottom} LEFT:${intersectionsBoundingBox.left} RIGHT:${intersectionsBoundingBox.right} WIDTH:${intersectionsBoundingBox.width} HEIGHT:${intersectionsBoundingBox.height}`);\n\n        //         if (!rectSame(intersectionsBoundingBox, rect, 2)) {\n        //             console.log(\"__RECT__ rect different than intersect bounds, replace\");\n        //             textReducedClientRectsToKeep.splice(textReducedClientRectsToKeep.indexOf(rect), 1, intersectionsBoundingBox);\n        //         }\n        //     }\n\n        //     // const rectPolygon = new Polygon(new Box(rect.left, rect.top, rect.left + rect.width, rect.top + rect.height));\n\n        //     // const poly = intersect(rangeUnionPolygon, rectPolygon);\n        //     // const b = poly.box; // shortcut, but we could check polygon faces too\n\n        //     // if (rect.left !== b.xmin || rect.top !== b.ymin || rect.right !== b.xmax || rect.bottom !== b.ymax) {\n        //     //     console.log(\"__RECT__ before\" + `TOP:${rect.top} BOTTOM:${rect.bottom} LEFT:${rect.left} RIGHT:${rect.right} WIDTH:${rect.width} HEIGHT:${rect.height}`);\n\n        //     //     rect.left = b.xmin;\n        //     //     rect.top = b.ymin;\n        //     //     rect.right = b.xmax;\n        //     //     rect.bottom = b.ymax;\n        //     //     rect.width = b.width;\n        //     //     rect.height = b.height;\n\n        //     //     console.log(\"__RECT__ after\" + `TOP:${rect.top} BOTTOM:${rect.bottom} LEFT:${rect.left} RIGHT:${rect.right} WIDTH:${rect.width} HEIGHT:${rect.height}`);\n        //     // }\n        // }\n\n        // console.log(\"__RECT__ :: \" + textClientRects.length + \" ===> \" + textReducedClientRectsToKeep.length);\n\n        // clientRects = (DEBUG_RECTS && drawStrikeThrough) ? textClientRects : textReducedClientRectsToKeep;\n    } else {\n        // solid highlight, can merge and reduce/simplify client rectangles as much as possible\n        clientRects = getClientRectsNoOverlap(rangeClientRects, false, vertical, highlight.expand ? highlight.expand : 0);\n    }\n\n    // let highlightAreaSVGDocFrag: DocumentFragment | undefined;\n    // const roundedCorner = 3;\n\n    const underlineThickness = 3;\n    const strikeThroughLineThickness = 4;\n\n    // const rangeBoundingClientRect = range.getBoundingClientRect();\n\n    const bodyWidth = parseInt(bodyComputedStyle.width, 10);\n    const paginatedTwo = paginated && isTwoPageSpread();\n    const paginatedWidth = scrollElement.clientWidth / (paginatedTwo ? 2 : 1);\n    const paginatedOffset = (paginatedWidth - bodyWidth) / 2 + parseInt(bodyComputedStyle.paddingLeft, 10);\n\n    const gap = 2;\n    const boxesNoGapExpanded = [];\n    const boxesGapExpanded = [];\n\n    for (const clientRect of clientRects) {\n\n        const rect = {\n            height: clientRect.height,\n            left: clientRect.left - xOffset,\n            top: clientRect.top - yOffset,\n            width: clientRect.width,\n        };\n        const w = rect.width * scale;\n        const h = rect.height * scale;\n        const x = rect.left * scale;\n        const y = rect.top * scale;\n\n        boxesGapExpanded.push(new Box(\n            Number((x - gap).toPrecision(12)),\n            Number((y - gap).toPrecision(12)),\n            Number((x + w + gap).toPrecision(12)),\n            Number((y + h + gap).toPrecision(12)),\n        ));\n\n        // boxesNoGapExpanded.push(new Box(\n        //     Number((x).toPrecision(12)),\n        //     Number((y).toPrecision(12)),\n        //     Number((x + w).toPrecision(12)),\n        //     Number((y + h).toPrecision(12)),\n        // ));\n\n        if (drawStrikeThrough) {\n\n            const thickness = DEBUG_RECTS ? (vertical ? rect.width : rect.height) : strikeThroughLineThickness;\n            const ww = (vertical ? thickness : rect.width) * scale;\n            const hh = (vertical ? rect.height : thickness) * scale;\n            const xx =\n            (\n            vertical\n            ?\n            (\n                DEBUG_RECTS\n                ?\n                rect.left\n                :\n                (rect.left + (rect.width / 2) - (thickness / 2))\n            )\n            :\n            rect.left\n            ) * scale;\n\n            const yy =\n            (\n            vertical\n            ?\n            rect.top\n            :\n            (\n                DEBUG_RECTS\n                ?\n                rect.top\n                :\n                (rect.top + (rect.height / 2) - (thickness / 2))\n            )\n            ) * scale;\n\n            boxesNoGapExpanded.push(new Box(\n                Number((xx).toPrecision(12)),\n                Number((yy).toPrecision(12)),\n                Number((xx + ww).toPrecision(12)),\n                Number((yy + hh).toPrecision(12)),\n            ));\n\n        } else { // drawStrikeThrough\n\n            const thickness = DEBUG_RECTS ? (vertical ? rect.width : rect.height) : underlineThickness;\n            if (drawUnderline) {\n                const ww = (vertical ? thickness : rect.width) * scale;\n                const hh = (vertical ? rect.height : thickness) * scale;\n                const xx =\n                (\n                vertical\n                ?\n                (\n                    DEBUG_RECTS\n                    ?\n                    rect.left\n                    :\n                    (rect.left - (thickness / 2))\n                )\n                :\n                rect.left\n                ) * scale;\n\n                const yy =\n                (\n                vertical\n                ?\n                rect.top\n                :\n                (\n                    DEBUG_RECTS\n                    ?\n                    rect.top\n                    :\n                    (rect.top + rect.height - (thickness / 2))\n                )\n                ) * scale;\n\n                boxesNoGapExpanded.push(new Box(\n                    Number((xx).toPrecision(12)),\n                    Number((yy).toPrecision(12)),\n                    Number((xx + ww).toPrecision(12)),\n                    Number((yy + hh).toPrecision(12)),\n                ));\n            } else {\n                boxesNoGapExpanded.push(new Box(\n                    Number((x).toPrecision(12)),\n                    Number((y).toPrecision(12)),\n                    Number((x + w).toPrecision(12)),\n                    Number((y + h).toPrecision(12)),\n                ));\n            }\n        }\n    }\n\n    const polygonCountourUnionPoly = boxesGapExpanded.reduce((previous, current) => unify(previous, new Polygon(current)), new Polygon());\n\n    Array.from(polygonCountourUnionPoly.faces).forEach((face: Face) => {\n        if (face.orientation() !== ORIENTATION.CCW) {\n            if (IS_DEV) {\n                console.log(\"--HIGH WEBVIEW-- removing polygon clockwise face / inner hole (contour))\");\n            }\n            polygonCountourUnionPoly.deleteFace(face);\n        }\n    });\n\n    let polygonSurface: Polygon | Polygon[] | undefined;\n    if (doNotMergeHorizontallyAlignedRects) {\n        const singleSVGPath = !DEBUG_RECTS;\n        if (singleSVGPath) {\n            polygonSurface = new Polygon();\n            for (const box of boxesNoGapExpanded) {\n                polygonSurface.addFace(box);\n            }\n        } else {\n            polygonSurface = [];\n            for (const box of boxesNoGapExpanded) {\n                const poly = new Polygon();\n                poly.addFace(box);\n                polygonSurface.push(poly);\n            }\n        }\n    } else {\n        polygonSurface = boxesNoGapExpanded.reduce((previous, current) => unify(previous, new Polygon(current)), new Polygon());\n\n        Array.from(polygonSurface.faces).forEach((face: Face) => {\n            if (face.orientation() !== ORIENTATION.CCW) {\n                if (IS_DEV) {\n                    console.log(\"--HIGH WEBVIEW-- removing polygon clockwise face / inner hole (surface))\");\n                }\n                (polygonSurface as Polygon).deleteFace(face);\n            }\n        });\n    }\n\n    // const offsetPolygon = offset(polygonCountour, -gap);\n\n    // const highlightAreaSVGDocFrag = documant.createDocumentFragment();\n    // highlightAreaSVGDocFrag.appendChild(highlightAreaSVGRect);\n    // const highlightAreaSVGG = documant.createElementNS(SVG_XML_NAMESPACE, \"g\");\n    // highlightAreaSVGG.appendChild(highlightAreaSVGDocFrag);\n    const highlightAreaSVG = documant.createElementNS(SVG_XML_NAMESPACE, \"svg\") as ISVGElementWithPolygon;\n    highlightAreaSVG.setAttribute(\"class\", `${CLASS_HIGHLIGHT_COMMON} ${CLASS_HIGHLIGHT_CONTOUR}`);\n\n    // highlightAreaSVG.polygon = polygonSurface;\n    highlightAreaSVG.polygon = polygonCountourUnionPoly; // TODO: gap expansion too generous for hit testing?\n\n    // highlightAreaSVG.append((new DOMParser()​​.parseFromString(`<svg xmlns=\"${SVG_XML_NAMESPACE}\">${polys.svg()}</svg>`, \"image/svg+xml\")).firstChild);\n    highlightAreaSVG.innerHTML =\n    (\n    Array.isArray(polygonSurface)\n    ?\n    polygonSurface.reduce((prev, cur) => {\n        return prev + cur.svg({\n            fill: DEBUG_RECTS ? \"pink\" : `rgb(${highlight.color.red}, ${highlight.color.green}, ${highlight.color.blue})`,\n            fillRule: \"evenodd\",\n            stroke: DEBUG_RECTS ? \"magenta\" : \"transparent\",\n            strokeWidth: DEBUG_RECTS ? 1 : 0,\n            fillOpacity: 1,\n            className: undefined,\n            // r: 4,\n        });\n    }, \"\")\n    :\n    polygonSurface.svg({\n        fill: DEBUG_RECTS ? \"yellow\" : `rgb(${highlight.color.red}, ${highlight.color.green}, ${highlight.color.blue})`,\n        fillRule: \"evenodd\",\n        stroke: DEBUG_RECTS ? \"green\" : \"transparent\",\n        strokeWidth: DEBUG_RECTS ? 1 : 0,\n        fillOpacity: 1,\n        className: undefined,\n        // r: 4,\n    })\n    )\n    +\n    polygonCountourUnionPoly.svg({\n        fill: \"transparent\",\n        fillRule: \"evenodd\",\n        stroke: DEBUG_RECTS ? \"red\" : \"transparent\",\n        strokeWidth: DEBUG_RECTS ? 1 : 1,\n        fillOpacity: 1,\n        className: undefined,\n        // r: 4,\n    })\n    ;\n\n    highlightParent.append(highlightAreaSVG);\n\n    // const boxes = Array.from(polygon.edges).map((edge: Edge) => {\n    //     const shape = edge.shape as Segment;\n    //     const ps = shape.ps as Point;\n    //     const pe = shape.pe as Point;\n    //     return new Box(\n    //         Math.min(ps.x, pe.x),\n    //         Math.min(ps.y, pe.y),\n    //         Math.max(ps.x, pe.x),\n    //         Math.max(ps.y, pe.y),\n    //     );\n    // });\n    // // box.xmin / box.ymin\n    // // box.width / box.height\n\n    if (doDrawMargin && highlight.pointerInteraction) {\n        const MARGIN_MARKER_THICKNESS = 14 * (win.READIUM2.isFixedLayout ? scale : 1);\n        const MARGIN_MARKER_OFFSET = 6 * (win.READIUM2.isFixedLayout ? scale : 1);\n        const paginatedOffset_ = paginatedOffset - MARGIN_MARKER_OFFSET - MARGIN_MARKER_THICKNESS;\n\n        let boundingRect: IRect | IRect[] | undefined;\n        const polygonCountourMarginRects = Array.from(polygonCountourUnionPoly.faces).map((face: Face) => {\n            const b = face.box;\n            const left =\n                // ----\n                vertical ?\n                b.xmin :\n                // ----\n                paginated ?\n                (\n                    (rtl\n                    ?\n                    paginatedWidth - MARGIN_MARKER_THICKNESS // - MARGIN_MARKER_OFFSET\n                    :\n                    0 // MARGIN_MARKER_OFFSET\n                    )\n                    +\n                    (rtl\n                    ?\n                    -1 * paginatedOffset_\n                    :\n                    paginatedOffset_\n                    )\n                    +\n                    Math.floor((b.xmin) / paginatedWidth) * paginatedWidth\n                )\n                :\n                // ---- scroll\n                (rtl\n                ?\n                MARGIN_MARKER_OFFSET + bodyRect.width - parseInt(bodyComputedStyle.paddingRight, 10)\n                :\n                win.READIUM2.isFixedLayout\n                ?\n                MARGIN_MARKER_OFFSET\n                :\n                parseInt(bodyComputedStyle.paddingLeft, 10) - MARGIN_MARKER_THICKNESS - MARGIN_MARKER_OFFSET\n                );\n            const top =\n                vertical\n                ?\n                parseInt(bodyComputedStyle.paddingTop, 10) - MARGIN_MARKER_THICKNESS - MARGIN_MARKER_OFFSET\n                :\n                b.ymin;\n            const width = vertical ? b.width : MARGIN_MARKER_THICKNESS;\n            const height = vertical ? MARGIN_MARKER_THICKNESS : b.height;\n\n            const extra = 0;\n            // const extra = paginated ? 2 : 0; // useful to union-join small gaps, but here we are able to compute groups of bounding boxes so that in column-paginated mode when crossing over page boundaries there is no gigantic bounding box.\n\n            const r: IRect = {\n                left: left - (vertical ? extra : 0),\n                top: top - (vertical ? 0 : extra),\n                right: left + width + (vertical ? extra : 0),\n                bottom: top + height + (vertical ? 0 : extra),\n                width: width + extra * 2,\n                height: height + extra * 2,\n            };\n\n            boundingRect = boundingRect ? getBoundingRect(boundingRect as IRect, r) : r;\n\n            return r;\n        });\n\n        const useFastBoundingRect = true; // we never union-join the polygons, instead we group possible rectangle bounding boxes together to allow fragmentation across page boundaries\n        let polygonMarginUnionPoly: Polygon | undefined;\n        if (paginated) {\n            const tolerance = 1;\n            const groups: Array<{\n                x: number,\n                boxes: IRect[],\n            }> = [];\n            for (const r of polygonCountourMarginRects) {\n                const group = groups.find((g) => {\n                    return !(r.left < (g.x - tolerance) || r.left > (g.x + tolerance));\n                });\n\n                if (!group) {\n                    groups.push({\n                        x: r.left,\n                        boxes: [r],\n                    });\n                } else {\n                    group.boxes?.push(r);\n                }\n            }\n\n            // console.log(\"XX RECTS: \" + polygonCountourMarginRects.length);\n            // console.log(JSON.stringify(polygonCountourMarginRects, null, 4));\n            // console.log(\"XX GROUPS: \" + groups.length);\n            // groups.forEach((g) => console.log(JSON.stringify(g.boxes, null, 4)));\n\n            boundingRect = groups.map<IRect>((g) => {\n                return g.boxes.reduce((prev, cur) => {\n                    if (prev === cur) {\n                        return cur;\n                    }\n                    return getBoundingRect(prev, cur);\n                }, g.boxes[0]);\n            });\n            if (boundingRect.length === 1) {\n                boundingRect = boundingRect[0];\n            }\n        }\n\n        if (useFastBoundingRect) {\n            if (boundingRect) {\n                polygonMarginUnionPoly = new Polygon();\n                if (Array.isArray(boundingRect)) {\n                    for (const b of boundingRect) {\n                        polygonMarginUnionPoly.addFace(new Box(b.left, b.top, b.right, b.bottom));\n                    }\n                } else {\n                    polygonMarginUnionPoly.addFace(new Box(boundingRect.left, boundingRect.top, boundingRect.right, boundingRect.bottom));\n                }\n            } else {\n                const poly = new Polygon();\n                for (const r of polygonCountourMarginRects) {\n                    poly.addFace(new Box(r.left, r.top, r.right, r.bottom));\n                }\n                polygonMarginUnionPoly = new Polygon();\n                polygonMarginUnionPoly.addFace(poly.box);\n            }\n        } else {\n            polygonMarginUnionPoly = polygonCountourMarginRects.reduce((previous, r) => unify(previous, new Polygon(new Box(r.left, r.top, r.right, r.bottom))), new Polygon());\n\n            // Array.from(polygonMarginUnionPoly.faces).forEach((face: Face) => {\n            //     if (face.orientation() !== ORIENTATION.CCW) {\n            //         if (IS_DEV) {\n            //             console.log(\"--HIGH WEBVIEW-- removing polygon clockwise face / inner hole (margin))\");\n            //         }\n            //         (polygonMarginUnionPoly as Polygon).deleteFace(face);\n            //     }\n            // });\n        }\n\n        const highlightMarginSVG = documant.createElementNS(SVG_XML_NAMESPACE, \"svg\") as ISVGElementWithPolygon;\n        highlightMarginSVG.setAttribute(\"class\", `${CLASS_HIGHLIGHT_COMMON} ${CLASS_HIGHLIGHT_CONTOUR_MARGIN}`);\n        highlightMarginSVG.polygon = polygonMarginUnionPoly as Polygon;\n        highlightMarginSVG.innerHTML = (polygonMarginUnionPoly as Polygon).svg({\n            fill: `rgb(${highlight.color.red}, ${highlight.color.green}, ${highlight.color.blue})`,\n            fillRule: \"evenodd\",\n            stroke: \"transparent\",\n            strokeWidth: 0,\n            // stroke: \"magenta\",\n            // strokeWidth: 1,\n            fillOpacity: 1,\n            className: undefined,\n            // r: 4,\n        });\n\n        highlightParent.append(highlightMarginSVG);\n    }\n\n    return highlightParent;\n}\n"]}