{"version":3,"file":"location.js","sourceRoot":"","sources":["../../../../../src/electron/renderer/location.ts"],"names":[],"mappings":"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","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport * as debug_ from \"debug\";\nimport { ipcRenderer, shell } from \"electron\";\nimport * as path from \"path\";\nimport { URL } from \"url\";\n\nimport { Locator, LocatorLocations } from \"@r2-shared-js/models/locator\";\nimport { PageEnum, Properties, SpreadEnum } from \"@r2-shared-js/models/metadata-properties\";\nimport { Link } from \"@r2-shared-js/models/publication-link\";\nimport { encodeURIComponent_RFC3986 } from \"@r2-utils-js/_utils/http/UrlUtils\";\n\nimport { DEBUG_AUDIO, IAudioPlaybackInfo } from \"../common/audiobook\";\nimport { IDocInfo } from \"../common/document\";\nimport {\n    IEventPayload_R2_EVENT_AUDIO_PLAYBACK_RATE, IEventPayload_R2_EVENT_LINK,\n    IEventPayload_R2_EVENT_LOCATOR_VISIBLE, IEventPayload_R2_EVENT_PAGE_TURN,\n    IEventPayload_R2_EVENT_READING_LOCATION, IEventPayload_R2_EVENT_READIUMCSS,\n    IEventPayload_R2_EVENT_SCROLLTO, IEventPayload_R2_EVENT_SHIFT_VIEW_X,\n    R2_EVENT_AUDIO_PLAYBACK_RATE, R2_EVENT_LINK, R2_EVENT_LOCATOR_VISIBLE, R2_EVENT_PAGE_TURN,\n    R2_EVENT_PAGE_TURN_RES, R2_EVENT_READING_LOCATION, R2_EVENT_SCROLLTO, R2_EVENT_SHIFT_VIEW_X,\n} from \"../common/events\";\nimport { IwidthHeight } from \"../common/fxl\";\nimport { IPaginationInfo } from \"../common/pagination\";\nimport { READIUM2_BASEURL_ID, readiumCssTransformHtml } from \"../common/readium-css-inject\";\nimport { IRangeInfo, ISelectionInfo } from \"../common/selection\";\nimport {\n    READIUM2_ELECTRON_HTTP_PROTOCOL, convertCustomSchemeToHttpUrl, convertHttpUrlToCustomScheme,\n} from \"../common/sessions\";\nimport {\n    AUDIO_BODY_ID, AUDIO_BUFFER_CANVAS_ID, AUDIO_CONTROLS_ID, AUDIO_COVER_ID, AUDIO_FORWARD_ID,\n    AUDIO_ID, AUDIO_NEXT_ID, AUDIO_PERCENT_ID, AUDIO_PLAYPAUSE_ID, AUDIO_PREVIOUS_ID, AUDIO_RATE_ID,\n    AUDIO_REWIND_ID, AUDIO_SECTION_ID, AUDIO_SLIDER_ID, AUDIO_TIME_ID, AUDIO_TITLE_ID,\n    WebViewSlotEnum,\n} from \"../common/styles\";\nimport { getCurrentAudioPlaybackRate, setCurrentAudioPlaybackRate } from \"./audiobook\";\nimport {\n    URL_PARAM_CLIPBOARD_INTERCEPT, URL_PARAM_CSS, URL_PARAM_DEBUG_VISUALS,\n    URL_PARAM_EPUBREADINGSYSTEM, URL_PARAM_GOTO, URL_PARAM_GOTO_DOM_RANGE, URL_PARAM_PREVIOUS,\n    URL_PARAM_REFRESH, URL_PARAM_SECOND_WEBVIEW, URL_PARAM_SESSION_INFO, URL_PARAM_WEBVIEW_SLOT,\n} from \"./common/url-params\";\nimport { getEpubReadingSystemInfo } from \"./epubReadingSystem\";\nimport { mediaOverlaysInterrupt } from \"./media-overlays\";\nimport {\n    adjustReadiumCssJsonMessageForFixedLayout, isFixedLayout, isRTL, obtainReadiumCss,\n} from \"./readium-css\";\nimport { IReadiumElectronBrowserWindow, IReadiumElectronWebview } from \"./webview/state\";\n\nimport URI = require(\"urijs\");\nconst debug = debug_(\"r2:navigator#electron/renderer/location\");\n\nconst IS_DEV = (process.env.NODE_ENV === \"development\" || process.env.NODE_ENV === \"dev\");\n\nconst win = window as IReadiumElectronBrowserWindow;\n\nconst webviewStyleCommon = \"display: flex; border: 0; margin: 0; padding: 0; box-sizing: border-box; position: absolute; \";\n\nconst webviewStyleLeft = \"opacity: 0; \" + webviewStyleCommon + \"left: 0; width: 50%; bottom: 0; top: 0;\";\nconst webviewStyleRight = \"opacity: 0; \" + webviewStyleCommon + \"left: 50%; right: 0; bottom: 0; top: 0;\";\nconst webviewStyleCenter = \"opacity: 0; \" + webviewStyleCommon + \"left: 0; right: 0; bottom: 0; top: 0;\";\n\nconst webviewStyleLeft_ = \"opacity: 1; \" + webviewStyleCommon +\n    \"left: 0; top: calc(0 - max(var(--R2_FXL_Y_SHIFT), var(--R2_FXL_Y_SHIFT_)));\";\n\nconst webviewStyleRight_ = \"opacity: 1; \" + webviewStyleCommon +\n    \"left: calc(50% - var(--R2_FXL_X_SHIFT));\" +\n    \"top: calc(0 - max(var(--R2_FXL_Y_SHIFT), var(--R2_FXL_Y_SHIFT_)));\";\n\nconst webviewStyleCenter_ = \"opacity: 1; \" + webviewStyleCommon +\n    \"left: 0; top: calc(0 - var(--R2_FXL_Y_SHIFT));\";\n\nexport function setWebViewStyle(wv: IReadiumElectronWebview, wvSlot: WebViewSlotEnum, fxl?: IwidthHeight | null) {\n\n    const v = fxl ? JSON.stringify(fxl).replace(/{/g, \"\").replace(/}/g, \"\").replace(/\"/g, \"\") : \"NO FXL\";\n    debug(\"setWebViewStyle fxl: \" + v);\n\n    if (fxl) {\n\n        let wvSlot_ = wv.getAttribute(\"data-wv-slot\") as WebViewSlotEnum;\n        if (!wvSlot_) {\n            wvSlot_ = wvSlot;\n        }\n\n        // fxl.tx can only be negative for WebViewSlotEnum.left and WebViewSlotEnum.center\n        // (WebViewSlotEnum.right is always aligned on the middle line of the spread)\n        const tx = fxl.tx >= 0 ? fxl.tx : 0;\n        if (wvSlot_ === WebViewSlotEnum.left || wvSlot_ === WebViewSlotEnum.center) {\n            win.document.documentElement.style.setProperty(\"--R2_FXL_X_SHIFT\", fxl.tx >= 0 ? \"0px\" : `${fxl.tx}px`);\n        }\n\n        // fxl.ty can be negative for WebViewSlotEnum.left/right/center\n        const ty = fxl.ty >= 0 ? fxl.ty : 0;\n        win.document.documentElement.style.setProperty(\n            (wvSlot_ === WebViewSlotEnum.left || wvSlot_ === WebViewSlotEnum.center) ? \"--R2_FXL_Y_SHIFT\" : \"--R2_FXL_Y_SHIFT_\",\n            fxl.ty >= 0 ? \"0px\" : `${fxl.ty}px`);\n\n        // tslint:disable-next-line:max-line-length\n        const cxx = ` width:${fxl.width * fxl.scale}px; height:${fxl.height * fxl.scale}px; transform-origin: 0 0; transform: translate(${tx}px, ${ty}px) scale(${\"1\"});`;\n        wv.setAttribute(\"style\",\n            wvSlot_ === WebViewSlotEnum.center ? webviewStyleCenter_ + cxx :\n                (wvSlot_ === WebViewSlotEnum.left ? webviewStyleLeft_ + cxx :\n                webviewStyleRight_ + cxx),\n        );\n\n        wv.setAttribute(\"data-wv-fxl\", v);\n    } else {\n        wv.setAttribute(\"style\",\n            wvSlot === WebViewSlotEnum.center ? webviewStyleCenter :\n                (wvSlot === WebViewSlotEnum.left ? webviewStyleLeft :\n                webviewStyleRight),\n        );\n\n        wv.removeAttribute(\"data-wv-fxl\");\n\n        wv.setAttribute(\"data-wv-slot\",\n            wvSlot === WebViewSlotEnum.center ? \"center\" :\n                (wvSlot === WebViewSlotEnum.left ? \"left\" :\n                \"right\"),\n        );\n    }\n}\n\nexport function locationHandleIpcMessage(\n    eventChannel: string,\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    eventArgs: any[],\n    eventCurrentTarget: IReadiumElectronWebview): boolean {\n\n    const activeWebView = eventCurrentTarget;\n\n    if (eventChannel === R2_EVENT_LOCATOR_VISIBLE) {\n        // noop\n    } else if (eventChannel === R2_EVENT_SHIFT_VIEW_X) {\n        shiftWebview(activeWebView,\n            (eventArgs[0] as IEventPayload_R2_EVENT_SHIFT_VIEW_X).offset,\n            (eventArgs[0] as IEventPayload_R2_EVENT_SHIFT_VIEW_X).backgroundColor);\n    } else if (eventChannel === R2_EVENT_PAGE_TURN_RES) {\n        const publication = win.READIUM2.publication;\n        const publicationURL = win.READIUM2.publicationURL;\n        if (!publication) {\n            return true;\n        }\n\n        const payload = eventArgs[0] as IEventPayload_R2_EVENT_PAGE_TURN;\n\n        const doNothing = payload.go === \"\" && payload.direction === \"\";\n        if (doNothing) {\n            return true;\n        }\n\n        const goPREVIOUS = payload.go === \"PREVIOUS\"; // any other value is NEXT\n\n        if (!activeWebView.READIUM2.link) {\n            debug(\"WEBVIEW READIUM2_LINK ??!!\");\n            return true;\n        }\n\n        let nextOrPreviousSpineItem: Link | undefined;\n        if (publication.Spine) {\n            for (let i = 0; i < publication.Spine.length; i++) {\n                if (publication.Spine[i] === activeWebView.READIUM2.link) {\n                    if (goPREVIOUS && (i - 1) >= 0) {\n                        nextOrPreviousSpineItem = publication.Spine[i - 1];\n                    } else if (!goPREVIOUS && (i + 1) < publication.Spine.length) {\n                        nextOrPreviousSpineItem = publication.Spine[i + 1];\n                    }\n                    break;\n                }\n            }\n        }\n        if (!nextOrPreviousSpineItem) {\n            return true;\n        }\n        if (publicationURL) {\n            const uri = new URL(nextOrPreviousSpineItem.Href, publicationURL);\n            uri.hash = \"\";\n            uri.search = \"\";\n            const urlNoQueryParams = uri.toString(); // publicationURL + \"/../\" + nextOrPreviousSpineItem.Href;\n            debug(`locationHandleIpcMessage R2_EVENT_PAGE_TURN_RES: ${urlNoQueryParams}`);\n            // NOTE that decodeURIComponent() must be called on the toString'ed URL urlNoQueryParams\n            // tslint:disable-next-line:max-line-length\n            // (in case nextOrPreviousSpineItem.Href contains Unicode characters, in which case they get percent-encoded by the URL.toString())\n            handleLink(\n                urlNoQueryParams,\n                goPREVIOUS,\n                false,\n                activeWebView.READIUM2.readiumCss,\n            );\n        }\n    } else if (eventChannel === R2_EVENT_READING_LOCATION) {\n        const payload = eventArgs[0] as IEventPayload_R2_EVENT_READING_LOCATION;\n\n        // if (!payload.userInteract) {\n        //     let linkFirst: Link | undefined;\n        //     let linkSecond: Link | undefined;\n        //     const firstWebView = win.READIUM2.getFirstWebView();\n        //     if (firstWebView) {\n        //         linkFirst = firstWebView.READIUM2.link;\n        //     }\n        //     const secondWebView = win.READIUM2.getSecondWebView(false);\n        //     if (secondWebView) {\n        //         linkSecond = secondWebView.READIUM2.link;\n        //     }\n        //     if (linkFirst && linkSecond && win.READIUM2.publication.Spine) {\n        //         const indexFirst = win.READIUM2.publication.Spine.indexOf(linkFirst);\n        //         const indexSecond = win.READIUM2.publication.Spine.indexOf(linkSecond);\n        //         if (indexSecond >= 0 && indexFirst >= 0) {\n        //             const firstLink = indexSecond < indexFirst ? linkSecond : linkFirst;\n        //             if (// payload.href is nil\n        //                 activeWebView.READIUM2.link?.Href && activeWebView.READIUM2.link?.Href !== firstLink.Href) {\n        //                 debug(`R2_EVENT_READING_LOCATION skipped spread ${activeWebView.READIUM2.link?.Href}`);\n        //                 return true;\n        //             }\n        //         }\n        //     }\n        // }\n\n        if (activeWebView.READIUM2.link) {\n            // TODO: position metrics, based on arbitrary number of characters (1034)\n            // https://github.com/readium/architecture/tree/master/positions\n            // https://github.com/readium/architecture/tree/master/locators#about-the-notion-of-position\n            // https://github.com/readium/architecture/blob/master/locators/locator-api.md\n            // if (typeof payload.progression !== \"undefined\" && _publication && activeWebView.READIUM2.link) {\n            //     const totalPositions = _publication.getTotalPositions(activeWebView.READIUM2.link);\n            //     if (totalPositions) {\n            //         payload.position = totalPositions * payload.progression;\n            //         const totalSpinePositions = _publication.getTotalSpinePositions();\n            //         if (totalSpinePositions) {\n            //             payload.globalProgression = payload.position / totalSpinePositions;\n            //         }\n            //     }\n            // }\n            _saveReadingLocation(activeWebView.READIUM2.link.Href, payload);\n        }\n    } else if (eventChannel === R2_EVENT_LINK) {\n        // debug(\"R2_EVENT_LINK (webview.addEventListener('ipc-message')\");\n        const payload = eventArgs[0] as IEventPayload_R2_EVENT_LINK;\n        debug(`locationHandleIpcMessage R2_EVENT_LINK: ${payload.url}`);\n        let href = payload.url;\n\n        if (!/^(https?|thoriumhttps):\\/\\//.test(href) &&\n            !href.startsWith((READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\")) &&\n            activeWebView.READIUM2.link) {\n\n            const sourceUrl = new URL(activeWebView.READIUM2.link.Href, win.READIUM2.publicationURL);\n            const destUrl = new URL(href, sourceUrl);\n            href = destUrl.toString();\n            debug(`R2_EVENT_LINK ABSOLUTE-ized: ${href}`);\n        }\n\n        handleLinkUrl(href, activeWebView.READIUM2.readiumCss);\n    } else if (eventChannel === R2_EVENT_AUDIO_PLAYBACK_RATE) {\n        // debug(\"R2_EVENT_AUDIO_PLAYBACK_RATE (webview.addEventListener('ipc-message')\");\n        const payload = eventArgs[0] as IEventPayload_R2_EVENT_AUDIO_PLAYBACK_RATE;\n        setCurrentAudioPlaybackRate(payload.speed);\n    } else {\n        return false;\n    }\n    return true;\n}\n\n// see webview.addEventListener(\"ipc-message\", ...)\n// needed for main process browserWindow.webContents.send()\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nipcRenderer.on(R2_EVENT_LINK, (_event: any, payload: IEventPayload_R2_EVENT_LINK) => {\n    debug(\"R2_EVENT_LINK (ipcRenderer.on)\");\n    debug(payload.url);\n\n    const activeWebView = win.READIUM2.getFirstOrSecondWebView();\n    handleLinkUrl(\n        payload.url,\n        activeWebView ? activeWebView.READIUM2.readiumCss : undefined);\n});\n\nexport function shiftWebview(webview: IReadiumElectronWebview, offset: number, backgroundColor: string | undefined) {\n    if (!offset) {\n        webview.style.transform = \"none\";\n        // if (_slidingViewport) {\n        //     _slidingViewport.style.backgroundColor = \"white\";\n        // }\n    } else {\n        // console.log(`backgroundColor:::::::::: ${backgroundColor}`);\n        if (backgroundColor) {\n            const domSlidingViewport = win.READIUM2.domSlidingViewport;\n            domSlidingViewport.style.backgroundColor = backgroundColor;\n        }\n        webview.style.transform = `translateX(${offset}px)`;\n    }\n}\n\nexport function navLeftOrRight(\n    left: boolean,\n    spineNav?: boolean,\n    ignorePageSpreadHandling?: boolean,\n    ): Link | undefined {\n\n    const publication = win.READIUM2.publication;\n    const publicationURL = win.READIUM2.publicationURL;\n    if (!publication || !publicationURL) {\n        return undefined;\n    }\n\n    if (!publication.Spine) {\n        return undefined;\n    }\n\n    // metadata-level RTL\n    const rtl = isRTL();\n\n    // const goPrevious = left && !rtl || !left && rtl;\n    const goPREVIOUS = left ? !rtl : rtl;\n\n    const loc = _lastSavedReadingLocation; // getCurrentReadingLocation()\n    let href = loc ? loc.locator.href : undefined;\n\n    if (!ignorePageSpreadHandling) {\n        let linkFirst: Link | undefined;\n        let linkSecond: Link | undefined;\n        const firstWebView = win.READIUM2.getFirstWebView();\n        if (firstWebView) {\n            linkFirst = firstWebView.READIUM2.link;\n        }\n        const secondWebView = win.READIUM2.getSecondWebView(false);\n        if (secondWebView) {\n            linkSecond = secondWebView.READIUM2.link;\n        }\n        if (linkFirst && linkSecond) {\n            const indexFirst = publication.Spine.indexOf(linkFirst);\n            const indexSecond = publication.Spine.indexOf(linkSecond);\n            if (indexSecond >= 0 && indexFirst >= 0) {\n                const boundaryLink = indexSecond < indexFirst ?\n                    (goPREVIOUS ? linkSecond : linkFirst) :\n                    (goPREVIOUS ? linkFirst : linkSecond);\n\n                debug(`navLeftOrRight spineNav = true force ${href} => ${boundaryLink.Href}`);\n                spineNav = true;\n                href = boundaryLink.Href;\n            }\n        }\n    }\n\n    if (spineNav) {\n        if (!href) {\n            return undefined;\n        }\n\n        if (IS_DEV) {\n            // document-level RTL\n            const rtl_ = loc ? (loc.docInfo && loc.docInfo.isRightToLeft) : rtl;\n            if (rtl_ !== rtl) {\n                debug(`RTL differ?! METADATA ${rtl} vs. DOCUMENT ${rtl_}`);\n            }\n        }\n\n        // array boundaries overflow are checked further down ...\n        const offset = (left ? -1 : 1) * (rtl ? -1 : 1);\n\n        const currentSpineIndex = publication.Spine.findIndex((link) => {\n            return link.Href === href;\n        });\n        if (currentSpineIndex >= 0) {\n            const spineIndex = currentSpineIndex + offset;\n\n            // array boundaries overflow are checked here:\n            if (spineIndex >= 0 && spineIndex <= (publication.Spine.length - 1)) {\n                const nextOrPreviousSpineItem = publication.Spine[spineIndex];\n\n                // handleLinkUrl(publicationURL + \"/../\" + nextOrPreviousSpineItem.Href);\n\n                const uri = new URL(nextOrPreviousSpineItem.Href, publicationURL);\n                uri.hash = \"\";\n                uri.search = \"\";\n                const urlNoQueryParams = uri.toString(); // publicationURL + \"/../\" + nextOrPreviousSpineItem.Href;\n                // NOTE that decodeURIComponent() must be called on the toString'ed URL urlNoQueryParams\n                // tslint:disable-next-line:max-line-length\n                // (in case nextOrPreviousSpineItem.Href contains Unicode characters, in which case they get percent-encoded by the URL.toString())\n                const activeWebView = win.READIUM2.getFirstOrSecondWebView();\n                debug(`navLeftOrRight: ${urlNoQueryParams}`);\n                handleLink(\n                    urlNoQueryParams,\n                    goPREVIOUS,\n                    false,\n                    activeWebView ? activeWebView.READIUM2.readiumCss : undefined,\n                );\n\n                return nextOrPreviousSpineItem;\n            } else {\n                shell.beep(); // announce boundary overflow (first or last Spine item)\n            }\n        }\n        mediaOverlaysInterrupt(); // done in handleLink() -> loadLink()\n    } else {\n        mediaOverlaysInterrupt();\n\n        const payload: IEventPayload_R2_EVENT_PAGE_TURN = {\n            direction: rtl ? \"RTL\" : \"LTR\",\n            go: goPREVIOUS ? \"PREVIOUS\" : \"NEXT\",\n        };\n        const activeWebView = win.READIUM2.getFirstOrSecondWebView();\n        if (activeWebView) {\n            setTimeout(async () => {\n                await activeWebView.send(R2_EVENT_PAGE_TURN, payload); // .getWebContents()\n            }, 0);\n        }\n    }\n\n    return undefined;\n}\n\nexport function handleLink(\n    href: string,\n    previous: boolean | undefined,\n    useGoto: boolean,\n    rcss?: IEventPayload_R2_EVENT_READIUMCSS,\n) {\n    debug(`handleLink: ${href}`);\n\n    const special = href.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\");\n    if (special) {\n        debug(\"handleLink R2 URL\");\n        const okay = loadLink(href, previous, useGoto, rcss);\n        if (!okay) {\n            debug(`Readium link fail?! ${href}`);\n        }\n    } else {\n        debug(\"handleLink non-R2 URL\");\n        const okay = loadLink(href, previous, useGoto, rcss);\n        if (!okay) {\n            if (/^https?:\\/\\/127\\.0\\.0\\.1/.test(href)) { // href.startsWith(\"https://127.0.0.1\")\n                debug(`Internal link, fails to match publication document: ${href}`);\n            } else {\n                debug(`External link: ${href}`);\n\n                // tslint:disable-next-line:no-floating-promises\n                (async () => {\n                    try {\n                        await shell.openExternal(href);\n                    } catch (err) {\n                        debug(err);\n                    }\n                })();\n            }\n        }\n    }\n}\n\nexport function handleLinkUrl(\n    href: string,\n    rcss?: IEventPayload_R2_EVENT_READIUMCSS,\n) {\n    debug(`handleLinkUrl: ${href}`);\n\n    handleLink(href, undefined, false, rcss);\n}\n\nexport function handleLinkLocator(\n    location: Locator | undefined,\n    rcss?: IEventPayload_R2_EVENT_READIUMCSS,\n    rangeInfo?: IRangeInfo,\n) {\n    const publication = win.READIUM2.publication;\n    const publicationURL = win.READIUM2.publicationURL;\n\n    if (!publication || !publicationURL) {\n        return;\n    }\n\n    let linkToLoad: Link | undefined;\n    let linkToLoadGoto: LocatorLocations | undefined;\n    if (location && location.href) {\n        if (publication.Spine && publication.Spine.length) {\n            linkToLoad = publication.Spine.find((spineLink) => {\n                return spineLink.Href === location.href;\n            });\n            if (linkToLoad && location.locations) {\n                linkToLoadGoto = location.locations;\n            }\n        }\n        if (!linkToLoad &&\n            publication.Resources && publication.Resources.length) {\n            linkToLoad = publication.Resources.find((resLink) => {\n                return resLink.Href === location.href;\n            });\n            if (linkToLoad && location.locations) {\n                linkToLoadGoto = location.locations;\n            }\n        }\n    }\n    if (!linkToLoad) {\n        debug(`handleLinkLocator FAIL ${publicationURL} + ${location ? location.href : \"NIL\"}`);\n    }\n    if (!linkToLoad) {\n        if (publication.Spine && publication.Spine.length) {\n            const firstLinear = publication.Spine[0];\n            if (firstLinear) {\n                linkToLoad = firstLinear;\n            }\n        }\n    }\n    if (linkToLoad) {\n        const useGoto = typeof linkToLoadGoto !== \"undefined\"\n            // && typeof linkToLoadGoto.cssSelector !== \"undefined\"\n            ;\n        const uri = new URL(linkToLoad.Href, publicationURL);\n        uri.hash = \"\";\n        uri.search = \"\";\n        const urlNoQueryParams = uri.toString(); // publicationURL + \"/../\" + linkToLoad.Href;\n        const hrefToLoad = urlNoQueryParams +\n            (useGoto ? (\"?\" + URL_PARAM_GOTO + \"=\" +\n                encodeURIComponent_RFC3986(Buffer.from(JSON.stringify(linkToLoadGoto, null, \"\")).toString(\"base64\"))) :\n                \"\") +\n            ((useGoto && rangeInfo) ? (\"&\" + URL_PARAM_GOTO_DOM_RANGE + \"=\" +\n                encodeURIComponent_RFC3986(Buffer.from(JSON.stringify(rangeInfo, null, \"\")).toString(\"base64\"))) :\n                \"\");\n\n        debug(`handleLinkLocator: ${hrefToLoad}`);\n        // NOTE that decodeURIComponent() must be called on the toString'ed URL hrefToLoad\n        // tslint:disable-next-line:max-line-length\n        // (in case linkToLoad.Href contains Unicode characters, in which case they get percent-encoded by the URL.toString())\n        handleLink(hrefToLoad, undefined, useGoto, rcss);\n    }\n}\n\nlet _reloadCounter = 0;\nexport function reloadContent() {\n    const activeWebViews = win.READIUM2.getActiveWebViews();\n    for (const activeWebView of activeWebViews) {\n        reloadWebView(activeWebView);\n    }\n}\nfunction reloadWebView(activeWebView: IReadiumElectronWebview) {\n\n    setTimeout(() => {\n        // const src = activeWebView.getAttribute(\"src\");\n        activeWebView.READIUM2.forceRefresh = true;\n        if (activeWebView.READIUM2.link) {\n            const uri = new URL(activeWebView.READIUM2.link.Href,\n                win.READIUM2.publicationURL);\n            uri.hash = \"\";\n            uri.search = \"\";\n            const urlNoQueryParams = uri.toString();\n            debug(`reloadContent: ${urlNoQueryParams}`);\n            handleLinkUrl(urlNoQueryParams, activeWebView.READIUM2.readiumCss);\n        }\n        // activeWebView.reloadIgnoringCache();\n    }, 0);\n}\n\nfunction loadLink(\n    hrefToLoad: string,\n    previous: boolean | undefined,\n    useGoto: boolean,\n    rcss: IEventPayload_R2_EVENT_READIUMCSS | undefined,\n    secondWebView?: boolean,\n    ): boolean {\n\n    const publication = win.READIUM2.publication;\n    const publicationURL = win.READIUM2.publicationURL;\n    if (!publication || !publicationURL) {\n        return false;\n    }\n\n    mediaOverlaysInterrupt();\n\n    let hrefToLoadHttp = hrefToLoad;\n    if (hrefToLoadHttp.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\")) {\n        hrefToLoadHttp = convertCustomSchemeToHttpUrl(hrefToLoadHttp);\n    }\n\n    const pubIsServedViaSpecialUrlProtocol = publicationURL.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\");\n\n    const publicationURLHttp = pubIsServedViaSpecialUrlProtocol ?\n        convertCustomSchemeToHttpUrl(publicationURL) : publicationURL;\n\n    const hrefToLoadHttpObj = new URL(hrefToLoadHttp);\n    hrefToLoadHttpObj.hash = \"\";\n    hrefToLoadHttpObj.search = \"\";\n    const publicationURLHttpObj = new URL(publicationURLHttp);\n    publicationURLHttpObj.hash = \"\";\n    publicationURLHttpObj.search = \"\";\n    const rootPath = publicationURLHttpObj.pathname.replace(/manifest\\.json$/, \"\");\n    let linkPath = hrefToLoadHttpObj.pathname.replace(rootPath, \"\");\n\n    // let linkPath: string | undefined;\n    // let iBreak = -1;\n    // for (let i = 0; i < publicationURLHttpObj.pathname.length; i++) {\n    //     const c1 = publicationURLHttpObj.pathname[i];\n    //     if (i < hrefToLoadHttpObj.pathname.length) {\n    //         const c2 = hrefToLoadHttpObj.pathname[i];\n    //         if (c1 !== c2) {\n    //             iBreak = i;\n    //             break;\n    //         }\n    //     } else {\n    //         break;\n    //     }\n    // }\n    // if (iBreak > 0) {\n    //     linkPath = hrefToLoadHttpObj.pathname.substr(iBreak);\n    // }\n    // if (!linkPath) {\n    //     debug(`R2LOADLINK?? ${hrefToLoad} ... ${publicationURL} !!! ${hrefToLoadHttp} ... ${publicationURLHttp}`);\n    //     return false;\n    // }\n\n    // because URL.toString() percent-encodes Unicode characters in the path!\n    linkPath = decodeURIComponent(linkPath);\n\n    debug(`R2LOADLINK: ${hrefToLoad} ... ${publicationURL} ==> ${linkPath}`);\n\n    // const pubUri = new URI(pubJsonUri);\n    // // \"/pub/BASE64_PATH/manifest.json\" ==> \"/pub/BASE64_PATH/\"\n    // const pathPrefix = decodeURIComponent(pubUri.path().replace(\"manifest.json\", \"\"));\n    // // \"/pub/BASE64_PATH/epub/chapter.html\" ==> \"epub/chapter.html\"\n    // const normPath = decodeURIComponent(linkUri.normalizePath().path());\n    // const linkPath = normPath.replace(pathPrefix, \"\");\n\n    let pubLink = publication.Spine ? publication.Spine.find((spineLink) => {\n        return spineLink.Href === linkPath;\n    }) : undefined;\n    if (!pubLink && publication.Resources) {\n        pubLink = publication.Resources.find((resLink) => {\n            return resLink.Href === linkPath;\n        });\n    }\n    if (!pubLink) {\n        let hrefToLoadHttpNoHash: string | undefined;\n        try {\n            const hrefToLoadHttpObjUri = new URI(hrefToLoadHttp);\n            hrefToLoadHttpObjUri.hash(\"\").normalizeHash();\n            // TODO: urijs types broke this! (lib remains unchanged)\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\n            (hrefToLoadHttpObjUri as any).search((data: any) => {\n                // overrides existing (leaves others intact)\n                data[URL_PARAM_PREVIOUS] = undefined;\n                data[URL_PARAM_GOTO] = undefined;\n                data[URL_PARAM_GOTO_DOM_RANGE] = undefined;\n                data[URL_PARAM_CSS] = undefined;\n                data[URL_PARAM_EPUBREADINGSYSTEM] = undefined;\n                data[URL_PARAM_DEBUG_VISUALS] = undefined;\n                data[URL_PARAM_CLIPBOARD_INTERCEPT] = undefined;\n                data[URL_PARAM_REFRESH] = undefined;\n                data[URL_PARAM_WEBVIEW_SLOT] = undefined;\n                data[URL_PARAM_SECOND_WEBVIEW] = undefined;\n            });\n            hrefToLoadHttpNoHash = hrefToLoadHttpObjUri.toString();\n        } catch (err) {\n            debug(err);\n        }\n        if (hrefToLoadHttpNoHash) {\n            pubLink = publication.Spine ? publication.Spine.find((spineLink) => {\n                return spineLink.Href === hrefToLoadHttpNoHash;\n            }) : undefined;\n            if (!pubLink && publication.Resources) {\n                pubLink = publication.Resources.find((resLink) => {\n                    return resLink.Href === hrefToLoadHttpNoHash;\n                });\n            }\n        }\n        if (!pubLink) {\n            // tslint:disable-next-line: max-line-length\n            debug(`CANNOT LOAD EXT LINK ${hrefToLoad} ... ${publicationURL} --- (${hrefToLoadHttpNoHash}) ==> ${linkPath}`);\n            return false;\n        }\n    }\n\n    if (!pubLink) {\n        debug(`CANNOT LOAD LINK ${hrefToLoad} ... ${publicationURL} ==> ${linkPath}`);\n        return false;\n    }\n\n    if (!secondWebView) {\n        win.document.documentElement.style.setProperty(\"--R2_FXL_X_SHIFT\", \"0px\");\n        win.document.documentElement.style.setProperty(\"--R2_FXL_Y_SHIFT\", \"0px\");\n        win.document.documentElement.style.setProperty(\"--R2_FXL_Y_SHIFT_\", \"0px\");\n    }\n\n    const webview1 = win.READIUM2.getFirstWebView();\n    const webview2 = win.READIUM2.getSecondWebView(false);\n\n    const webviewSpreadSwap = secondWebView ?\n        (webview2 && webview1 && webview1.READIUM2.link === pubLink) :\n        (webview2 && webview2.READIUM2.link === pubLink);\n\n    // if (!webviewSpreadSwap) {\n    //     if (webview1 && webview1.READIUM2.link && isFixedLayout(webview1.READIUM2.link)) {\n    //         setTimeout(async () => {\n    //             const webview1_ = win.READIUM2.getFirstWebView();\n    //             if (webview1_ && webview1_.READIUM2.link && isFixedLayout(webview1_.READIUM2.link)) {\n    //                 await webview1_.send(\"R2_EVENT_HIDE\", true);\n    //             }\n    //         }, 0);\n    //     }\n    //     if (webview2 && webview2.READIUM2.link && isFixedLayout(webview2.READIUM2.link)) {\n    //         setTimeout(async () => {\n    //             const webview2_ = win.READIUM2.getSecondWebView(false);\n    //             if (webview2_ && webview2_.READIUM2.link && isFixedLayout(webview2_.READIUM2.link)) {\n    //                 await webview2_.send(\"R2_EVENT_HIDE\", true);\n    //             }\n    //         }, 0);\n    //     }\n    // }\n\n    const secondWebViewWasJustCreated = secondWebView && !webviewSpreadSwap && !webview2;\n    const activeWebView = webviewSpreadSwap ?\n        (secondWebView ? webview1 : win.READIUM2.getSecondWebView(true)) :\n        (secondWebView ? win.READIUM2.getSecondWebView(true) : webview1);\n\n    const actualReadiumCss = (activeWebView && activeWebView.READIUM2.readiumCss) ?\n        activeWebView.READIUM2.readiumCss :\n        obtainReadiumCss(rcss);\n    if (activeWebView) {\n        activeWebView.READIUM2.readiumCss = actualReadiumCss;\n    }\n\n    const fileName = path.basename(linkPath);\n    const ext = path.extname(fileName);\n    const isAudio =\n        publication.Metadata &&\n        publication.Metadata.RDFType &&\n        /https?:\\/\\/schema\\.org\\/Audiobook$/.test(publication.Metadata.RDFType) &&\n        ((pubLink.TypeLink && pubLink.TypeLink.startsWith(\"audio/\")) ||\n        // fallbacks:\n        /\\.mp[3|4]$/i.test(ext) ||\n        /\\.wav$/i.test(ext) ||\n        /\\.aac$/i.test(ext) ||\n        /\\.og[g|b|a]$/i.test(ext) ||\n        /\\.aiff$/i.test(ext) ||\n        /\\.wma$/i.test(ext) ||\n        /\\.flac$/i.test(ext));\n\n    let webViewSlot = WebViewSlotEnum.center;\n\n    let loadingSecondWebView: Link | undefined;\n\n    const linkIndex = publication.Spine ? publication.Spine.indexOf(pubLink) : -1;\n    if (publication.Spine && // to satisfy the compiler ... implied by linkIndex >= 0\n        linkIndex >= 0 &&\n        isFixedLayout(pubLink)) {\n\n        const rtl = isRTL();\n\n        const publicationSpreadNone = publication.Metadata?.Rendition?.Spread === SpreadEnum.None;\n        const slotOfFirstPageInSpread = rtl ? PageEnum.Right : PageEnum.Left;\n        const slotOfSecondPageInSpread = slotOfFirstPageInSpread === PageEnum.Right ? PageEnum.Left : PageEnum.Right;\n\n        publication.Spine.forEach((spineLink, i) => {\n            if (!isFixedLayout(spineLink)) {\n                // eslint-disable-next-line @typescript-eslint/no-explicit-any\n                (spineLink as any).__notInSpread = true;\n                if (!spineLink.Properties) {\n                    spineLink.Properties = new Properties();\n                }\n                spineLink.Properties.Page = PageEnum.Center;\n                return; // continue\n            }\n            const linkSpreadNone = spineLink.Properties?.Spread === SpreadEnum.None;\n            const linkSpreadOther = !linkSpreadNone && spineLink.Properties?.Spread;\n            const notInSpread = linkSpreadNone || (publicationSpreadNone && !linkSpreadOther);\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\n            (spineLink as any).__notInSpread = notInSpread;\n            if (spineLink.Properties?.Page &&\n                spineLink.Properties.Page !== PageEnum.Left &&\n                spineLink.Properties.Page !== PageEnum.Right) {\n\n                    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n                (spineLink as any).__notInSpread = true;\n            }\n            if (!spineLink.Properties?.Page) {\n                if (!spineLink.Properties) {\n                    spineLink.Properties = new Properties();\n                }\n                if (i === 0) {\n                    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n                    (spineLink as any).__notInSpread = true;\n                    spineLink.Properties.Page = notInSpread ? PageEnum.Center : slotOfSecondPageInSpread;\n                } else {\n                    const firstPageInSpread = publication.Spine && // to satisfy the compiler\n                        publication.Spine[i - 1].Properties?.Page !== slotOfFirstPageInSpread;\n                    spineLink.Properties.Page = notInSpread ? PageEnum.Center :\n                        (firstPageInSpread ? slotOfFirstPageInSpread : slotOfSecondPageInSpread);\n                }\n            }\n        });\n\n        const prev = previous ? true : false;\n        const page = pubLink.Properties?.Page;\n        if (page === PageEnum.Left) {\n            webViewSlot = WebViewSlotEnum.left;\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\n            if (!secondWebView && !(pubLink as any).__notInSpread) {\n                const otherIndex = linkIndex + (rtl ? -1 : 1);\n                const otherLink = publication.Spine[otherIndex];\n                // eslint-disable-next-line @typescript-eslint/no-explicit-any\n                if (otherLink && !(otherLink as any).__notInSpread &&\n                    otherLink.Properties?.Page === PageEnum.Right) {\n\n                    const needToInverse = !webviewSpreadSwap &&\n                        prev && publication.Spine.indexOf(pubLink) > otherIndex;\n\n                    const otherLinkURLObj = new URL(otherLink.Href, publicationURL);\n                    otherLinkURLObj.hash = \"\";\n                    otherLinkURLObj.search = \"\";\n                    loadingSecondWebView = otherLink;\n                    loadLink(\n                        otherLinkURLObj.toString(),\n                        undefined, // previous\n                        false, // useGoto\n                        rcss,\n                        needToInverse ? false : true, // secondWebView\n                    );\n                    if (needToInverse) {\n                        return true;\n                    }\n                }\n            }\n            if (activeWebView) {\n                debug(\"loadLink LEFT ... setWebViewStyle\");\n                setWebViewStyle(activeWebView, WebViewSlotEnum.left);\n            }\n        } else if (page === PageEnum.Right) {\n            webViewSlot = WebViewSlotEnum.right;\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\n            if (!secondWebView && !(pubLink as any).__notInSpread) {\n                const otherIndex = linkIndex + (!rtl ? -1 : 1);\n                const otherLink = publication.Spine[otherIndex];\n                // eslint-disable-next-line @typescript-eslint/no-explicit-any\n                if (otherLink && !(otherLink as any).__notInSpread &&\n                    otherLink.Properties?.Page === PageEnum.Left) {\n\n                    const needToInverse = !webviewSpreadSwap &&\n                        prev && publication.Spine.indexOf(pubLink) > otherIndex;\n\n                    const otherLinkURLObj = new URL(otherLink.Href, publicationURL);\n                    otherLinkURLObj.hash = \"\";\n                    otherLinkURLObj.search = \"\";\n                    loadingSecondWebView = otherLink;\n                    loadLink(\n                        otherLinkURLObj.toString(),\n                        undefined, // previous\n                        false, // useGoto\n                        rcss,\n                        needToInverse ? false : true, // secondWebView\n                    );\n                    if (needToInverse) {\n                        return true;\n                    }\n                }\n            }\n            if (activeWebView) {\n                debug(\"loadLink RIGHT ... setWebViewStyle\");\n                setWebViewStyle(activeWebView, WebViewSlotEnum.right);\n            }\n        } else {\n            webViewSlot = WebViewSlotEnum.center;\n            if (activeWebView) {\n                debug(\"loadLink CENTER ... setWebViewStyle\");\n                setWebViewStyle(activeWebView, WebViewSlotEnum.center);\n            }\n        }\n    }\n\n    if (!secondWebView && !loadingSecondWebView && !webviewSpreadSwap) {\n        win.READIUM2.destroySecondWebView();\n    }\n\n    const rcssJson = adjustReadiumCssJsonMessageForFixedLayout(activeWebView, actualReadiumCss);\n\n    const rcssJsonstr = JSON.stringify(rcssJson, null, \"\");\n    const rcssJsonstrBase64 = Buffer.from(rcssJsonstr).toString(\"base64\");\n\n    // Note that with URI (unlike URL) if hrefToLoadHttp contains Unicode characters,\n    // the toString() function does not percent-encode them.\n    // But also note that if hrefToLoadHttp is already percent-encoded, this is returned as-is!\n    // (i.e. do not expect toString() to output Unicode chars from their escaped notation)\n    // See decodeURIComponent() above,\n    // which is necessary in cases where loadLink() is called with URL.toString() for hrefToLoadHttp\n    // ... which it is!\n    const hrefToLoadHttpUri = new URI(hrefToLoadHttp);\n    if (isAudio) {\n        if (useGoto) {\n            hrefToLoadHttpUri.hash(\"\").normalizeHash();\n\n            if (pubLink.Duration) {\n                const gotoBase64 = hrefToLoadHttpUri.search(true)[URL_PARAM_GOTO];\n\n                if (gotoBase64) {\n                    const str = Buffer.from(gotoBase64 as string, \"base64\").toString(\"utf8\");\n                    const json = JSON.parse(str);\n                    const gotoProgression = (json as LocatorLocations).progression;\n                    if (typeof gotoProgression !== \"undefined\") {\n                        const time = gotoProgression * pubLink.Duration;\n                        hrefToLoadHttpUri.hash(`t=${time}`).normalizeHash();\n                    }\n                }\n            }\n        }\n\n        // TODO: urijs types broke this! (lib remains unchanged)\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        (hrefToLoadHttpUri as any).search((data: any) => {\n            // overrides existing (leaves others intact)\n            data[URL_PARAM_PREVIOUS] = undefined;\n            data[URL_PARAM_GOTO] = undefined;\n            data[URL_PARAM_GOTO_DOM_RANGE] = undefined;\n            data[URL_PARAM_CSS] = undefined;\n            data[URL_PARAM_EPUBREADINGSYSTEM] = undefined;\n            data[URL_PARAM_DEBUG_VISUALS] = undefined;\n            data[URL_PARAM_CLIPBOARD_INTERCEPT] = undefined;\n            data[URL_PARAM_REFRESH] = undefined;\n            data[URL_PARAM_WEBVIEW_SLOT] = undefined;\n            data[URL_PARAM_SECOND_WEBVIEW] = undefined;\n        });\n    } else {\n        // TODO: urijs types broke this! (lib remains unchanged)\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        (hrefToLoadHttpUri as any).search((data: any) => {\n            // overrides existing (leaves others intact)\n\n            if (typeof previous === \"undefined\") {\n                // erase unwanted forward of query param during linking\n                data[URL_PARAM_PREVIOUS] = undefined;\n                // delete data[URL_PARAM_PREVIOUS];\n            } else {\n                data[URL_PARAM_PREVIOUS] = previous ? \"true\" : \"false\";\n            }\n\n            if (!useGoto) {\n                // erase unwanted forward of query param during linking\n                data[URL_PARAM_GOTO] = undefined;\n                // delete data[URL_PARAM_GOTO];\n\n                data[URL_PARAM_GOTO_DOM_RANGE] = undefined;\n                // delete data[URL_PARAM_GOTO_DOM_RANGE];\n            }\n        });\n        if (useGoto) {\n            hrefToLoadHttpUri.hash(\"\").normalizeHash();\n        }\n\n        // no need for encodeURIComponent_RFC3986, auto-encoded by URI class\n\n        const rersJson = getEpubReadingSystemInfo();\n        const rersJsonstr = JSON.stringify(rersJson, null, \"\");\n        const rersJsonstrBase64 = Buffer.from(rersJsonstr).toString(\"base64\");\n\n        // TODO: urijs types broke this! (lib remains unchanged)\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        (hrefToLoadHttpUri as any).search((data: any) => {\n            // overrides existing (leaves others intact)\n\n            // tslint:disable-next-line:no-string-literal\n            data[URL_PARAM_CSS] = rcssJsonstrBase64;\n\n            // tslint:disable-next-line:no-string-literal\n            data[URL_PARAM_EPUBREADINGSYSTEM] = rersJsonstrBase64;\n\n            // tslint:disable-next-line:no-string-literal\n            data[URL_PARAM_DEBUG_VISUALS] = (IS_DEV &&\n                win.READIUM2.DEBUG_VISUALS) ?\n                \"true\" : \"false\";\n\n            // tslint:disable-next-line:no-string-literal\n            data[URL_PARAM_CLIPBOARD_INTERCEPT] =\n                win.READIUM2.clipboardInterceptor ?\n                \"true\" : \"false\";\n\n            data[URL_PARAM_WEBVIEW_SLOT] = webViewSlot;\n\n            data[URL_PARAM_SECOND_WEBVIEW] = secondWebView ? \"1\" :\n                (loadingSecondWebView ? `0${loadingSecondWebView.Href}` : \"0\");\n        });\n    }\n\n    const webviewNeedsForcedRefresh = !isAudio && (win.READIUM2.ttsClickEnabled ||\n        activeWebView && activeWebView.READIUM2.forceRefresh);\n    if (activeWebView) {\n        activeWebView.READIUM2.forceRefresh = undefined;\n    }\n    const webviewNeedsHardRefresh = !isAudio &&\n        (win.READIUM2.enableScreenReaderAccessibilityWebViewHardRefresh\n        && win.READIUM2.isScreenReaderMounted);\n\n    if (// !secondWebView && !loadingSecondWebView &&\n        // !win.READIUM2.getSecondWebView(false) &&\n        !isAudio && !webviewNeedsHardRefresh && !webviewNeedsForcedRefresh &&\n        activeWebView && activeWebView.READIUM2.link === pubLink && !isFixedLayout(pubLink)) {\n\n        const goto = useGoto ? hrefToLoadHttpUri.search(true)[URL_PARAM_GOTO] as string : undefined;\n        const gotoDomRange = useGoto ? hrefToLoadHttpUri.search(true)[URL_PARAM_GOTO_DOM_RANGE] as string : undefined;\n        const hash = useGoto ? undefined : hrefToLoadHttpUri.fragment(); // without #\n\n        debug(\"WEBVIEW ALREADY LOADED: \" + pubLink.Href);\n\n        const payload: IEventPayload_R2_EVENT_SCROLLTO = {\n            goto,\n            gotoDomRange,\n            hash,\n            isSecondWebView: secondWebView ? true : false,\n            previous: previous ? true : false,\n        };\n\n        if (IS_DEV) {\n            const msgStr = JSON.stringify(payload);\n            debug(msgStr);\n        }\n        if (activeWebView) {\n            if (activeWebView.style.transform &&\n                activeWebView.style.transform !== \"none\" &&\n                !activeWebView.hasAttribute(\"data-wv-fxl\")) {\n\n                activeWebView.style.opacity = \"0\";\n                // setTimeout(async () => {\n                //     await activeWebView.send(\"R2_EVENT_HIDE\",\n                //         activeWebView.READIUM2.link ? isFixedLayout(activeWebView.READIUM2.link) : null);\n                // }, 0);\n\n                setTimeout(async () => {\n                    shiftWebview(activeWebView, 0, undefined); // reset\n                    await activeWebView.send(R2_EVENT_SCROLLTO, payload);\n                }, 10);\n            } else {\n                setTimeout(async () => {\n                    await activeWebView.send(R2_EVENT_SCROLLTO, payload);\n                }, 0);\n            }\n        }\n\n        return true;\n    }\n\n    // if (!isFixedLayout(pubLink)) {\n    //     if (_rootHtmlElement) {\n    //         _rootHtmlElement.dispatchEvent(new Event(DOM_EVENT_HIDE_VIEWPORT));\n    //     }\n    // }\n\n    if (activeWebView) {\n\n        if (webviewNeedsForcedRefresh) {\n            // TODO: urijs types broke this! (lib remains unchanged)\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\n            (hrefToLoadHttpUri as any).search((data: any) => {\n                // overrides existing (leaves others intact)\n\n                data[URL_PARAM_REFRESH] = `${++_reloadCounter}`;\n            });\n        }\n\n        if (win.READIUM2.sessionInfo) {\n            // TODO: urijs types broke this! (lib remains unchanged)\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\n            (hrefToLoadHttpUri as any).search((data: any) => {\n                // overrides existing (leaves others intact)\n\n                if (win.READIUM2.sessionInfo) {\n                    const b64SessionInfo = Buffer.from(win.READIUM2.sessionInfo).toString(\"base64\");\n                    data[URL_PARAM_SESSION_INFO] = b64SessionInfo;\n                }\n            });\n        }\n\n        const uriStr = hrefToLoadHttpUri.toString();\n\n        const uriStr_ = uriStr.startsWith(READIUM2_ELECTRON_HTTP_PROTOCOL + \"://\") ? uriStr :\n            (pubIsServedViaSpecialUrlProtocol ? convertHttpUrlToCustomScheme(uriStr) : uriStr);\n\n        // if (IS_DEV) {\n        //     debug(\"####### >>> ---\");\n        //     debug(activeWebView.READIUM2.id);\n        //     debug(pubLink.Href);\n        //     debug(uriStr);\n        //     debug(hrefToLoadHttpUri.hash()); // with #\n        //     debug(hrefToLoadHttpUri.fragment()); // without #\n        //     // tslint:disable-next-line:no-string-literal\n        //     const gto = hrefToLoadHttpUri.search(true)[URL_PARAM_GOTO];\n        //     debug(gto ? (Buffer.from(gto, \"base64\").toString(\"utf8\")) : \"\"); // decodeURIComponent\n        //     // tslint:disable-next-line:no-string-literal\n        //     debug(hrefToLoadHttpUri.search(true)[URL_PARAM_PREVIOUS]);\n        //     // tslint:disable-next-line:no-string-literal\n        //     debug(hrefToLoadHttpUri.search(true)[URL_PARAM_CSS]);\n        //     debug(\"####### >>> ---\");\n        // }\n        if (isAudio) {\n            if (IS_DEV) {\n                debug(`___HARD AUDIO___ WEBVIEW REFRESH: ${uriStr_}`);\n            }\n\n            const readiumCssBackup = activeWebView.READIUM2.readiumCss;\n            if (secondWebView) {\n                if (!secondWebViewWasJustCreated) {\n                    win.READIUM2.destroySecondWebView();\n                    win.READIUM2.createSecondWebView();\n                }\n            } else {\n                win.READIUM2.destroyFirstWebView();\n                win.READIUM2.createFirstWebView();\n            }\n            const newActiveWebView = secondWebView ?\n                win.READIUM2.getSecondWebView(false) :\n                win.READIUM2.getFirstWebView();\n            if (newActiveWebView) {\n                newActiveWebView.READIUM2.readiumCss = readiumCssBackup;\n                newActiveWebView.READIUM2.link = pubLink;\n\n                // let coverImage: string | undefined;\n                const coverLink = publication.GetCover();\n                // if (coverLink) {\n                //     coverImage = coverLink.Href;\n                //     // if (coverImage && !isHTTP(coverImage)) {\n                //     //     coverImage = absoluteURL(coverImage);\n                //     // }\n                // }\n\n                let title: string | undefined;\n                if (pubLink.Title) {\n                    const regExp = /&(nbsp|amp|quot|lt|gt);/g;\n                    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n                    const map: any = {\n                        amp: \"&\",\n                        gt: \">\",\n                        lt: \"<\",\n                        nbsp: \" \",\n                        quot: \"\\\"\",\n                    };\n                    title = pubLink.Title.replace(regExp, (_match, entityName) => {\n                        return map[entityName] ? map[entityName] : entityName;\n                    });\n                }\n\n                const audioPlaybackRate = getCurrentAudioPlaybackRate();\n                // let audioPlaybackRate = 1;\n                if (rcssJson.setCSS) {\n                    // if (rcssJson.setCSS.audioPlaybackRate) {\n                    //     audioPlaybackRate = rcssJson.setCSS.audioPlaybackRate;\n                    // }\n\n                    rcssJson.setCSS.paged = false;\n                }\n\n                let htmlMarkup = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:epub=\"http://www.idpf.org/2007/ops\">\n<head>\n    <meta charset=\"utf-8\" />\n    ${title ? `<title>${title}</title>` : \"<!-- NO TITLE -->\"}\n    <base href=\"${publicationURLHttp /* publicationURL */ }\" id=\"${READIUM2_BASEURL_ID}\" />\n    <style type=\"text/css\">\n    /*<![CDATA[*/\n    /*]]>*/\n    </style>\n\n    <script>\n    //<![CDATA[\n\n    const DEBUG_AUDIO = ${IS_DEV};\n    const DEBUG_AUDIO_X = ${DEBUG_AUDIO};\n\n    document.addEventListener(\"DOMContentLoaded\", () => {\n        const _audioElement = document.getElementById(\"${AUDIO_ID}\");\n        _audioElement.playbackRate = ${audioPlaybackRate};\n\n        _audioElement.addEventListener(\"error\", function()\n            {\n                console.debug(\"-1) error\");\n                if (_audioElement.error) {\n                    // 1 === MEDIA_ERR_ABORTED\n                    // 2 === MEDIA_ERR_NETWORK\n                    // 3 === MEDIA_ERR_DECODE\n                    // 4 === MEDIA_ERR_SRC_NOT_SUPPORTED\n                    console.log(_audioElement.error.code);\n                    console.log(_audioElement.error.message);\n                }\n            }\n        );\n\n        if (DEBUG_AUDIO)\n        {\n            _audioElement.addEventListener(\"load\", function()\n                {\n                    console.debug(\"0) load\");\n                }\n            );\n\n            _audioElement.addEventListener(\"loadstart\", function()\n                {\n                    console.debug(\"1) loadstart\");\n                }\n            );\n\n            _audioElement.addEventListener(\"durationchange\", function()\n                {\n                    console.debug(\"2) durationchange\");\n                }\n            );\n\n            _audioElement.addEventListener(\"loadedmetadata\", function()\n                {\n                    console.debug(\"3) loadedmetadata\");\n                }\n            );\n\n            _audioElement.addEventListener(\"loadeddata\", function()\n                {\n                    console.debug(\"4) loadeddata\");\n                }\n            );\n\n            _audioElement.addEventListener(\"progress\", function()\n                {\n                    console.debug(\"5) progress\");\n                }\n            );\n\n            _audioElement.addEventListener(\"canplay\", function()\n                {\n                    console.debug(\"6) canplay\");\n                }\n            );\n\n            _audioElement.addEventListener(\"canplaythrough\", function()\n                {\n                    console.debug(\"7) canplaythrough\");\n                }\n            );\n\n            _audioElement.addEventListener(\"play\", function()\n                {\n                    console.debug(\"8) play\");\n                }\n            );\n\n            _audioElement.addEventListener(\"pause\", function()\n                {\n                    console.debug(\"9) pause\");\n                }\n            );\n\n            _audioElement.addEventListener(\"ended\", function()\n                {\n                    console.debug(\"10) ended\");\n                }\n            );\n\n            _audioElement.addEventListener(\"seeked\", function()\n                {\n                    console.debug(\"11) seeked\");\n                }\n            );\n\n            if (DEBUG_AUDIO_X) {\n                _audioElement.addEventListener(\"timeupdate\", function()\n                    {\n                        console.debug(\"12) timeupdate\");\n                    }\n                );\n            }\n\n            _audioElement.addEventListener(\"seeking\", function()\n                {\n                    console.debug(\"13) seeking\");\n                }\n            );\n\n            _audioElement.addEventListener(\"waiting\", function()\n                {\n                    console.debug(\"14) waiting\");\n                }\n            );\n\n            _audioElement.addEventListener(\"volumechange\", function()\n                {\n                    console.debug(\"15) volumechange\");\n                }\n            );\n\n            _audioElement.addEventListener(\"suspend\", function()\n                {\n                    console.debug(\"16) suspend\");\n                }\n            );\n\n            _audioElement.addEventListener(\"stalled\", function()\n                {\n                    console.debug(\"17) stalled\");\n                }\n            );\n\n            _audioElement.addEventListener(\"ratechange\", function()\n                {\n                    console.debug(\"18) ratechange\");\n                }\n            );\n\n            _audioElement.addEventListener(\"playing\", function()\n                {\n                    console.debug(\"19) playing\");\n                }\n            );\n\n            _audioElement.addEventListener(\"interruptend\", function()\n                {\n                    console.debug(\"20) interruptend\");\n                }\n            );\n\n            _audioElement.addEventListener(\"interruptbegin\", function()\n                {\n                    console.debug(\"21) interruptbegin\");\n                }\n            );\n\n            _audioElement.addEventListener(\"emptied\", function()\n                {\n                    console.debug(\"22) emptied\");\n                }\n            );\n\n            _audioElement.addEventListener(\"abort\", function()\n                {\n                    console.debug(\"23) abort\");\n                }\n            );\n        }\n    }, false);\n\n    //]]>\n    </script>\n</head>\n<body id=\"${AUDIO_BODY_ID}\">\n<section id=\"${AUDIO_SECTION_ID}\">\n${title ? `<h3 id=\"${AUDIO_TITLE_ID}\">${title}</h3>` : \"\"}\n${coverLink ? `<img id=\"${AUDIO_COVER_ID}\" src=\"${coverLink.Href}\" alt=\"\" ${coverLink.Height ? `height=\"${coverLink.Height}\"` : \"\"} ${coverLink.Width ? `width=\"${coverLink.Width}\"` : \"\"} ${coverLink.Width || coverLink.Height ? `style=\"${coverLink.Height ? `height: ${coverLink.Height}px !important;` : \"\"} ${coverLink.Width ? `width: ${coverLink.Width}px !important;` : \"\"}\"` : \"\"}/>` : \"\"}\n    <audio\n        id=\"${AUDIO_ID}\"\n        ${DEBUG_AUDIO ? \"controlsx=\\\"controlsx\\\"\" : \"\"}\n        autoplay=\"autoplay\"\n        preload=\"metadata\">\n\n        <source src=\"${uriStr /* linkPath */}\" type=\"${pubLink.TypeLink}\" />\n    </audio>\n    ${DEBUG_AUDIO ?\n    `\n<canvas id=\"${AUDIO_BUFFER_CANVAS_ID}\"> </canvas>\n    `\n    : \"\"}\n\n    <!-- SVG credits (tweaked sizing and coloring): https://material.io/resources/icons/?style=round -->\n\n    <div id=\"${AUDIO_CONTROLS_ID}\">\n        <button id=\"${AUDIO_PREVIOUS_ID}\" title=\"previous\">\n            <svg xmlns=\"http://www.w3.org/2000/svg\"\n                viewBox=\"0 0 24 24\" width=\"48px\" height=\"48px\">\n                <path d=\"M7 6c.55 0 1 .45 1 1v10c0 .55-.45 1-1 1s-1-.45-1-1V7c0-.55.45-1 1-1zm3.66 6.82l5.77 4.07c.66.47 1.58-.01 1.58-.82V7.93c0-.81-.91-1.28-1.58-.82l-5.77 4.07c-.57.4-.57 1.24 0 1.64z\"/></svg>\n        </button>\n        <button id=\"${AUDIO_REWIND_ID}\" title=\"rewind\">\n            <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" width=\"48px\" height=\"48px\">\n            <path d=\"M12 5V2.21c0-.45-.54-.67-.85-.35l-3.8 3.79c-.2.2-.2.51 0 .71l3.79 3.79c.32.31.86.09.86-.36V7c3.73 0 6.68 3.42 5.86 7.29-.47 2.27-2.31 4.1-4.57 4.57-3.57.75-6.75-1.7-7.23-5.01-.07-.48-.49-.85-.98-.85-.6 0-1.08.53-1 1.13.62 4.39 4.8 7.64 9.53 6.72 3.12-.61 5.63-3.12 6.24-6.24C20.84 9.48 16.94 5 12 5zm-2.44 8.49h.45c.21 0 .37-.05.48-.16s.16-.25.16-.43c0-.08-.01-.15-.04-.22s-.06-.12-.11-.17-.11-.09-.18-.11-.16-.04-.25-.04c-.08 0-.15.01-.22.03s-.13.05-.18.1-.09.09-.12.15-.05.13-.05.2h-.85c0-.18.04-.34.11-.48s.17-.27.3-.37.27-.18.44-.23.35-.08.54-.08c.21 0 .41.03.59.08s.33.13.46.23.23.23.3.38.11.33.11.53c0 .09-.01.18-.04.27s-.07.17-.13.25-.12.15-.2.22-.17.12-.28.17c.24.09.42.21.54.39s.18.38.18.61c0 .2-.04.38-.12.53s-.18.29-.32.39-.29.19-.48.24-.38.08-.6.08c-.18 0-.36-.02-.53-.07s-.33-.12-.46-.23-.25-.23-.33-.38-.12-.34-.12-.55h.85c0 .08.02.15.05.22s.07.12.13.17.12.09.2.11.16.04.25.04c.1 0 .19-.01.27-.04s.15-.07.2-.12.1-.11.13-.18.04-.15.04-.24c0-.11-.02-.21-.05-.29s-.08-.15-.14-.2-.13-.09-.22-.11-.18-.04-.29-.04h-.47v-.65zm5.74.75c0 .32-.03.6-.1.82s-.17.42-.29.57-.28.26-.45.33-.37.1-.59.1-.41-.03-.59-.1-.33-.18-.46-.33-.23-.34-.3-.57-.11-.5-.11-.82v-.74c0-.32.03-.6.1-.82s.17-.42.29-.57.28-.26.45-.33.37-.1.59-.1.41.03.59.1.33.18.46.33.23.34.3.57.11.5.11.82v.74zm-.85-.86c0-.19-.01-.35-.04-.48s-.07-.23-.12-.31-.11-.14-.19-.17-.16-.05-.25-.05-.18.02-.25.05-.14.09-.19.17-.09.18-.12.31-.04.29-.04.48v.97c0 .19.01.35.04.48s.07.24.12.32.11.14.19.17.16.05.25.05.18-.02.25-.05.14-.09.19-.17.09-.19.11-.32c.03-.13.04-.29.04-.48v-.97z\"/></svg>\n        </button>\n        <button id=\"${AUDIO_PLAYPAUSE_ID}\" title=\"play / pause\">\n            <svg id=\"${AUDIO_PLAYPAUSE_ID}_0\" xmlns=\"http://www.w3.org/2000/svg\"\n                viewBox=\"0 0 24 24\" width=\"60px\" height=\"60px\">\n                <path d=\"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14c-.55 0-1-.45-1-1V9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1zm4 0c-.55 0-1-.45-1-1V9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1z\"/></svg>\n            <svg id=\"${AUDIO_PLAYPAUSE_ID}_1\" xmlns=\"http://www.w3.org/2000/svg\"\n                viewBox=\"0 0 24 24\" width=\"60px\" height=\"60px\">\n                <path d=\"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 13.5v-7c0-.41.47-.65.8-.4l4.67 3.5c.27.2.27.6 0 .8l-4.67 3.5c-.33.25-.8.01-.8-.4z\"/></svg>\n        </button>\n        <button id=\"${AUDIO_FORWARD_ID}\" title=\"forward\">\n            <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" width=\"48px\" height=\"48px\">\n            <path d=\"M18.92 13c-.5 0-.91.37-.98.86-.48 3.37-3.77 5.84-7.42 4.96-2.25-.54-3.91-2.27-4.39-4.53C5.32 10.42 8.27 7 12 7v2.79c0 .45.54.67.85.35l3.79-3.79c.2-.2.2-.51 0-.71l-3.79-3.79c-.31-.31-.85-.09-.85.36V5c-4.94 0-8.84 4.48-7.84 9.6.6 3.11 2.9 5.5 5.99 6.19 4.83 1.08 9.15-2.2 9.77-6.67.09-.59-.4-1.12-1-1.12zm-8.38 2.22c-.06.05-.12.09-.2.12s-.17.04-.27.04c-.09 0-.17-.01-.25-.04s-.14-.06-.2-.11-.1-.1-.13-.17-.05-.14-.05-.22h-.85c0 .21.04.39.12.55s.19.28.33.38.29.18.46.23.35.07.53.07c.21 0 .41-.03.6-.08s.34-.14.48-.24.24-.24.32-.39.12-.33.12-.53c0-.23-.06-.44-.18-.61s-.3-.3-.54-.39c.1-.05.2-.1.28-.17s.15-.14.2-.22.1-.16.13-.25.04-.18.04-.27c0-.2-.04-.37-.11-.53s-.17-.28-.3-.38-.28-.18-.46-.23-.37-.08-.59-.08c-.19 0-.38.03-.54.08s-.32.13-.44.23-.23.22-.3.37-.11.3-.11.48h.85c0-.07.02-.14.05-.2s.07-.11.12-.15.11-.07.18-.1.14-.03.22-.03c.1 0 .18.01.25.04s.13.06.18.11.08.11.11.17.04.14.04.22c0 .18-.05.32-.16.43s-.26.16-.48.16h-.43v.66h.45c.11 0 .2.01.29.04s.16.06.22.11.11.12.14.2.05.18.05.29c0 .09-.01.17-.04.24s-.08.11-.13.17zm3.9-3.44c-.18-.07-.37-.1-.59-.1s-.41.03-.59.1-.33.18-.45.33-.23.34-.29.57-.1.5-.1.82v.74c0 .32.04.6.11.82s.17.42.3.57.28.26.46.33.37.1.59.1.41-.03.59-.1.33-.18.45-.33.22-.34.29-.57.1-.5.1-.82v-.74c0-.32-.04-.6-.11-.82s-.17-.42-.3-.57-.28-.26-.46-.33zm.01 2.57c0 .19-.01.35-.04.48s-.06.24-.11.32-.11.14-.19.17-.16.05-.25.05-.18-.02-.25-.05-.14-.09-.19-.17-.09-.19-.12-.32-.04-.29-.04-.48v-.97c0-.19.01-.35.04-.48s.06-.23.12-.31.11-.14.19-.17.16-.05.25-.05.18.02.25.05.14.09.19.17.09.18.12.31.04.29.04.48v.97z\"/></svg>\n        </button>\n        <button id=\"${AUDIO_NEXT_ID}\" title=\"next\">\n        <svg xmlns=\"http://www.w3.org/2000/svg\"\n            viewBox=\"0 0 24 24\" width=\"48px\" height=\"48px\">\n            <path d=\"M7.58 16.89l5.77-4.07c.56-.4.56-1.24 0-1.63L7.58 7.11C6.91 6.65 6 7.12 6 7.93v8.14c0 .81.91 1.28 1.58.82zM16 7v10c0 .55.45 1 1 1s1-.45 1-1V7c0-.55-.45-1-1-1s-1 .45-1 1z\"/></svg>\n        </button>\n        <input id=\"${AUDIO_SLIDER_ID}\" type=\"range\" min=\"0\" max=\"100\" value=\"0\" step=\"1\" title=\"progress\" />\n        <button id=\"${AUDIO_TIME_ID}\" title=\"time information 1\">-</button>\n        <button id=\"${AUDIO_PERCENT_ID}\" title=\"time information 2\">-</button>\n        <select id=\"${AUDIO_RATE_ID}\" title=\"playback speed\">\n            <option value=\"2\">2x</option>\n            <option value=\"1.75\">1.75x</option>\n            <option value=\"1.5\">1.5x</option>\n            <option value=\"1.25\">1.25x</option>\n            <option value=\"1\">1x</option>\n            <option value=\"0.75\">0.75x</option>\n            <option value=\"0.5\">0.5x</option>\n            <option value=\"0.35\">0.35x</option>\n            <option value=\"0.25\">0.25x</option>\n        </select>\n    </div>\n</section>\n</body>\n</html>`;\n\n                // const contentType = \"text/html\";\n                const contentType = \"application/xhtml+xml\";\n                htmlMarkup = readiumCssTransformHtml(htmlMarkup, rcssJson, contentType);\n\n                const b64HTML = Buffer.from(htmlMarkup).toString(\"base64\");\n                const dataUri = `data:${contentType};base64,${b64HTML}`;\n                newActiveWebView.setAttribute(\"src\", dataUri);\n                // newActiveWebView.setAttribute(\"src\", uriStr_);\n                // newActiveWebView.setAttribute(\"srcdoc\", \"<p>TEST</p>\");\n                // setTimeout(async () => {\n                //     await newActiveWebView.getWebContents().loadURL(uriStr_, { extraHeaders: \"pragma: no-cache\\n\" });\n                // }, 0);\n            }\n            return true;\n        } else if (webviewNeedsHardRefresh) {\n            if (IS_DEV) {\n                debug(`___HARD___ WEBVIEW REFRESH: ${uriStr_}`);\n            }\n\n            const readiumCssBackup = activeWebView.READIUM2.readiumCss;\n            if (secondWebView) {\n                if (!secondWebViewWasJustCreated) {\n                    win.READIUM2.destroySecondWebView();\n                    win.READIUM2.createSecondWebView();\n                }\n            } else {\n                win.READIUM2.destroyFirstWebView();\n                win.READIUM2.createFirstWebView();\n            }\n            const newActiveWebView = secondWebView ?\n                win.READIUM2.getSecondWebView(false) :\n                win.READIUM2.getFirstWebView();\n            if (newActiveWebView) {\n                newActiveWebView.READIUM2.readiumCss = readiumCssBackup;\n                newActiveWebView.READIUM2.link = pubLink;\n                newActiveWebView.setAttribute(\"src\", uriStr_);\n            }\n            return true;\n        } else {\n            if (IS_DEV) {\n                debug(`___SOFT___ WEBVIEW REFRESH: ${uriStr_}`);\n            }\n\n            const webviewAlreadyHasContent = (typeof activeWebView.READIUM2.link !== \"undefined\")\n                && activeWebView.READIUM2.link !== null;\n            activeWebView.READIUM2.link = pubLink;\n\n            if (activeWebView.style.transform &&\n                activeWebView.style.transform !== \"none\" &&\n                !activeWebView.hasAttribute(\"data-wv-fxl\")) {\n                // activeWebView.setAttribute(\"src\", \"data:, \");\n\n                if (webviewAlreadyHasContent) {\n                    activeWebView.style.opacity = \"0\";\n                    // setTimeout(async () => {\n                    //     await activeWebView.send(\"R2_EVENT_HIDE\",\n                    //         activeWebView.READIUM2.link ? isFixedLayout(activeWebView.READIUM2.link) : null);\n                    // }, 0);\n                }\n\n                setTimeout(() => {\n                    shiftWebview(activeWebView, 0, undefined); // reset\n                    activeWebView.setAttribute(\"src\", uriStr_);\n                }, 10);\n            } else {\n                activeWebView.setAttribute(\"src\", uriStr_);\n            }\n        }\n    }\n\n    // activeWebView.getWebContents().loadURL(uriStr_, { extraHeaders: \"pragma: no-cache\\n\" });\n    // activeWebView.loadURL(uriStr_, { extraHeaders: \"pragma: no-cache\\n\" });\n\n    return true;\n}\n\nexport interface LocatorExtended {\n    audioPlaybackInfo: IAudioPlaybackInfo | undefined;\n    locator: Locator;\n    paginationInfo: IPaginationInfo | undefined;\n    selectionInfo: ISelectionInfo | undefined;\n    selectionIsNew: boolean | undefined;\n    docInfo: IDocInfo | undefined;\n\n    // not NavDoc epub:type=\"page-list\",\n    // but target HTML document's epub:type=\"pagebreak\" / role=\"doc-pagebreak\"\n    // (nearest preceding ancestor/sibling)\n    epubPage: string | undefined;\n\n    secondWebViewHref: string | undefined;\n}\n\nlet _lastSavedReadingLocation: LocatorExtended | undefined;\nexport function getCurrentReadingLocation(): LocatorExtended | undefined {\n    return _lastSavedReadingLocation;\n}\nlet _readingLocationSaver: ((locator: LocatorExtended) => void) | undefined;\nconst _saveReadingLocation = (docHref: string, locator: IEventPayload_R2_EVENT_READING_LOCATION) => {\n\n    const publication = win.READIUM2.publication;\n\n    let position: number | undefined;\n    if (publication && publication.Spine) {\n        const isAudio =\n            publication.Metadata &&\n            publication.Metadata.RDFType &&\n            /https?:\\/\\/schema\\.org\\/Audiobook$/.test(publication.Metadata.RDFType);\n        if (isAudio) {\n            const metaDuration = publication.Metadata.Duration;\n            let totalDuration = 0;\n            let timePosition: number | undefined;\n            for (const spineItem of publication.Spine) {\n                if (typeof spineItem.Duration !== \"undefined\") {\n                    if (docHref === spineItem.Href) {\n                        const percent = typeof locator.locations.progression !== \"undefined\" ?\n                            locator.locations.progression : 0;\n                        const time = percent * spineItem.Duration;\n                        if (typeof timePosition === \"undefined\") {\n                            timePosition = totalDuration + time;\n                        }\n                    }\n\n                    totalDuration += spineItem.Duration;\n                }\n            }\n            if (totalDuration !== metaDuration) {\n                console.log(`DIFFERENT AUDIO DURATIONS?! ${totalDuration} (spines) !== ${metaDuration} (metadata)`);\n            }\n            if (typeof timePosition !== \"undefined\") {\n                position = timePosition / totalDuration;\n                if (locator.audioPlaybackInfo) {\n                    locator.audioPlaybackInfo.globalTime = timePosition;\n                    locator.audioPlaybackInfo.globalDuration = totalDuration;\n                    locator.audioPlaybackInfo.globalProgression = position;\n                }\n            }\n        }\n    }\n\n    _lastSavedReadingLocation = {\n        audioPlaybackInfo: locator.audioPlaybackInfo,\n        docInfo: locator.docInfo,\n        epubPage: locator.epubPage,\n        locator: {\n            href: docHref,\n            locations: {\n                cfi: locator.locations.cfi ?\n                    locator.locations.cfi : undefined,\n                cssSelector: locator.locations.cssSelector ?\n                    locator.locations.cssSelector : undefined,\n                position: (typeof locator.locations.position !== \"undefined\") ?\n                    locator.locations.position : position,\n                progression: (typeof locator.locations.progression !== \"undefined\") ?\n                    locator.locations.progression : undefined,\n            },\n            text: locator.text,\n            title: locator.title,\n        },\n        paginationInfo: locator.paginationInfo,\n        secondWebViewHref: locator.secondWebViewHref,\n        selectionInfo: locator.selectionInfo,\n        selectionIsNew: locator.selectionIsNew,\n    };\n\n    if (IS_DEV) {\n        // debug(\">->->\", JSON.stringify(_lastSavedReadingLocation, null, \"  \"));\n        debug(\">->->\");\n        debug(_lastSavedReadingLocation);\n    }\n\n    if (_readingLocationSaver) {\n        _readingLocationSaver(_lastSavedReadingLocation);\n    }\n\n    // // tslint:disable-next-line:no-floating-promises\n    // (async () => {\n    //     try {\n    //         const visible = await isLocatorVisible(_lastSavedReadingLocation.locator);\n    //         debug(`isLocatorVisible async: ${visible}`);\n    //     } catch (err) {\n    //         debug(err);\n    //     }\n    // })();\n};\nexport function setReadingLocationSaver(func: (locator: LocatorExtended) => void) {\n    _readingLocationSaver = func;\n}\n\nexport async function isLocatorVisible(locator: Locator): Promise<boolean> {\n    return new Promise<boolean>((resolve, reject) => {\n        const activeWebViews = win.READIUM2.getActiveWebViews();\n        for (const activeWebView of activeWebViews) {\n            if (activeWebView.READIUM2.link?.Href !== locator.href) {\n                continue;\n            }\n\n            // const cb = (_event: any, payload: IEventPayload_R2_EVENT_LOCATOR_VISIBLE) => {\n            //     debug(\"R2_EVENT_LOCATOR_VISIBLE\");\n            //     debug(payload.visible);\n            // };\n            // ipcRenderer.once(R2_EVENT_LOCATOR_VISIBLE, cb);\n\n            const cb = (event: Electron.IpcMessageEvent) => {\n                if (event.channel === R2_EVENT_LOCATOR_VISIBLE) {\n                    const webview = event.currentTarget as IReadiumElectronWebview;\n                    if (webview !== activeWebView) {\n                        console.log(\"Wrong navigator webview?!\");\n                        return;\n                    }\n                    const payloadPong = event.args[0] as IEventPayload_R2_EVENT_LOCATOR_VISIBLE;\n                    // debug(`isLocatorVisible: ${payload_.visible}`);\n                    activeWebView.removeEventListener(\"ipc-message\", cb);\n                    resolve(payloadPong.visible);\n                }\n            };\n            activeWebView.addEventListener(\"ipc-message\", cb);\n\n            const payloadPing: IEventPayload_R2_EVENT_LOCATOR_VISIBLE = { location: locator.locations, visible: false };\n            setTimeout(async () => {\n                await activeWebView.send(R2_EVENT_LOCATOR_VISIBLE, payloadPing);\n            }, 0);\n\n            return;\n        }\n\n        reject(\"isLocatorVisible - no webview href match.\");\n    });\n}\n"]}